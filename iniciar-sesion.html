<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Iniciar sesión · The Pets Lovers</title>
  <meta name="description" content="Accede a tu cuenta o regístrate en The Pets Lovers.">

  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Poppins:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <!-- TPL: INICIO BLOQUE NUEVO [Estilos login compactado y sin desbordes] -->
  <style>
    :root { --tpl-primary:#339496; --tpl-ink:#58425a; }
    /* Asegura que nada se salga de la tarjeta */
    *, *::before, *::after { box-sizing: border-box; }

    body{ background:#f7f9f9; }
    /* mismo “aire” arriba/abajo, card un pelín más estrecha */
    .auth-wrap{ max-width:440px; margin:120px auto 60px; padding:0 14px; }

    .auth-card{
      background:#fff; border:1px solid #eee; border-radius:14px;
      box-shadow:0 2px 12px rgba(0,0,0,.06);
      padding:16px;               /* más compacta */
      overflow:hidden;            /* evita que algo sobresalga */
    }

    .auth-title{ margin:0 0 6px; color:var(--tpl-ink); font-size:1.3rem; text-align:center }
    .auth-sub{ margin:0 0 12px; color:#666; text-align:center }

    .auth-form{ display:grid; gap:8px; margin-top:4px; }  /* más cerrado */
    .auth-form label{ font-size:.92rem; color:var(--tpl-ink); display:block; margin-bottom:6px; }
    .input-wrap{ position:relative; }
    .auth-form input{
      display:block; width:100%; max-width:100%;
      border:1px solid #ddd; border-radius:10px; padding:10px 12px; font-size:1rem; background:#fff;
    }
    .auth-form input:focus{ outline:none; border-color:#c7e6e6; box-shadow:0 0 0 3px rgba(51,148,150,.12); }

    .btn{
      background:#339496; color:#fff; border:none; border-radius:999px;
      padding:10px 14px; cursor:pointer; font-weight:700; width:100%;
    }
    .btn[disabled]{ opacity:.65; cursor:not-allowed; }
    .btn-outline{
      background:#fff; color:#339496; border:1px solid #339496; border-radius:999px;
      padding:10px 14px; cursor:pointer; font-weight:700; width:100%;
    }
    .btn-google{
      display:flex; align-items:center; justify-content:center; gap:8px;
      border:1px solid #ddd; border-radius:999px; padding:10px 14px; background:#fff;
      cursor:pointer; font-weight:700; width:100%; color:var(--tpl-primary);
    }
    .btn:focus, .btn-outline:focus, .btn-google:focus{ outline:3px solid rgba(51,148,150,.22); }

    .auth-msg{ min-height:1.1em; color:var(--tpl-ink); text-align:center; margin-top:4px; font-size:.92rem }

    .sep{ position:relative; text-align:center; margin:8px 0 6px; color:#999; font-size:.9rem }
    .sep::before{ content:""; position:absolute; left:0; right:0; top:50%; height:1px; background:#eee }
    .sep span{ background:#fff; padding:0 8px; position:relative; z-index:1 }

    .row-actions{ display:grid; gap:8px; margin-top:6px; }

    .below{ margin-top:8px; text-align:center; font-size:.9rem; }
    .below a{ color:var(--tpl-primary); font-weight:700; text-decoration:underline; }

    /* Link fuera de la tarjeta */
    .auth-footer-link{
      display:block; text-align:center; margin-top:16px; font-size:.85rem;
      color:#339496; text-decoration:none
    }

    /* (el aviso HTML “ya estás logueado” lo dejamos oculto por JS; no cambia diseño) */
    .already{ margin-top:8px; text-align:center; font-size:.92rem; color:#555; display:none; }
    .btn-chip{
      display:inline-block; margin:6px 6px 0 6px; padding:8px 12px;
      border-radius:999px; border:1px solid #d7efef; background:#f5fbfb;
      color:#339496; font-weight:700; text-decoration:none;
    }
  </style>
  <!-- TPL: FIN BLOQUE NUEVO -->
</head>
<body>

  <!-- Navbar unificada -->
  <div id="tpl-navbar"></div>
  <script src="tpl-navbar.js" defer></script>

  <main class="auth-wrap container">
    <section class="auth-card" aria-label="Acceso">
      <h1 class="auth-title">Iniciar sesión</h1>
      <p class="auth-sub">Introduce tu email y contraseña.</p>

      <!-- TPL: INICIO BLOQUE NUEVO [Aviso (se mantiene pero no se muestra; redirigimos directo)] -->
      <div id="tpl-logged" class="already">
        Ya has iniciado sesión.
        <a href="tpl-candidaturas-admin.html" class="btn-chip" id="tpl-btn-panel">Ir a Panel</a>
        <a href="perfil.html" class="btn-chip" id="tpl-btn-perfil">Ir a Mi perfil</a>
      </div>
      <!-- TPL: FIN BLOQUE NUEVO -->

      <!-- Formulario -->
      <form id="formAuth" class="auth-form" novalidate>
        <div>
          <label for="email">Email</label>
          <div class="input-wrap">
            <input id="email" name="email" type="email" required autocomplete="email" />
          </div>
        </div>
        <div>
          <label for="password">Contraseña</label>
          <div class="input-wrap">
            <input id="password" name="password" type="password" required autocomplete="current-password" />
          </div>
        </div>
        <button id="btnLogin" class="btn" type="submit">Iniciar sesión</button>
        <button id="btnForgot" class="btn-outline" type="button">¿Has olvidado la contraseña?</button>
        <p id="msg" class="auth-msg" aria-live="polite"></p>
      </form>

      <div class="sep"><span>o</span></div>
      <div class="row-actions">
        <button id="btnGoogle" class="btn-google" type="button"><i class="fa-brands fa-google"></i> Continuar con Google</button>
      </div>

      <p class="below">¿Aún no tienes cuenta? <a id="btnSignup" href="registro.html">Regístrate</a></p>
    </section>

    <!-- Link “Volver a la web” fuera de la tarjeta -->
    <a href="index.html" class="auth-footer-link">← Volver a la web</a>
  </main>

  <!-- Footer -->
  <div id="tpl-footer"></div>
  <script src="tpl-footer.js" defer></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script>
    (function(){
      const firebaseConfig = {
        apiKey: "AIzaSyDW73aFuz2AFS9VeWg_linHIRJYN4YMgTk",
        authDomain: "thepetslovers-c1111.firebaseapp.com",
        projectId: "thepetslovers-c1111",
        storageBucket: "thepetslovers-c1111.appspot.com",
        messagingSenderId: "415914577533",
        appId: "1:415914577533:web:0b7a056ebaa4f1de28ab14",
        measurementId: "G-FXPD69KXBG"
      };
      if (typeof firebase !== 'undefined' && firebase.apps.length === 0) {
        firebase.initializeApp(firebaseConfig);
      }
      window.__TPL_AUTH_INIT = true;
    })();
  </script>

  <!-- TPL: INICIO BLOQUE NUEVO [Redirección inmediata post-login sin mensajes] -->
  <script>
    (function(){
      // Admin ⇒ panel, resto ⇒ perfil
      const PANEL_URL = 'tpl-candidaturas-admin.html';
      const PROFILE_URL = 'perfil.html';
      const ADMIN_EMAILS = ['4b.jenny.gomez@gmail.com'];
      const ADMIN_SET = new Set(ADMIN_EMAILS.map(x =>
        String(x).trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'')
      ));
      const isAdminEmail = (email) => {
        const norm = String(email||'').trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
        return ADMIN_SET.has(norm);
      };

      const $ = (s,p=document)=>p.querySelector(s);
      const form = $('#formAuth');
      const email = $('#email');
      const pass  = $('#password');
      const btnForgot = $('#btnForgot');
      const btnGoogle = $('#btnGoogle');
      const btnLogin = $('#btnLogin');
      const msg = $('#msg');

      const auth = () => (typeof firebase!=='undefined' && firebase.auth) ? firebase.auth() : null;

      async function go(url){
        // Redirección directa; sin mensajes
        location.href = url;
      }
      async function decideNext(user){
        return (user && isAdminEmail(user.email)) ? PANEL_URL : PROFILE_URL;
      }

      // Si ya hay sesión al entrar aquí → redirigir sin mostrar nada
      document.addEventListener('DOMContentLoaded', function(){
        try{
          const a = auth();
          if (!a) return;
          a.onAuthStateChanged(async function(u){
            if (u && !u.isAnonymous){
              // cache ligero para navbar (opcional)
              try{ localStorage.setItem('tplAuth','1'); if(u.email) localStorage.setItem('tplEmail', String(u.email)); }catch(e){}
              await go(await decideNext(u));
            }
          });
        }catch(e){}
      });

      function setBusy(b){
        try{
          btnLogin && (btnLogin.disabled = b);
          btnGoogle && (btnGoogle.disabled = b);
        }catch(e){}
      }
      function showError(t){ msg && (msg.textContent = t || ''); }

      // Email/contraseña
      form.addEventListener('submit', async function(e){
        e.preventDefault();
        const a = auth();
        if (!a){ showError('Servicio de autenticación no disponible.'); return; }
        const em = (email.value||'').trim();
        const pw = pass.value;
        try{
          setBusy(true);
          const cred = await a.signInWithEmailAndPassword(em, pw);
          try{ localStorage.setItem('tplAuth','1'); if(cred.user && cred.user.email) localStorage.setItem('tplEmail', String(cred.user.email)); }catch(e){}
          await go(await decideNext(cred.user));
        }catch(err){
          let m = (err && err.code) ? err.code : (err && err.message) || 'Error';
          if (/auth\/invalid-credential|auth\/wrong-password/.test(m)) m = 'Credenciales no válidas. Revisa tu email y contraseña.';
          if (/auth\/user-not-found/.test(m)) m = 'No existe una cuenta con ese email.';
          showError(m);
          setBusy(false);
        }
      });

      // Google (popup / redirect en iOS-Safari)
      btnGoogle.addEventListener('click', async function(){
        const a = auth();
        if (!a){ showError('Servicio de autenticación no disponible.'); return; }
        const provider = new firebase.auth.GoogleAuthProvider();
        setBusy(true);
        try{
          const isIOS = /iP(ad|hone|od)/i.test(navigator.userAgent);
          const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
          if (isIOS && isSafari){
            await a.signInWithRedirect(provider);
            return; // vuelve con getRedirectResult
          } else {
            const res = await a.signInWithPopup(provider);
            try{ localStorage.setItem('tplAuth','1'); if(res.user && res.user.email) localStorage.setItem('tplEmail', String(res.user.email)); }catch(e){}
            await go(await decideNext(res.user));
          }
        }catch(err){
          let m = (err && err.message) || 'No se pudo iniciar con Google.';
          if (/popup-closed-by-user/i.test(m)) m = 'Has cerrado la ventana de Google.';
          showError(m);
          setBusy(false);
        }
      });

      // Si volvemos de redirect de Google
      (async function handleRedirect(){
        try{
          const a = auth(); if (!a) return;
          const res = await a.getRedirectResult();
          if (res && res.user){
            try{ localStorage.setItem('tplAuth','1'); if(res.user.email) localStorage.setItem('tplEmail', String(res.user.email)); }catch(e){}
            await go(await decideNext(res.user));
          }
        }catch(e){}
      })();

      // Reset password
      btnForgot && btnForgot.addEventListener('click', async function(){
        const a = auth();
        if (!a){ showError('Servicio de autenticación no disponible.'); return; }
        const em = (email.value||'').trim();
        if (!em){ showError('Escribe tu email arriba y vuelve a pulsar.'); return; }
        try{
          await a.sendPasswordResetEmail(em);
          showError('Revisa tu correo para restablecer la contraseña.');
        }catch(e){
          showError('No se pudo enviar el email. Revisa el correo indicado.');
        }
      });
    })();
  </script>
  <!-- TPL: FIN BLOQUE NUEVO -->
</body>
</html>
