<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Iniciar sesión · The Pets Lovers</title>
  <meta name="description" content="Accede a tu cuenta o regístrate en The Pets Lovers. Profesionales del sector veterinario.">
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Poppins:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <!-- TPL: INICIO BLOQUE NUEVO [Estilos UI login compacto y estético] -->
  <style>
    :root { --tpl-primary:#339496; --tpl-ink:#58425a; }

    body.auth-bg{
      background:
        radial-gradient(1200px 500px at 110% -10%, rgba(51,148,150,.14) 0%, rgba(51,148,150,0) 70%),
        radial-gradient(1000px 400px at -10% 110%, rgba(88,66,90,.10) 0%, rgba(88,66,90,0) 70%),
        #f7f9f9;
    }

    .auth-wrap{
      max-width: 880px;
      margin: 86px auto 48px;
      padding: 0 16px;
    }

    /* Layout 2 columnas en desktop, 1 en mobile */
    .auth-layout{
      display: grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 18px;
      align-items: stretch;
    }
    @media (max-width: 880px){
      .auth-layout{ grid-template-columns: 1fr; gap:14px; }
      .auth-wrap{ margin-top: 82px; }
    }

    .auth-card, .auth-side{
      background:#fff;
      border:1px solid #eee;
      border-radius:16px;
      box-shadow:0 2px 14px rgba(0,0,0,.06);
    }

    .auth-card{ padding:18px; }
    .auth-head{
      display:flex; align-items:center; gap:12px; margin:2px 0 4px;
    }
    .auth-badge{
      width:40px;height:40px;border-radius:10px;display:grid;place-items:center;
      background:#f2fbfb; color:var(--tpl-primary); border:1px solid #d7efef;
      flex:0 0 auto;
    }
    .auth-title{ margin:0; color:var(--tpl-ink); font-size:1.35rem; line-height:1.1; }
    .auth-sub{ margin:0; color:#666; font-size:.95rem; }

    .auth-form{ display:grid; gap:10px; margin-top:10px; }
    .auth-form label{ font-size:.92rem; color:var(--tpl-ink); display:block; margin-bottom:6px; }
    .input-wrap{
      position:relative;
    }
    .auth-form input{
      width:100%;
      border:1px solid #ddd; border-radius:12px; padding:11px 12px;
      font-size:1rem; background:#fff;
    }
    .auth-form input:focus{ outline:none; border-color:#c7e6e6; box-shadow:0 0 0 3px rgba(51,148,150,.12); }

    .toggle-pass{
      position:absolute; right:8px; top:50%; transform:translateY(-50%);
      border:none; background:transparent; color:#888; padding:6px;
      cursor:pointer; border-radius:8px;
    }
    .toggle-pass:focus{ outline:2px solid rgba(51,148,150,.35); }

    .btn{ background:#339496; color:#fff; border:none; border-radius:999px; padding:11px 16px; cursor:pointer; font-weight:700; width:100%; }
    .btn[disabled]{ opacity:.65; cursor:not-allowed; }
    .btn-outline{ background:#fff; color:#339496; border:1.5px solid #339496; border-radius:999px; padding:11px 16px; cursor:pointer; font-weight:700; width:100% }
    .btn-google{
      display:flex; align-items:center; justify-content:center; gap:8px;
      border:1px solid #e7e7e7; border-radius:999px; padding:11px 16px; background:#fff;
      cursor:pointer; font-weight:700; width:100%; color:#2b6e70;
    }
    .btn-google:focus, .btn-outline:focus, .btn:focus{ outline:3px solid rgba(51,148,150,.25); }

    .row-actions{ display:grid; gap:10px; margin-top:10px; }
    .link{
      background:none; border:none; color:#339496; text-decoration:underline; cursor:pointer; padding:6px 0; font-weight:600;
    }

    .sep{ position:relative; text-align:center; margin:10px 0 4px; color:#999; font-size:.9rem }
    .sep::before{ content:""; position:absolute; left:0; right:0; top:50%; height:1px; background:#eee }
    .sep span{ background:#fff; padding:0 8px; position:relative; z-index:1 }

    .auth-msg{ min-height:1.2em; color:var(--tpl-ink); text-align:center; margin-top:6px }

    /* Lado derecho con mini-beneficios y marca para no dejar “hueco muerto” */
    .auth-side{
      padding:16px;
      display:grid; align-content:start; gap:8px;
      background:
        linear-gradient(180deg, rgba(51,148,150,.06), rgba(51,148,150,0) 36%),
        #fff;
    }
    .side-title{ margin:2px 0 0; color:#244; font-size:1.1rem; }
    .side-list{ list-style:none; padding:0; margin:6px 0 0; display:grid; gap:8px; }
    .side-list li{
      display:flex; align-items:flex-start; gap:8px; padding:8px 10px;
      border:1px solid #eef3f3; border-radius:12px; background:#fafefe;
      color:#335; font-size:.95rem;
    }
    .side-list i{ color:var(--tpl-primary); margin-top:2px; }
    .side-footer{
      margin-top:8px; font-size:.86rem; color:#666;
      display:flex; align-items:center; gap:8px; flex-wrap:wrap;
    }
    .side-footer .pill{
      display:inline-block; padding:2px 8px; border:1px solid #d7efef;
      color:#339496; background:#f5fbfb; border-radius:999px; font-weight:700; font-size:.82rem;
    }

    /* Mejoras pequeñas de espaciado */
    .auth-legal{
      margin-top:10px; font-size:.82rem; color:#6c6c6c; text-align:center;
    }
  </style>
  <!-- TPL: FIN BLOQUE NUEVO -->
</head>
<body class="auth-bg">

  <!-- Navbar (inyectada, no tocamos diseño global) -->
  <div id="tpl-navbar"></div>
  <script src="tpl-navbar.js" defer></script>

  <main class="auth-wrap container">
    <div class="auth-layout" aria-label="Acceso a la cuenta">
      <!-- Columna principal (formulario) -->
      <section class="auth-card" aria-label="Formulario de acceso">
        <div class="auth-head">
          <div class="auth-badge" aria-hidden="true"><i class="fa-solid fa-shield-dog"></i></div>
          <div>
            <h1 class="auth-title">Iniciar sesión</h1>
            <p class="auth-sub">Accede con tu email y contraseña. Luego podrás completar tu perfil.</p>
          </div>
        </div>

        <form id="formAuth" class="auth-form" novalidate>
          <div>
            <label for="email">Email</label>
            <div class="input-wrap">
              <input id="email" name="email" type="email" required autocomplete="email" placeholder="tunombre@email.com" />
            </div>
          </div>
          <div>
            <label for="password">Contraseña</label>
            <div class="input-wrap">
              <input id="password" name="password" type="password" required autocomplete="current-password" placeholder="••••••••" />
              <button type="button" class="toggle-pass" aria-label="Mostrar u ocultar contraseña" title="Mostrar/ocultar">
                <i class="fa-regular fa-eye"></i>
              </button>
            </div>
          </div>

          <button id="btnLogin" class="btn" type="submit">Iniciar sesión</button>
          <button id="btnForgot" class="link" type="button">¿Has olvidado la contraseña?</button>
          <p id="msg" class="auth-msg" aria-live="polite"></p>
        </form>

        <div class="sep"><span>o</span></div>

        <div class="row-actions">
          <button id="btnGoogle" class="btn-google" type="button"><i class="fa-brands fa-google"></i> Continuar con Google</button>
          <!-- href base: lo sobreescribe el JS si hay ?next= o si vienes de Trabaja con nosotros -->
          <a id="btnSignup" class="btn-outline" href="registro.html">Crear cuenta</a>
        </div>

        <p class="auth-legal">Al continuar aceptas nuestras <a href="condiciones.html">Condiciones</a> y la <a href="privacidad.html">Política de privacidad</a>.</p>
      </section>

      <!-- Columna lateral (beneficios/branding) -->
      <aside class="auth-side" aria-label="Ventajas y seguridad">
        <h2 class="side-title">Tu tranquilidad, su bienestar</h2>
        <ul class="side-list">
          <li><i class="fa-solid fa-user-nurse"></i> Equipo de <strong>auxiliares veterinarios titulados</strong>.</li>
          <li><i class="fa-solid fa-shield-heart"></i> <strong>Primera visita gratuita</strong> para conoceros.</li>
          <li><i class="fa-solid fa-file-pen"></i> Informe diario con <strong>fotos y seguimiento</strong>.</li>
          <li><i class="fa-solid fa-paw"></i> Servicios: visitas, paseos, guardería, estancias y bodas.</li>
        </ul>
        <div class="side-footer">
          <span class="pill">Profesionales</span>
          <span class="pill">Cuidado en casa</span>
          <span class="pill">Atención segura</span>
        </div>
      </aside>
    </div>
  </main>

  <!-- Footer (inyectado, igual que el resto de la web) -->
  <div id="tpl-footer"></div>
  <script src="tpl-footer.js" defer></script>

  <!-- Firebase compat SDKs + init -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script>
    (function(){
      const firebaseConfig = {
        apiKey: "AIzaSyDW73aFuz2AFS9VeWg_linHIRJYN4YMgTk",
        authDomain: "thepetslovers-c1111.firebaseapp.com",
        projectId: "thepetslovers-c1111",
        storageBucket: "thepetslovers-c1111.appspot.com",
        messagingSenderId: "415914577533",
        appId: "1:415914577533:web:0b7a056ebaa4f1de28ab14",
        measurementId: "G-FXPD69KXBG"
      };
      if (typeof firebase !== 'undefined' && firebase.apps.length === 0) {
        firebase.initializeApp(firebaseConfig);
      }
      window.__TPL_AUTH_INIT = true;
      // marca body para fondo suave del login
      try{ document.body.classList.add('auth-bg'); }catch(e){}
    })();
  </script>

  <!-- TPL: INICIO BLOQUE NUEVO [UX: mostrar/ocultar contraseña + estados de carga] -->
  <script>
    (function(){
      function $(s, p=document){ return p.querySelector(s); }
      var pwd = $('#password');
      var toggle = $('.toggle-pass');
      var btnLogin = $('#btnLogin');
      var btnGoogle = $('#btnGoogle');
      var form = $('#formAuth');
      var msg = $('#msg');

      function setBusy(b){
        try{
          btnLogin && (btnLogin.disabled = b);
          btnGoogle && (btnGoogle.disabled = b);
        }catch(e){}
      }
      function showMsg(t){ if(msg) msg.textContent = t || ''; }

      if(toggle){
        toggle.addEventListener('click', function(){
          var isPwd = pwd.getAttribute('type')==='password';
          pwd.setAttribute('type', isPwd ? 'text' : 'password');
          toggle.innerHTML = isPwd ? '<i class="fa-regular fa-eye-slash"></i>' : '<i class="fa-regular fa-eye"></i>';
          pwd.focus();
        });
      }

      // Minimiza “saltos”: al enviar, deshabilita botones
      if(form){
        form.addEventListener('submit', function(){ setBusy(true); showMsg('Accediendo…'); });
      }
    })();
  </script>
  <!-- TPL: FIN BLOQUE NUEVO -->

  <!-- TPL: INICIO BLOQUE NUEVO [Lógica: login + Google + reset + redirección admin/panel] -->
  <script>
    (function(){
      const AUTH_FLAG = 'tplAuth';
      const params = new URLSearchParams(location.search);
      const NEXT = params.get('next'); // opcional

      // === Admin: si eres este correo → Panel
      const PANEL_URL = 'tpl-candidaturas-admin.html';
      const ADMIN_EMAILS = ['4b.jenny.gomez@gmail.com'];
      const ADMIN_SET = new Set(ADMIN_EMAILS.map(x =>
        String(x).trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'')
      ));
      function isAdminEmail(email){
        const norm = String(email||'').trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
        return ADMIN_SET.has(norm);
      }

      const $ = (s, p=document)=>p.querySelector(s);
      const form = $('#formAuth');
      const email = $('#email');
      const pass  = $('#password');
      const btnForgot = $('#btnForgot');
      const btnGoogle = $('#btnGoogle');
      const btnSignup = $('#btnSignup');
      const btnLogin = $('#btnLogin');
      const msg = $('#msg');

      // Propagar ?next= y default desde Trabaja con nosotros
      function setSignupHref(){
        var target = 'registro.html';
        if (NEXT) {
          target += '?next=' + encodeURIComponent(NEXT);
        } else if (document.referrer && /trabaja-con-nosotros\.html/i.test(document.referrer)) {
          target += '?next=cuestionario-candidatos.html';
        }
        if (btnSignup) btnSignup.setAttribute('href', target);
      }

      // Resolver URL del perfil (fallbacks)
      const PROFILE_URL_LS = 'tpl_profile_url_cache';
      async function resolveProfileUrl(){
        try{ const c = localStorage.getItem(PROFILE_URL_LS); if (c) return c; }catch(e){}
        const candidates = ['mi-perfil.html','mi-cuenta.html','perfil.html'];
        for (let p of candidates){
          try{
            let r = await fetch(p, { method:'HEAD', cache:'no-store' });
            if (!r || !r.ok){ r = await fetch(p, { method:'GET', cache:'no-store' }); }
            if (r && r.ok){ try{ localStorage.setItem(PROFILE_URL_LS, p); }catch(e){} return p; }
          }catch(e){}
        }
        return 'mi-perfil.html';
      }

      async function safeGo(url){
        try{
          let r = await fetch(url, { method:'HEAD', cache:'no-store' });
          if (!r || !r.ok){ r = await fetch(url, { method:'GET', cache:'no-store' }); }
          if (r && r.ok){ location.href = url; return; }
        }catch(e){}
        location.href = await resolveProfileUrl();
      }

      function showMsg(t){ msg && (msg.textContent = t || ''); }
      function setBusy(b){
        try{
          btnLogin && (btnLogin.disabled = b);
          btnGoogle && (btnGoogle.disabled = b);
        }catch(e){}
      }
      function auth(){ return (typeof firebase!=='undefined' && firebase.auth) ? firebase.auth() : null; }

      // Decide destino por usuario
      async function nextUrlFor(user){
        if (user && isAdminEmail(user.email)) return PANEL_URL;   // admin ⇒ panel
        if (NEXT) return NEXT;                                    // respeta ?next=
        return await resolveProfileUrl();                         // resto ⇒ perfil
      }

      document.addEventListener('DOMContentLoaded', async function(){
        setSignupHref();

        // Si ya hay sesión, decide destino por correo
        const a = auth();
        const loggedUser = a && a.currentUser;
        const flag = localStorage.getItem(AUTH_FLAG)==='1';
        if (loggedUser || flag){
          await safeGo(await nextUrlFor(loggedUser));
        }
      });

      // Login email/contraseña
      form.addEventListener('submit', async function(e){
        e.preventDefault();
        const a = auth();
        if (!a){ showMsg('Servicio de autenticación no disponible.'); setBusy(false); return; }
        const em = (email.value||'').trim();
        const pw = pass.value;
        try{
          showMsg('Accediendo…'); setBusy(true);
          const cred = await a.signInWithEmailAndPassword(em, pw);
          try{ localStorage.setItem(AUTH_FLAG,'1'); }catch(e){}
          showMsg('¡Listo! Redirigiendo…');
          await safeGo(await nextUrlFor(cred && cred.user));
        }catch(err){
          let m = (err && err.code) ? err.code : (err && err.message) || 'Error';
          if (/auth\/invalid-credential|auth\/wrong-password/.test(m)) m = 'Credenciales no válidas. Revisa tu email y contraseña.';
          if (/auth\/user-not-found/.test(m)) m = 'No existe una cuenta con ese email.';
          showMsg(m); setBusy(false);
        }
      });

      // Reset password
      btnForgot.addEventListener('click', async function(){
        const a = auth();
        if (!a){ showMsg('Servicio de autenticación no disponible.'); return; }
        const em = (email.value||'').trim();
        if (!em){ showMsg('Escribe tu email arriba y vuelve a pulsar.'); return; }
        try{
          showMsg('Enviando enlace de restablecimiento…');
          await a.sendPasswordResetEmail(em);
          showMsg('Revisa tu correo para restablecer la contraseña.');
        }catch(e){
          showMsg('No se pudo enviar el email. Revisa el correo indicado.');
        }
      });

      // Google (popup + fallback redirect en iOS/Safari) ⇒ decide destino por correo
      btnGoogle.addEventListener('click', async function(){
        const a = auth();
        if (!a){ showMsg('Servicio de autenticación no disponible.'); return; }
        const provider = new firebase.auth.GoogleAuthProvider();
        showMsg('Conectando con Google…'); setBusy(true);
        try{
          const isIOS = /iP(ad|hone|od)/i.test(navigator.userAgent);
          const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
          let userCred;
          if (isIOS && isSafari) { await a.signInWithRedirect(provider); return; }
          else { userCred = await a.signInWithPopup(provider); }
          try{ localStorage.setItem(AUTH_FLAG,'1'); }catch(e){}
          const user = (userCred && userCred.user) || (a && a.currentUser);
          await safeGo(await nextUrlFor(user));
        }catch(err){
          let m = (err && err.message) || 'No se pudo iniciar con Google.';
          if (/popup-closed-by-user/i.test(m)) m = 'Has cerrado la ventana de Google.';
          showMsg(m); setBusy(false);
        }
      });

      // Si volvemos de redirect (iOS/Safari)
      (async function handleRedirect(){
        try{
          const a = auth(); if (!a) return;
          const res = await a.getRedirectResult();
          if (res && res.user){
            try{ localStorage.setItem(AUTH_FLAG,'1'); }catch(e){}
            await safeGo(await nextUrlFor(res.user));
          }
        }catch(e){}
      })();

      // Sincroniza flag para el navbar entre pestañas
      try{
        const a = auth();
        if (a) {
          a.onAuthStateChanged(function(user){
            try{
              if (user) localStorage.setItem(AUTH_FLAG,'1');
              else localStorage.removeItem(AUTH_FLAG);
            }catch(e){}
          });
        }
      }catch(e){}
    })();
  </script>
  <!-- TPL: FIN BLOQUE NUEVO -->
</body>
</html>
