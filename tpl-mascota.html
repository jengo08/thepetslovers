/* TPL: INICIO BLOQUE NUEVO [Estado mínimo del perfil + lectura temporal de mascotas] */
(function(){
  'use strict';

  // Helpers de DOM
  const $ = (sel) => document.querySelector(sel);
  const show = (el) => { if (el) el.hidden = false; };
  const hide = (el) => { if (el) el.hidden = true; };
  const setText = (sel, txt) => { const el = $(sel); if (el) el.textContent = txt; };

  document.addEventListener('DOMContentLoaded', () => {
    // ------- OWNER -------
    setOwnerIncomplete();

    // ------- PETS -------
    setPetsEmpty();

    /* TPL: INICIO BLOQUE NUEVO [Cargar mascotas desde sessionStorage] */
    try{
      const saved = JSON.parse(sessionStorage.getItem('tpl.pets') || '[]');
      if (Array.isArray(saved) && saved.length){
        renderPets(saved);
      }
    }catch(e){ /* noop */ }
    /* TPL: FIN BLOQUE NUEVO */

    // ------- BOOKINGS -------
    setBookingsEmpty();
  });

  function setOwnerIncomplete(){
    setText('#tpl-owner-nombre', '—');
    setText('#tpl-owner-telefono', '—');
    setText('#tpl-owner-zona', '—');
    setText('#tpl-owner-email', '—');

    const status = $('#tpl-owner-status');
    if (status){
      status.innerHTML = '<i class="fa-solid fa-circle-exclamation"></i> Incompleto';
    }
    const fill = $('#tpl-owner-fill'); const edit = $('#tpl-owner-edit');
    if (fill) fill.style.display = '';
    if (edit) edit.style.display = 'none';
  }

  function setOwnerComplete(mock){
    setText('#tpl-owner-nombre', mock?.nombre || 'Tu nombre');
    setText('#tpl-owner-telefono', mock?.telefono || '—');
    setText('#tpl-owner-zona', mock?.zona || '—');
    setText('#tpl-owner-email', mock?.email || '—');

    const status = $('#tpl-owner-status');
    if (status){
      status.innerHTML = '<i class="fa-solid fa-circle-check"></i> Completo';
    }
    const fill = $('#tpl-owner-fill'); const edit = $('#tpl-owner-edit');
    if (fill) fill.style.display = 'none';
    if (edit) edit.style.display = '';
  }

  function setPetsEmpty(){
    const empty = $('#tpl-pets-empty');
    const list  = $('#tpl-pets-list');
    $('#tpl-pets-status').innerHTML = '<i class="fa-solid fa-circle-exclamation"></i> Ninguna';
    if (empty) empty.style.display = 'flex';
    hide(list);
  }

  function renderPets(pets){
    const empty = $('#tpl-pets-empty');
    const list  = $('#tpl-pets-list');
    if (!Array.isArray(pets) || pets.length === 0) return setPetsEmpty();

    if (empty) empty.style.display = 'none';
    if (list){
      list.innerHTML = '';
      pets.forEach(p => {
        const item = document.createElement('div');
        item.className = 'tpl-pet-item';
        item.innerHTML = `
          <img class="tpl-pet-thumb" alt="Foto de ${escapeHtml(p.nombre||'mascota')}" src="${escapeAttr(p.foto||'images/pet-placeholder.png')}">
          <div>
            <div><strong>${escapeHtml(p.nombre||'Sin nombre')}</strong> · ${escapeHtml(p.especie||'')}</div>
            <div style="color:#666;font-size:.9rem">${escapeHtml(p.raza || p.tipoExotico || '')} ${p.edad ? ('· ' + escapeHtml(p.edad)) : ''}</div>
          </div>
        `;
        list.appendChild(item);
      });
      show(list);
      $('#tpl-pets-status').innerHTML = `<i class="fa-solid fa-paw"></i> ${pets.length} ${pets.length===1?'mascota':'mascotas'}`;
    }
  }

  function setBookingsEmpty(){
    $('#tpl-bookings-status').innerHTML = '<i class="fa-regular fa-circle"></i> Sin reservas';
    show($('#tpl-bookings-empty'));
    hide($('#tpl-bookings-list'));
  }

  // Utilidades de escape
  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function escapeAttr(s){ return escapeHtml(s).replace(/"/g, '&quot;'); }

  // Exponer helpers (por si los usamos luego)
  window.__TPL_PERFIL__ = {
    setOwnerComplete,
    renderPets
  };
})();
/* TPL: FIN BLOQUE NUEVO */
