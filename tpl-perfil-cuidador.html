<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Perfil de cuidador · The Pets Lovers</title>
<meta name="robots" content="noindex,nofollow">
<link rel="stylesheet" href="style.css">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Poppins:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<style>
  :root{ --tpl-primary:#339496; --tpl-ink:#58425a; }
  .page{ padding-top:120px }
  .tpl-wrap{ max-width:1100px; margin:0 auto 60px; display:grid; gap:16px; grid-template-columns: 1fr; }
  @media (min-width: 980px){ .tpl-wrap{ grid-template-columns: 420px 1fr; } }
  .tpl-card{ background:#fff; border:1px solid #eee; border-radius:12px; box-shadow:0 2px 12px rgba(0,0,0,.05); padding:16px; }
  .title{ margin:0 0 10px }
  .muted{ color:#666 }
  .pill{ display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #d7efef; color:#339496; background:#f5fbfb; font-size:.85rem }
  .btn{ background:#339496; color:#fff; border-radius:999px; padding:8px 12px; text-decoration:none; border:2px solid transparent; display:inline-block; font-weight:700; cursor:pointer }
  .btn.sec{ background:#fff; color:#339496; border-color:#339496 }
  .btn.sm{ padding:6px 10px; font-size:.92rem }
  .kv{ margin:6px 0 } .kv strong{ color:var(--tpl-ink) }
  .row{ display:grid; grid-template-columns: 1fr 1fr; gap:8px }
  /* Calendario */
  .cal-head{ display:flex; justify-content:space-between; align-items:center; margin-bottom:8px }
  .cal-grid{ display:grid; grid-template-columns: repeat(7, 1fr); border:1px solid #eee; border-radius:10px; overflow:hidden }
  .cal-grid .hd{ background:#f9f9f9; font-weight:700; padding:8px; text-align:center; border-right:1px solid #eee }
  .cal-grid .hd:nth-child(7){ border-right:none }
  .day{ min-height:90px; border-right:1px solid #eee; border-top:1px solid #eee; padding:6px; position:relative }
  .day:nth-child(7n){ border-right:none }
  .day .d{ font-weight:700; color:#444; margin-bottom:4px }
  .slot{ font-size:.85rem; padding:4px 6px; border-radius:6px; margin:2px 0; background:#eef7f7; border:1px solid #d7efef }
  .slot.busy{ background:#fff2f2; border-color:#ffd4d4 }
  /* Modal */
  .modal{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; padding:16px }
  .modal .box{ background:#fff; max-width:520px; width:100%; border-radius:12px; padding:16px }
  .modal .grid{ display:grid; gap:8px; grid-template-columns: 1fr 1fr }
  .modal label{ font-weight:700; color:#58425a; font-size:.95rem }
  .modal input,.modal select,.modal textarea{ border:1px solid #ddd; border-radius:10px; padding:8px; font:inherit }
  .toggle{ display:inline-flex; align-items:center; gap:6px; margin-right:12px; }
</style>
</head>
<body>
<main class="page">
  <div class="tpl-wrap">
    <!-- FICHA -->
    <section class="tpl-card">
      <h1 class="title">Perfil de cuidador</h1>
      <div id="tpl-info" class="muted">Cargando…</div>
      <div id="tpl-kv"></div>
      <div style="margin-top:10px">
        <label class="toggle"><input type="checkbox" id="esp-perro" checked> Perro</label>
        <label class="toggle"><input type="checkbox" id="esp-gato" checked> Gato</label>
        <label class="toggle"><input type="checkbox" id="esp-exotico"> Exótico</label>
        <button id="tpl-save-especies" class="btn sec sm">Guardar especies</button>
      </div>
      <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap">
        <button id="tpl-refresh" class="btn sec sm">Recargar</button>
      </div>
    </section>

    <!-- CALENDARIO -->
    <section class="tpl-card">
      <div class="cal-head">
        <button class="btn sec sm" id="tpl-prev">←</button>
        <div><strong id="tpl-month"></strong></div>
        <button class="btn sec sm" id="tpl-next">→</button>
      </div>
      <div style="margin:6px 0"><span class="pill">Doble clic en un día para añadir bloque</span></div>
      <div id="tpl-cal" class="cal-grid" role="grid" aria-label="Calendario"></div>
    </section>
  </div>
</main>

<script src="tpl-navbar.js" defer></script>
<script src="tpl-footer.js" defer></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

<div id="tpl-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="tpl-modal-title">
  <div class="box">
    <h3 id="tpl-modal-title" style="margin-top:0">Nuevo bloque</h3>
    <div class="grid">
      <div><label>Fecha</label><input type="date" id="tpl-date"></div>
      <div><label>Tipo</label><select id="tpl-type"><option value="free">Disponibilidad</option><option value="busy">Ocupado/Reserva</option></select></div>
      <div><label>Inicio</label><input type="time" id="tpl-start" value="09:00"></div>
      <div><label>Fin</label><input type="time" id="tpl-end" value="18:00"></div>
      <div class="grid" style="grid-column:1 / -1"><label>Reserva/Cliente (opcional)</label><input type="text" id="tpl-reserva" placeholder="reservaId o nombre"></div>
      <div class="grid" style="grid-column:1 / -1"><label>Notas</label><textarea id="tpl-notes" rows="2" placeholder="Interno"></textarea></div>
    </div>
    <div style="margin-top:10px; display:flex; gap:8px; justify-content:flex-end">
      <button class="btn sec" id="tpl-cancel">Cancelar</button>
      <button class="btn" id="tpl-save">Guardar</button>
    </div>
  </div>
</div>

<script>
(function(){
  if (!firebase.apps.length){
    const firebaseConfig = {
      apiKey: "AIzaSyDW73aFuz2AFS9VeWg_linHIRJYN4YMgTk",
      authDomain: "thepetslovers-c1111.firebaseapp.com",
      projectId: "thepetslovers-c1111",
      storageBucket: "thepetslovers-c1111.appspot.com",
      messagingSenderId: "415914577533",
      appId: "1:415914577533:web:0b7a056ebaa4f1de28ab14",
      measurementId: "G-FXPD69KXBG"
    };
    firebase.initializeApp(firebaseConfig);
  }
  const db = firebase.firestore();
  const cuid = new URLSearchParams(location.search).get('id');
  const info = document.getElementById('tpl-info');
  const kv = document.getElementById('tpl-kv');

  if(!cuid){ info.textContent='Falta ?id='; return; }
  function esc(s){ return String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]); }

  const chkPerro = document.getElementById('esp-perro');
  const chkGato = document.getElementById('esp-gato');
  const chkExo = document.getElementById('esp-exotico');

  async function loadInfo(){
    const d = await db.collection('cuidadores').doc(cuid).get();
    if (!d.exists){ info.textContent='No existe este cuidador.'; return; }
    const c = d.data();
    info.innerHTML = `<strong>${esc(c.nombre||'-')}</strong> · <span class="pill">${esc(c.zona||c.ciudad||'-')}</span>`;
    kv.innerHTML = `
      <div class="kv"><strong>Email:</strong> ${esc(c.email||'-')}</div>
      <div class="kv"><strong>Tel.:</strong> ${esc(c.telefono||'-')}</div>
      <div class="kv"><strong>Ciudad/CP:</strong> ${esc(c.ciudad||'-')} ${c.cp?('('+esc(c.cp)+')'):''}</div>
      <div class="kv"><strong>Disponibilidad:</strong> ${esc(c.disponibilidad||'-')}</div>
      <div class="kv"><strong>Zonas:</strong> ${esc(c.zonasCobertura||'-')}</div>
      <div class="kv"><strong>ATV:</strong> ${esc(c.atvTitulado||'-')}</div>
      <div class="kv"><strong>Formación:</strong> ${esc(c.otrasFormaciones||'-')}</div>
    `;
    chkPerro.checked = c.especiePerro !== false;
    chkGato.checked = c.especieGato !== false;
    chkExo.checked = c.especieExotico === true;
  }

  document.getElementById('tpl-save-especies').addEventListener('click', async ()=>{
    await db.collection('cuidadores').doc(cuid).update({
      especiePerro: !!chkPerro.checked,
      especieGato: !!chkGato.checked,
      especieExotico: !!chkExo.checked
    });
    alert('Especies guardadas.');
  });

  // Calendario
  const monthEl = document.getElementById('tpl-month');
  const grid = document.getElementById('tpl-cal');
  const prevBtn = document.getElementById('tpl-prev');
  const nextBtn = document.getElementById('tpl-next');
  const modal = document.getElementById('tpl-modal');
  const mDate = document.getElementById('tpl-date');
  const mType = document.getElementById('tpl-type');
  const mStart= document.getElementById('tpl-start');
  const mEnd  = document.getElementById('tpl-end');
  const mReserva = document.getElementById('tpl-reserva');
  const mNotes = document.getElementById('tpl-notes');
  const mCancel= document.getElementById('tpl-cancel');
  const mSave  = document.getElementById('tpl-save');

  let cur = new Date(); cur.setDate(1);
  let slots = [];

  function isoDate(d){ return d.toISOString().slice(0,10); }
  function openModal(dateStr){ modal.style.display='flex'; mDate.value=dateStr||isoDate(new Date()); mType.value='free'; mStart.value='09:00'; mEnd.value='18:00'; mReserva.value=''; mNotes.value=''; }
  function closeModal(){ modal.style.display='none'; }
  mCancel.addEventListener('click', closeModal);
  modal.addEventListener('click', e=>{ if(e.target===modal) closeModal(); });

  async function saveSlot(){
    if(!mDate.value) return alert('Fecha requerida');
    const doc = { date:mDate.value, type:mType.value, start:mStart.value, end:mEnd.value, reservaId:mReserva.value||'', notes:mNotes.value||'', createdAt: firebase.firestore.FieldValue.serverTimestamp() };
    await db.collection('cuidadores').doc(cuid).collection('agenda').add(doc);
    await loadMonth(); closeModal();
  }
  mSave.addEventListener('click', saveSlot);

  function renderCal(){
    const y=cur.getFullYear(), m=cur.getMonth();
    const monthName = new Date(y,m,1).toLocaleDateString('es-ES',{month:'long', year:'numeric'});
    monthEl.textContent = monthName[0].toUpperCase()+monthName.slice(1);
    const daysHd = ['L','M','X','J','V','S','D'].map(d=>`<div class="hd">${d}</div>`).join('');
    const firstDow = (new Date(y,m,1).getDay()+6)%7;
    const blanks = Array.from({length:firstDow}).map(()=>'<div class="day"></div>').join('');
    const total = new Date(y,m+1,0).getDate();
    const cells = [];
    for(let d=1; d<=total; d++){
      const dt = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      const daySlots = slots.filter(s=>s.date===dt);
      const htmlSlots = daySlots.map(s=>`<div class="slot ${s.type==='busy'?'busy':''}">${s.start||''}-${s.end||''} ${s.reservaId?`· <span class="muted">${s.reservaId}</span>`:''}</div>`).join('');
      cells.push(`<div class="day" data-date="${dt}"><div class="d">${d}</div>${htmlSlots||''}</div>`);
    }
    grid.innerHTML = daysHd + blanks + cells.join('');
    grid.querySelectorAll('.day').forEach(cell=> cell.addEventListener('dblclick', ()=> openModal(cell.getAttribute('data-date'))));
  }

  async function loadMonth(){
    const first = new Date(cur.getFullYear(), cur.getMonth(), 1);
    const last  = new Date(cur.getFullYear(), cur.getMonth()+1, 0);
    const startStr = isoDate(first), endStr=isoDate(last);
    const snap = await db.collection('cuidadores').doc(cuid).collection('agenda').where('date','>=',startStr).where('date','<=',endStr).orderBy('date','asc').get();
    slots = snap.docs.map(d=>({ id:d.id, ...d.data() }));
    renderCal();
  }

  document.getElementById('tpl-prev').addEventListener('click', async ()=>{ cur = new Date(cur.getFullYear(), cur.getMonth()-1, 1); await loadMonth(); });
  document.getElementById('tpl-next').addEventListener('click', async ()=>{ cur = new Date(cur.getFullYear(), cur.getMonth()+1, 1); await loadMonth(); });
  document.getElementById('tpl-refresh').addEventListener('click', async ()=>{ await loadInfo(); await loadMonth(); });

  (async function boot(){ await loadInfo(); await loadMonth(); })();
})();
</script>
</body>
</html>
