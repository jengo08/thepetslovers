<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reg√≠strate ¬∑ The Pets Lovers</title>
  <meta name="description" content="Crea tu cuenta con email y contrase√±a o con Google. Completa tu perfil y el de tu mascota m√°s tarde.">

  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Poppins:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <!-- TPL: INICIO BLOQUE NUEVO [Estilos m√≠nimos de registro + perfil] -->
  <style>
    :root { --tpl-primary:#339496; --tpl-ink:#58425a; }
    .auth-wrap{ max-width:560px; margin:120px auto 64px; padding:0 16px; }
    .auth-card{ background:#fff; border:1px solid #eee; border-radius:14px; box-shadow:0 2px 12px rgba(0,0,0,.06); padding:18px; }
    .auth-title{ margin:0 0 6px; color:var(--tpl-ink); }
    .auth-sub{ margin:0 0 14px; color:#666; }
    .auth-form{ display:grid; gap:10px; }
    .auth-form label{ font-size:.92rem; color:var(--tpl-ink); }
    .auth-form input, .auth-form textarea, .auth-form select{
      border:1px solid #ddd; border-radius:10px; padding:11px 12px; font-size:1rem; width:100%;
    }
    .btn{ background:#339496; color:#fff; border:none; border-radius:999px; padding:11px 16px; cursor:pointer; font-weight:700; width:100%; }
    .btn[disabled]{ opacity:.7; cursor:not-allowed; }
    .btn-google{ display:flex; align-items:center; justify-content:center; gap:8px; border:1px solid #ddd; border-radius:999px; padding:11px 16px; background:#fff; cursor:pointer; font-weight:700; width:100%; color:var(--tpl-primary); }
    .row-actions{ display:grid; gap:10px; margin-top:10px; }
    .link{ background:none; border:none; color:#339496; text-decoration:underline; cursor:pointer; padding:6px 0; font-weight:600; }
    .sep{ position:relative; text-align:center; margin:10px 0 4px; color:#999; font-size:.9rem; }
    .sep::before{ content:""; position:absolute; left:0; right:0; top:50%; height:1px; background:#eee; }
    .sep span{ background:#fff; padding:0 8px; position:relative; z-index:1; }
    .auth-msg{ min-height:1.2em; color:var(--tpl-ink); text-align:center; margin-top:6px; }

    /* TPL: INICIO BLOQUE NUEVO [Tarjeta perfil propietario] */
    .profile-card{ margin-top:16px; }
    .row-2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media (max-width:560px){ .row-2{ grid-template-columns:1fr; } }
    .hint{ color:#666; font-size:.9rem; margin-top:6px; }
    /* TPL: FIN BLOQUE NUEVO */
  </style>
  <!-- TPL: FIN BLOQUE NUEVO -->
</head>
<body>

  <!-- Navbar centralizada -->
  <div id="tpl-navbar"></div>
  <script src="tpl-navbar.js" defer></script>

  <main class="auth-wrap container">
    <!-- ========= Tarjeta REGISTRO ========= -->
    <section id="card-signup" class="auth-card" aria-label="Registro">
      <h1 class="auth-title">Reg√≠strate</h1>
      <p class="auth-sub">Crea tu cuenta con tu correo. Podr√°s completar tu perfil y el de tu mascota m√°s tarde.</p>

      <!-- Formulario: email + contrase√±a + bot√≥n √∫nico -->
      <form id="formSignup" class="auth-form" novalidate>
        <div>
          <label for="email">Email</label>
          <input id="email" name="email" type="email" required autocomplete="email" />
        </div>
        <div>
          <label for="password">Contrase√±a</label>
          <input id="password" name="password" type="password" required autocomplete="new-password" />
        </div>
        <button id="btnSignup" class="btn" type="submit">Reg√≠strate</button>
        <p id="msg" class="auth-msg" aria-live="polite"></p>
      </form>

      <div class="sep"><span>o</span></div>
      <div class="row-actions">
        <button id="btnGoogle" class="btn-google" type="button"><i class="fa-brands fa-google"></i> Continuar con Google</button>
        <a class="link" href="iniciar-sesion.html">¬øYa tienes cuenta? Inicia sesi√≥n</a>
      </div>
    </section>

    <!-- ========= Tarjeta PERFIL (solo visible si se fuerza edici√≥n o hay sesi√≥n) ========= -->
    <!-- TPL: INICIO BLOQUE NUEVO [Perfil del propietario] -->
    <section id="card-profile" class="auth-card profile-card" aria-label="Perfil del propietario" hidden>
      <h2 class="auth-title">Perfil del propietario</h2>
      <p class="auth-sub">Completa estos datos para poder realizar reservas.</p>

      <form id="formProfile" class="auth-form" novalidate>
        <div class="row-2">
          <div>
            <label for="pNombre">Nombre y apellidos</label>
            <input id="pNombre" name="nombre" type="text" required autocomplete="name" />
          </div>
          <div>
            <label for="pTelefono">Tel√©fono</label>
            <input id="pTelefono" name="telefono" type="tel" required autocomplete="tel" />
          </div>
        </div>

        <div>
          <label for="pEmail">Email</label>
          <input id="pEmail" name="email" type="email" required autocomplete="email" disabled />
        </div>

        <div>
          <label for="pDireccion">Direcci√≥n</label>
          <input id="pDireccion" name="direccion" type="text" autocomplete="street-address" />
        </div>

        <div class="row-2">
          <div>
            <label for="pCP">C√≥digo postal</label>
            <input id="pCP" name="cp" type="text" inputmode="numeric" pattern="[0-9]{4,5}" required />
          </div>
          <div>
            <label for="pPref">Preferencias / notas</label>
            <input id="pPref" name="preferencias" type="text" />
          </div>
        </div>

        <button id="btnSaveProfile" class="btn" type="submit">Guardar perfil</button>
        <p id="msgProfile" class="auth-msg" aria-live="polite"></p>
        <p class="hint">* Todos nuestros cuidadores son <strong>auxiliares veterinarios titulados</strong>.</p>
      </form>
    </section>
    <!-- TPL: FIN BLOQUE NUEVO -->
  </main>

  <!-- Footer centralizado -->
  <div id="tpl-footer"></div>
  <script src="tpl-footer.js" defer></script>

  <!-- Firebase compat SDKs + init (tu mismo proyecto) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <!-- TPL: INICIO BLOQUE NUEVO [Firestore para guardar perfil] -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
  <!-- TPL: FIN BLOQUE NUEVO -->
  <script>
    /* TPL: INICIO BLOQUE NUEVO [Init seguro Firebase] */
    (function(){
      const firebaseConfig = {
        apiKey: "AIzaSyDW73aFuz2AFS9VeWg_linHIRJYN4YMgTk",
        authDomain: "thepetslovers-c1111.firebaseapp.com",
        projectId: "thepetslovers-c1111",
        storageBucket: "thepetslovers-c1111.appspot.com",
        messagingSenderId: "415914577533",
        appId: "1:415914577533:web:0b7a056ebaa4f1de28ab14",
        measurementId: "G-FXPD69KXBG"
      };
      if (typeof firebase !== 'undefined' && firebase.apps.length === 0) {
        firebase.initializeApp(firebaseConfig);
      }
      window.__TPL_AUTH_INIT = true;
    })();
    /* TPL: FIN BLOQUE NUEVO */
  </script>

  <!-- TPL: INICIO BLOQUE NUEVO [L√≥gica registro + Google + redirecci√≥n + edici√≥n perfil] -->
  <script>
    (function(){
      const AUTH_FLAG = 'tplAuth';
      const PROFILE_URL_LS = 'tpl_profile_url_cache';
      const params = new URLSearchParams(location.search);
      const NEXT = params.get('next'); // opcional
      // üëâ Fuerza modo edici√≥n de perfil si next=perfil.html, o ?edit=profile / ?profile=1
      const FORCE_PROFILE = /perfil\.html$/i.test(String(NEXT||'')) ||
                            params.get('edit') === 'profile' ||
                            params.get('profile') === '1';

      // üëâ Admin ‚Üí Panel (mismo criterio que navbar)
      const PANEL_URL = 'tpl-candidaturas-admin.html';
      const ADMIN_EMAILS = ['4b.jenny.gomez@gmail.com'];
      const ADMIN_SET = new Set(ADMIN_EMAILS.map(x =>
        String(x).trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'')
      ));
      function isAdminEmail(email){
        const norm = String(email||'').trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
        return ADMIN_SET.has(norm);
      }

      // ====== Refs ======
      const $ = (s, p=document)=>p.querySelector(s);
      const cardSignup  = $('#card-signup');
      const form        = $('#formSignup');
      const email       = $('#email');
      const pass        = $('#password');
      const btnGoogle   = $('#btnGoogle');
      const msg         = $('#msg');

      // Perfil
      const cardProfile = $('#card-profile');
      const formProfile = $('#formProfile');
      const pNombre = $('#pNombre');
      const pTelefono = $('#pTelefono');
      const pEmail = $('#pEmail');
      const pDireccion = $('#pDireccion');
      const pCP = $('#pCP');
      const pPref = $('#pPref');
      const msgProfile = $('#msgProfile');
      const btnSaveProfile = $('#btnSaveProfile');

      // ====== Utils ======
      function show(el){ if(el){ el.hidden=false; el.style.display=''; } }
      function hide(el){ if(el){ el.hidden=true; el.style.display='none'; } }
      function showMsg(t){ msg.textContent = t || ''; }
      function showMsgProfile(t){ msgProfile.textContent = t || ''; }
      function auth(){ return (typeof firebase!=='undefined' && firebase.auth) ? firebase.auth() : null; }
      function db(){ return (typeof firebase!=='undefined' && firebase.firestore) ? firebase.firestore() : null; }

      // üîÑ Sincroniza flags para que la navbar cambie en TODAS las p√°ginas
      function syncNavbarFlags(u){
        try{
          if (u) {
            localStorage.setItem(AUTH_FLAG,'1');
            if (u.email) localStorage.setItem('tplEmail', String(u.email));
          } else {
            localStorage.removeItem(AUTH_FLAG);
            localStorage.removeItem('tplEmail');
          }
        }catch(e){}
      }

      // Resuelve el archivo de perfil existente (mi-perfil.html / mi-cuenta.html / perfil.html)
      async function resolveProfileUrl(){
        try{ const c = localStorage.getItem(PROFILE_URL_LS); if (c) return c; }catch(e){}
        const candidates = ['mi-perfil.html','mi-cuenta.html','perfil.html'];
        for (let p of candidates){
          try{
            let r = await fetch(p, { method:'HEAD', cache:'no-store' });
            if (!r || !r.ok){ r = await fetch(p, { method:'GET', cache:'no-store' }); }
            if (r && r.ok){ try{ localStorage.setItem(PROFILE_URL_LS, p); }catch(e){} return p; }
          }catch(e){}
        }
        return 'perfil.html';
      }

      // Decide destino por usuario
      async function nextUrlFor(user){
        if (user && isAdminEmail(user.email)) return PANEL_URL;
        if (NEXT && !FORCE_PROFILE) return NEXT;
        return await resolveProfileUrl();
      }

      // Comprueba que existe; si no, cae al perfil
      async function safeGo(url){
        try{
          let r = await fetch(url, { method:'HEAD', cache:'no-store' });
          if (!r || !r.ok){ r = await fetch(url, { method:'GET', cache:'no-store' }); }
          if (r && r.ok){ location.href = url; return; }
        }catch(e){}
        location.href = await resolveProfileUrl();
      }

      // ====== PERFIL: carga/guarda ======
      async function loadProfile(uid){
        try{
          const ref = db().collection('users').doc(uid).collection('private').doc('profile');
          const snap = await ref.get();
          return snap.exists ? snap.data() : null;
        }catch(e){ return null; }
      }

      async function saveProfile(uid, data){
        const now = new Date();
        const ref = db().collection('users').doc(uid).collection('private').doc('profile');
        await ref.set({ ...data, updatedAt: now, source: 'registro.html' }, { merge:true });

        // (Opcional) Mirror a owners para el recuento admin: cambia a true si lo quieres activo
        const MIRROR_OWNERS = false; // <-- ponlo a true si quieres crear/actualizar owners/{uid}
        if (MIRROR_OWNERS){
          const oref = db().collection('owners').doc(uid);
          await oref.set({
            nombre: data.nombre || '',
            email: data.email || '',
            telefono: data.telefono || '',
            cp: data.cp || '',
            createdAt: now,
            updatedAt: now
          }, { merge:true });
        }
      }

      function prefillProfile(u, profile){
        try{
          pEmail.value = u?.email || profile?.email || '';
          if (profile){
            if (profile.nombre)    pNombre.value    = profile.nombre;
            if (profile.telefono)  pTelefono.value  = profile.telefono;
            if (profile.direccion) pDireccion.value = profile.direccion;
            if (profile.cp)        pCP.value        = profile.cp;
            if (profile.preferencias) pPref.value   = profile.preferencias;
          }
        }catch(_){}
      }

      function validateProfile(){
        if (!pNombre.value.trim()) return 'El nombre es obligatorio.';
        if (!pTelefono.value.trim()) return 'El tel√©fono es obligatorio.';
        if (!pCP.value.trim()) return 'El c√≥digo postal es obligatorio.';
        return '';
      }

      function enterProfileMode(){
        hide(cardSignup);
        show(cardProfile);
        try{ document.title = 'Perfil del propietario ¬∑ The Pets Lovers'; }catch(_){}
        setTimeout(()=>{ cardProfile.scrollIntoView({behavior:'smooth', block:'start'}); }, 50);
      }

      function profileCompletedFlag(){
        try{ localStorage.setItem('tplProfileComplete','1'); }catch(_){}
      }

      // ====== Eventos ======
      // üö™ Si ya hay sesi√≥n activa: solo redirige si NO vienes a editar perfil.
      document.addEventListener('DOMContentLoaded', async function(){
        const a = auth();
        const u = a && a.currentUser;
        const flag = localStorage.getItem(AUTH_FLAG)==='1';

        if ((u || flag) && !FORCE_PROFILE){
          await safeGo(await nextUrlFor(u));
        }

        // Si venimos a editar perfil, mostramos la tarjeta perfil cuando el user est√© listo
        if (FORCE_PROFILE && a){
          a.onAuthStateChanged(async (user)=>{
            if (user && !user.isAnonymous){
              syncNavbarFlags(user);
              enterProfileMode();
              prefillProfile(user, await loadProfile(user.uid));
            }
          });
        }
      });

      // üßæ Registro email/contrase√±a
      form.addEventListener('submit', async function(e){
        e.preventDefault();
        const a = auth();
        if (!a){ showMsg('Servicio de autenticaci√≥n no disponible.'); return; }
        const em = (email.value||'').trim();
        const pw = pass.value;
        try{
          const cred = await a.createUserWithEmailAndPassword(em, pw);
          const u = cred && cred.user;
          syncNavbarFlags(u);

          if (FORCE_PROFILE){
            // Cambiamos a modo perfil, sin redirigir
            enterProfileMode();
            prefillProfile(u, null);
            showMsg('Cuenta creada. Completa tu perfil para continuar.');
          }else{
            await safeGo(await nextUrlFor(u));
          }
        }catch(err){
          let m = (err && err.code) ? err.code : (err && err.message) || 'Error';
          if (/auth\/email-already-in-use/.test(m)) m = 'Ese email ya est√° registrado. Inicia sesi√≥n.';
          if (/auth\/weak-password/.test(m)) m = 'La contrase√±a es demasiado d√©bil (m√≠nimo 6 caracteres).';
          if (/auth\/invalid-email/.test(m)) m = 'Email no v√°lido.';
          showMsg(m);
        }
      });

      // üü¶ Google (popup + fallback redirect en iOS/Safari)
      btnGoogle.addEventListener('click', async function(){
        const a = auth();
        if (!a){ showMsg('Servicio de autenticaci√≥n no disponible.'); return; }
        const provider = new firebase.auth.GoogleAuthProvider();
        try{
          const isIOS = /iP(ad|hone|od)/i.test(navigator.userAgent);
          const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
          let res;
          if (isIOS && isSafari) { await a.signInWithRedirect(provider); return; }
          else { res = await a.signInWithPopup(provider); }
          const u = (res && res.user) || (a && a.currentUser);
          syncNavbarFlags(u);

          if (FORCE_PROFILE){
            enterProfileMode();
            prefillProfile(u, await loadProfile(u.uid));
            showMsg('Sesi√≥n iniciada. Completa tu perfil para continuar.');
          }else{
            await safeGo(await nextUrlFor(u));
          }
        }catch(err){
          let m = (err && err.message) || 'No se pudo continuar con Google.';
          if (/popup-closed-by-user/i.test(m)) m = 'Has cerrado la ventana de Google.';
          showMsg(m);
        }
      });

      // üîÅ Volver del redirect (iOS/Safari)
      (async function handleRedirect(){
        try{
          const a = auth(); if (!a) return;
          const res = await a.getRedirectResult();
          if (res && res.user){
            syncNavbarFlags(res.user);
            if (FORCE_PROFILE){
              enterProfileMode();
              prefillProfile(res.user, await loadProfile(res.user.uid));
              showMsg('Sesi√≥n iniciada. Completa tu perfil para continuar.');
            }else{
              await safeGo(await nextUrlFor(res.user));
            }
          }
        }catch(e){}
      })();

      // üëÇ Adem√°s, si cambia el estado mientras estamos en esta p√°gina, sincroniza email/flag
      try{
        const a = auth();
        if (a) {
          a.onAuthStateChanged(function(user){
            syncNavbarFlags(user);
            // Si estamos en modo perfil y a√∫n no hemos precargado, hacemos prefill
            if (user && FORCE_PROFILE && cardProfile.hidden){
              enterProfileMode();
              loadProfile(user.uid).then(p => prefillProfile(user, p));
            }
          });
        }
      }catch(e){}

      // üìù Guardar perfil propietario
      formProfile.addEventListener('submit', async function(e){
        e.preventDefault();
        const a = auth();
        const u = a && a.currentUser;
        if (!u){ showMsgProfile('Inicia sesi√≥n para guardar tu perfil.'); return; }
        const err = validateProfile();
        if (err){ showMsgProfile(err); return; }

        const data = {
          nombre: pNombre.value.trim(),
          telefono: pTelefono.value.trim(),
          email: u.email || pEmail.value.trim(),
          direccion: pDireccion.value.trim(),
          cp: pCP.value.trim(),
          preferencias: pPref.value.trim()
        };

        try{
          btnSaveProfile.disabled = true;
          await saveProfile(u.uid, data);
          showMsgProfile('Perfil guardado correctamente.');
          profileCompletedFlag();

          // Redirecci√≥n amigable (por defecto a perfil.html)
          const go = await nextUrlFor(u); // si ven√≠as con next, lo respeta (salvo FORCE_PROFILE)
          setTimeout(()=>{ location.href = go; }, 700);
        }catch(err){
          showMsgProfile('No se pudo guardar el perfil. Int√©ntalo de nuevo.');
        }finally{
          btnSaveProfile.disabled = false;
        }
      });
    })();
  </script>
  <!-- TPL: FIN BLOQUE NUEVO -->
</body>
</html>
