<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Mi perfil · The Pets Lovers</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Poppins:wght@400;700&display=swap" rel="stylesheet">
  <!-- TPL: INICIO BLOQUE NUEVO [Iconos footer visibles en esta página] -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <!-- TPL: FIN BLOQUE NUEVO -->

  <style>
    .tpl-profile{ max-width:980px; margin:120px auto 60px; padding:20px; background:#fff; border:1px solid #eee; border-radius:12px; box-shadow:0 2px 12px rgba(0,0,0,.05);}
    .tpl-sub{ color:#666; margin-bottom:18px; }
    .tpl-cards{ display:grid; gap:12px; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); }
    .tpl-card{ border:1px solid #eee; border-radius:12px; padding:16px; position:relative; }
    .tpl-card h2{ font-size:18px; margin:0 0 8px; color:#58425a; }
    .tpl-actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .cta-button{ background:#339496; color:#fff; padding:10px 16px; border-radius:999px; border:none; cursor:pointer; font-weight:700; text-align:center; }
    .link{ background:#fff; color:#339496; border:2px solid #339496; }

    /* TPL: INICIO BLOQUE NUEVO [vistas compactas + badges] */
    .tpl-view{ background:#fafafa; border:1px solid #eee; border-radius:10px; padding:12px; }
    .tpl-view dl{ margin:0; display:grid; grid-template-columns: 140px 1fr; row-gap:6px; column-gap:10px; }
    .tpl-view dt{ font-weight:700; color:#58425a; }
    .tpl-empty{ color:#666; font-style:italic; }
    .tpl-list{ margin:0; padding-left:18px; }
    .tpl-list li{ margin:4px 0; }
    .tpl-status{ position:absolute; top:12px; right:12px; font-weight:700; font-size:.9rem; display:flex; align-items:center; gap:6px; color:#2a7e80; }
    .tpl-status i{ font-size:1rem; }
    .tpl-chip{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid #e7e7e7; border-radius:999px; background:#fff; font-weight:700; color:#58425a; }
    .tpl-pet-actions{ display:inline-flex; gap:6px; margin-left:8px; }
    .tpl-pet-actions .cta-button{ padding:6px 10px; }
    .tpl-hidden{ display:none !important; }
    /* TPL: FIN BLOQUE NUEVO */
  </style>
</head>
<body>
  <div id="tpl-navbar"></div>
  <script src="tpl-navbar.js" defer></script>

  <main class="tpl-profile" aria-labelledby="t">
    <h1 id="t">Mi perfil</h1>
    <p class="tpl-sub">Gestiona tus datos y los de tus mascotas. <strong>Profesionales del sector veterinario</strong> a tu lado.</p>

    <section class="tpl-cards">

      <!-- DATOS DE CLIENTE -->
      <article class="tpl-card" id="tpl-card-cliente">
        <!-- TPL: INICIO BLOQUE NUEVO [Badge perfil completo] -->
        <div id="tpl-cliente-status" class="tpl-status tpl-hidden" aria-hidden="true">
          <i class="fa-solid fa-circle-check"></i> Perfil completo
        </div>
        <!-- TPL: FIN BLOQUE NUEVO -->

        <h2>Datos de cliente</h2>
        <p id="tpl-cliente-empty" class="tpl-empty">Aún no has creado tu perfil. Usa el botón para rellenarlo.</p>

        <!-- TPL: INICIO BLOQUE NUEVO [Vista solo lectura de datos] -->
        <div id="tpl-cliente-view" class="tpl-view tpl-hidden" aria-live="polite">
          <dl>
            <dt>Nombre</dt><dd id="tpl-view-nombre">—</dd>
            <dt>Teléfono</dt><dd id="tpl-view-telefono">—</dd>
            <dt>Email</dt><dd id="tpl-view-email">—</dd>
            <dt>Dirección</dt><dd id="tpl-view-direccion">—</dd>
            <dt>Código postal</dt><dd id="tpl-view-cp">—</dd>
            <dt>Preferencias</dt><dd id="tpl-view-pref">—</dd>
          </dl>
        </div>
        <!-- TPL: FIN BLOQUE NUEVO -->

        <div class="tpl-actions">
          <!-- Botón que te gustaba: página externa de edición -->
          <a class="cta-button" id="tpl-btn-perfil" href="registro.html?next=perfil.html">Rellenar / Editar perfil</a>
        </div>
      </article>

      <!-- MASCOTAS -->
      <article class="tpl-card" id="tpl-card-mascotas">
        <h2>Mis mascotas</h2>
        <!-- TPL: INICIO BLOQUE NUEVO [Chip conteo] -->
        <div id="tpl-chip-mascotas" class="tpl-chip tpl-hidden" aria-hidden="true">
          <i class="fa-solid fa-paw"></i> <span id="tpl-count-mascotas">0</span>
        </div>
        <!-- TPL: FIN BLOQUE NUEVO -->

        <p id="tpl-mascotas-empty" class="tpl-empty">Aún no has añadido mascotas.</p>

        <!-- TPL: INICIO BLOQUE NUEVO [Lista compacta con Editar] -->
        <div id="tpl-mascotas-view" class="tpl-view tpl-hidden" aria-live="polite">
          <ul id="tpl-mascotas-list" class="tpl-list"></ul>
        </div>
        <!-- TPL: FIN BLOQUE NUEVO -->

        <div class="tpl-actions">
          <!-- Botón global a la página de gestión completa -->
          <a class="cta-button" id="tpl-btn-mascotas" href="perfil-mascotas.html">Gestionar mascotas</a>
          <!-- TPL: INICIO BLOQUE NUEVO [Añadir otra mascota directo] -->
          <a class="cta-button link" id="tpl-btn-mascota-nueva" href="perfil-mascotas.html?mode=new">Añadir otra mascota</a>
          <!-- TPL: FIN BLOQUE NUEVO -->
        </div>
      </article>

      <!-- RESERVAS -->
      <article class="tpl-card">
        <h2>Reservas</h2>
        <p>Cuando tu perfil esté completo podrás reservar.</p>
        <div class="tpl-actions">
          <a class="cta-button link" href="reserva.html">Ir a reservar</a>
        </div>
      </article>

      <!-- SESIÓN -->
      <article class="tpl-card">
        <h2>Sesión</h2>
        <p>Cierra tu sesión de forma segura.</p>
        <div class="tpl-actions">
          <!-- TPL: INICIO BLOQUE NUEVO [Cerrar sesión real] -->
          <button type="button" class="cta-button link" id="tpl-logout-btn">Cerrar sesión</button>
          <noscript><a class="cta-button link" href="index.html">Cerrar sesión (sin JS)</a></noscript>
          <!-- TPL: FIN BLOQUE NUEVO -->
        </div>
      </article>

    </section>
  </main>

  <div id="tpl-footer"></div>
  <script src="tpl-footer.js" defer></script>

  <!-- TPL: INICIO BLOQUE NUEVO [Firebase compat + tu configuración] -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
  <script>
    // Tu proyecto Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDW73aFuz2AFS9VeWg_linHIRJYN4YMgTk",
      authDomain: "thepetslovers-c1111.firebaseapp.com",
      projectId: "thepetslovers-c1111",
      storageBucket: "thepetslovers-c1111.firebasestorage.app",
      messagingSenderId: "415914577533",
      appId: "1:415914577533:web:0b7a056ebaa4f1de28ab14",
      measurementId: "G-FXPD69KXBG"
    };
  </script>
  <!-- TPL: FIN BLOQUE NUEVO -->

  <!-- TPL: INICIO BLOQUE NUEVO [Lectura Firestore + render + logout robusto con fallback local] -->
  <script>
    (function(){
      const app = firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();

      const LS_PROFILE_KEY = 'tpl-profile';
      const LS_PETS_KEY = 'tpl-pets';

      // Refs UI
      const emptyCliente = document.getElementById('tpl-cliente-empty');
      const viewCliente  = document.getElementById('tpl-cliente-view');
      const statusCliente= document.getElementById('tpl-cliente-status');

      const mascotasEmpty= document.getElementById('tpl-mascotas-empty');
      const mascotasView = document.getElementById('tpl-mascotas-view');
      const mascotasList = document.getElementById('tpl-mascotas-list');
      const chipMascotas = document.getElementById('tpl-chip-mascotas');
      const cntMascotas  = document.getElementById('tpl-count-mascotas');

      const logoutBtn    = document.getElementById('tpl-logout-btn');

      function updateBadge(profile){
        const complete = profile && profile.nombre && profile.telefono && profile.email && profile.cp;
        statusCliente.classList.toggle('tpl-hidden', !complete);
        statusCliente.setAttribute('aria-hidden', complete ? 'false' : 'true');
      }

      async function getProfile(uid){
        if (uid) {
          const doc = await db.collection('users').doc(uid).collection('private').doc('profile').get();
          return doc.exists ? doc.data() : null;
        }
        try { return JSON.parse(localStorage.getItem(LS_PROFILE_KEY) || 'null'); } catch(e){ return null; }
      }

      async function getPets(uid){
        if (uid) {
          const snap = await db.collection('users').doc(uid).collection('pets').get();
          return snap.docs.map(d => ({ id: d.id, ...d.data() }));
        }
        try { return JSON.parse(localStorage.getItem(LS_PETS_KEY) || '[]'); } catch(e){ return []; }
      }

      function petEditHref(pet, idx, isFirebase){
        // Si tenemos id (Firestore), lo pasamos como ?id=abc; si no, usamos ?idx=0
        return isFirebase && pet.id
          ? ('perfil-mascotas.html?id=' + encodeURIComponent(pet.id))
          : ('perfil-mascotas.html?idx=' + encodeURIComponent(idx));
      }

      async function render(uid){
        const isFirebase = !!uid;

        // ----- Perfil
        const profile = await getProfile(uid);
        updateBadge(profile);
        if (profile && profile.nombre) {
          document.getElementById('tpl-view-nombre').textContent = profile.nombre || '—';
          document.getElementById('tpl-view-telefono').textContent = profile.telefono || '—';
          document.getElementById('tpl-view-email').textContent = profile.email || '—';
          document.getElementById('tpl-view-direccion').textContent = profile.direccion || '—';
          document.getElementById('tpl-view-cp').textContent = profile.cp || '—';
          document.getElementById('tpl-view-pref').textContent = profile.preferencias || '—';
          emptyCliente.classList.add('tpl-hidden');
          viewCliente.classList.remove('tpl-hidden');
        } else {
          viewCliente.classList.add('tpl-hidden');
          emptyCliente.classList.remove('tpl-hidden');
        }

        // ----- Mascotas
        const pets = await getPets(uid);
        mascotasList.innerHTML = '';
        const count = pets ? pets.length : 0;

        if (count > 0) {
          mascotasEmpty.classList.add('tpl-hidden');
          mascotasView.classList.remove('tpl-hidden');
          chipMascotas.classList.remove('tpl-hidden');
          chipMascotas.setAttribute('aria-hidden','false');
          cntMascotas.textContent = String(count);

          pets.forEach((p, idx) => {
            const li = document.createElement('li');
            li.textContent = (p.nombre || '—') + ' · ' + (p.especie || '—') + (p.notas ? (' · ' + p.notas) : '');

            // Acciones: Editar (abre perfil-mascotas.html con id/idx)
            const actions = document.createElement('span');
            actions.className = 'tpl-pet-actions';

            const edit = document.createElement('a');
            edit.textContent = 'Editar';
            edit.className = 'cta-button';
            edit.setAttribute('href', petEditHref(p, idx, isFirebase));

            actions.appendChild(edit);
            li.appendChild(actions);
            mascotasList.appendChild(li);
          });
        } else {
          mascotasView.classList.add('tpl-hidden');
          mascotasEmpty.classList.remove('tpl-hidden');
          chipMascotas.classList.add('tpl-hidden');
          chipMascotas.setAttribute('aria-hidden','true');
          cntMascotas.textContent = '0';
        }
      }

      // Logout robusto
      async function doLogout(){
        try { await auth.signOut(); } catch(e) { console.warn('signOut:', e); }
        localStorage.removeItem(LS_PROFILE_KEY);
        localStorage.removeItem(LS_PETS_KEY);
        alert('Has cerrado sesión.');
        location.href = 'index.html';
      }
      if (logoutBtn) logoutBtn.addEventListener('click', doLogout);

      // Sesión
      auth.onAuthStateChanged(async (u) => {
        await render(u ? u.uid : null);
      });
    })();
  </script>
  <!-- TPL: FIN BLOQUE NUEVO -->
</body>
</html>
