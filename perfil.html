<!-- TPL: INICIO BLOQUE NUEVO [perfil.html — Script robusto con carga Firebase, sin Storage y tolerante a permisos] -->
<script>
(async function(){
  /* ---------- CARGA DINÁMICA DE FIREBASE (compat) ---------- */
  function loadScript(src){
    return new Promise((res, rej)=>{
      const s = document.createElement('script');
      s.src = src; s.async = true; s.onload = res;
      s.onerror = ()=>rej(new Error('No se pudo cargar: '+src));
      document.head.appendChild(s);
    });
  }
  async function ensureFirebase(){
    if (typeof window.firebase === 'undefined'){
      await loadScript('https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js');
    }
    if (!('auth' in firebase))      { await loadScript('https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js'); }
    if (!('firestore' in firebase)) { await loadScript('https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js'); }
    // Storage NO se carga: no subimos fotos.

    // Config si no existe ya en la página
    if (typeof window.firebaseConfig === 'undefined'){
      window.firebaseConfig = {
        apiKey: "AIzaSyDW73aFuz2AFS9VeWg_linHIRJYN4YMgTk",
        authDomain: "thepetslovers-c1111.firebaseapp.com",
        projectId: "thepetslovers-c1111",
        storageBucket: "thepetslovers-c1111.appspot.com",
        messagingSenderId: "415914577533",
        appId: "1:415914577533:web:0b7a056ebaa4f1de28ab14",
        measurementId: "G-FXPD69KXBG"
      };
    }
  }
  await ensureFirebase();

  /* ---------- INIT ---------- */
  if (firebase.apps.length === 0) { firebase.initializeApp(window.firebaseConfig); }
  const auth = firebase.auth();
  const db   = firebase.firestore();

  let CURRENT_UID = null;
  const LS_PROFILE_KEY = 'tpl-profile';
  const LS_PETS_KEY    = 'tpl-pets';
  const LS_RES_KEY     = 'tpl-reservas';

  /* ---------- REFS UI (tolerantes a null) ---------- */
  const $ = (id)=>document.getElementById(id);
  const bannerInc   = $('tpl-banner-incompleto');

  const emptyCliente  = $('tpl-cliente-empty');
  const viewCliente   = $('tpl-cliente-view');
  const statusCliente = $('tpl-cliente-status');
  const actionsPerfil = $('tpl-actions-perfil');
  const linkEditar    = $('tpl-link-editar');

  const mascotasEmpty = $('tpl-mascotas-empty');
  const mascotasView  = $('tpl-mascotas-view');
  const mascotasList  = $('tpl-mascotas-list');
  const chipMascotas  = $('tpl-chip-mascotas');
  const cntMascotas   = $('tpl-count-mascotas');

  const logoutBtn     = $('tpl-logout-btn');

  const reservasView  = $('tpl-reservas-view');
  const reservasList  = $('tpl-reservas-list');
  const reservasEmpty = $('tpl-reservas-empty');
  const btnIrReserva  = $('tpl-btn-ir-reserva');
  const pHintReserva  = document.querySelector("article[aria-labelledby='h-reservas'] p");

  const SERVICE_LABELS = {
    "guarderia-dia": "Guardería de día",
    "visitas": "Visitas a domicilio (gatos)",
    "alojamiento": "Alojamiento nocturno",
    "paseos": "Paseos",
    "transporte": "Transporte",
    "bodas": "Bodas",
    "postoperatorio": "Postoperatorio",
    "exoticos": "Exóticos"
  };

  /* ---------- HELPERS ---------- */
  const isPermError = (e)=> !!(e && (e.code === 'permission-denied' || /insufficient permissions/i.test(e.message||'')));
  function toDate(any){
    if (!any) return null;
    if (any.toDate) { try { return any.toDate(); } catch(_){} }
    if (typeof any === 'number') return new Date(any);
    const d = new Date(String(any));
    return isNaN(d) ? null : d;
  }

  function updateBadge(profile){
    const complete = !!(profile && profile.nombre && profile.telefono && profile.email && profile.cp);
    if (statusCliente){
      statusCliente.classList.toggle('tpl-hidden', !complete);
      statusCliente.setAttribute('aria-hidden', complete ? 'false' : 'true');
    }
    if (complete) {
      actionsPerfil && actionsPerfil.classList.add('tpl-hidden');
      if (linkEditar){
        linkEditar.classList.remove('tpl-hidden');
        linkEditar.setAttribute('aria-hidden','false');
      }
    } else {
      actionsPerfil && actionsPerfil.classList.add('tpl-hidden');
      if (linkEditar){
        linkEditar.classList.add('tpl-hidden');
        linkEditar.setAttribute('aria-hidden','true');
      }
    }
  }

  async function getProfile(uid){
    // 1) Intento Firestore
    if (uid) {
      try{
        const ref = db.collection('users').doc(uid).collection('private').doc('profile');
        const snap = await ref.get();
        if (snap.exists) return snap.data();
      }catch(e){
        console.warn('TPL profile read error:', e);
        if (!isPermError(e)) { /* noop */ }
      }
    }
    // 2) Fallback LocalStorage
    try { return JSON.parse(localStorage.getItem(LS_PROFILE_KEY) || 'null'); } catch(e){ return null; }
  }

  async function getPets(uid){
    if (uid) {
      try{
        const snap = await db.collection('users').doc(uid).collection('pets').get();
        return snap.docs.map(d => ({ id: d.id, ...d.data() }));
      }catch(e){
        console.warn('TPL pets read error:', e);
      }
    }
    try { return JSON.parse(localStorage.getItem(LS_PETS_KEY) || '[]'); } catch(e){ return []; }
  }

  function statusBadge(status){
    const s = String(status || '').toLowerCase();
    if (s==='aceptada' || s==='aprobada') return '<span class="tpl-badge ok"><i class="fa-solid fa-check"></i> Aceptada</span>';
    if (s==='en_revision' || s==='en-revision' || s==='revision') return '<span class="tpl-badge review"><i class="fa-solid fa-hourglass-half"></i> En revisión</span>';
    if (s==='enviada' || s==='pendiente') return '<span class="tpl-badge pending"><i class="fa-regular fa-paper-plane"></i> Enviada</span>';
    if (s==='completada' || s==='finalizada') return '<span class="tpl-badge done"><i class="fa-regular fa-circle-check"></i> Completada</span>';
    if (s==='cancelada') return '<span class="tpl-badge canceled"><i class="fa-regular fa-circle-xmark"></i> Cancelada</span>';
    return '<span class="tpl-badge"><i class="fa-regular fa-circle-question"></i> —</span>';
  }

  function ensureReservationAccess(hasProfile, hasPets){
    const complete = !!(hasProfile && hasPets);
    try{
      window.__TPL_PROFILE_COMPLETE__ = complete;
      localStorage.setItem('tplProfileComplete', complete ? '1' : '0');
    }catch(_){}
    if (bannerInc) bannerInc.hidden = complete;
    if (pHintReserva) pHintReserva.style.display = complete ? 'none' : '';

    function guardClick(e){
      e.preventDefault();
      if (bannerInc){
        bannerInc.hidden = false;
        bannerInc.scrollIntoView({behavior:'smooth', block:'start'});
      }
    }
    if (btnIrReserva){
      btnIrReserva.setAttribute('aria-disabled', complete ? 'false' : 'true');
      if (!complete){
        btnIrReserva.addEventListener('click', guardClick);
        btnIrReserva.setAttribute('title','Completa tu perfil y añade una mascota para continuar');
        btnIrReserva.setAttribute('href', '#completar');
      } else {
        btnIrReserva.replaceWith(btnIrReserva.cloneNode(true));
        const fresh = $('tpl-btn-ir-reserva');
        if (fresh){ fresh.setAttribute('href','reserva.html'); fresh.removeAttribute('aria-disabled'); fresh.removeAttribute('title'); }
      }
    }
  }

  async function getReservations(uid){
    try{
      const snap = await db.collection('users').doc(uid).collection('reservas').get();
      if (!snap.empty) return snap.docs.map(d => ({ id:d.id, ...d.data() }));
    }catch(_){}
    try{
      const snap2 = await db.collection('reservas').where('ownerUid','==', uid).get();
      if (!snap2.empty) return snap2.docs.map(d => ({ id:d.id, ...d.data() }));
    }catch(_){}
    try{ return JSON.parse(localStorage.getItem(LS_RES_KEY) || '[]'); }catch(_){ return []; }
  }

  function renderReservations(reservas){
    if (!reservasList || !reservasView || !reservasEmpty) return; // tolerar páginas sin bloque de reservas
    reservasList.innerHTML = '';
    if (!reservas || reservas.length===0){
      reservasView.classList.add('tpl-hidden');
      reservasEmpty.classList.remove('tpl-hidden');
      return;
    }
    reservasEmpty.classList.add('tpl-hidden');
    reservasView.classList.remove('tpl-hidden');

    reservas.sort((a,b)=>{
      const da = toDate(a.fechaInicio || a.startAt || a.startDate || a.inicio) || new Date(8640000000000000);
      const dbb = toDate(b.fechaInicio || b.startAt || b.startDate || b.inicio) || new Date(8640000000000000);
      return da - dbb;
    });

    reservas.forEach(r=>{
      const start = toDate(r.fechaInicio || r.startAt || r.startDate || r.inicio);
      const end   = toDate(r.fechaFin || r.endAt || r.endDate || r.fin);
      const servicio = SERVICE_LABELS[r.servicio] || r.servicio || 'Servicio';
      const estado   = r.estado || r.status || 'enviada';
      const pets     = Array.isArray(r.mascotas) ? r.mascotas : (r.mascotaNombre ? [r.mascotaNombre] : []);
      const caret    = r.cuidadorNombre || r.cuidador || '';
      const addr     = r.direccion || r.address || '';
      const price    = r.precio || r.price || '';

      const el = document.createElement('div');
      el.className = 'tpl-reserva';
      el.innerHTML = `
        <h3>${servicio}</h3>
        <div class="row"><i class="fa-regular fa-calendar"></i> ${start ? start.toLocaleDateString('es-ES') : '—'} ${end ? ' · ' + end.toLocaleDateString('es-ES') : ''}</div>
        <div class="row"><i class="fa-solid fa-paw"></i> ${pets.length ? pets.join(', ') : '—'}</div>
        ${caret ? `<div class="row"><i class="fa-regular fa-user"></i> ${caret}</div>` : ''}
        ${addr ? `<div class="row"><i class="fa-regular fa-map"></i> ${addr}</div>` : ''}
        ${price ? `<div class="row"><i class="fa-solid fa-euro-sign"></i> ${price}</div>` : ''}
        <div class="row">${statusBadge(estado)}</div>
      `;
      reservasList.appendChild(el);
    });
  }

  async function render(uid){
    const isFirebase = !!uid;

    // Perfil
    const profile = await getProfile(uid);
    updateBadge(profile);
    if (profile && profile.nombre) {
      $('tpl-view-nombre') && ( $('tpl-view-nombre').textContent    = profile.nombre || '—' );
      $('tpl-view-telefono') && ( $('tpl-view-telefono').textContent  = profile.telefono || '—' );
      $('tpl-view-email') && ( $('tpl-view-email').textContent     = profile.email || '—' );
      $('tpl-view-direccion') && ( $('tpl-view-direccion').textContent = profile.direccion || '—' );
      $('tpl-view-cp') && ( $('tpl-view-cp').textContent        = profile.cp || '—' );
      $('tpl-view-pref') && ( $('tpl-view-pref').textContent      = profile.preferencias || '—' );
      emptyCliente && emptyCliente.classList.add('tpl-hidden');
      viewCliente && viewCliente.classList.remove('tpl-hidden');
    } else {
      viewCliente && viewCliente.classList.add('tpl-hidden');
      emptyCliente && emptyCliente.classList.remove('tpl-hidden');
    }

    // Mascotas
    const pets = await getPets(uid);
    mascotasList && (mascotasList.innerHTML = '');
    const count = pets ? pets.length : 0;

    if (count > 0) {
      mascotasEmpty && mascotasEmpty.classList.add('tpl-hidden');
      mascotasView  && mascotasView.classList.remove('tpl-hidden');
      chipMascotas  && chipMascotas.classList.remove('tpl-hidden');
      chipMascotas  && chipMascotas.setAttribute('aria-hidden','false');
      cntMascotas   && (cntMascotas.textContent = String(count));

      pets.forEach((p, idx) => {
        const especie = p.especie || '—';
        const card   = document.createElement('div');
        card.className = 'tpl-pet';

        const avatar = document.createElement('div');
        avatar.className = 'tpl-avatar';
        const imgSrc = p.fotoDataUrl || p.fotoUrl || '';
        if (imgSrc){
          const img = document.createElement('img');
          img.src = imgSrc; img.alt = `Foto de ${p.nombre || 'mascota'}`;
          avatar.appendChild(img);
        } else {
          const initials = (p.nombre||'').trim().split(/\s+/).slice(0,2).map(s=>s[0]?.toUpperCase()||'').join('') || '—';
          avatar.textContent = initials;
        }

        const textBox = document.createElement('div');
        const nameEl = document.createElement('div'); nameEl.className='tpl-pet-name'; nameEl.textContent=p.nombre||'—';
        const secEl  = document.createElement('div'); secEl.className='tpl-pet-secondary'; secEl.textContent=especie;
        textBox.appendChild(nameEl); textBox.appendChild(secEl);

        const actions = document.createElement('div'); actions.className='tpl-pet-actions';
        const edit = document.createElement('a');
        edit.textContent = 'Editar';
        edit.className = 'tpl-btn-sm tpl-btn-outline';
        edit.setAttribute('href', (isFirebase && p.id)
          ? ('perfil-mascotas.html?id=' + encodeURIComponent(p.id) + '&next=' + encodeURIComponent('perfil.html'))
          : ('perfil-mascotas.html?idx=' + encodeURIComponent(idx) + '&next=' + encodeURIComponent('perfil.html')));
        actions.appendChild(edit);

        const pop = document.createElement('div');
        pop.className = 'tpl-popover'; pop.setAttribute('role','dialog');
        pop.innerHTML = `
          <dl>
            <dt>Especie</dt><dd>${especie || '—'}</dd>
            <dt>Edad</dt><dd>${(p.edad ?? '—')}</dd>
            <dt>Peso</dt><dd>${(p.peso ?? '—')}</dd>
            <dt>Sexo</dt><dd>${p.sexo || '—'}</dd>
            <dt>Esterilizado</dt><dd>${(p.esterilizado ?? '—')}</dd>
          </dl>
          ${p.comentarios ? `<div class="tpl-notas"><strong>Notas:</strong> ${p.comentarios}</div>` : ''}
        `;

        card.appendChild(avatar);
        card.appendChild(textBox);
        card.appendChild(actions);
        card.appendChild(pop);
        mascotasList && mascotasList.appendChild(card);
      });
    } else {
      mascotasView  && mascotasView.classList.add('tpl-hidden');
      mascotasEmpty && mascotasEmpty.classList.remove('tpl-hidden');
      chipMascotas  && chipMascotas.classList.add('tpl-hidden');
      chipMascotas  && chipMascotas.setAttribute('aria-hidden','true');
      cntMascotas   && (cntMascotas.textContent = '0');
    }

    // Reservas
    const hasProfile = !!(profile && profile.nombre && profile.telefono && profile.email && profile.cp);
    const hasPets    = count > 0;
    ensureReservationAccess(hasProfile, hasPets);

    const reservas = await getReservations(uid);
    renderReservations(reservas);
  }

  /* ---------- LOGOUT ---------- */
  async function doLogout(){
    try { await auth.signOut(); } catch(e) {}
    try {
      localStorage.removeItem('tplAuth');
      localStorage.removeItem('tplEmail');
      localStorage.removeItem(LS_PROFILE_KEY);
      localStorage.removeItem(LS_PETS_KEY);
      localStorage.removeItem('tplProfileComplete');
    } catch(e) {}
    if ('caches' in window) { caches.keys().then(keys => keys.forEach(k => caches.delete(k))).catch(()=>{}); }
    location.href = 'index.html';
  }
  logoutBtn && logoutBtn.addEventListener('click', doLogout);

  /* ---------- MODAL OWNER (propietario) ---------- */
  const ownerModal = $('tpl-owner-modal');
  const ownerForm  = $('tpl-owner-form');
  const oMsg       = $('o_msg');

  function openOwnerModal(pre){
    if (!ownerModal || !ownerForm) return;
    ownerModal.setAttribute('aria-hidden','false');
    document.documentElement.style.overflow='hidden';
    ownerForm.reset(); if (oMsg) oMsg.style.display='none';

    const f_nombre = ownerForm.querySelector('#o_nombre');
    const f_tel    = ownerForm.querySelector('#o_telefono');
    const f_email  = ownerForm.querySelector('#o_email');
    const f_dir    = ownerForm.querySelector('#o_direccion');
    const f_cp     = ownerForm.querySelector('#o_cp');
    const f_pref   = ownerForm.querySelector('#o_pref');

    if (f_nombre) f_nombre.value = pre?.nombre || '';
    if (f_tel)    f_tel.value    = pre?.telefono || '';
    if (f_email)  f_email.value  = (auth.currentUser && auth.currentUser.email) || pre?.email || '';
    if (f_dir)    f_dir.value    = pre?.direccion || '';
    if (f_cp)     f_cp.value     = pre?.cp || '';
    if (f_pref)   f_pref.value   = pre?.preferencias || '';
    setTimeout(()=> f_nombre?.focus(), 0);
  }
  function closeOwnerModal(){
    if (!ownerModal) return;
    ownerModal.setAttribute('aria-hidden','true');
    document.documentElement.style.overflow='';
  }
  ownerModal && ownerModal.addEventListener('click', (e)=>{ if (e.target.matches('[data-close-owner]')) closeOwnerModal(); });
  ownerForm && ownerForm.querySelector('[data-close-owner]')?.addEventListener('click', closeOwnerModal);

  ownerForm && ownerForm.addEventListener('submit', async (e)=>{
    e.preventDefault(); if (oMsg) oMsg.style.display='none';
    if (!ownerForm.reportValidity()) return;

    const uid = (typeof CURRENT_UID === 'string' && CURRENT_UID) || (auth.currentUser && auth.currentUser.uid);
    if (!uid){ alert('Vuelve a iniciar sesión para guardar tu perfil.'); return; }

    const data = {
      nombre:      ownerForm.querySelector('#o_nombre').value.trim(),
      telefono:    ownerForm.querySelector('#o_telefono').value.trim(),
      email:       ownerForm.querySelector('#o_email').value.trim(),
      direccion:   ownerForm.querySelector('#o_direccion').value.trim(),
      cp:          ownerForm.querySelector('#o_cp').value.trim(),
      preferencias:ownerForm.querySelector('#o_pref').value.trim(),
      updatedAt:   new Date().toISOString()
    };

    try{
      // Guarda también email en /users/{uid}
      await db.collection('users').doc(uid).set({ email: data.email, updatedAt: new Date() }, {merge:true});
      await db.collection('users').doc(uid).collection('private').doc('profile').set(data, {merge:true});
      try { localStorage.setItem('tplProfileComplete','1'); } catch(_){}
      if (oMsg){ oMsg.style.display='inline-flex'; }
      await render(uid);
      setTimeout(closeOwnerModal, 400);
    }catch(err){
      alert('No se pudo guardar el perfil (reglas Firestore). Revisa las REGLAS o usa el formulario página completa. ' + (err?.message || err));
    }
  });

  /* ---------- MODAL PET (mascota) ---------- */
  const petModal = $('tpl-pet-modal');
  const petForm  = $('tpl-pet-form');
  const pMsg     = $('p_msg');
  const pDel     = $('p_delete');
  const pFull    = $('p_fullpage');

  const pFoto    = $('p_foto');
  const pCambiar = $('p_cambiar');
  const pPrev    = $('p_preview');

  const wrapFaltan = $('p_wrap_faltan');
  const pFaltan    = $('p_faltan');
  const pVac       = $('p_vac');

  const wrapSeg    = $('p_wrap_seg');
  const pSegVet    = $('p_segvet');
  const pAseg      = $('p_aseg');
  const pPol       = $('p_pol');

  const pEspecie   = $('p_especie');
  const pRaza      = $('p_raza');
  const pLabelRaza = $('p_label_raza');

  const pNoChip    = $('p_nochip');
  const pMicro     = $('p_micro');

  let CURRENT_PET_ID = null;
  let petPhotoDataUrl = '';  // DataURL únicamente (sin Storage)

  function openPetModal(p){
    if (!petModal || !petForm) return;
    petModal.setAttribute('aria-hidden','false');
    document.documentElement.style.overflow='hidden';
    petForm.reset(); if (pMsg) pMsg.style.display='none';
    CURRENT_PET_ID = p?.id || null;

    petPhotoDataUrl = p?.fotoDataUrl || '';
    if (pPrev) pPrev.src = petPhotoDataUrl || (p?.fotoUrl || '');
    setPhotoUI( !!(petPhotoDataUrl || p?.fotoUrl) );

    petForm.querySelector('#p_nombre').value = p?.nombre || '';
    pMicro.value   = p?.microchip || '';
    pNoChip.checked = !p?.microchip;
    toggleMicrochip();

    pEspecie.value = p?.especie || '';
    toggleEspecie();
    if ((p?.especie||'') === 'Exótico'){
      pRaza.value = p?.tipoExotico || '';
    } else {
      pRaza.value = p?.raza || '';
    }

    petForm.querySelector('#p_edad').value = p?.edad ?? '';
    petForm.querySelector('#p_peso').value = p?.peso ?? '';
    petForm.querySelector('#p_sexo').value = p?.sexo || '';
    petForm.querySelector('#p_ester').value = p?.esterilizado || '';
    petForm.querySelector('#p_pat').value  = p?.patologias || '';
    petForm.querySelector('#p_via').value  = p?.via || '';
    petForm.querySelector('#p_comidas').value = p?.comidas || '';
    pVac.value = p?.vacunas || '';
    toggleVacunas();
    pFaltan.value = p?.faltan || '';
    petForm.querySelector('#p_comp').value = p?.comportamiento || '';
    pSegVet.value = p?.seguroVet || '';
    toggleSegVet();
    pAseg.value = p?.aseguradora || '';
    pPol.value  = p?.poliza || '';
    petForm.querySelector('#p_segRC').value = p?.seguroRC || '';
    petForm.querySelector('#p_notas').value = p?.comentarios || '';

    pDel && (pDel.style.display = CURRENT_PET_ID ? 'inline-flex' : 'none');
    pFull && (pFull.href = CURRENT_PET_ID ? ('perfil-mascotas.html?id='+encodeURIComponent(CURRENT_PET_ID)+'&next=perfil.html') : 'perfil-mascotas.html?mode=new&next=perfil.html');

    setTimeout(()=> document.getElementById('p_nombre')?.focus(), 0);
  }
  function closePetModal(){
    if (!petModal) return;
    petModal.setAttribute('aria-hidden','true');
    document.documentElement.style.overflow='';
  }
  petModal && petModal.addEventListener('click', (e)=>{ if (e.target.matches('[data-close-pet]')) closePetModal(); });
  petForm && petForm.querySelector('[data-close-pet]')?.addEventListener('click', closePetModal);

  function openOwnerFromStorageOrEmpty(){
    getProfile(CURRENT_UID).then(p=> openOwnerModal(p||null));
  }
  function openPetFromIdOrNew(id){
    if (!CURRENT_UID){ openPetModal(null); return; }
    if (id){
      db.collection('users').doc(CURRENT_UID).collection('pets').doc(id).get()
        .then(d=> openPetModal(d.exists ? ({id:d.id, ...d.data()}) : null))
        .catch(()=> openPetModal(null));
    } else {
      openPetModal(null);
    }
  }

  function setPhotoUI(hasPhoto){
    if (!pFoto || !pCambiar) return;
    if (hasPhoto){
      pFoto.classList.add('is-hidden');
      pCambiar.classList.remove('is-hidden');
    } else {
      pFoto.classList.remove('is-hidden');
      pCambiar.classList.add('is-hidden');
    }
  }
  pFoto && pFoto.addEventListener('change', async ()=>{
    const f = pFoto.files?.[0]; if (!f) return;
    try{
      const reader = new FileReader();
      reader.onload = e => { if (pPrev) pPrev.src = e.target.result; petPhotoDataUrl = e.target.result; setPhotoUI(true); };
      reader.readAsDataURL(f);
    }catch(_){}
  });
  pCambiar && pCambiar.addEventListener('click', ()=> pFoto.click());

  function toggleMicrochip(){
    if (!pNoChip || !pMicro) return;
    if (pNoChip.checked){
      pMicro.required=false; pMicro.value=''; pMicro.disabled=true;
    } else {
      pMicro.required=true; pMicro.disabled=false;
    }
  }
  pNoChip && pNoChip.addEventListener('change', toggleMicrochip);

  function toggleVacunas(){
    if (!wrapFaltan || !pFaltan || !pVac) return;
    if (pVac.value === 'No'){
      wrapFaltan.classList.remove('is-hidden'); pFaltan.required = true;
    } else {
      wrapFaltan.classList.add('is-hidden'); pFaltan.required = false; pFaltan.value='';
    }
  }
  pVac && pVac.addEventListener('change', toggleVacunas);

  function toggleEspecie(){
    if (!pEspecie || !pRaza) return;
    if (pEspecie.value === 'Exótico'){
      pRaza.placeholder = 'Ej.: Ave, Reptil, Pequeño mamífero…';
      if (pLabelRaza) pLabelRaza.innerHTML = 'Tipo de exótico *';
      pRaza.required = true;
    } else if (pEspecie.value){
      if (pLabelRaza) pLabelRaza.innerHTML = 'Raza / especie *';
      pRaza.placeholder = 'Escribe o elige…';
      pRaza.required = true;
    } else {
      if (pLabelRaza) pLabelRaza.innerHTML = 'Raza / especie';
      pRaza.required = false;
    }
  }
  pEspecie && pEspecie.addEventListener('change', toggleEspecie);

  function toggleSegVet(){
    if (!wrapSeg || !pSegVet || !pAseg || !pPol) return;
    if (pSegVet.value === 'Sí'){
      wrapSeg.classList.remove('is-hidden'); pAseg.required = true; pPol.required = true;
    } else {
      wrapSeg.classList.add('is-hidden'); pAseg.required = false; pPol.required = false; pAseg.value=''; pPol.value='';
    }
  }
  pSegVet && pSegVet.addEventListener('change', toggleSegVet);

  petForm && petForm.addEventListener('submit', async (e)=>{
    e.preventDefault(); pMsg && (pMsg.style.display='none');
    if (pVac && pVac.value==='No' && !pFaltan.value.trim()){ pFaltan.reportValidity(); return; }
    if (!petForm.reportValidity()) return;

    const uid = (typeof CURRENT_UID === 'string' && CURRENT_UID) || (auth.currentUser && auth.currentUser.uid);
    if (!uid){ alert('Vuelve a iniciar sesión para guardar la mascota.'); return; }

    const isExotico = (pEspecie && pEspecie.value === 'Exótico');
    const data = {
      fotoDataUrl: (typeof petPhotoDataUrl === 'string' && petPhotoDataUrl) ? petPhotoDataUrl : undefined,
      fotoUrl: '',

      nombre: document.getElementById('p_nombre').value.trim(),
      microchip: pNoChip && pNoChip.checked ? '' : (pMicro ? pMicro.value.trim() : ''),
      especie: pEspecie ? pEspecie.value : '',
      raza: isExotico ? '' : (pRaza ? pRaza.value.trim() : ''),
      tipoExotico: isExotico ? (pRaza ? pRaza.value.trim() : '') : '',
      edad: Number(document.getElementById('p_edad').value || 0),
      peso: Number(document.getElementById('p_peso').value || 0),
      sexo: document.getElementById('p_sexo').value,
      esterilizado: document.getElementById('p_ester').value,
      patologias: document.getElementById('p_pat').value.trim(),
      via: document.getElementById('p_via').value.trim(),
      comidas: document.getElementById('p_comidas').value.trim(),
      vacunas: pVac ? pVac.value : '',
      faltan: (pVac && pVac.value==='No') ? (pFaltan ? pFaltan.value.trim() : '') : '',
      comportamiento: document.getElementById('p_comp').value.trim(),
      seguroVet: pSegVet ? pSegVet.value : '',
      aseguradora: (pSegVet && pSegVet.value==='Sí') ? (pAseg ? pAseg.value.trim() : '') : '',
      poliza: (pSegVet && pSegVet.value==='Sí') ? (pPol ? pPol.value.trim() : '') : '',
      seguroRC: document.getElementById('p_segRC').value,
      comentarios: document.getElementById('p_notas').value.trim(),
      updatedAt: new Date().toISOString()
    };

    try{
      let petId = CURRENT_PET_ID;
      if (!petId){
        const ref = await db.collection('users').doc(uid).collection('pets').add(data);
        petId = ref.id; CURRENT_PET_ID = petId;
      } else {
        await db.collection('users').doc(uid).collection('pets').doc(petId).set(data, {merge:true});
      }
      pMsg && (pMsg.style.display='inline-flex');
      await render(uid);
      setTimeout(closePetModal, 400);
    }catch(err){
      alert('No se pudo guardar la mascota (reglas Firestore). ' + (err?.message || err));
    }
  });

  pDel && pDel.addEventListener('click', async ()=>{
    if (!CURRENT_PET_ID) return;
    if (!confirm('¿Eliminar esta mascota?')) return;
    try{
      const uid = (typeof CURRENT_UID === 'string' && CURRENT_UID) || (auth.currentUser && auth.currentUser.uid);
      if (!uid){ alert('Vuelve a iniciar sesión.'); return; }
      await db.collection('users').doc(uid).collection('pets').doc(CURRENT_PET_ID).delete();
      await render(uid);
      closePetModal();
    }catch(err){
      alert('No se pudo eliminar: ' + (err?.message || err));
    }
  });

  /* ---------- Interceptar enlaces antiguos ---------- */
  function toggleOwnerLinkInterceptions(){
    document.addEventListener('click', function(e){
      const a = e.target.closest('a'); if (!a) return;
      const href = a.getAttribute('href') || '';
      if (/^registro\.html/i.test(href)){
        e.preventDefault(); openOwnerFromStorageOrEmpty();
      }
      if (/^perfil-mascotas\.html/i.test(href)){
        e.preventDefault();
        const url = new URL(href, location.href);
        const id  = url.searchParams.get('id');
        openPetFromIdOrNew(id);
      }
    });
  }
  toggleOwnerLinkInterceptions();

  /* ---------- Botones visibles ---------- */
  $('tpl-btn-perfil') && $('tpl-btn-perfil').addEventListener('click', (e)=>{ e.preventDefault(); openOwnerFromStorageOrEmpty(); });
  $('tpl-btn-mascota-nueva') && $('tpl-btn-mascota-nueva').addEventListener('click', (e)=>{ e.preventDefault(); openPetModal(null); });

  /* ---------- Deep links ---------- */
  function handleDeepLinks(){
    try{
      const qs = new URLSearchParams(location.search);
      const owner = qs.get('owner');
      const pet   = qs.get('pet');
      if (owner === 'edit'){ openOwnerFromStorageOrEmpty(); }
      if (pet === 'new'){ openPetModal(null); }
      else if (pet){ openPetFromIdOrNew(pet); }
    }catch(_){}
  }

  /* ---------- ESC cierra modales ---------- */
  document.addEventListener('keydown', (e)=>{
    if (e.key === 'Escape'){
      (ownerModal && ownerModal.getAttribute('aria-hidden') === 'false') && (function(){ ownerModal.setAttribute('aria-hidden','true'); document.documentElement.style.overflow=''; })();
      (petModal && petModal.getAttribute('aria-hidden') === 'false') && (function(){ petModal.setAttribute('aria-hidden','true'); document.documentElement.style.overflow=''; })();
    }
  });

  /* ---------- Auth guard + render ---------- */
  auth.onAuthStateChanged(async (u)=>{
    if (u && !u.isAnonymous){
      CURRENT_UID = u.uid;
      try{
        localStorage.setItem('tplAuth','1');
        if (u.email) localStorage.setItem('tplEmail', String(u.email));
      }catch(_){}
      await render(CURRENT_UID);
      handleDeepLinks();
    } else {
      location.href = 'iniciar-sesion.html?next=' + encodeURIComponent('perfil.html');
    }
  });

  /* ---------- Log errores globales ---------- */
  window.addEventListener('error', e => { console.error('TPL runtime error:', e.error || e.message || e); });
})();
</script>
<!-- TPL: FIN BLOQUE NUEVO -->
