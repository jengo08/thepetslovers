<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Mi perfil · The Pets Lovers</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Poppins:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <style>
    :root{ --tpl-primary:#339496; --tpl-ink:#58425a; }

    /* Layout base */
    .tpl-profile{ max-width:980px; margin:120px auto 60px; padding:20px; background:#fff; border:1px solid #eee; border-radius:12px; box-shadow:0 2px 12px rgba(0,0,0,.05);}
    .tpl-sub{ color:#666; margin-bottom:18px; }

    /* Cards */
    .tpl-cards{ display:grid; gap:14px; grid-template-columns:repeat(auto-fit, minmax(320px, 1fr)); align-items:start; }
    .tpl-card{ border:1px solid #eee; border-radius:12px; padding:16px; position:relative; background:#fff; }
    .tpl-card h2{ font-size:18px; margin:0 0 10px; color:#58425a; }
    .tpl-card-wide{ grid-column:1 / -1; }

    .tpl-actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .cta-button{ background:#339496; color:#fff; padding:10px 16px; border-radius:999px; border:none; cursor:pointer; font-weight:700; text-align:center; }
    a.cta-button{ display:inline-block; }
    .link{ background:#fff; color:#339496; border:2px solid #339496; }

    /* Vistas */
    .tpl-view{ background:#fafafa; border:1px solid #eee; border-radius:10px; padding:12px; }
    .tpl-view dl{ margin:0; display:grid; grid-template-columns: 170px 1fr; row-gap:6px; column-gap:10px; }
    .tpl-view dt{ font-weight:700; color:#58425a; }
    .tpl-view dd{ margin:0; overflow-wrap:anywhere; color:#333; }
    .tpl-empty{ color:#666; font-style:italic; }
    .tpl-status{ position:absolute; top:12px; right:12px; font-weight:700; font-size:.9rem; display:flex; align-items:center; gap:6px; color:#2a7e80; }
    .tpl-status i{ font-size:1rem; }
    .tpl-chip{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid #e7e7e7; border-radius:999px; background:#fff; font-weight:700; color:#58425a; }
    .tpl-hidden{ display:none !important; }

    /* Lista de mascotas */
    .tpl-pets{ display:grid; grid-template-columns:repeat(auto-fit, minmax(240px, 1fr)); gap:10px; }
    .tpl-pet{ position:relative; display:flex; align-items:center; gap:10px; padding:10px; border:1px solid #eee; border-radius:12px; background:#fff; }
    .tpl-avatar{ width:56px; height:56px; border-radius:50%; overflow:hidden; border:2px solid #e8f2f2; background:#eaf5f5; display:flex; align-items:center; justify-content:center; font-weight:700; color:#58425a; }
    .tpl-avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
    .tpl-pet-name{ font-weight:700; color:#58425a; line-height:1.2 }
    .tpl-pet-secondary{ font-size:.9rem; color:#666 }
    .tpl-pet-actions{ margin-left:auto; display:flex; gap:6px }
    .tpl-btn-sm{ padding:6px 10px; border-radius:999px; font-weight:700; border:none; cursor:pointer; }
    .tpl-btn-outline{ background:#fff; color:#339496; border:2px solid #339496; }

    /* Reservas */
    .tpl-reservas{ display:grid; gap:10px; grid-template-columns:repeat(auto-fit, minmax(260px,1fr)); }
    .tpl-reserva{ border:1px solid #eee; border-radius:12px; padding:12px; background:#fff; position:relative; }
    .tpl-reserva h3{ margin:0 0 6px; font-size:1rem; color:#58425a; }
    .tpl-reserva .row{ display:flex; gap:10px; align-items:center; font-size:.95rem; color:#333; margin:4px 0; }
    .tpl-badge{ display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; font-weight:700; font-size:.85rem; border:1px solid #eee; background:#fafafa; color:#58425a; }
    .tpl-badge.ok{ background:#e9fbf4; border-color:#bfe7d3; color:#1f7a5a; }
    .tpl-badge.pending{ background:#fff8e6; border-color:#ffe4a3; color:#906500; }
    .tpl-badge.canceled{ background:#ffeaea; border-color:#ffcccc; color:#9a1f1f; }
    .tpl-badge.done{ background:#eef0ff; border-color:#d8ddff; color:#2833a7; }
    .tpl-badge.review{ background:#f0f6ff; border-color:#d6e7ff; color:#285f9a; }
    .tpl-soon{ position:absolute; right:12px; top:12px; font-weight:800; font-size:.85rem; }

    /* Banner bloqueo reservas */
    .tpl-banner-warning{ display:flex; gap:10px; align-items:flex-start; margin:10px 0 14px; padding:10px 12px; border:1px dashed #339496; border-radius:12px; background:#f0fbfb; color:#2a7e80; }
    .tpl-banner-warning i{ margin-top:2px; }

    /* MODALES (propietario + mascota inline) */
    .tpl-modal{ position:fixed; inset:0; z-index:9999; display:none; }
    .tpl-modal[aria-hidden="false"]{ display:block; }
    .tpl-modal__backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.45); }
    .tpl-modal__dialog{ position:relative; max-width:760px; margin:5vh auto; background:#fff; border-radius:14px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.2) }
    .tpl-modal__header{ display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px }
    .tpl-modal__title{ font-size:1.1rem; font-weight:700; margin:0; color:#58425a }
    .tpl-modal__close{ appearance:none; border:none; background:#f3f3f3; border-radius:8px; padding:8px 10px; cursor:pointer }
    .tpl-modal__close:hover{ background:#e9e9e9 }
    .tpl-form{ display:grid; gap:12px }
    @media (min-width:760px){ .tpl-form--2col{ grid-template-columns:1fr 1fr } .col-span-2{ grid-column: span 2 } }
    .tpl-field{ display:flex; flex-direction:column; gap:6px }
    .tpl-field label{ font-weight:700; color:#58425a }
    .tpl-input,.tpl-textarea,.tpl-select{ width:100%; padding:10px; border:1px solid #ddd; border-radius:10px; font:inherit }
    .tpl-input:focus,.tpl-textarea:focus,.tpl-select:focus{ border-color:var(--tpl-primary); box-shadow:0 0 0 3px rgba(51,148,150,.18) }
    .tpl-submit{ background:#339496; color:#fff; border:none; border-radius:10px; padding:12px 16px; font-weight:700; cursor:pointer }
    .tpl-btn-outline{ background:#fff; color:#339496; border:2px solid #339496; border-radius:10px; padding:12px 16px; font-weight:700; cursor:pointer }

    /* Foto mini en modal mascota */
    .tpl-photo{ width:120px; height:120px; object-fit:cover; border-radius:12px; border:1px solid #eee; background:#fafafa }
  </style>
</head>
<body>
  <!-- Navbar unificada -->
  <div id="tpl-navbar"></div>
  <script src="tpl-navbar.js" defer></script>

  <main class="tpl-profile" aria-labelledby="t">
    <h1 id="t" style="margin:0 0 6px">Mi perfil</h1>

    <!-- Banner “Perfil incompleto” -->
    <section id="tpl-banner-incompleto" class="tpl-banner-warning" hidden>
      <i class="fa-solid fa-circle-exclamation" aria-hidden="true"></i>
      <div>
        <strong>Perfil incompleto.</strong> Para poder reservar, completa tus datos y añade al menos una mascota.
        <div style="margin-top:6px;">
          <button id="btn-open-owner" class="cta-button link" type="button">Completar perfil</button>
          <button id="btn-open-pet" class="cta-button link" type="button">Añadir mascota</button>
        </div>
      </div>
    </section>

    <p class="tpl-sub">Gestiona tus datos y los de tus mascotas.</p>

    <section class="tpl-cards">
      <!-- PROPIETARIO -->
      <article class="tpl-card" id="tpl-card-cliente" aria-labelledby="h-cliente">
        <div id="tpl-cliente-status" class="tpl-status tpl-hidden" aria-hidden="true">
          <i class="fa-solid fa-circle-check"></i> Perfil completo
        </div>

        <h2 id="h-cliente">Datos de cliente</h2>
        <p id="tpl-cliente-empty" class="tpl-empty">Aún no has creado tu perfil. Usa el botón para rellenarlo.</p>

        <div id="tpl-cliente-view" class="tpl-view tpl-hidden" aria-live="polite">
          <dl>
            <dt>Nombre</dt><dd id="tpl-view-nombre">—</dd>
            <dt>Teléfono</dt><dd id="tpl-view-telefono">—</dd>
            <dt>Email</dt><dd id="tpl-view-email">—</dd>
            <dt>Dirección</dt><dd id="tpl-view-direccion">—</dd>
            <dt>Código postal</dt><dd id="tpl-view-cp">—</dd>
            <dt>Preferencias</dt><dd id="tpl-view-pref">—</dd>
          </dl>
        </div>

        <div class="tpl-actions" id="tpl-actions-perfil">
          <button id="btn-open-owner-2" class="cta-button" type="button">Rellenar / Editar perfil</button>
        </div>
      </article>

      <!-- MASCOTAS -->
      <article class="tpl-card" id="tpl-card-mascotas" aria-labelledby="h-mascotas">
        <h2 id="h-mascotas">Mis mascotas</h2>
        <div id="tpl-chip-mascotas" class="tpl-chip tpl-hidden" aria-hidden="true">
          <i class="fa-solid fa-paw"></i> <span id="tpl-count-mascotas">0</span>
        </div>

        <p id="tpl-mascotas-empty" class="tpl-empty">Aún no has añadido mascotas.</p>

        <div id="tpl-mascotas-view" class="tpl-view tpl-hidden" aria-live="polite">
          <div id="tpl-mascotas-list" class="tpl-pets"></div>
        </div>

        <div class="tpl-actions">
          <button id="btn-open-pet-2" class="cta-button link" type="button">Añadir mascota</button>
        </div>
      </article>

      <!-- RESERVAS -->
      <article class="tpl-card tpl-card-wide" aria-labelledby="h-reservas">
        <h2 id="h-reservas">Reservas</h2>
        <p>Cuando tu perfil esté completo podrás reservar.</p>

        <div id="tpl-reservas-view" class="tpl-view tpl-hidden" aria-live="polite">
          <div id="tpl-reservas-list" class="tpl-reservas"></div>
        </div>
        <p id="tpl-reservas-empty" class="tpl-empty tpl-hidden">Aún no tienes reservas.</p>

        <div class="tpl-actions">
          <a class="cta-button" id="tpl-btn-ir-reserva" href="reserva.html">Ir a reservar</a>
        </div>
      </article>
    </section>
  </main>

  <!-- Footer unificado -->
  <div id="tpl-footer"></div>
  <script src="tpl-footer.js" defer></script>

  <!-- ====== MODAL PERFIL PROPIETARIO ====== -->
  <div id="modal-owner" class="tpl-modal" aria-hidden="true">
    <div class="tpl-modal__backdrop" data-close></div>
    <div class="tpl-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="owner-title">
      <div class="tpl-modal__header">
        <h3 id="owner-title" class="tpl-modal__title">Perfil de propietario</h3>
        <button class="tpl-modal__close" type="button" data-close>✕</button>
      </div>
      <form id="form-owner" class="tpl-form tpl-form--2col" novalidate>
        <div class="tpl-field"><label for="o_nombre">Nombre completo *</label><input id="o_nombre" class="tpl-input" required></div>
        <div class="tpl-field"><label for="o_telefono">Teléfono *</label><input id="o_telefono" class="tpl-input" inputmode="tel" required></div>
        <div class="tpl-field col-span-2"><label for="o_email">Email *</label><input id="o_email" class="tpl-input" type="email" required></div>
        <div class="tpl-field col-span-2"><label for="o_direccion">Dirección</label><input id="o_direccion" class="tpl-input"></div>
        <div class="tpl-field"><label for="o_cp">Código postal *</label><input id="o_cp" class="tpl-input" pattern="[0-9]{5}" inputmode="numeric" maxlength="5" required></div>
        <div class="tpl-field col-span-2"><label for="o_pref">Preferencias</label><textarea id="o_pref" class="tpl-textarea" rows="3" placeholder="Comunicación, horarios, etc."></textarea></div>
        <div class="tpl-actions col-span-2">
          <button class="tpl-submit" type="submit">Guardar</button>
          <button class="tpl-btn-outline" type="button" data-close>Cancelar</button>
          <span id="o_msg" style="align-self:center;color:#2a7e80;display:none"><i class="fa-solid fa-circle-check"></i> Guardado</span>
        </div>
      </form>
    </div>
  </div>

  <!-- ====== MODAL MASCOTA (ALTA/EDICIÓN RÁPIDA) ====== -->
  <div id="modal-pet" class="tpl-modal" aria-hidden="true">
    <div class="tpl-modal__backdrop" data-close></div>
    <div class="tpl-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="pet-title">
      <div class="tpl-modal__header">
        <h3 id="pet-title" class="tpl-modal__title">Mascota</h3>
        <button class="tpl-modal__close" type="button" data-close>✕</button>
      </div>
      <form id="form-pet" class="tpl-form tpl-form--2col" novalidate>
        <input type="hidden" id="p_id">
        <div class="tpl-field"><label for="p_nombre">Nombre *</label><input id="p_nombre" class="tpl-input" required></div>
        <div class="tpl-field"><label for="p_especie">Especie *</label>
          <select id="p_especie" class="tpl-select" required>
            <option value="">Elige…</option><option>Perro</option><option>Gato</option><option>Exótico</option><option>Otro</option>
          </select>
        </div>
        <div class="tpl-field"><label id="p_label_raza" for="p_raza">Raza / especie *</label><input id="p_raza" class="tpl-input" required placeholder="Escribe aquí…"></div>
        <div class="tpl-field"><label for="p_sexo">Sexo *</label>
          <select id="p_sexo" class="tpl-select" required><option value="">Elige…</option><option>Macho</option><option>Hembra</option></select>
        </div>
        <div class="tpl-field"><label for="p_edad">Edad (años) *</label><input id="p_edad" class="tpl-input" type="number" min="0" step="1" required></div>
        <div class="tpl-field"><label for="p_peso">Peso (kg) *</label><input id="p_peso" class="tpl-input" type="number" min="0" step="0.1" required></div>
        <div class="tpl-field"><label for="p_esterilizado">¿Esterilizado/a? *</label>
          <select id="p_esterilizado" class="tpl-select" required><option value="">Elige…</option><option>Sí</option><option>No</option></select>
        </div>
        <div class="tpl-field col-span-2"><label for="p_patologias">Patología / medicación (breve)</label><textarea id="p_patologias" class="tpl-textarea" rows="2"></textarea></div>
        <div class="tpl-field"><label for="p_vacunas">¿Vacunas al día? *</label>
          <select id="p_vacunas" class="tpl-select" required><option value="">Elige…</option><option>Sí</option><option>No</option></select>
        </div>
        <div class="tpl-field col-span-2"><label for="p_comportamiento">Comportamiento</label><textarea id="p_comportamiento" class="tpl-textarea" rows="2" placeholder="Sociable, tímido, reactivo…"></textarea></div>
        <div class="tpl-field col-span-2"><label for="p_comentarios">Comentarios</label><textarea id="p_comentarios" class="tpl-textarea" rows="2"></textarea></div>

        <div class="tpl-field">
          <label for="p_foto">Foto</label>
          <input id="p_foto" type="file" accept="image/*" class="tpl-input">
        </div>
        <div class="tpl-field">
          <img id="p_preview" class="tpl-photo" alt="">
        </div>

        <div class="tpl-actions col-span-2">
          <button class="tpl-submit" type="submit">Guardar</button>
          <button class="tpl-btn-outline" type="button" data-close>Cancelar</button>
          <button id="p_delete" class="tpl-btn-outline" type="button" style="margin-left:auto;display:none;color:#b00020;border-color:#b00020">Eliminar</button>
          <span id="p_msg" style="align-self:center;color:#2a7e80;display:none"><i class="fa-solid fa-circle-check"></i> Guardado</span>
        </div>
      </form>
    </div>
  </div>

  <!-- Firebase compat + config -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-storage-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDW73aFuz2AFS9VeWg_linHIRJYN4YMgTk",
      authDomain: "thepetslovers-c1111.firebaseapp.com",
      projectId: "thepetslovers-c1111",
      storageBucket: "thepetslovers-c1111.appspot.com",
      messagingSenderId: "415914577533",
      appId: "1:415914577533:web:0b7a056ebaa4f1de28ab14",
      measurementId: "G-FXPD69KXBG"
    };
  </script>

  <!-- Lógica perfil: lecturas, modales y guardas -->
  <script>
  (function(){
    // Init Firebase seguro
    if (firebase.apps.length === 0) { firebase.initializeApp(firebaseConfig); }
    const auth = firebase.auth();
    const db   = firebase.firestore();
    const st   = firebase.storage();

    // ===== util =====
    const byId = (id)=>document.getElementById(id);
    const qs   = (sel,root=document)=>root.querySelector(sel);
    const show = (el)=>{ el && (el.style.display='block'); };
    const hide = (el)=>{ el && (el.style.display='none'); };
    const showFlex = (el)=>{ el && (el.style.display='flex'); };
    const truncate = (s,n)=> (String(s||'').length>n ? String(s).slice(0,n)+'…' : (s||''));

    // ===== refs UI =====
    const bannerInc   = byId('tpl-banner-incompleto');

    const emptyCliente  = byId('tpl-cliente-empty');
    const viewCliente   = byId('tpl-cliente-view');
    const statusCliente = byId('tpl-cliente-status');
    const actionsPerfil = byId('tpl-actions-perfil');

    const mascotasEmpty = byId('tpl-mascotas-empty');
    const mascotasView  = byId('tpl-mascotas-view');
    const mascotasList  = byId('tpl-mascotas-list');
    const chipMascotas  = byId('tpl-chip-mascotas');
    const cntMascotas   = byId('tpl-count-mascotas');

    const reservasView  = byId('tpl-reservas-view');
    const reservasList  = byId('tpl-reservas-list');
    const reservasEmpty = byId('tpl-reservas-empty');
    const btnIrReserva  = byId('tpl-btn-ir-reserva');
    const pHintReserva  = qs("article[aria-labelledby='h-reservas'] p");

    // Modales
    const modalOwner = byId('modal-owner');
    const formOwner  = byId('form-owner');
    const o_msg      = byId('o_msg');

    const modalPet   = byId('modal-pet');
    const formPet    = byId('form-pet');
    const p_msg      = byId('p_msg');
    const p_delete   = byId('p_delete');
    const p_foto     = byId('p_foto');
    const p_preview  = byId('p_preview');

    // ===== helpers =====
    function openModal(modal){ modal.setAttribute('aria-hidden','false'); document.documentElement.style.overflow='hidden'; }
    function closeModal(modal){ modal.setAttribute('aria-hidden','true'); document.documentElement.style.overflow=''; }
    document.addEventListener('click', (e)=>{ if (e.target.matches('[data-close]')) closeModal(e.target.closest('.tpl-modal')); });
    document.addEventListener('keydown', (e)=>{ if (e.key==='Escape'){ [modalOwner, modalPet].forEach(m=>m.getAttribute('aria-hidden')==='false' && closeModal(m)); }});
    [modalOwner, modalPet].forEach(m=> m.addEventListener('click', (e)=>{ if (e.target.classList.contains('tpl-modal__backdrop')) closeModal(m);} ));

    function getInitials(name){ if(!name) return '—'; const parts = String(name).trim().split(/\s+/).slice(0,2); return parts.map(p=>p[0]?.toUpperCase()||'').join('')||'—'; }

    function statusBadge(status){
      const s = String(status || '').toLowerCase();
      if (s==='aceptada'||s==='aprobada') return '<span class="tpl-badge ok"><i class="fa-solid fa-check"></i> Aceptada</span>';
      if (s==='en_revision'||s==='en-revision'||s==='revision') return '<span class="tpl-badge review"><i class="fa-solid fa-hourglass-half"></i> En revisión</span>';
      if (s==='enviada'||s==='pendiente') return '<span class="tpl-badge pending"><i class="fa-regular fa-paper-plane"></i> Enviada</span>';
      if (s==='completada'||s==='finalizada') return '<span class="tpl-badge done"><i class="fa-regular fa-circle-check"></i> Completada</span>';
      if (s==='cancelada') return '<span class="tpl-badge canceled"><i class="fa-regular fa-circle-xmark"></i> Cancelada</span>';
      return '<span class="tpl-badge"><i class="fa-regular fa-circle-question"></i> —</span>';
    }

    // ===== datos =====
    async function getProfile(uid){
      // fuente oficial
      try{
        const doc = await db.collection('users').doc(uid).collection('private').doc('profile').get();
        if (doc.exists) return doc.data();
      }catch(_){}
      // fallback legacy
      try{
        const doc2 = await db.collection('users').doc(uid).get();
        if (doc2.exists && doc2.data()?.profile) return doc2.data().profile;
      }catch(_){}
      return null;
    }
    async function saveProfile(uid, data){
      await db.collection('users').doc(uid).collection('private').doc('profile').set({
        ...data,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge:true });
    }

    async function getPets(uid){
      const snap = await db.collection('users').doc(uid).collection('pets').get();
      return snap.docs.map(d=>({ id:d.id, ...d.data() }));
    }
    async function getPet(uid, id){
      const d = await db.collection('users').doc(uid).collection('pets').doc(id).get();
      return d.exists ? { id:d.id, ...d.data() } : null;
    }
    async function savePet(uid, data, id){
      if (id){
        await db.collection('users').doc(uid).collection('pets').doc(id).set({ ...data, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
        return id;
      } else {
        const ref = await db.collection('users').doc(uid).collection('pets').add({ ...data, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
        return ref.id;
      }
    }
    async function deletePet(uid, id){
      if (!id) return;
      await db.collection('users').doc(uid).collection('pets').doc(id).delete();
      // borra fotos
      try{
        const dirRef = st.ref().child(`users/${uid}/pets/${id}`);
        const list = await dirRef.listAll();
        await Promise.all(list.items.map(i=>i.delete()));
      }catch(_){}
    }
    async function uploadPetPhoto(uid, petId, file){
      const safe = (file.name||'photo.jpg').replace(/[^a-zA-Z0-9._-]/g,'_');
      const ref = st.ref().child(`users/${uid}/pets/${petId}/${Date.now()}_${safe}`);
      await ref.put(file, { contentType: file.type || 'image/jpeg' });
      return await ref.getDownloadURL();
    }

    function ensureReservationAccess(hasProfile, hasPets){
      const complete = !!(hasProfile && hasPets);
      try{ window.__TPL_PROFILE_COMPLETE__ = complete; localStorage.setItem('tplProfileComplete', complete?'1':'0'); }catch(_){}
      bannerInc.hidden = complete;
      if (pHintReserva) pHintReserva.style.display = complete ? 'none' : '';
      function guardClick(e){ e.preventDefault(); bannerInc.hidden=false; bannerInc.scrollIntoView({behavior:'smooth', block:'start'}); }
      if (btnIrReserva){
        btnIrReserva.setAttribute('aria-disabled', complete?'false':'true');
        if (!complete){
          btnIrReserva.addEventListener('click', guardClick);
          btnIrReserva.setAttribute('title','Completa tu perfil y añade una mascota para continuar');
          btnIrReserva.setAttribute('href','#');
        } else {
          btnIrReserva.replaceWith(btnIrReserva.cloneNode(true));
          const fresh = byId('tpl-btn-ir-reserva'); if (fresh){ fresh.setAttribute('href','reserva.html'); fresh.removeAttribute('aria-disabled'); fresh.removeAttribute('title'); }
        }
      }
    }

    // ===== render =====
    function updateOwnerBadge(profile){
      const complete = !!(profile && profile.nombre && profile.telefono && profile.email && profile.cp);
      statusCliente.classList.toggle('tpl-hidden', !complete);
      statusCliente.setAttribute('aria-hidden', complete ? 'false' : 'true');
      if (complete) {
        actionsPerfil.classList.add('tpl-hidden');
      } else {
        actionsPerfil.classList.remove('tpl-hidden');
      }
    }
    function renderOwner(profile){
      updateOwnerBadge(profile);
      if (profile && profile.nombre){
        byId('tpl-view-nombre').textContent    = profile.nombre || '—';
        byId('tpl-view-telefono').textContent  = profile.telefono || '—';
        byId('tpl-view-email').textContent     = profile.email || '—';
        byId('tpl-view-direccion').textContent = profile.direccion || '—';
        byId('tpl-view-cp').textContent        = profile.cp || '—';
        byId('tpl-view-pref').textContent      = profile.preferencias || '—';
        emptyCliente.classList.add('tpl-hidden');
        viewCliente.classList.remove('tpl-hidden');
      } else {
        viewCliente.classList.add('tpl-hidden');
        emptyCliente.classList.remove('tpl-hidden');
      }
    }
    function renderPets(pets){
      mascotasList.innerHTML = '';
      const count = pets ? pets.length : 0;
      if (count>0){
        mascotasEmpty.classList.add('tpl-hidden');
        mascotasView.classList.remove('tpl-hidden');
        chipMascotas.classList.remove('tpl-hidden'); chipMascotas.setAttribute('aria-hidden','false');
        cntMascotas.textContent = String(count);
        pets.forEach(p=>{
          const card = document.createElement('div'); card.className='tpl-pet';
          const avatar = document.createElement('div'); avatar.className='tpl-avatar';
          if (p.fotoUrl){ const img=document.createElement('img'); img.src=p.fotoUrl; img.alt=`Foto de ${p.nombre||'mascota'}`; avatar.appendChild(img); } else { avatar.textContent=getInitials(p.nombre); }
          const box = document.createElement('div');
          const name = document.createElement('div'); name.className='tpl-pet-name'; name.textContent=p.nombre||'—';
          const sec  = document.createElement('div'); sec.className='tpl-pet-secondary'; sec.textContent=p.especie||'—';
          box.appendChild(name); box.appendChild(sec);
          const actions = document.createElement('div'); actions.className='tpl-pet-actions';
          const edit = document.createElement('button'); edit.className='tpl-btn-sm tpl-btn-outline'; edit.textContent='Editar';
          edit.addEventListener('click', ()=> openPetModal(p));
          actions.appendChild(edit);
          card.appendChild(avatar); card.appendChild(box); card.appendChild(actions);
          mascotasList.appendChild(card);
        });
      } else {
        mascotasView.classList.add('tpl-hidden');
        mascotasEmpty.classList.remove('tpl-hidden');
        chipMascotas.classList.add('tpl-hidden'); chipMascotas.setAttribute('aria-hidden','true');
        cntMascotas.textContent = '0';
      }
    }
    function renderReservations(res){
      reservasList.innerHTML = '';
      if (!res || res.length===0){
        reservasView.classList.add('tpl-hidden');
        reservasEmpty.classList.remove('tpl-hidden');
        return;
      }
      reservasEmpty.classList.add('tpl-hidden');
      reservasView.classList.remove('tpl-hidden');
      res.sort((a,b)=> (a.startAt?.toDate?.()||new Date(8640000000000000)) - (b.startAt?.toDate?.()||new Date(8640000000000000)));
      res.forEach(r=>{
        const el = document.createElement('div'); el.className='tpl-reserva';
        const start = (r.startAt && r.startAt.toDate) ? r.startAt.toDate() : null;
        const end   = (r.endAt && r.endAt.toDate) ? r.endAt.toDate() : null;
        el.innerHTML = `
          <h3>${r.servicio || 'Servicio'}</h3>
          <div class="row"><i class="fa-regular fa-calendar"></i> ${start ? start.toLocaleDateString('es-ES') : '—'} ${end ? ' · '+end.toLocaleDateString('es-ES') : ''}</div>
          <div class="row"><i class="fa-solid fa-paw"></i> ${Array.isArray(r.mascotas)? r.mascotas.join(', ') : (r.mascotaNombre||'—')}</div>
          ${r.direccion? `<div class="row"><i class="fa-regular fa-map"></i> ${truncate(r.direccion,48)}</div>` : ''}
          <div class="row">${statusBadge(r.estado||r.status||'enviada')}</div>`;
        reservasList.appendChild(el);
      });
    }

    // ===== flujo principal =====
    async function refreshAll(uid){
      const profile = await getProfile(uid);
      renderOwner(profile);

      const pets = await getPets(uid);
      renderPets(pets);

      // acceso a reserva
      const hasProfile = !!(profile && profile.nombre && profile.telefono && profile.email && profile.cp);
      const hasPets    = pets.length > 0;
      ensureReservationAccess(hasProfile, hasPets);

      // reservas (si tienes colección; si no, se quedará vacío sin romper)
      try{
        const snap = await db.collection('users').doc(uid).collection('reservas').get();
        const list = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        renderReservations(list);
      }catch(_){ renderReservations([]); }
    }

    // ===== Owner modal logic =====
    function openOwnerModal(prefill){
      formOwner.reset(); o_msg.style.display='none';
      if (prefill){
        byId('o_nombre').value = prefill.nombre || '';
        byId('o_telefono').value = prefill.telefono || '';
        byId('o_email').value = prefill.email || '';
        byId('o_direccion').value = prefill.direccion || '';
        byId('o_cp').value = prefill.cp || '';
        byId('o_pref').value = prefill.preferencias || '';
      }
      openModal(modalOwner);
    }
    modalOwner.addEventListener('click', (e)=>{ if (e.target.dataset.close!==undefined) closeModal(modalOwner); });

    formOwner.addEventListener('submit', async (e)=>{
      e.preventDefault(); o_msg.style.display='none';
      if (!formOwner.reportValidity()) return;
      const u = auth.currentUser; if (!u) return;
      const data = {
        nombre: byId('o_nombre').value.trim(),
        telefono: byId('o_telefono').value.trim(),
        email: byId('o_email').value.trim(),
        direccion: byId('o_direccion').value.trim(),
        cp: byId('o_cp').value.trim(),
        preferencias: byId('o_pref').value.trim()
      };
      try{
        await saveProfile(u.uid, data);
        o_msg.style.display='inline';
        await refreshAll(u.uid);
        setTimeout(()=> closeModal(modalOwner), 350);
      }catch(err){ alert('No se pudo guardar el perfil: ' + (err?.message||err)); }
    });

    // botones abrir owner
    ['btn-open-owner','btn-open-owner-2'].forEach(id=>{
      const b = byId(id);
      if (b) b.addEventListener('click', async ()=>{
        const u = auth.currentUser; if (!u) return;
        const pre = await getProfile(u.uid);
        openOwnerModal(pre||null);
      });
    });

    // ===== Pet modal logic =====
    let CURRENT_PET_ID = null;
    function setupPetForm(p){
      byId('p_id').value = p?.id || '';
      byId('p_nombre').value = p?.nombre || '';
      byId('p_especie').value = p?.especie || '';
      byId('p_raza').value = p?.especie==='Exótico' ? (p?.tipoExotico||'') : (p?.raza||'');
      byId('p_sexo').value = p?.sexo || '';
      byId('p_edad').value = (p?.edad ?? '');
      byId('p_peso').value = (p?.peso ?? '');
      byId('p_esterilizado').value = p?.esterilizado || '';
      byId('p_patologias').value = p?.patologias || '';
      byId('p_vacunas').value = p?.vacunas || '';
      byId('p_comportamiento').value = p?.comportamiento || '';
      byId('p_comentarios').value = p?.comentarios || '';
      p_preview.src = p?.fotoUrl || '';
      p_delete.style.display = p?.id ? 'inline-flex' : 'none';
      adjustRazaLabel();
      p_msg.style.display='none';
      p_foto.value = '';
    }
    function adjustRazaLabel(){
      const lbl = byId('p_label_raza');
      if (byId('p_especie').value === 'Exótico'){ lbl.textContent = 'Tipo de exótico *'; }
      else { lbl.textContent = 'Raza / especie *'; }
    }
    byId('p_especie').addEventListener('change', adjustRazaLabel);

    function openPetModal(p){ setupPetForm(p||null); CURRENT_PET_ID = p?.id || null; openModal(modalPet); }
    document.getElementById('btn-open-pet').addEventListener('click', ()=> openPetModal(null));
    document.getElementById('btn-open-pet-2').addEventListener('click', ()=> openPetModal(null));

    p_foto.addEventListener('change', ()=>{
      const f = p_foto.files?.[0]; if (!f) return; const r = new FileReader();
      r.onload = e=>{ p_preview.src = e.target.result; }; r.readAsDataURL(f);
    });

    formPet.addEventListener('submit', async (e)=>{
      e.preventDefault(); p_msg.style.display='none';
      if (!formPet.reportValidity()) return;
      const u = auth.currentUser; if (!u) return;
      const isEx = byId('p_especie').value==='Exótico';
      const data = {
        nombre: byId('p_nombre').value.trim(),
        especie: byId('p_especie').value,
        raza: isEx ? '' : byId('p_raza').value.trim(),
        tipoExotico: isEx ? byId('p_raza').value.trim() : '',
        sexo: byId('p_sexo').value,
        edad: Number(byId('p_edad').value || 0),
        peso: Number(byId('p_peso').value || 0),
        esterilizado: byId('p_esterilizado').value,
        patologias: byId('p_patologias').value.trim(),
        vacunas: byId('p_vacunas').value,
        comportamiento: byId('p_comportamiento').value.trim(),
        comentarios: byId('p_comentarios').value.trim()
      };
      try{
        const id = await savePet(u.uid, data, CURRENT_PET_ID);
        // subir foto si hay
        const f = p_foto.files?.[0];
        if (f){
          const url = await uploadPetPhoto(u.uid, id, f);
          await savePet(u.uid, { fotoUrl: url }, id);
        }
        p_msg.style.display='inline';
        await refreshAll(u.uid);
        setTimeout(()=> closeModal(modalPet), 350);
      }catch(err){ alert('No se pudo guardar la mascota: ' + (err?.message||err)); }
    });

    p_delete.addEventListener('click', async ()=>{
      if (!confirm('¿Eliminar esta mascota?')) return;
      const u = auth.currentUser; if (!u || !CURRENT_PET_ID) return;
      try{
        await deletePet(u.uid, CURRENT_PET_ID);
        await refreshAll(u.uid);
        closeModal(modalPet);
      }catch(err){ alert('No se pudo eliminar: ' + (err?.message||err)); }
    });

    // ===== auth guard + primera carga =====
    auth.onAuthStateChanged(async (u)=>{
      if (!u || u.isAnonymous){
        location.href = 'iniciar-sesion.html?next=' + encodeURIComponent('perfil.html');
        return;
      }
      // prellenar email del owner con el del login si no hay perfil
      try{
        const p = await getProfile(u.uid);
        renderOwner(p);
        if (!p || !p.email){ byId('o_email').value = u.email || ''; }
      }catch(_){}
      await refreshAll(u.uid);
    });
  })();
  </script>

  <!-- Antibloqueo menor -->
  <script>
    (function(){
      try{
        document.documentElement.classList.remove('tpl-auth-boot');
        var ov = document.getElementById('tpl-form-overlay');
        if (ov) ov.classList.remove('show');
      }catch(_){}
    })();
  </script>
</body>
</html>
