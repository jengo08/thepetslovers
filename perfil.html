<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Mi perfil · The Pets Lovers</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Poppins:wght@400;700&display=swap" rel="stylesheet">
  <!-- TPL: INICIO BLOQUE NUEVO [Iconos footer visibles en esta página] -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <!-- TPL: FIN BLOQUE NUEVO -->

  <style>
    .tpl-profile{ max-width:980px; margin:120px auto 60px; padding:20px; background:#fff; border:1px solid #eee; border-radius:12px; box-shadow:0 2px 12px rgba(0,0,0,.05);}

    /* TPL: INICIO BLOQUE NUEVO [barra acciones superiores] */
    .tpl-profile-top{
      display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px;
    }
    .tpl-profile-actions{ display:flex; align-items:center; gap:8px; }
    .tpl-btn-ghost{
      background:#fff; color:#339496; border:2px solid #339496; border-radius:999px; padding:8px 14px; font-weight:700; cursor:pointer;
    }
    /* TPL: FIN BLOQUE NUEVO */

    .tpl-sub{ color:#666; margin-bottom:18px; }

    /* TPL: INICIO BLOQUE NUEVO [Grid 2 columnas + card amplia] */
    .tpl-cards{
      display:grid; gap:14px;
      grid-template-columns:repeat(auto-fit, minmax(320px, 1fr));
      align-items:start;
    }
    .tpl-card{ border:1px solid #eee; border-radius:12px; padding:16px; position:relative; background:#fff; }
    .tpl-card h2{ font-size:18px; margin:0 0 10px; color:#58425a; }
    .tpl-card-wide{ grid-column:1 / -1; } /* Reservas a todo el ancho */
    /* TPL: FIN BLOQUE NUEVO */

    .tpl-actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .cta-button{ background:#339496; color:#fff; padding:10px 16px; border-radius:999px; border:none; cursor:pointer; font-weight:700; text-align:center; }
    .link{ background:#fff; color:#339496; border:2px solid #339496; }

    /* TPL: INICIO BLOQUE NUEVO [vistas compactas + badges + anti overflow] */
    .tpl-view{ background:#fafafa; border:1px solid #eee; border-radius:10px; padding:12px; }
    .tpl-view dl{
      margin:0; display:grid; grid-template-columns: 170px 1fr; row-gap:6px; column-gap:10px;
    }
    .tpl-view dt{ font-weight:700; color:#58425a; }
    .tpl-view dd{
      margin:0; overflow-wrap:anywhere; word-break:break-word; color:#333;
    }
    @media (max-width:480px){
      .tpl-view dl{ grid-template-columns: 130px 1fr; }
    }
    .tpl-empty{ color:#666; font-style:italic; }
    .tpl-status{ position:absolute; top:12px; right:12px; font-weight:700; font-size:.9rem; display:flex; align-items:center; gap:6px; color:#2a7e80; }
    .tpl-status i{ font-size:1rem; }
    .tpl-chip{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid #e7e7e7; border-radius:999px; background:#fff; font-weight:700; color:#58425a; }
    .tpl-hidden{ display:none !important; }
    /* TPL: FIN BLOQUE NUEVO */

    /* TPL: INICIO BLOQUE NUEVO [Editar perfil pequeño] */
    .tpl-edit-small{
      position:absolute; right:12px; bottom:12px;
      font-size:.9rem; font-weight:700; color:#339496; text-decoration:none;
    }
    .tpl-edit-small i{ margin-right:6px; }
    .tpl-edit-small:focus, .tpl-edit-small:hover{ text-decoration:underline; }
    /* TPL: FIN BLOQUE NUEVO */

    /* TPL: INICIO BLOQUE NUEVO [lista de mascotas con avatar y popover] */
    .tpl-pets{
      display:grid; grid-template-columns:repeat(auto-fit, minmax(240px, 1fr)); gap:10px;
    }
    .tpl-pet{
      position:relative; display:flex; align-items:center; gap:10px;
      padding:10px; border:1px solid #eee; border-radius:12px; background:#fff;
    }
    .tpl-avatar{
      width:56px; height:56px; border-radius:50%; flex:0 0 56px; overflow:hidden; border:2px solid #e8f2f2; background:#eaf5f5; display:flex; align-items:center; justify-content:center; font-weight:700; color:#58425a;
    }
    .tpl-avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
    .tpl-pet-name{ font-weight:700; color:#58425a; line-height:1.2 }
    .tpl-pet-secondary{ font-size:.9rem; color:#666 }

    .tpl-pet-actions{ margin-left:auto; display:flex; gap:6px }
    .tpl-btn-sm{ padding:6px 10px; border-radius:999px; font-weight:700; border:none; cursor:pointer; }
    .tpl-btn-outline{ background:#fff; color:#339496; border:2px solid #339496; }

    /* Popover al pasar el ratón */
    .tpl-popover{
      position:absolute; left:10px; right:10px; top:calc(100% + 8px);
      background:#fff; border:1px solid #eee; border-radius:12px; padding:12px; box-shadow:0 8px 24px rgba(0,0,0,.08);
      opacity:0; pointer-events:none; transform:translateY(-4px); transition:opacity .15s ease, transform .15s ease;
      z-index:3;
    }
    .tpl-pet:hover .tpl-popover, .tpl-pet:focus-within .tpl-popover{ opacity:1; pointer-events:auto; transform:translateY(0); }
    .tpl-popover dl{ margin:0; display:grid; grid-template-columns:120px 1fr; row-gap:6px; column-gap:8px; }
    .tpl-popover dt{ font-weight:700; color:#58425a }
    .tpl-popover .tpl-notas{ margin-top:6px; font-size:.95rem; color:#444 }
    @media (hover:none){
      .tpl-popover{ position:static; opacity:1; pointer-events:auto; transform:none; box-shadow:none; margin-top:8px; }
    }
    /* TPL: FIN BLOQUE NUEVO */
  </style>
</head>
<body>
  <div id="tpl-navbar"></div>
  <script src="tpl-navbar.js" defer></script>

  <main class="tpl-profile" aria-labelledby="t">
    <!-- TPL: INICIO BLOQUE NUEVO [barra superior con logout discreto] -->
    <div class="tpl-profile-top">
      <h1 id="t" style="margin:0">Mi perfil</h1>
      <div class="tpl-profile-actions">
        <button type="button" class="tpl-btn-ghost" id="tpl-logout-btn" aria-label="Cerrar sesión">Cerrar sesión</button>
      </div>
    </div>
    <!-- TPL: FIN BLOQUE NUEVO -->

    <p class="tpl-sub">Gestiona tus datos y los de tus mascotas. <strong>Profesionales del sector veterinario</strong> a tu lado.</p>

    <section class="tpl-cards">

      <!-- DATOS DE CLIENTE (Card grande) -->
      <article class="tpl-card" id="tpl-card-cliente" aria-labelledby="h-cliente">
        <!-- TPL: INICIO BLOQUE NUEVO [Badge perfil completo] -->
        <div id="tpl-cliente-status" class="tpl-status tpl-hidden" aria-hidden="true">
          <i class="fa-solid fa-circle-check"></i> Perfil completo
        </div>
        <!-- TPL: FIN BLOQUE NUEVO -->

        <h2 id="h-cliente">Datos de cliente</h2>
        <p id="tpl-cliente-empty" class="tpl-empty">Aún no has creado tu perfil. Usa el botón para rellenarlo.</p>

        <!-- TPL: INICIO BLOQUE NUEVO [Vista solo lectura de datos] -->
        <div id="tpl-cliente-view" class="tpl-view tpl-hidden" aria-live="polite">
          <dl>
            <dt>Nombre</dt><dd id="tpl-view-nombre">—</dd>
            <dt>Teléfono</dt><dd id="tpl-view-telefono">—</dd>
            <dt>Email</dt><dd id="tpl-view-email">—</dd>
            <dt>Dirección</dt><dd id="tpl-view-direccion">—</dd>
            <dt>Código postal</dt><dd id="tpl-view-cp">—</dd>
            <dt>Preferencias</dt><dd id="tpl-view-pref">—</dd>
          </dl>
        </div>
        <!-- TPL: FIN BLOQUE NUEVO -->

        <div class="tpl-actions" id="tpl-actions-perfil">
          <a class="cta-button" id="tpl-btn-perfil" href="registro.html?next=perfil.html">Rellenar / Editar perfil</a>
        </div>

        <!-- TPL: INICIO BLOQUE NUEVO [enlace pequeño editar cuando perfil completo] -->
        <a id="tpl-link-editar" href="registro.html?next=perfil.html" class="tpl-edit-small tpl-hidden" aria-hidden="true">
          <i class="fa-solid fa-pen-to-square"></i> Editar perfil
        </a>
        <!-- TPL: FIN BLOQUE NUEVO -->
      </article>

      <!-- MASCOTAS (Card grande) -->
      <article class="tpl-card" id="tpl-card-mascotas" aria-labelledby="h-mascotas">
        <h2 id="h-mascotas">Mis mascotas</h2>
        <!-- TPL: INICIO BLOQUE NUEVO [Chip conteo] -->
        <div id="tpl-chip-mascotas" class="tpl-chip tpl-hidden" aria-hidden="true">
          <i class="fa-solid fa-paw"></i> <span id="tpl-count-mascotas">0</span>
        </div>
        <!-- TPL: FIN BLOQUE NUEVO -->

        <p id="tpl-mascotas-empty" class="tpl-empty">Aún no has añadido mascotas.</p>

        <!-- TPL: INICIO BLOQUE NUEVO [Grid con tarjetas + hover + foto automática] -->
        <div id="tpl-mascotas-view" class="tpl-view tpl-hidden" aria-live="polite">
          <div id="tpl-mascotas-list" class="tpl-pets"></div>
        </div>
        <!-- TPL: FIN BLOQUE NUEVO -->

        <div class="tpl-actions">
          <!-- TPL: INICIO BLOQUE NUEVO [Solo "Añadir mascota"] -->
          <a class="cta-button link" id="tpl-btn-mascota-nueva" href="perfil-mascotas.html?mode=new">Añadir mascota</a>
          <!-- TPL: FIN BLOQUE NUEVO -->
        </div>
      </article>

      <!-- RESERVAS (al final, ancho completo) -->
      <article class="tpl-card tpl-card-wide" aria-labelledby="h-reservas">
        <h2 id="h-reservas">Reservas</h2>
        <p>Cuando tu perfil esté completo podrás reservar.</p>
        <div class="tpl-actions">
          <a class="cta-button" href="reserva.html">Ir a reservar</a>
        </div>
      </article>

    </section>
  </main>

  <div id="tpl-footer"></div>
  <script src="tpl-footer.js" defer></script>

  <!-- TPL: INICIO BLOQUE NUEVO [Firebase compat + tu configuración] -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
  <script>
    // Tu proyecto Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDW73aFuz2AFS9VeWg_linHIRJYN4YMgTk",
      authDomain: "thepetslovers-c1111.firebaseapp.com",
      projectId: "thepetslovers-c1111",
      storageBucket: "thepetslovers-c1111.firebasestorage.app",
      messagingSenderId: "415914577533",
      appId: "1:415914577533:web:0b7a056ebaa4f1de28ab14",
      measurementId: "G-FXPD69KXBG"
    };
  </script>
  <!-- TPL: FIN BLOQUE NUEVO -->

  <!-- TPL: INICIO BLOQUE NUEVO [Lectura Firestore + render + logout + UI condiciones] -->
  <script>
    (function(){
      const app = firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();

      const LS_PROFILE_KEY = 'tpl-profile';
      const LS_PETS_KEY = 'tpl-pets';

      // Refs UI
      const emptyCliente  = document.getElementById('tpl-cliente-empty');
      const viewCliente   = document.getElementById('tpl-cliente-view');
      const statusCliente = document.getElementById('tpl-cliente-status');
      const actionsPerfil = document.getElementById('tpl-actions-perfil');
      const linkEditar    = document.getElementById('tpl-link-editar');

      const mascotasEmpty = document.getElementById('tpl-mascotas-empty');
      const mascotasView  = document.getElementById('tpl-mascotas-view');
      const mascotasList  = document.getElementById('tpl-mascotas-list');
      const chipMascotas  = document.getElementById('tpl-chip-mascotas');
      const cntMascotas   = document.getElementById('tpl-count-mascotas');

      const logoutBtn     = document.getElementById('tpl-logout-btn');

      function updateBadge(profile){
        const complete = !!(profile && profile.nombre && profile.telefono && profile.email && profile.cp);
        statusCliente.classList.toggle('tpl-hidden', !complete);
        statusCliente.setAttribute('aria-hidden', complete ? 'false' : 'true');

        // CTA grande vs enlace pequeño
        if (complete) {
          if (actionsPerfil) actionsPerfil.classList.add('tpl-hidden');
          if (linkEditar) {
            linkEditar.classList.remove('tpl-hidden');
            linkEditar.setAttribute('aria-hidden','false');
          }
        } else {
          if (actionsPerfil) actionsPerfil.classList.remove('tpl-hidden');
          if (linkEditar) {
            linkEditar.classList.add('tpl-hidden');
            linkEditar.setAttribute('aria-hidden','true');
          }
        }
      }

      async function getProfile(uid){
        if (uid) {
          const doc = await db.collection('users').doc(uid).collection('private').doc('profile').get();
          return doc.exists ? doc.data() : null;
        }
        try { return JSON.parse(localStorage.getItem(LS_PROFILE_KEY) || 'null'); } catch(e){ return null; }
      }

      async function getPets(uid){
        if (uid) {
          const snap = await db.collection('users').doc(uid).collection('pets').get();
          return snap.docs.map(d => ({ id: d.id, ...d.data() }));
        }
        try { return JSON.parse(localStorage.getItem(LS_PETS_KEY) || '[]'); } catch(e){ return []; }
      }

      function petEditHref(pet, idx, isFirebase){
        return (isFirebase && pet.id)
          ? ('perfil-mascotas.html?id=' + encodeURIComponent(pet.id))
          : ('perfil-mascotas.html?idx=' + encodeURIComponent(idx));
      }

      // Helpers
      function getInitials(name){
        if(!name) return '—';
        const parts = String(name).trim().split(/\s+/).slice(0,2);
        return parts.map(p=>p[0]?.toUpperCase()||'').join('') || '—';
      }
      function fmt(val, fallback='—'){
        return (val===0 || !!val) ? String(val) : fallback;
      }

      async function render(uid){
        const isFirebase = !!uid;

        // ----- Perfil
        const profile = await getProfile(uid);
        updateBadge(profile);
        if (profile && profile.nombre) {
          document.getElementById('tpl-view-nombre').textContent    = profile.nombre || '—';
          document.getElementById('tpl-view-telefono').textContent  = profile.telefono || '—';
          document.getElementById('tpl-view-email').textContent     = profile.email || '—';
          document.getElementById('tpl-view-direccion').textContent = profile.direccion || '—';
          document.getElementById('tpl-view-cp').textContent        = profile.cp || '—';
          document.getElementById('tpl-view-pref').textContent      = profile.preferencias || '—';
          emptyCliente.classList.add('tpl-hidden');
          viewCliente.classList.remove('tpl-hidden');
        } else {
          viewCliente.classList.add('tpl-hidden');
          emptyCliente.classList.remove('tpl-hidden');
        }

        // ----- Mascotas
        const pets = await getPets(uid);
        mascotasList.innerHTML = '';
        const count = pets ? pets.length : 0;

        if (count > 0) {
          mascotasEmpty.classList.add('tpl-hidden');
          mascotasView.classList.remove('tpl-hidden');
          chipMascotas.classList.remove('tpl-hidden');
          chipMascotas.setAttribute('aria-hidden','false');
          cntMascotas.textContent = String(count);

          pets.forEach((p, idx) => {
            const especie = p.especie || '—';
            const edad    = (p.edad || p.edadAnios || p.anios) ?? '—';
            const peso    = p.peso ?? '—';
            const sexo    = p.sexo || p.genero || '—';
            const ester   = (p.esterilizado===true || p.esterilizada===true) ? 'Sí' : (p.esterilizado===false || p.esterilizada===false) ? 'No' : '—';
            const notas   = p.notas || p.comentarios || '';

            const card   = document.createElement('div');
            card.className = 'tpl-pet';

            // Avatar: fotoUrl si existe; si no, iniciales
            const avatar = document.createElement('div');
            avatar.className = 'tpl-avatar';
            if (p.fotoUrl){
              const img = document.createElement('img');
              img.src = p.fotoUrl;
              img.alt = `Foto de ${p.nombre || 'la mascota'}`;
              avatar.appendChild(img);
            } else {
              avatar.textContent = getInitials(p.nombre);
            }

            const textBox = document.createElement('div');
            const nameEl  = document.createElement('div');
            nameEl.className = 'tpl-pet-name';
            nameEl.textContent = p.nombre || '—';

            const secEl   = document.createElement('div');
            secEl.className = 'tpl-pet-secondary';
            secEl.textContent = especie;

            textBox.appendChild(nameEl);
            textBox.appendChild(secEl);

            const actions = document.createElement('div');
            actions.className = 'tpl-pet-actions';
            const edit = document.createElement('a');
            edit.textContent = 'Editar';
            edit.className = 'tpl-btn-sm tpl-btn-outline';
            edit.setAttribute('href', petEditHref(p, idx, isFirebase));
            actions.appendChild(edit);

            // Popover con detalles
            const pop = document.createElement('div');
            pop.className = 'tpl-popover';
            pop.setAttribute('role','dialog');
            pop.setAttribute('aria-label', `Detalles de ${p.nombre || 'mascota'}`);
            pop.innerHTML = `
              <dl>
                <dt>Especie</dt><dd>${fmt(especie)}</dd>
                <dt>Edad</dt><dd>${fmt(edad)}</dd>
                <dt>Peso</dt><dd>${fmt(peso)}</dd>
                <dt>Sexo</dt><dd>${fmt(sexo)}</dd>
                <dt>Esterilizado</dt><dd>${fmt(ester)}</dd>
              </dl>
              ${notas ? `<div class="tpl-notas"><strong>Notas:</strong> ${fmt(notas,'')}</div>` : ''}
            `;

            card.appendChild(avatar);
            card.appendChild(textBox);
            card.appendChild(actions);
            card.appendChild(pop);

            mascotasList.appendChild(card);
          });
        } else {
          mascotasView.classList.add('tpl-hidden');
          mascotasEmpty.classList.remove('tpl-hidden');
          chipMascotas.classList.add('tpl-hidden');
          chipMascotas.setAttribute('aria-hidden','true');
          cntMascotas.textContent = '0';
        }
      }

      // Logout robusto
      async function doLogout(){
        try { await auth.signOut(); } catch(e) { console.warn('signOut:', e); }
        localStorage.removeItem(LS_PROFILE_KEY);
        localStorage.removeItem(LS_PETS_KEY);
        alert('Has cerrado sesión.');
        location.href = 'index.html';
      }
      if (logoutBtn) logoutBtn.addEventListener('click', doLogout);

      // Sesión
      auth.onAuthStateChanged(async (u) => {
        await render(u ? u.uid : null);
      });
    })();
  </script>
  <!-- TPL: FIN BLOQUE NUEVO -->
</body>
</html>
