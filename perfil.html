<script>
/* ================================
   TPL · PERFIL.HTML — SCRIPT COMPLETO
   Carga Firebase de forma segura, lee perfil + mascotas,
   tolera errores de permisos/red y nunca deja la página en blanco.
   ================================ */
(async function(){
  // ---------- Cargador de Firebase (compat) ----------
  function loadScript(src){
    return new Promise((res, rej)=>{
      const s = document.createElement('script');
      s.src = src; s.async = true;
      s.onload = res;
      s.onerror = ()=>rej(new Error('No se pudo cargar: '+src));
      document.head.appendChild(s);
    });
  }
  async function ensureFirebase(){
    if (typeof firebase === 'undefined'){
      await loadScript('https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js');
    }
    if (!('auth' in firebase)){
      await loadScript('https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js');
    }
    if (!('firestore' in firebase)){
      await loadScript('https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js');
    }
    // Config: usa la global si ya la declaraste en otra parte; si no, ponemos la tuya
    if (!window.firebaseConfig){
      window.firebaseConfig = {
        apiKey: "AIzaSyDW73aFuz2AFS9VeWg_linHIRJYN4YMgTk",
        authDomain: "thepetslovers-c1111.firebaseapp.com",
        projectId: "thepetslovers-c1111",
        storageBucket: "thepetslovers-c1111.appspot.com",
        messagingSenderId: "415914577533",
        appId: "1:415914577533:web:0b7a056ebaa4f1de28ab14",
        measurementId: "G-FXPD69KXBG"
      };
    }
  }

  try {
    await ensureFirebase();
  } catch (e){
    console.error('TPL Firebase loader error:', e);
  }

  // ✅ CLAVE: inicializar SIEMPRE con la config correcta
  const cfg = window.firebaseConfig || {};
  try {
    if (firebase && firebase.apps && firebase.apps.length === 0){
      firebase.initializeApp(cfg);
    }
  } catch(e){
    console.warn('TPL init app warning:', e);
  }

  // ---------- Instancias ----------
  const auth = (firebase && firebase.auth) ? firebase.auth() : null;
  const db   = (firebase && firebase.firestore) ? firebase.firestore() : null;

  // ---------- Refs DOM (null-safe) ----------
  const $ = (id)=> document.getElementById(id);

  const bannerInc   = $('tpl-banner-incompleto');

  const emptyCliente  = $('tpl-cliente-empty');
  const viewCliente   = $('tpl-cliente-view');
  const statusCliente = $('tpl-cliente-status');
  const actionsPerfil = $('tpl-actions-perfil');
  const linkEditar    = $('tpl-link-editar');

  const mascotasEmpty = $('tpl-mascotas-empty');
  const mascotasView  = $('tpl-mascotas-view');
  const mascotasList  = $('tpl-mascotas-list');
  const chipMascotas  = $('tpl-chip-mascotas');
  const cntMascotas   = $('tpl-count-mascotas');

  const logoutBtn     = $('tpl-logout-btn');

  // ---------- Storage local (fallback) ----------
  const LS_PROFILE_KEY = 'tpl-profile';
  const LS_PETS_KEY    = 'tpl-pets';

  const permErr = (e)=> !!(e && (e.code === 'permission-denied' || /insufficient permissions/i.test(e.message||'')));

  // ---------- UI helpers ----------
  function updateBadge(profile){
    const complete = !!(profile && profile.nombre && profile.telefono && profile.email && profile.cp);
    if (statusCliente){
      statusCliente.classList.toggle('tpl-hidden', !complete);
      statusCliente.setAttribute('aria-hidden', complete ? 'false' : 'true');
    }
    if (actionsPerfil && linkEditar){
      if (complete){
        actionsPerfil.classList.add('tpl-hidden');
        linkEditar.classList.remove('tpl-hidden');
        linkEditar.setAttribute('aria-hidden','false');
      } else {
        actionsPerfil.classList.remove('tpl-hidden');
        linkEditar.classList.add('tpl-hidden');
        linkEditar.setAttribute('aria-hidden','true');
      }
    }
    if (bannerInc) bannerInc.hidden = complete;
  }

  function setText(id, val){
    const el = $(id);
    if (el) el.textContent = (val ?? '—');
  }

  // ---------- Data: Perfil ----------
  async function getProfile(uid){
    // Intenta Firestore primero
    if (db && uid){
      try{
        const snap = await db.collection('users').doc(uid).collection('private').doc('profile').get();
        if (snap.exists) return snap.data();
      }catch(e){
        if (!permErr(e)) console.warn('TPL perfil:getProfile error', e);
      }
    }
    // Fallback local
    try{ return JSON.parse(localStorage.getItem(LS_PROFILE_KEY) || 'null'); }
    catch(_){ return null; }
  }

  // ---------- Data: Mascotas ----------
  async function getPets(uid){
    if (db && uid){
      try{
        const snap = await db.collection('users').doc(uid).collection('pets').get();
        return snap.docs.map(d=>({ id:d.id, ...d.data() }));
      }catch(e){
        if (!permErr(e)) console.warn('TPL perfil:getPets error', e);
      }
    }
    try{ return JSON.parse(localStorage.getItem(LS_PETS_KEY) || '[]'); }
    catch(_){ return []; }
  }

  // ---------- Render: Perfil ----------
  function renderProfile(p){
    if (p && (p.nombre || p.telefono || p.email || p.cp)){
      setText('tpl-view-nombre',    p.nombre || '—');
      setText('tpl-view-telefono',  p.telefono || '—');
      setText('tpl-view-email',     p.email || '—');
      setText('tpl-view-direccion', p.direccion || '—');
      setText('tpl-view-cp',        p.cp || '—');
      setText('tpl-view-pref',      p.preferencias || '—');

      if (emptyCliente) emptyCliente.classList.add('tpl-hidden');
      if (viewCliente)  viewCliente.classList.remove('tpl-hidden');
    } else {
      if (viewCliente)  viewCliente.classList.add('tpl-hidden');
      if (emptyCliente) emptyCliente.classList.remove('tpl-hidden');
    }
    updateBadge(p);
  }

  // ---------- Render: Mascotas ----------
  function petEditHref(p, idx, isFirebase){
    return (isFirebase && p.id)
      ? ('perfil-mascotas.html?id=' + encodeURIComponent(p.id) + '&next=perfil.html')
      : ('perfil-mascotas.html?idx=' + encodeURIComponent(idx) + '&next=perfil.html');
  }

  function renderPets(pets, isFirebase){
    if (!mascotasList) return;

    mascotasList.innerHTML = '';
    const count = Array.isArray(pets) ? pets.length : 0;

    if (count > 0){
      mascotasEmpty && mascotasEmpty.classList.add('tpl-hidden');
      mascotasView  && mascotasView.classList.remove('tpl-hidden');
      if (chipMascotas){
        chipMascotas.classList.remove('tpl-hidden');
        chipMascotas.setAttribute('aria-hidden','false');
      }
      if (cntMascotas) cntMascotas.textContent = String(count);

      pets.forEach((p, idx)=>{
        const card = document.createElement('div'); card.className='tpl-pet';

        // Avatar (usa fotoDataUrl si existe; si no, fotoUrl; si no, iniciales)
        const avatar = document.createElement('div'); avatar.className='tpl-avatar';
        const src = p.fotoDataUrl || p.fotoUrl || '';
        if (src){
          const img = document.createElement('img');
          img.src = src; img.alt = `Foto de ${p.nombre||'mascota'}`;
          avatar.appendChild(img);
        } else {
          const initials = (p.nombre||'').trim().split(/\s+/).slice(0,2).map(s=>s[0]?.toUpperCase()||'').join('') || '—';
          avatar.textContent = initials;
        }

        const text = document.createElement('div');
        const n = document.createElement('div'); n.className='tpl-pet-name'; n.textContent = p.nombre || '—';
        const s = document.createElement('div'); s.className='tpl-pet-secondary'; s.textContent = p.especie || '—';
        text.appendChild(n); text.appendChild(s);

        const actions = document.createElement('div'); actions.style.marginLeft='auto';
        const edit = document.createElement('a');
        edit.className='tpl-btn-sm tpl-btn-outline';
        edit.textContent='Editar';
        edit.href = petEditHref(p, idx, isFirebase);
        actions.appendChild(edit);

        card.appendChild(avatar); card.appendChild(text); card.appendChild(actions);
        mascotasList.appendChild(card);
      });
    } else {
      mascotasView  && mascotasView.classList.add('tpl-hidden');
      mascotasEmpty && mascotasEmpty.classList.remove('tpl-hidden');
      if (chipMascotas){
        chipMascotas.classList.add('tpl-hidden');
        chipMascotas.setAttribute('aria-hidden','true');
      }
      if (cntMascotas) cntMascotas.textContent = '0';
    }

    // Banner de “Perfil incompleto”
    const hasProfile = !!(
      ( $('tpl-view-nombre')?.textContent || '' ).trim() &&
      ( $('tpl-view-telefono')?.textContent || '' ).trim() &&
      ( $('tpl-view-cp')?.textContent || '' ).trim()
    );
    const hasPets = count > 0;
    if (bannerInc) bannerInc.hidden = (hasProfile && hasPets);
  }

  // ---------- Orquestador ----------
  async function render(uid){
    const isFirebase = !!uid;
    const profile = await getProfile(uid);
    renderProfile(profile);
    const pets = await getPets(uid);
    renderPets(pets, isFirebase);
  }

  // ---------- Logout ----------
  logoutBtn && logoutBtn.addEventListener('click', async (e)=>{
    e.preventDefault();
    try { await auth?.signOut(); } catch(_){}
    try {
      localStorage.removeItem('tpl_auth_email');
      localStorage.removeItem('tpl_auth_uid');
      localStorage.removeItem('tplProfileComplete');
      // (opcional) mirrors tuyos:
      // localStorage.removeItem('tpl-profile');
      // localStorage.removeItem('tpl-pets');
    } catch(_){}
    location.href = 'index.html';
  });

  // ---------- Guard de sesión ----------
  if (!auth){
    console.error('TPL: Firebase Auth no disponible');
    // Pinta “vacío” en ausencia de auth para evitar página en blanco
    renderProfile(null);
    renderPets([], false);
    return;
  }

  auth.onAuthStateChanged(async (u)=>{
    if (u && !u.isAnonymous){
      try { await render(u.uid); }
      catch(e){ console.error('TPL render error:', e); }
    } else {
      location.href = 'iniciar-sesion.html?next=' + encodeURIComponent('perfil.html');
    }
  });

})();
</script>
