<!DOCTYPE html> 
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Mi perfil · The Pets Lovers</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Poppins:wght@400;700&display=swap" rel="stylesheet">
  <!-- TPL: INICIO BLOQUE NUEVO [Iconos footer visibles en esta página] -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <!-- TPL: FIN BLOQUE NUEVO -->

  <style>
    .tpl-profile{ max-width:980px; margin:120px auto 60px; padding:20px; background:#fff; border:1px solid #eee; border-radius:12px; box-shadow:0 2px 12px rgba(0,0,0,.05);}

    /* TPL: INICIO BLOQUE NUEVO [barra acciones superiores] */
    .tpl-profile-top{
      display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px;
    }
    .tpl-profile-actions{ display:flex; align-items:center; gap:8px; }
    .tpl-btn-ghost{
      background:#fff; color:#339496; border:2px solid #339496; border-radius:999px; padding:8px 14px; font-weight:700; cursor:pointer;
    }
    /* TPL: FIN BLOQUE NUEVO */

    .tpl-sub{ color:#666; margin-bottom:18px; }

    /* TPL: INICIO BLOQUE NUEVO [Grid 2 columnas + card amplia] */
    .tpl-cards{
      display:grid; gap:14px;
      grid-template-columns:repeat(auto-fit, minmax(320px, 1fr));
      align-items:start;
    }
    .tpl-card{ border:1px solid #eee; border-radius:12px; padding:16px; position:relative; background:#fff; }
    .tpl-card h2{ font-size:18px; margin:0 0 10px; color:#58425a; }
    .tpl-card-wide{ grid-column:1 / -1; } /* Reservas a todo el ancho */
    /* TPL: FIN BLOQUE NUEVO */

    .tpl-actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .cta-button{ background:#339496; color:#fff; padding:10px 16px; border-radius:999px; border:none; cursor:pointer; font-weight:700; text-align:center; }
    .link{ background:#fff; color:#339496; border:2px solid #339496; }

    /* TPL: INICIO BLOQUE NUEVO [vistas compactas + badges + anti overflow] */
    .tpl-view{ background:#fafafa; border:1px solid #eee; border-radius:10px; padding:12px; }
    .tpl-view dl{
      margin:0; display:grid; grid-template-columns: 170px 1fr; row-gap:6px; column-gap:10px;
    }
    .tpl-view dt{ font-weight:700; color:#58425a; }
    .tpl-view dd{
      margin:0; overflow-wrap:anywhere; word-break:break-word; color:#333;
    }
    @media (max-width:480px){
      .tpl-view dl{ grid-template-columns: 130px 1fr; }
    }
    .tpl-empty{ color:#666; font-style:italic; }
    .tpl-status{ position:absolute; top:12px; right:12px; font-weight:700; font-size:.9rem; display:flex; align-items:center; gap:6px; color:#2a7e80; }
    .tpl-status i{ font-size:1rem; }
    .tpl-chip{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid #e7e7e7; border-radius:999px; background:#fff; font-weight:700; color:#58425a; }
    .tpl-hidden{ display:none !important; }
    /* TPL: FIN BLOQUE NUEVO */

    /* TPL: INICIO BLOQUE NUEVO [Editar perfil pequeño] */
    .tpl-edit-small{
      position:absolute; right:12px; bottom:12px;
      font-size:.9rem; font-weight:700; color:#339496; text-decoration:none;
    }
    .tpl-edit-small i{ margin-right:6px; }
    .tpl-edit-small:focus, .tpl-edit-small:hover{ text-decoration:underline; }
    /* TPL: FIN BLOQUE NUEVO */

    /* TPL: INICIO BLOQUE NUEVO [lista de mascotas con avatar y popover] */
    .tpl-pets{
      display:grid; grid-template-columns:repeat(auto-fit, minmax(240px, 1fr)); gap:10px;
    }
    .tpl-pet{
      position:relative; display:flex; align-items:center; gap:10px;
      padding:10px; border:1px solid #eee; border-radius:12px; background:#fff;
    }
    .tpl-avatar{
      width:56px; height:56px; border-radius:50%; flex:0 0 56px; overflow:hidden; border:2px solid #e8f2f2; background:#eaf5f5; display:flex; align-items:center; justify-content:center; font-weight:700; color:#58425a;
    }
    .tpl-avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
    .tpl-pet-name{ font-weight:700; color:#58425a; line-height:1.2 }
    .tpl-pet-secondary{ font-size:.9rem; color:#666 }

    .tpl-pet-actions{ margin-left:auto; display:flex; gap:6px }
    .tpl-btn-sm{ padding:6px 10px; border-radius:999px; font-weight:700; border:none; cursor:pointer; }
    .tpl-btn-outline{ background:#fff; color:#339496; border:2px solid #339496; }

    .tpl-popover{
      position:absolute; left:10px; right:10px; top:calc(100% + 8px);
      background:#fff; border:1px solid #eee; border-radius:12px; padding:12px; box-shadow:0 8px 24px rgba(0,0,0,.08);
      opacity:0; pointer-events:none; transform:translateY(-4px); transition:opacity .15s ease, transform .15s ease;
      z-index:3;
    }
    .tpl-pet:hover .tpl-popover, .tpl-pet:focus-within .tpl-popover{ opacity:1; pointer-events:auto; transform:translateY(0); }
    .tpl-popover dl{ margin:0; display:grid; grid-template-columns:120px 1fr; row-gap:6px; column-gap:8px; }
    .tpl-popover dt{ font-weight:700; color:#58425a }
    .tpl-popover .tpl-notas{ margin-top:6px; font-size:.95rem; color:#444 }
    @media (hover:none){
      .tpl-popover{ position:static; opacity:1; pointer-events:auto; transform:none; box-shadow:none; margin-top:8px; }
    }
    /* TPL: FIN BLOQUE NUEVO */

    /* TPL: INICIO BLOQUE NUEVO [Banner bloqueo reservas + Reservas list] */
    .tpl-banner-warning{
      display:flex; gap:10px; align-items:flex-start; margin:10px 0 14px;
      padding:10px 12px; border:1px dashed #339496; border-radius:12px; background:#f0fbfb; color:#2a7e80;
    }
    .tpl-banner-warning i{ margin-top:2px; }

    .tpl-reservas{ display:grid; gap:10px; grid-template-columns:repeat(auto-fit, minmax(260px,1fr)); }
    .tpl-reserva{ border:1px solid #eee; border-radius:12px; padding:12px; background:#fff; position:relative; }
    .tpl-reserva h3{ margin:0 0 6px; font-size:1rem; color:#58425a; }
    .tpl-reserva .row{ display:flex; gap:10px; align-items:center; font-size:.95rem; color:#333; margin:4px 0; }
    .tpl-badge{ display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; font-weight:700; font-size:.85rem; border:1px solid #eee; background:#fafafa; color:#58425a; }
    .tpl-badge.ok{ background:#e9fbf4; border-color:#bfe7d3; color:#1f7a5a; }
    .tpl-badge.pending{ background:#fff8e6; border-color:#ffe4a3; color:#906500; }
    .tpl-badge.canceled{ background:#ffeaea; border-color:#ffcccc; color:#9a1f1f; }
    .tpl-badge.done{ background:#eef0ff; border-color:#d8ddff; color:#2833a7; }
    .tpl-badge.review{ background:#f0f6ff; border-color:#d6e7ff; color:#285f9a; }
    .tpl-soon{ position:absolute; right:12px; top:12px; font-weight:800; font-size:.85rem; }
    /* TPL: FIN BLOQUE NUEVO */

    /* =========================
       TPL: INICIO BLOQUE NUEVO [MODAL PERFIL PROPIETARIO]
       ========================= */
    .tpl-modal{position:fixed;inset:0;z-index:9999;display:none}
    .tpl-modal[aria-hidden="false"]{display:block}
    .tpl-modal__backdrop{position:absolute;inset:0;background:rgba(0,0,0,.45)}
    .tpl-modal__dialog{position:relative;max-width:640px;margin:6vh auto;background:#fff;border-radius:12px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.2)}
    .tpl-modal__header{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px}
    .tpl-modal__title{font-size:1.1rem;font-weight:700;margin:0;color:#58425a}
    .tpl-modal__close{appearance:none;border:none;background:#f3f3f3;border-radius:8px;padding:8px 10px;cursor:pointer}
    .tpl-modal__close:hover{background:#e9e9e9}
    .tpl-form{display:grid;gap:12px}
    @media (min-width:760px){.tpl-form{grid-template-columns:1fr 1fr}}
    .tpl-form .full{grid-column:1 / -1}
    .tpl-input,.tpl-select,.tpl-textarea{width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;font:inherit}
    .tpl-submit{background:#339496;color:#fff;border:none;border-radius:8px;padding:12px 16px;font-weight:700;cursor:pointer}
    .tpl-submit:hover{background:#2a7e80}
    .tpl-help{font-size:.9rem;color:#555}
    /* =========================
       TPL: FIN BLOQUE NUEVO
       ========================= */
  </style>
</head>
<body>
  <div id="tpl-navbar"></div>
  <script src="tpl-navbar.js" defer></script>

  <main class="tpl-profile" aria-labelledby="t">
    <!-- TPL: INICIO BLOQUE NUEVO [barra superior con logout discreto] -->
    <div class="tpl-profile-top">
      <h1 id="t" style="margin:0">Mi perfil</h1>
      <div class="tpl-profile-actions">
        <button type="button" class="tpl-btn-ghost" id="tpl-logout-btn" aria-label="Cerrar sesión">Cerrar sesión</button>
      </div>
    </div>
    <!-- TPL: FIN BLOQUE NUEVO -->

    <!-- TPL: INICIO BLOQUE NUEVO [Banner “Perfil incompleto”] -->
    <section id="tpl-banner-incompleto" class="tpl-banner-warning" hidden>
      <i class="fa-solid fa-circle-exclamation" aria-hidden="true"></i>
      <div>
        <strong>Perfil incompleto.</strong> Para poder reservar, completa tus datos y añade al menos una mascota.
        <div style="margin-top:6px;">
          <a id="completar" class="cta-button link" href="#editar-perfil">Completar perfil</a>
          <a class="cta-button link" href="perfil-mascotas.html?mode=new">Añadir mascota</a>
        </div>
      </div>
    </section>
    <!-- TPL: FIN BLOQUE NUEVO -->

    <p class="tpl-sub">Gestiona tus datos y los de tus mascotas. <strong>Profesionales del sector veterinario</strong> a tu lado.</p>

    <section class="tpl-cards">

      <!-- DATOS DE CLIENTE (Card grande) -->
      <article class="tpl-card" id="tpl-card-cliente" aria-labelledby="h-cliente">
        <!-- TPL: INICIO BLOQUE NUEVO [Badge perfil completo] -->
        <div id="tpl-cliente-status" class="tpl-status tpl-hidden" aria-hidden="true">
          <i class="fa-solid fa-circle-check"></i> Perfil completo
        </div>
        <!-- TPL: FIN BLOQUE NUEVO -->

        <h2 id="h-cliente">Datos de cliente</h2>
        <p id="tpl-cliente-empty" class="tpl-empty">Aún no has creado tu perfil. Usa el botón para rellenarlo.</p>

        <!-- TPL: INICIO BLOQUE NUEVO [Vista solo lectura de datos] -->
        <div id="tpl-cliente-view" class="tpl-view tpl-hidden" aria-live="polite">
          <dl>
            <dt>Nombre</dt><dd id="tpl-view-nombre">—</dd>
            <dt>Teléfono</dt><dd id="tpl-view-telefono">—</dd>
            <dt>Email</dt><dd id="tpl-view-email">—</dd>
            <dt>Dirección</dt><dd id="tpl-view-direccion">—</dd>
            <dt>Código postal</dt><dd id="tpl-view-cp">—</dd>
            <dt>Preferencias</dt><dd id="tpl-view-pref">—</dd>
          </dl>
        </div>
        <!-- TPL: FIN BLOQUE NUEVO -->

        <div class="tpl-actions" id="tpl-actions-perfil">
          <a class="cta-button" id="tpl-btn-perfil" href="#editar-perfil">Rellenar / Editar perfil</a>
        </div>

        <!-- TPL: INICIO BLOQUE NUEVO [enlace pequeño editar cuando perfil completo] -->
        <a id="tpl-link-editar" href="#editar-perfil" class="tpl-edit-small tpl-hidden" aria-hidden="true">
          <i class="fa-solid fa-pen-to-square"></i> Editar perfil
        </a>
        <!-- TPL: FIN BLOQUE NUEVO -->
      </article>

      <!-- MASCOTAS (Card grande) -->
      <article class="tpl-card" id="tpl-card-mascotas" aria-labelledby="h-mascotas">
        <h2 id="h-mascotas">Mis mascotas</h2>
        <!-- TPL: INICIO BLOQUE NUEVO [Chip conteo] -->
        <div id="tpl-chip-mascotas" class="tpl-chip tpl-hidden" aria-hidden="true">
          <i class="fa-solid fa-paw"></i> <span id="tpl-count-mascotas">0</span>
        </div>
        <!-- TPL: FIN BLOQUE NUEVO -->

        <p id="tpl-mascotas-empty" class="tpl-empty">Aún no has añadido mascotas.</p>

        <!-- TPL: INICIO BLOQUE NUEVO [Grid con tarjetas + hover + foto automática] -->
        <div id="tpl-mascotas-view" class="tpl-view tpl-hidden" aria-live="polite">
          <div id="tpl-mascotas-list" class="tpl-pets"></div>
        </div>
        <!-- TPL: FIN BLOQUE NUEVO -->

        <div class="tpl-actions">
          <!-- TPL: INICIO BLOQUE NUEVO [Solo "Añadir mascota"] -->
          <a class="cta-button link" id="tpl-btn-mascota-nueva" href="perfil-mascotas.html?mode=new">Añadir mascota</a>
          <!-- TPL: FIN BLOQUE NUEVO -->
        </div>
      </article>

      <!-- RESERVAS (al final, ancho completo) -->
      <article class="tpl-card tpl-card-wide" aria-labelledby="h-reservas">
        <h2 id="h-reservas">Reservas</h2>
        <p>Cuando tu perfil esté completo podrás reservar.</p>

        <!-- TPL: INICIO BLOQUE NUEVO [Vista reservas + estados + proximidad] -->
        <div id="tpl-reservas-view" class="tpl-view tpl-hidden" aria-live="polite">
          <div id="tpl-reservas-list" class="tpl-reservas"></div>
        </div>
        <p id="tpl-reservas-empty" class="tpl-empty tpl-hidden">Aún no tienes reservas.</p>
        <!-- TPL: FIN BLOQUE NUEVO -->

        <div class="tpl-actions">
          <a class="cta-button" id="tpl-btn-ir-reserva" href="reserva.html">Ir a reservar</a>
        </div>
      </article>

    </section>
  </main>

  <!-- TPL: INICIO BLOQUE NUEVO [MODAL PERFIL PROPIETARIO: igual filosofía que perfil-mascotas] -->
  <div id="tpl-modal-perfil" class="tpl-modal" aria-hidden="true">
    <div class="tpl-modal__backdrop" data-close></div>
    <div class="tpl-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="tpl-modal-perfil-title">
      <div class="tpl-modal__header">
        <h3 class="tpl-modal__title" id="tpl-modal-perfil-title">Tu perfil de propietario</h3>
        <button class="tpl-modal__close" type="button" aria-label="Cerrar" data-close>✕</button>
      </div>
      <form id="tpl-form-perfil" class="tpl-form" novalidate>
        <div class="full">
          <p class="tpl-help" style="margin:0">Estos datos se usan para asignarte el cuidador adecuado y coordinar las reservas.</p>
        </div>
        <div class="full">
          <label for="pf-nombre">Nombre y apellidos</label>
          <input class="tpl-input" id="pf-nombre" name="nombre" type="text" required autocomplete="name" />
        </div>
        <div>
          <label for="pf-telefono">Teléfono</label>
          <input class="tpl-input" id="pf-telefono" name="telefono" type="tel" required inputmode="tel" placeholder="+34 ..." />
        </div>
        <div>
          <label for="pf-email">Email</label>
          <input class="tpl-input" id="pf-email" name="email" type="email" required autocomplete="email" />
        </div>
        <div class="full">
          <label for="pf-direccion">Dirección</label>
          <input class="tpl-input" id="pf-direccion" name="direccion" type="text" placeholder="Calle, nº, localidad" />
        </div>
        <div>
          <label for="pf-cp">Código postal</label>
          <input class="tpl-input" id="pf-cp" name="cp" type="text" inputmode="numeric" pattern="[0-9]{5}" maxlength="5" required />
        </div>
        <div class="full">
          <label for="pf-preferencias">Preferencias / notas</label>
          <textarea class="tpl-textarea" id="pf-preferencias" name="preferencias" rows="3" placeholder="Hábitos, pautas, horarios preferidos…"></textarea>
        </div>
        <div class="full" style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <button type="submit" class="tpl-submit">Guardar</button>
          <span class="tpl-help">Podrás editarlo cuando quieras.</span>
        </div>
      </form>
    </div>
  </div>
  <!-- TPL: FIN BLOQUE NUEVO -->

  <div id="tpl-footer"></div>
  <script src="tpl-footer.js" defer></script>

  <!-- TPL: INICIO BLOQUE NUEVO [Firebase compat + tu configuración] -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
  <script>
    // Tu proyecto Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDW73aFuz2AFS9VeWg_linHIRJYN4YMgTk",
      authDomain: "thepetslovers-c1111.firebaseapp.com",
      projectId: "thepetslovers-c1111",
      storageBucket: "thepetslovers-c1111.firebasestorage.app",
      messagingSenderId: "415914577533",
      appId: "1:415914577533:web:0b7a056ebaa4f1de28ab14",
      measurementId: "G-FXPD69KXBG"
    };
  </script>
  <!-- TPL: FIN BLOQUE NUEVO -->

  <!-- TPL: INICIO BLOQUE NUEVO [Lectura Firestore + render + logout + UI condiciones + MODAL PERFIL] -->
  <script>
    (function(){
      // ✅ Init seguro
      if (firebase.apps.length === 0) { firebase.initializeApp(firebaseConfig); }
      const auth = firebase.auth();
      const db   = firebase.firestore();

      const LS_PROFILE_KEY = 'tpl-profile';
      const LS_PETS_KEY    = 'tpl-pets';
      const LS_RES_KEY     = 'tpl-reservas';

      // Refs UI
      const bannerInc   = document.getElementById('tpl-banner-incompleto');

      const emptyCliente  = document.getElementById('tpl-cliente-empty');
      const viewCliente   = document.getElementById('tpl-cliente-view');
      const statusCliente = document.getElementById('tpl-cliente-status');
      const actionsPerfil = document.getElementById('tpl-actions-perfil');
      const linkEditar    = document.getElementById('tpl-link-editar');
      const btnPerfil     = document.getElementById('tpl-btn-perfil');

      const mascotasEmpty = document.getElementById('tpl-mascotas-empty');
      const mascotasView  = document.getElementById('tpl-mascotas-view');
      const mascotasList  = document.getElementById('tpl-mascotas-list');
      const chipMascotas  = document.getElementById('tpl-chip-mascotas');
      const cntMascotas   = document.getElementById('tpl-count-mascotas');

      const logoutBtn     = document.getElementById('tpl-logout-btn');

      // Reservas
      const reservasView  = document.getElementById('tpl-reservas-view');
      const reservasList  = document.getElementById('tpl-reservas-list');
      const reservasEmpty = document.getElementById('tpl-reservas-empty');
      const btnIrReserva  = document.getElementById('tpl-btn-ir-reserva');
      const pHintReserva  = document.querySelector("article[aria-labelledby='h-reservas'] p");

      // Modal Perfil propietario
      const modalPerfil = document.getElementById('tpl-modal-perfil');
      const formPerfil  = document.getElementById('tpl-form-perfil');
      const closeEls    = modalPerfil.querySelectorAll('[data-close]');

      // Mapeo de servicios (fallback genérico)
      const SERVICE_LABELS = {
        "guarderia-dia": "Guardería de día",
        "visitas": "Visitas a domicilio (gatos)",
        "alojamiento": "Alojamiento nocturno",
        "paseos": "Paseos",
        "transporte": "Transporte",
        "bodas": "Bodas",
        "postoperatorio": "Postoperatorio",
        "exoticos": "Exóticos"
      };

      function openPerfilModal(prefill){
        try {
          formPerfil.reset();
          if (prefill){
            formPerfil.nombre.value       = prefill.nombre || '';
            formPerfil.telefono.value     = prefill.telefono || '';
            formPerfil.email.value        = prefill.email || '';
            formPerfil.direccion.value    = prefill.direccion || '';
            formPerfil.cp.value           = prefill.cp || '';
            formPerfil.preferencias.value = prefill.preferencias || '';
          }
          modalPerfil.setAttribute('aria-hidden','false');
          document.documentElement.style.overflow = 'hidden';
          setTimeout(()=> formPerfil.nombre.focus(), 0);
        } catch(e){}
      }
      function closePerfilModal(){
        modalPerfil.setAttribute('aria-hidden','true');
        document.documentElement.style.overflow = '';
      }
      closeEls.forEach(el => el.addEventListener('click', (e)=>{ e.preventDefault(); closePerfilModal(); }));
      modalPerfil.addEventListener('click', (e)=>{ if (e.target.matches('[data-close]')) closePerfilModal(); });
      document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape' && modalPerfil.getAttribute('aria-hidden') === 'false') closePerfilModal(); });

      function updateBadge(profile){
        const complete = !!(profile && profile.nombre && profile.telefono && profile.email && profile.cp);
        statusCliente.classList.toggle('tpl-hidden', !complete);
        statusCliente.setAttribute('aria-hidden', complete ? 'false' : 'true');

        if (complete) {
          if (actionsPerfil) actionsPerfil.classList.add('tpl-hidden');
          if (linkEditar) {
            linkEditar.classList.remove('tpl-hidden');
            linkEditar.setAttribute('aria-hidden','false');
          }
        } else {
          if (actionsPerfil) actionsPerfil.classList.remove('tpl-hidden');
          if (linkEditar) {
            linkEditar.classList.add('tpl-hidden');
            linkEditar.setAttribute('aria-hidden','true');
          }
        }
      }

      async function getProfile(uid){
        if (uid) {
          const doc = await db.collection('users').doc(uid).collection('private').doc('profile').get();
          return doc.exists ? doc.data() : null;
        }
        try { return JSON.parse(localStorage.getItem(LS_PROFILE_KEY) || 'null'); } catch(e){ return null; }
      }

      async function getPets(uid){
        if (uid) {
          const snap = await db.collection('users').doc(uid).collection('pets').get();
          return snap.docs.map(d => ({ id: d.id, ...d.data() }));
        }
        try { return JSON.parse(localStorage.getItem(LS_PETS_KEY) || '[]'); } catch(e){ return []; }
      }

      function petEditHref(pet, idx, isFirebase){
        return (isFirebase && pet.id)
          ? ('perfil-mascotas.html?id=' + encodeURIComponent(pet.id))
          : ('perfil-mascotas.html?idx=' + encodeURIComponent(idx));
      }

      function getInitials(name){
        if(!name) return '—';
        const parts = String(name).trim().split(/\s+/).slice(0,2);
        return parts.map(p=>p[0]?.toUpperCase()||'').join('') || '—';
      }
      function fmt(val, fallback='—'){
        return (val===0 || !!val) ? String(val) : fallback;
      }
      function toDate(any){
        if (!any) return null;
        if (any.toDate) { try { return any.toDate(); } catch(_){} }
        if (typeof any === 'number') return new Date(any);
        const s = String(any);
        const d = new Date(s);
        return isNaN(d) ? null : d;
      }
      function soonBadge(start){
        if (!start) return '';
        const now = new Date();
        const d = (toDate(start) || null);
        if (!d) return '';
        const diffHr = Math.round((d - now) / 3600000);
        if (diffHr <= 0 && diffHr > -24) return '<span class="tpl-badge done">¡Hoy!</span>';
        if (diffHr > 0 && diffHr <= 24) return '<span class="tpl-badge ok tpl-soon">Mañana</span>';
        if (diffHr > 24 && diffHr <= 48) return '<span class="tpl-badge review tpl-soon">En 2 días</span>';
        return '';
      }
      function statusBadge(status){
        const s = String(status || '').toLowerCase();
        if (s==='aceptada' || s==='aprobada') return '<span class="tpl-badge ok"><i class="fa-solid fa-check"></i> Aceptada</span>';
        if (s==='en_revision' || s==='en-revision' || s==='revision') return '<span class="tpl-badge review"><i class="fa-solid fa-hourglass-half"></i> En revisión</span>';
        if (s==='enviada' || s==='pendiente') return '<span class="tpl-badge pending"><i class="fa-regular fa-paper-plane"></i> Enviada</span>';
        if (s==='completada' || s==='finalizada') return '<span class="tpl-badge done"><i class="fa-regular fa-circle-check"></i> Completada</span>';
        if (s==='cancelada') return '<span class="tpl-badge canceled"><i class="fa-regular fa-circle-xmark"></i> Cancelada</span>';
        return '<span class="tpl-badge"><i class="fa-regular fa-circle-question"></i> —</span>';
      }

      function ensureReservationAccess(hasProfile, hasPets){
        const complete = !!(hasProfile && hasPets);
        try{
          window.__TPL_PROFILE_COMPLETE__ = complete;
          localStorage.setItem('tplProfileComplete', complete ? '1' : '0');
        }catch(_){}

        bannerInc.hidden = complete;
        if (pHintReserva) pHintReserva.style.display = complete ? 'none' : '';

        function guardClick(e){
          e.preventDefault();
          bannerInc.hidden = false;
          bannerInc.scrollIntoView({behavior:'smooth', block:'start'});
        }
        if (btnIrReserva){
          btnIrReserva.setAttribute('aria-disabled', complete ? 'false' : 'true');
          if (!complete){
            btnIrReserva.addEventListener('click', guardClick);
            btnIrReserva.setAttribute('title','Completa tu perfil y añade una mascota para continuar');
            btnIrReserva.setAttribute('href', '#completar');
          } else {
            btnIrReserva.replaceWith(btnIrReserva.cloneNode(true));
            const freshBtn = document.getElementById('tpl-btn-ir-reserva');
            if (freshBtn) {
              freshBtn.setAttribute('href','reserva.html');
              freshBtn.removeAttribute('aria-disabled');
              freshBtn.removeAttribute('title');
            }
          }
        }
      }

      async function getReservations(uid){
        try{
          const snap = await db.collection('users').doc(uid).collection('reservas').get();
          if (!snap.empty){
            return snap.docs.map(d => ({ id:d.id, ...d.data() }));
          }
        }catch(_){}
        try{
          const snap2 = await db.collection('reservas').where('ownerUid','==', uid).get();
          if (!snap2.empty){
            return snap2.docs.map(d => ({ id:d.id, ...d.data() }));
          }
        }catch(_){}
        try{ return JSON.parse(localStorage.getItem(LS_RES_KEY) || '[]'); }catch(_){ return []; }
      }

      function renderReservations(reservas){
        reservasList.innerHTML = '';
        if (!reservas || reservas.length===0){
          reservasView.classList.add('tpl-hidden');
          reservasEmpty.classList.remove('tpl-hidden');
          return;
        }
        reservasEmpty.classList.add('tpl-hidden');
        reservasView.classList.remove('tpl-hidden');

        reservas.sort((a,b)=>{
          const da = toDate(a.fechaInicio || a.startAt || a.startDate || a.inicio) || new Date(8640000000000000);
          const dbb = toDate(b.fechaInicio || b.startAt || b.startDate || b.inicio) || new Date(8640000000000000);
          return da - dbb;
        });

        reservas.forEach(r=>{
          const start = toDate(r.fechaInicio || r.startAt || r.startDate || r.inicio);
          const end   = toDate(r.fechaFin || r.endAt || r.endDate || r.fin);
          const servicio = SERVICE_LABELS[r.servicio] || r.servicio || 'Servicio';
          const estado = r.estado || r.status || 'enviada';
          const pets   = Array.isArray(r.mascotas) ? r.mascotas : (r.mascotaNombre ? [r.mascotaNombre] : []);
          const caret  = r.cuidadorNombre || r.cuidador || '';
          const addr   = r.direccion || r.address || '';
          const price  = r.precio || r.price || '';

          const soon   = soonBadge(start);

          const el = document.createElement('div');
          el.className = 'tpl-reserva';
          el.innerHTML = `
            ${soon || ''}
            <h3>${servicio}</h3>
            <div class="row"><i class="fa-regular fa-calendar"></i> ${start ? start.toLocaleDateString('es-ES') : '—'} ${end ? ' · ' + end.toLocaleDateString('es-ES') : ''}</div>
            <div class="row"><i class="fa-solid fa-paw"></i> ${pets.length ? pets.join(', ') : '—'}</div>
            ${caret ? `<div class="row"><i class="fa-regular fa-user"></i> ${caret}</div>` : ''}
            ${addr ? `<div class="row"><i class="fa-regular fa-map"></i> ${addr}</div>` : ''}
            ${price ? `<div class="row"><i class="fa-solid fa-euro-sign"></i> ${price}</div>` : ''}
            <div class="row">${statusBadge(estado)}</div>
          `;
          reservasList.appendChild(el);
        });
      }

      async function render(uid){
        const isFirebase = !!uid;

        // ----- Perfil
        const profile = await getProfile(uid);
        updateBadge(profile);
        if (profile && profile.nombre) {
          document.getElementById('tpl-view-nombre').textContent    = profile.nombre || '—';
          document.getElementById('tpl-view-telefono').textContent  = profile.telefono || '—';
          document.getElementById('tpl-view-email').textContent     = profile.email || '—';
          document.getElementById('tpl-view-direccion').textContent = profile.direccion || '—';
          document.getElementById('tpl-view-cp').textContent        = profile.cp || '—';
          document.getElementById('tpl-view-pref').textContent      = profile.preferencias || '—';
          emptyCliente.classList.add('tpl-hidden');
          viewCliente.classList.remove('tpl-hidden');
        } else {
          viewCliente.classList.add('tpl-hidden');
          emptyCliente.classList.remove('tpl-hidden');
        }

        // ----- Mascotas
        const pets = await getPets(uid);
        mascotasList.innerHTML = '';
        const count = pets ? pets.length : 0;

        if (count > 0) {
          mascotasEmpty.classList.add('tpl-hidden');
          mascotasView.classList.remove('tpl-hidden');
          chipMascotas.classList.remove('tpl-hidden');
          chipMascotas.setAttribute('aria-hidden','false');
          cntMascotas.textContent = String(count);

          pets.forEach((p, idx) => {
            const especie = p.especie || '—';
            const edad    = (p.edad || p.edadAnios || p.anios) ?? '—';
            const peso    = p.peso ?? '—';
            const sexo    = p.sexo || p.genero || '—';
            const ester   = (p.esterilizado===true || p.esterilizada===true) ? 'Sí' : (p.esterilizado===false || p.esterilizada===false) ? 'No' : '—';
            const notas   = p.notas || p.comentarios || '';

            const card   = document.createElement('div');
            card.className = 'tpl-pet';

            const avatar = document.createElement('div');
            avatar.className = 'tpl-avatar';
            if (p.fotoUrl){
              const img = document.createElement('img');
              img.src = p.fotoUrl;
              img.alt = `Foto de ${p.nombre || 'la mascota'}`;
              avatar.appendChild(img);
            } else {
              avatar.textContent = getInitials(p.nombre);
            }

            const textBox = document.createElement('div');
            const nameEl  = document.createElement('div');
            nameEl.className = 'tpl-pet-name';
            nameEl.textContent = p.nombre || '—';

            const secEl   = document.createElement('div');
            secEl.className = 'tpl-pet-secondary';
            secEl.textContent = especie;

            textBox.appendChild(nameEl);
            textBox.appendChild(secEl);

            const actions = document.createElement('div');
            actions.className = 'tpl-pet-actions';
            const edit = document.createElement('a');
            edit.textContent = 'Editar';
            edit.className = 'tpl-btn-sm tpl-btn-outline';
            edit.setAttribute('href', petEditHref(p, idx, isFirebase));
            actions.appendChild(edit);

            const pop = document.createElement('div');
            pop.className = 'tpl-popover';
            pop.setAttribute('role','dialog');
            pop.setAttribute('aria-label', `Detalles de ${p.nombre || 'mascota'}`);
            pop.innerHTML = `
              <dl>
                <dt>Especie</dt><dd>${fmt(especie)}</dd>
                <dt>Edad</dt><dd>${fmt(edad)}</dd>
                <dt>Peso</dt><dd>${fmt(peso)}</dd>
                <dt>Sexo</dt><dd>${fmt(sexo)}</dd>
                <dt>Esterilizado</dt><dd>${fmt(ester)}</dd>
              </dl>
              ${notas ? `<div class="tpl-notas"><strong>Notas:</strong> ${fmt(notas,'')}</div>` : ''}
            `;

            card.appendChild(avatar);
            card.appendChild(textBox);
            card.appendChild(actions);
            card.appendChild(pop);

            mascotasList.appendChild(card);
          });
        } else {
          mascotasView.classList.add('tpl-hidden');
          mascotasEmpty.classList.remove('tpl-hidden');
          chipMascotas.classList.add('tpl-hidden');
          chipMascotas.setAttribute('aria-hidden','true');
          cntMascotas.textContent = '0';
        }

        // 🔐 Bloqueo reservas si falta algo
        const hasProfile = !!(profile && profile.nombre && profile.telefono && profile.email && profile.cp);
        const hasPets    = count > 0;
        ensureReservationAccess(hasProfile, hasPets);

        // ----- Reservas
        const reservas = await getReservations(uid);
        renderReservations(reservas);

        // Auto-abrir modal de perfil si falta (obligatorio para reservar)
        if (!hasProfile) {
          openPerfilModal(null);
        }
      }

      // Guardado de perfil propietario (Firestore)
      formPerfil.addEventListener('submit', async (e)=>{
        e.preventDefault();
        if (typeof formPerfil.reportValidity === 'function' && !formPerfil.reportValidity()) return;

        const u = auth.currentUser;
        if (!u || u.isAnonymous) { alert('Inicia sesión para guardar tu perfil.'); return; }

        const data = {
          nombre: formPerfil.nombre.value.trim(),
          telefono: formPerfil.telefono.value.trim(),
          email: formPerfil.email.value.trim() || (u.email || ''),
          direccion: formPerfil.direccion.value.trim(),
          cp: formPerfil.cp.value.trim(),
          preferencias: formPerfil.preferencias.value.trim(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        try{
          await db.collection('users').doc(u.uid).collection('private').doc('profile').set(data, { merge:true });
          // cache local opcional (por si lo usas en algún otro sitio)
          try{ localStorage.setItem('tpl-profile', JSON.stringify(data)); }catch(_){}
          closePerfilModal();
          // refrescar vista
          render(u.uid);
        }catch(err){
          console.error('No se pudo guardar el perfil:', err);
          alert('No se pudo guardar el perfil. Inténtalo de nuevo.');
        }
      });

      // Botones para abrir modal de edición
      function hookEditLinks(prefill){
        if (btnPerfil){
          btnPerfil.addEventListener('click', function(e){ e.preventDefault(); openPerfilModal(prefill); });
        }
        if (linkEditar){
          linkEditar.addEventListener('click', function(e){ e.preventDefault(); openPerfilModal(prefill); });
        }
        const completar = document.getElementById('completar');
        if (completar){
          completar.addEventListener('click', function(e){ e.preventDefault(); openPerfilModal(prefill); });
        }
      }

      // ✅ Logout
      async function doLogout(){
        try { await auth.signOut(); } catch(e) { /* silencioso */ }
        try {
          localStorage.removeItem('tplAuth');
          localStorage.removeItem('tplEmail');
          localStorage.removeItem(LS_PROFILE_KEY);
          localStorage.removeItem(LS_PETS_KEY);
          localStorage.removeItem('tplProfileComplete');
        } catch(e) {}
        if ('caches' in window) { caches.keys().then(keys => keys.forEach(k => caches.delete(k))).catch(()=>{}); }
        location.href = 'index.html';
      }
      if (logoutBtn) logoutBtn.addEventListener('click', doLogout);

      // Guardia de sesión
      auth.onAuthStateChanged(async (u) => {
        if (u && !u.isAnonymous) {
          try{
            localStorage.setItem('tplAuth','1');
            if (u.email) localStorage.setItem('tplEmail', String(u.email));
          }catch(e){}
          // Pre-llenar email desde auth si no hay perfil aún
          try{
            document.getElementById('pf-email').value = u.email || '';
          }catch(_){}
          hookEditLinks(null);
          await render(u.uid);
        } else {
          location.href = 'iniciar-sesion.html?next=' + encodeURIComponent('perfil.html');
        }
      });
    })();
  </script>
  <!-- TPL: FIN BLOQUE NUEVO -->

  <!-- TPL: INICIO BLOQUE NUEVO [Antibloqueo runtime seguro] -->
  <script>
    (function(){
      try{
        document.documentElement.classList.remove('tpl-auth-boot');
        var ov = document.getElementById('tpl-form-overlay');
        if (ov) ov.classList.remove('show');
        window.addEventListener('load', function(){
          document.documentElement.classList.remove('tpl-auth-boot');
          var ov2 = document.getElementById('tpl-form-overlay');
          if (ov2) ov2.classList.remove('show');
        });
      }catch(_){}
    })();
  </script>
  <!-- TPL: FIN BLOQUE NUEVO -->
</body>
</html>
