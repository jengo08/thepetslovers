<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Reserva · The Pets Lovers</title>

  <!-- Canonical guard (no afecta a localhost ni GitHub Pages) -->
  <script>
  (function(){
    var CANON = 'www.thepetslovers.es';
    var host = location.hostname || '';
    var IS_DEV = /^(localhost|127\.0\.0\.1|0\.0\.0\.0)$/i.test(host) || /github\.io$/i.test(host);
    if (host && host !== CANON && !IS_DEV) {
      location.replace(location.protocol + '//' + CANON + location.pathname + location.search + location.hash);
    }
  })();
  </script>

  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Poppins:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <!-- Estética (igual que el formulario antiguo) -->
  <style>
    :root{ --color-principal:#339496; --color-texto:#58425a; }
    body{background:#fafafa}
    .booking-wrapper{max-width:980px;margin:120px auto 60px;padding:20px;background:#fff;border:1px solid #eee;border-radius:12px;box-shadow:0 2px 12px rgba(0,0,0,.05)}
    .booking-header{text-align:center;margin-bottom:18px}
    .booking-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px}
    .booking-field{display:flex;flex-direction:column;gap:6px}
    .booking-field label{font-weight:700;font-size:.95rem;color:var(--color-texto)}
    .booking-field input,.booking-field select,.booking-field textarea{padding:10px 12px;border:1px solid #ddd;border-radius:8px;font-family:inherit}
    .cta-button{background:var(--color-principal);color:#fff;border:none;border-radius:999px;padding:10px 16px;cursor:pointer;font-weight:700}
    .cta-button[disabled]{opacity:.6;cursor:not-allowed}
    .booking-actions{display:flex;gap:12px;justify-content:center;margin-top:16px;flex-wrap:wrap}
    .tpl-section{margin-top:18px}
    .tpl-section h2{margin:6px 0 8px;font-size:1.15rem}
    .auth-wall{padding:14px;border:1px dashed #bbb;border-radius:10px;text-align:center;background:#fafafa;margin-bottom:16px}
    .auth-wall strong{color:var(--color-texto)}
    .disabled{opacity:.6;pointer-events:none}
    .help-link{white-space:nowrap;text-decoration:none;border:1px solid var(--color-principal);border-radius:999px;padding:8px 12px;font-weight:600;color:var(--color-principal)}
    .pet-card{border:1px solid #eee;border-radius:10px;padding:10px}
    small.muted{color:#666}
    /* overlay genérico (reservas.js) */
    .tpl-overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:9999}
    .tpl-overlay.on{display:flex}
    .tpl-modal{background:#fff;padding:20px;border-radius:12px;max-width:520px;box-shadow:0 8px 30px rgba(0,0,0,.2);text-align:center}
    .tpl-modal p{margin:0 0 12px}
  </style>
</head>
<body>

  <!-- Navbar unificada (inyectada) -->
  <div id="tpl-navbar">
    <noscript>
      <nav class="navbar">
        <div class="logo">
          <a href="index.html"><img src="images/logo.png.png" alt="The Pets Lovers"></a>
        </div>
        <a href="index.html" class="home-button">Inicio</a>
        <ul class="nav-links">
          <li><a href="como-funciona.html">Cómo funciona</a></li>
          <li><a href="servicios.html">Servicios</a></li>
          <li><a href="index.html#contactanos">Contáctanos</a></li>
          <li><a href="index.html#hazte-cuidador">Conviértete en cuidador</a></li>
        </ul>
        <a class="login-button" href="iniciar-sesion.html?next=reservas.html">Iniciar sesión</a>
      </nav>
    </noscript>
  </div>

  <div class="booking-wrapper">
    <div class="booking-header">
      <h1>Reserva tu servicio</h1>
      <p>Selecciona servicio y fechas para completar la reserva. Tras enviar, te llamaremos para confirmar detalles y asignarte el auxiliar adecuado.</p>
    </div>

    <!-- Muro de autenticación -->
    <div id="authWall" class="auth-wall" aria-live="polite">
      <p><strong>Debes iniciar sesión para enviar una reserva.</strong></p>
      <div id="tpl-inline-login" class="tpl-inline-login"></div>
    </div>

    <!-- Formulario -->
    <form
      id="bookingForm"
      class="disabled"
      novalidate
      data-tpl-success="Tu solicitud se ha enviado correctamente."
      data-tpl-redirect="perfil.html"
      data-tpl-emailjs="true"
      data-service-id="service_odjqrfl"
      data-template-id="template_rao5n0c"
      data-public-key="L2xAATfVuHJwj4EIV"
      data-to-email="gestion@thepetslovers.es"
      data-to-name="Gestión The Pets Lovers"
    >
      <!-- Datos del servicio -->
      <section class="tpl-section" aria-labelledby="sec-servicio">
        <h2 id="sec-servicio">Datos del servicio</h2>
        <div class="booking-grid">
          <div class="booking-field">
            <label for="service">Servicio</label>
            <select id="service" name="Servicio" required>
              <option value="" selected>Elige un servicio…</option>
              <option value="visitas">Visitas a domicilio</option>
              <option value="paseos">Paseos</option>
              <option value="guarderia">Guardería de día</option>
              <option value="alojamiento">Alojamiento (noche)</option>
              <option value="bodas">Bodas / exclusivos</option>
              <option value="postq">Postquirúrgicos</option>
              <option value="exoticos">Exóticos</option>
            </select>
          </div>

          <div class="booking-field">
            <label for="startDate">Fecha inicio</label>
            <input type="date" id="startDate" name="Fecha_inicio" required>
          </div>
          <div class="booking-field">
            <label for="endDate">Fecha fin</label>
            <input type="date" id="endDate" name="Fecha_fin" required>
          </div>
          <div class="booking-field">
            <label for="start">Hora inicio</label>
            <input type="time" id="start" name="Hora_inicio" required>
          </div>
          <div class="booking-field">
            <label for="end">Hora fin</label>
            <input type="time" id="end" name="Hora_fin" required>
          </div>

          <div class="booking-field">
            <label for="petCount">Nº de mascotas</label>
            <select id="petCount" name="Numero_mascotas">
              <option value="1" selected>1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
            </select>
          </div>

          <div class="booking-field">
            <label for="animalType">Tipo de animal</label>
            <select id="animalType" name="Tipo_animal">
              <option value="perro" selected>Perro</option>
              <option value="gato">Gato</option>
              <option value="exotico">Exótico</option>
            </select>
          </div>

          <div class="booking-field">
            <label for="breed">Raza / Especie</label>
            <select id="breed" name="Raza"></select>
          </div>

          <div class="booking-field" id="puppyWrap" hidden>
            <label><input type="checkbox" id="isPuppy"> ¿Cachorro (≤ 6 meses)?</label>
          </div>

          <div class="booking-field">
            <label><input type="checkbox" id="needTransport"> ¿Necesito transporte?</label>
          </div>
          <div class="booking-field" id="transportFields" hidden>
            <label for="km">Km estimados (ida/recogida)</label>
            <input type="number" id="km" min="0" step="1" placeholder="Ej. 12">
            <small class="muted">Se estima: 20 € + 1 €/km</small>
          </div>
        </div>
      </section>

      <!-- Mascotas (multi) -->
      <section class="tpl-section" aria-labelledby="sec-mascotas">
        <h2 id="sec-mascotas">Mascotas</h2>
        <div id="petMulti" class="booking-grid"></div>
        <small class="muted">Puedes seleccionar mascotas de tu perfil (si las tienes guardadas) o escribir el nombre.</small>
      </section>

      <!-- Opciones VISITAS -->
      <section class="tpl-section" id="sec-visitas" aria-labelledby="h-visitas" hidden>
        <h2 id="h-visitas">Opciones de visitas</h2>
        <div class="booking-grid">
          <div class="booking-field">
            <label for="visitsPerDay">Visitas por día</label>
            <select id="visitsPerDay">
              <option value="1" selected>1 visita/día</option>
              <option value="2">2 visitas/día</option>
            </select>
          </div>
          <div class="booking-field">
            <label for="visitType">Duración</label>
            <select id="visitType">
              <option value="60" selected>60 min (base 22 €)</option>
              <option value="90">90 min (base 30 €)</option>
              <option value="med15">Solo medicación 15 min (12 €)</option>
            </select>
            <small class="muted">Desde el día 11: 18 €/60’, 27 €/90’, 10 €/15’.</small>
          </div>
        </div>
        <p class="muted">Primera visita gratuita: tras crear tu reserva, concertamos una visita inicial en tu hogar.</p>
      </section>

      <!-- Datos de contacto -->
      <section class="tpl-section" aria-labelledby="sec-titular">
        <h2 id="sec-titular">Datos de contacto</h2>
        <div class="booking-grid">
          <div class="booking-field">
            <label for="firstName">Nombre</label>
            <input type="text" id="firstName" name="Nombre" required autocomplete="given-name">
          </div>
          <div class="booking-field">
            <label for="lastName">Apellidos</label>
            <input type="text" id="lastName" name="Apellidos" required autocomplete="family-name">
          </div>
          <div class="booking-field">
            <label for="email">Email</label>
            <input type="email" id="email" name="Email" required autocomplete="email">
          </div>
          <div class="booking-field">
            <label for="phone">Teléfono</label>
            <input type="tel" id="phone" name="Telefono" required autocomplete="tel" inputmode="tel">
          </div>
          <div class="booking-field">
            <label for="postalCode">Código Postal</label>
            <input type="text" id="postalCode" name="CP" required inputmode="numeric" pattern="[0-9]{5}" maxlength="5" placeholder="Ej. 28012">
          </div>
          <div class="booking-field" style="grid-column:1/-1">
            <label for="notes">Notas (opcional)</label>
            <textarea id="notes" name="Notas" rows="3" placeholder="Rutinas, medicación, horarios…"></textarea>
          </div>
        </div>
      </section>

      <!-- Resumen (email) -->
      <input type="hidden" name="Desglose" id="summaryField">

      <!-- Fallback por si algún script usa sendForm -->
      <input type="hidden" name="to_email" value="gestion@thepetslovers.es">
      <input type="hidden" name="to_name" value="Gestión The Pets Lovers">

      <!-- Ocultos EmailJS + tracking -->
      <input type="hidden" name="_replyto" id="tpl-replyto">
      <input type="hidden" name="uid" id="tpl-uid">
      <input type="hidden" name="perfil_url" id="tpl-perfil-url">

      <!-- Ocultos “mascotas” agregados -->
      <input type="hidden" name="Mascotas_json" id="tpl-pets-json">

      <!-- Ocultos 1ª mascota (compat) -->
      <input type="hidden" name="Mascota_nombre" id="tpl-pet-name">
      <input type="hidden" name="Mascota_especie" id="tpl-pet-species">
      <input type="hidden" name="Mascota_raza" id="tpl-pet-breed">
      <input type="hidden" name="Mascota_tamano" id="tpl-pet-size">
      <input type="hidden" name="Mascota_medicacion" id="tpl-pet-med">
      <input type="hidden" name="Mascota_necesidades" id="tpl-pet-needs">
      <input type="hidden" name="Mascota_id" id="tpl-pet-id">

      <!-- Ocultos zona por CP -->
      <input type="hidden" name="Zona_codigo" id="tpl-zone-code">
      <input type="hidden" name="Zona_nombre" id="tpl-zone-name">

      <div class="booking-actions">
        <button type="submit" class="cta-button">Solicitar reserva</button>
      </div>
      <p style="text-align:center;margin-top:8px">
        <small class="muted">Al enviar el formulario te llamaremos para confirmar detalles. Al confirmar la reserva, se cobrará el <strong id="depositPctText">30%</strong> del servicio como señal.</small>
      </p>

      <!-- Desglose -->
      <section class="tpl-section" id="tpl-budget-section" aria-labelledby="sec-presupuesto" style="margin-top:24px">
        <h2 id="sec-presupuesto" style="margin:6px 0 8px;font-size:1.15rem">Desglose preliminar</h2>
        <div class="budget-card" style="border:1px solid #eee;border-radius:12px;padding:14px">
          <table class="budget-table" style="width:100%;border-collapse:collapse">
            <tbody>
              <tr><th style="text-align:left;padding:8px;border-bottom:1px solid #f1f1f1">Servicio</th><td id="tpl-b-svc"      style="padding:8px;border-bottom:1px solid #f1f1f1">—</td></tr>
              <tr><th style="text-align:left;padding:8px;border-bottom:1px solid #f1f1f1">Periodo</th><td id="tpl-b-periodo"  style="padding:8px;border-bottom:1px solid #f1f1f1">—</td></tr>
              <tr><th style="text-align:left;padding:8px;border-bottom:1px solid #f1f1f1">Duración</th><td id="tpl-b-duracion" style="padding:8px;border-bottom:1px solid #f1f1f1">—</td></tr>
              <tr><th style="text-align:left;padding:8px;border-bottom:1px solid #f1f1f1">Mascotas</th><td id="tpl-b-mascota"  style="padding:8px;border-bottom:1px solid #f1f1f1">—</td></tr>
              <tr id="tpl-b-trans-row" style="display:none"><th style="text-align:left;padding:8px;border-bottom:1px solid #f1f1f1">Transporte</th><td id="tpl-b-trans" style="padding:8px;border-bottom:1px solid #f1f1f1">—</td></tr>
              <tr><th style="text-align:left;padding:8px;border-bottom:1px solid #f1f1f1">Notas</th><td id="tpl-b-notas"    style="padding:8px;border-bottom:1px solid #f1f1f1">—</td></tr>
            </tbody>
            <tfoot>
              <tr class="total">
                <th style="text-align:left;padding:10px;border-top:2px solid #ddd">Total</th>
                <td id="tpl-b-total" style="padding:10px;border-top:2px solid #ddd"><strong>—</strong></td>
              </tr>
            </tfoot>
          </table>
          <div style="margin-top:10px">
            <span id="tpl-budget-mini">Presupuesto estimado: <strong id="tpl-budget-amount">—</strong></span>
          </div>
        </div>
      </section>

      <!-- Línea inferior interna (ayuda) -->
      <div class="booking-actions" style="margin-top:12px">
        <a href="ayuda.html" class="help-link" id="tpl-help-link"><i class="fa-regular fa-circle-question"></i> Centro de ayuda</a>
      </div>
    </form>
  </div>

  <!-- Footer unificado (inyectado) -->
  <div id="tpl-footer"><noscript>…</noscript></div>

  <!-- Mini-injectors -->
  <script src="tpl-navbar.js" defer></script>
  <script src="tpl-footer.js" defer></script>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <!-- Inicialización de Firebase -->
  <script>
  (function(){
    const firebaseConfig = {
      apiKey: "AIzaSyDW73aFuz2AFS9VeWg_linHIRJYN4YMgTk",
      authDomain: "thepetslovers-c1111.firebaseapp.com",
      projectId: "thepetslovers-c1111",
      storageBucket: "thepetslovers-c1111.appspot.com",
      messagingSenderId: "415914577533",
      appId: "1:415914577533:web:0b7a056ebaa4f1de28ab14"
    };
    if (typeof firebase !== 'undefined') {
      if (firebase.apps.length === 0) firebase.initializeApp(firebaseConfig);
      try { firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL); } catch(_){}
    }
  })();
  </script>

  <!-- EmailJS + init -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script>
    window.TPL_EMAILJS = {
      serviceId: 'service_odjqrfl',
      templateId: 'template_rao5n0c',
      publicKey:  'L2xAATfVuHJwj4EIV',
      toEmail: 'gestion@thepetslovers.es',
      toName:  'Gestión The Pets Lovers'
    };
    (function(){
      const cfg = window.TPL_EMAILJS || {};
      if (window.emailjs && (cfg.publicKey||cfg.userId)) {
        try{ emailjs.init({ publicKey: cfg.publicKey || cfg.userId }); }catch(_){}
      }
    })();
  </script>

  <!-- Página de login por defecto -->
  <script>window.TPL_LOGIN_PAGE = 'iniciar-sesion.html';</script>

  <!-- Auth bridge (mismo comportamiento de antes) -->
  <script>
  (function(){
    'use strict';
    var DEBUG = /[?&]debugAuth=1\b/.test(location.search);
    function $(sel, root){ return (root||document).querySelector(sel); }
    var LOGIN_CANDIDATES = ['iniciar-sesion.html','iniciar-sesión.html','login.html'];
    function getLoginBase(){ return window.TPL_LOGIN_PAGE || LOGIN_CANDIDATES[0]; }
    function buildNext(){ var p=(location.pathname||'').replace(/^\//,''); return p+(location.search||'')+(location.hash||''); }
    function buildLoginUrl(nextOverride){ var base=getLoginBase(); var next=nextOverride||buildNext(); return base+'?next='+encodeURIComponent(next); }

    window.__TPL_AUTH__ = window.__TPL_AUTH__ || { user:null, ready:null };

    function updateUI(user){
      var wall = $('#authWall');
      var form = $('#bookingForm');
      var slot = $('#tpl-inline-login');
      if (!wall || !form) return;

      if (user) {
        wall.style.display = 'none';
        form.classList.remove('disabled');
        var email = $('#email'); if (user.email && email && !email.value) email.value = user.email;
        var name  = $('#firstName');
        if (user.displayName && name && !name.value) {
          var dn = String(user.displayName).trim(); name.value = dn.split(' ')[0] || dn;
        }
      } else {
        wall.style.display = 'block';
        form.classList.add('disabled');
        if (slot && !slot.hasChildNodes()) {
          var loginUrl = buildLoginUrl();
          slot.innerHTML =
            '<a class="cta-button" href="'+ loginUrl +'">Iniciar sesión</a> '+
            '<a class="help-link" style="border-color:#ccc;color:#666" href="index.html#iniciar-sesion">Volver al inicio</a>';
        }
        if (window.TPL_REQUIRE_LOGIN_ON_RESERVAS === true) { location.href = buildLoginUrl(); }
      }
    }

    function setupAuthBridge(){
      if (typeof firebase === 'undefined' || !firebase.auth) return;
      var auth = firebase.auth();
      if (!window.__TPL_AUTH__.ready) {
        window.__TPL_AUTH__.ready = new Promise(function(resolve){
          var first = true;
          function handle(user){
            window.__TPL_AUTH__.user = user || null;
            try { document.body.setAttribute('data-auth', user ? 'in' : 'out'); } catch(_){}
            try { window.dispatchEvent(new CustomEvent('tpl-auth-change', { detail:{ email: user ? (user.email||null) : null } })); } catch(_){}
            if (first) { first=false; try { window.dispatchEvent(new CustomEvent('tpl-auth-ready', { detail:{ user:user||null } })); } catch(_){} resolve(user||null); }
            if (DEBUG) console.log('[TPL][Auth] Estado:', user ? user.uid : null);
            updateUI(user);
          }
          auth.onAuthStateChanged(handle);
          handle(auth.currentUser);
        });
      } else {
        window.__TPL_AUTH__.ready.then(updateUI);
      }
    }
    setupAuthBridge();
    var tries=0, t=setInterval(function(){
      tries++;
      if (window.__TPL_AUTH__ && window.__TPL_AUTH__.ready) { clearInterval(t); return; }
      setupAuthBridge();
      if (tries > 30) clearInterval(t);
    }, 100);
  })();
  </script>

  <!-- Autorrellenar perfil: también teléfono (Firestore) -->
  <script>
  (function(){
    'use strict';
    window.TPL_REQUIRE_LOGIN_ON_RESERVAS = true;

    function $(sel, root){ return (root||document).querySelector(sel); }
    function setIfEmpty(input, val){ if (input && !input.value && val) input.value = val; }
    function splitFullName(full){
      if (!full) return { nombre:'', apellidos:'' };
      var s = String(full).trim().replace(/\s+/g,' ');
      var parts = s.split(' ');
      if (parts.length === 1) return { nombre: parts[0], apellidos: '' };
      return { nombre: parts[0], apellidos: parts.slice(1).join(' ') };
    }
    async function loadProfileData(uid){
      try{
        if (typeof firebase==='undefined' || !firebase.firestore) return;
        var db=firebase.firestore();
        var cols=['profiles','usuarios','owners','propietarios'];
        for (var i=0;i<cols.length;i++){
          var snap = await db.collection(cols[i]).doc(uid).get().catch(()=>null);
          if (snap && snap.exists){
            var d = snap.data()||{};
            var phone = d.phone || d.telefono || d.tel || '';
            if (phone) setIfEmpty($('#phone'), phone);
            var name  = d.name || d.nombre || '';
            var last  = d.lastname || d.apellidos || '';
            if (name) setIfEmpty($('#firstName'), name);
            if (last) setIfEmpty($('#lastName'), last);
            break;
          }
        }
      }catch(_){}
    }
    function syncHidden(user){
      var hidReply = $('#tpl-replyto');
      var hidUid   = $('#tpl-uid');
      var hidProf  = $('#tpl-perfil-url');
      if (hidUid && user && user.uid) hidUid.value = user.uid;
      if (hidProf) hidProf.value = 'perfil.html';
      var inputEmail = $('#email');
      var emailVal = (inputEmail && inputEmail.value) ? inputEmail.value : (user && user.email) || '';
      if (hidReply) hidReply.value = emailVal;
    }
    function bindReplySync(){
      var email = $('#email');
      var hidReply = $('#tpl-replyto');
      if (!email || !hidReply) return;
      email.addEventListener('input', function(){ hidReply.value = email.value || ''; });
    }
    function onAuthReady(cb){
      if (window.__TPL_AUTH__ && window.__TPL_AUTH__.ready) {
        window.__TPL_AUTH__.ready.then(cb);
      } else {
        window.addEventListener('tpl-auth-ready', function(ev){
          cb(ev.detail && ev.detail.user ? ev.detail.user : null);
        }, { once:true });
      }
    }
    onAuthReady(function(user){
      try{
        if (user){
          if (user.email) setIfEmpty($('#email'), user.email);
          var sp = splitFullName(user.displayName || '');
          if (sp.nombre || sp.apellidos){ setIfEmpty($('#firstName'), sp.nombre); setIfEmpty($('#lastName'), sp.apellidos); }
          loadProfileData(user.uid);
        }
      }catch(_){}
      syncHidden(user);
      bindReplySync();
    });
    window.addEventListener('tpl-auth-change', function(){
      var user = (window.__TPL_AUTH__ && window.__TPL_AUTH__.user) || null;
      syncHidden(user);
    });
  })();
  </script>

  <!-- IMG *.png.png → *.png -->
  <script>
  (function(){
    window.addEventListener('error', function(e){
      var el = e.target;
      if (!el || !el.tagName) return;
      if (el.tagName === 'IMG' && /(\.png\.png)(\?.*)?$/i.test(el.src||'')) {
        var fixed = el.src.replace(/\.png\.png/i, '.png'); el.onerror = null; el.src = fixed;
      }
    }, true);
  })();
  </script>

  <!-- Razas dinámicas -->
  <script>
  (function(){
    'use strict';
    var BREEDS = {
      perro: ["Mestizo","Labrador","Golden Retriever","Pastor Alemán","Bulldog Francés","Caniche (Poodle)","Chihuahua","Beagle","Border Collie","Yorkshire","Shiba Inu","Dálmata","Carlino","Boxer","Husky"],
      gato:  ["Común europeo","Siames","Persa","Maine Coon","Bengalí","Sphynx","British Shorthair","Ragdoll","Azul ruso","Scottish Fold","Noruego","Angora","Bombay","Savannah"],
      exotico:["Ave (canario, agapornis…)","Reptil (gecko, pogona…)","Pez","Roedor (hámster, cobaya…)","Hurón","Conejo","Tortuga","Erizo","Iguana","Serpiente"]
    };
    function $(id){ return document.getElementById(id); }
    function populateBreedOptions(){
      var t = $('animalType')?.value || 'perro';
      var sel = $('breed'); if (!sel) return;
      var list = BREEDS[t] || [];
      var current = sel.value;
      sel.innerHTML = '';
      list.forEach(function(name){ sel.add(new Option(name,name)); });
      if (current && !Array.from(sel.options).some(o=>o.value===current)) sel.add(new Option(current,current));
      if (current) sel.value=current;
      // Mostrar “cachorro” solo si perro
      $('puppyWrap').hidden = (t!=='perro');
    }
    ['animalType'].forEach(function(id){
      var el=$(id); if (!el) return;
      el.addEventListener('change', populateBreedOptions);
      el.addEventListener('input',  populateBreedOptions);
    });
    document.addEventListener('DOMContentLoaded', populateBreedOptions);
    window.TPL_BREEDS={populateBreedOptions};
  })();
  </script>

  <!-- Mascotas: cargar del perfil (Firestore) y UI multi -->
  <script>
  (function(){
    'use strict';
    var SAVED_PETS = []; // {id, nombre, especie, raza, ...}
    function $(sel,root){ return (root||document).querySelector(sel); }
    function h(tag, attrs, children){
      var el=document.createElement(tag);
      if (attrs) Object.keys(attrs).forEach(function(k){
        if (k==='class') el.className=attrs[k];
        else if (k==='html') el.innerHTML=attrs[k];
        else el.setAttribute(k, attrs[k]);
      });
      (children||[]).forEach(function(c){ el.appendChild(c); });
      return el;
    }
    function option(txt,val){ var o=document.createElement('option'); o.textContent=txt; o.value=val; return o; }

    function normalizePet(p){
      if (!p) return null;
      var id  = p.id || p.uid || p._id || p.chip || p.chipid || p.microchip || null;
      var nombre = p.nombre || p.name || p.petName || '';
      var especie = (p.especie || p.tipo || p.species || p.type || '').toLowerCase();
      if (especie==='perros') especie='perro';
      if (especie==='gatos') especie='gato';
      if (!/^(perro|gato)$/.test(especie)) especie='exotico';
      var raza = p.raza || p.breed || '';
      var tam = p.tamano || p['tamaño'] || p.size || '';
      var meds = p.medicacion || p['medicación'] || p.medication || '';
      var needs = p.necesidades || p.needs || p.specialNeeds || '';
      return { id:id, nombre:nombre, especie:especie, raza:raza, tamano:tam, medicacion:meds, necesidades:needs };
    }
    async function loadPetsFromFirestore(uid){
      var list = [];
      try{
        if (typeof firebase==='undefined' || !firebase.firestore) return list;
        var db = firebase.firestore();
        var cols = ['owners','propietarios','profiles','usuarios'];
        for (var i=0;i<cols.length;i++){
          var ref = db.collection(cols[i]).doc(uid);
          try{
            var sub1 = await ref.collection('mascotas').get().catch(()=>null);
            if (sub1 && !sub1.empty){ sub1.forEach(function(d){ list.push(normalizePet(Object.assign({id:d.id}, d.data()))); }); }
            var sub2 = await ref.collection('pets').get().catch(()=>null);
            if (sub2 && !sub2.empty){ sub2.forEach(function(d){ list.push(normalizePet(Object.assign({id:d.id}, d.data()))); }); }
            var main = await ref.get().catch(()=>null);
            if (main && main.exists){
              var data = main.data()||{};
              var arr = [];
              function toArrayMaybe(objOrArr){
                if (!objOrArr) return [];
                if (Array.isArray(objOrArr)) return objOrArr;
                return Object.keys(objOrArr).map(function(k){ return Object.assign({id:k}, objOrArr[k]); });
              }
              toArrayMaybe(data.mascotas).forEach(function(p){ list.push(normalizePet(p)); });
              toArrayMaybe(data.pets).forEach(function(p){ list.push(normalizePet(p)); });
            }
            if (list.length) break;
          }catch(_){}
        }
        // colecciones sueltas
        if (!list.length){
          var q1 = await db.collection('mascotas').where('ownerUid','==',uid).get().catch(()=>null);
          if (q1 && !q1.empty){ q1.forEach(function(d){ list.push(normalizePet(Object.assign({id:d.id}, d.data()))); }); }
          if (!list.length){
            var q2 = await db.collection('mascotas').where('uid','==',uid).get().catch(()=>null);
            if (q2 && !q2.empty){ q2.forEach(function(d){ list.push(normalizePet(Object.assign({id:d.id}, d.data()))); }); }
          }
        }
      }catch(_){}
      return list.filter(Boolean);
    }

    function buildPetRow(idx){
      var wrap = h('div', {class:'pet-card'});
      var title = h('div', {class:''}, [document.createTextNode('Mascota '+idx)]);
      var sel = h('select', {class:'pet-saved'});
      sel.appendChild(option('— Elegir de tu perfil —',''));
      SAVED_PETS.forEach(function(p){
        sel.appendChild(option((p.nombre||'Sin nombre') + (p.especie?(' · '+p.especie):''), p.id||p.nombre||('p'+idx)));
        try{ sel.lastChild.dataset.pet = JSON.stringify(p); }catch(_){}
      });
      var name = h('input', {type:'text', placeholder:'Nombre (o escribe si no está en tu perfil)', class:'pet-name'});
      wrap.appendChild(title);
      wrap.appendChild(h('div',{class:'booking-grid'},[
        h('div',{class:'booking-field'},[
          h('label',{},[document.createTextNode('De tu perfil')]),
          sel
        ]),
        h('div',{class:'booking-field'},[
          h('label',{},[document.createTextNode('Nombre')]),
          name
        ])
      ]));
      // Eventos
      sel.addEventListener('change', function(){
        var o = sel.options[sel.selectedIndex]; if (!o) return;
        var p = null; try{ p = JSON.parse(o.dataset.pet||'{}'); }catch(_){}
        if (p){
          if (!name.value) name.value = p.nombre||'';
          // reflejar primera mascota en ocultos compatibles
          if (idx===1){
            var map = {
              'tpl-pet-id': p.id||'',
              'tpl-pet-name': p.nombre||'',
              'tpl-pet-species': p.especie||'',
              'tpl-pet-breed': p.raza||'',
              'tpl-pet-size': p.tamano||'',
              'tpl-pet-med': p.medicacion||'',
              'tpl-pet-needs': p.necesidades||''
            };
            Object.keys(map).forEach(function(id){
              var el = document.getElementById(id); if (el) el.value = map[id];
            });
            // sincroniza tipo/raza visibles si están vacíos
            var t = document.getElementById('animalType');
            if (t && p.especie) t.value = p.especie;
            window.TPL_BREEDS && TPL_BREEDS.populateBreedOptions();
            var b = document.getElementById('breed');
            if (b && p.raza){
              if (!Array.from(b.options).some(o=>o.value===p.raza)) b.add(new Option(p.raza,p.raza));
              b.value = p.raza;
            }
          }
        }
        window.TPL_PETS && TPL_PETS.collect();
        window.TPL_BUDGET && TPL_BUDGET.update();
      });
      name.addEventListener('input', function(){
        if (idx===1){
          var nh=document.getElementById('tpl-pet-name'); if (nh) nh.value=name.value||'';
        }
        window.TPL_PETS && TPL_PETS.collect();
        window.TPL_BUDGET && TPL_BUDGET.update();
      });
      return wrap;
    }

    function renderPetMulti(){
      var container = $('#petMulti'); if (!container) return;
      container.innerHTML = '';
      var n = parseInt($('#petCount')?.value||'1',10)||1;
      for (var i=1;i<=n;i++) container.appendChild(buildPetRow(i));
      window.TPL_PETS && TPL_PETS.collect();
    }

    function collectPets(){
      var list=[];
      var cards = document.querySelectorAll('#petMulti .pet-card');
      cards.forEach(function(card, i){
        var name = card.querySelector('.pet-name')?.value?.trim() || '';
        var sel  = card.querySelector('.pet-saved');
        var p = null;
        try{ p = JSON.parse(sel?.options[sel.selectedIndex]?.dataset?.pet || '{}'); }catch(_){}
        list.push({
          idx: i+1,
          nombre: name || p?.nombre || '',
          especie: p?.especie || (document.getElementById('animalType')?.value||''),
          raza: p?.raza || (document.getElementById('breed')?.value||'')
        });
      });
      var hid = document.getElementById('tpl-pets-json');
      if (hid) try{ hid.value = JSON.stringify(list); }catch(_){}
      // Para el desglose
      var label = list.map(function(x){ return x.nombre || 'Mascota '+x.idx; }).join(', ');
      var bm = document.getElementById('tpl-b-mascota');
      if (bm) bm.textContent = label || '—';
      return list;
    }

    async function init(){
      var uid = (window.__TPL_AUTH__ && window.__TPL_AUTH__.user && window.__TPL_AUTH__.user.uid) || null;
      if (uid){
        SAVED_PETS = await loadPetsFromFirestore(uid);
      }
      renderPetMulti();
    }

    document.getElementById('petCount')?.addEventListener('change', renderPetMulti);
    window.addEventListener('tpl-auth-ready', init);
    document.addEventListener('DOMContentLoaded', init);

    window.TPL_PETS = { collect: collectPets };
  })();
  </script>

  <!-- Validaciones + resumen + CP → zona -->
  <script>
  (function(){
    'use strict';
    var $ = (s,r)=> (r||document).querySelector(s);
    var form = $('#bookingForm'); if (!form) return;

    var LEAD_HOURS = (typeof window.TPL_RESERVAS_LEAD_HOURS === 'number') ? window.TPL_RESERVAS_LEAD_HOURS : 24;
    var DEPOSIT_PCT = (typeof window.TPL_DEPOSIT_PCT === 'number') ? window.TPL_DEPOSIT_PCT : 30;
    (function(){ var t=document.getElementById('depositPctText'); if (t) t.textContent = DEPOSIT_PCT+'%'; })();

    function parseDate(d){ if(!d) return null; var p=d.split('-'); if(p.length!==3) return null; return new Date(+p[0], +p[1]-1, +p[2], 12, 0, 0, 0); }
    function parseTime(t){ if(!t) return null; var p=t.split(':'); if(p.length<2) return null; return {h:+p[0], m:+p[1]}; }
    function combine(dt, tm){ if(!dt||!tm) return null; var d=new Date(dt); d.setHours(tm.h, tm.m, 0, 0); return d; }
    function fmtDate(d){ return d.toLocaleDateString('es-ES', {weekday:'short', day:'2-digit', month:'2-digit', year:'numeric'}); }
    function fmtTime(d){ return d.toLocaleTimeString('es-ES', {hour:'2-digit', minute:'2-digit'}); }
    function cleanPhone(s){ if (!s) return ''; return String(s).replace(/[\s\-().]/g,'').replace(/^(\+34)(34)/,'$1'); }
    function validPhoneES(s){ var x = cleanPhone(s); return (/^\+34\d{9}$/.test(x) || /^\d{9}$/.test(x)); }

    var elService=$('#service'), elSD=$('#startDate'), elED=$('#endDate'), elST=$('#start'), elET=$('#end');
    var elPhone=$('#phone'), elEmail=$('#email'), elNotes=$('#notes'), elSummary=$('#summaryField');

    // UI dependiente de servicio
    function toggleBlocks(){
      var v = elService?.value || '';
      $('#sec-visitas').hidden = (v!=='visitas');
      // Transporte visible si checkbox
      var needT = $('#needTransport')?.checked;
      $('#transportFields').hidden = !needT;
      // “cachorro” solo si perro (lo controla breeds también)
      $('#puppyWrap').hidden = ($('#animalType')?.value!=='perro');
    }

    function validateDates(){
      elSD.setCustomValidity(''); elED.setCustomValidity(''); elST.setCustomValidity(''); elET.setCustomValidity('');
      var sd=parseDate(elSD.value), ed=parseDate(elED.value), st=parseTime(elST.value), et=parseTime(elET.value);
      if (!sd || !ed || !st || !et) return true;
      var sDT=combine(sd,st), eDT=combine(ed,et);
      if (eDT < sDT){ elED.setCustomValidity('La fecha/hora de fin debe ser posterior a la de inicio.'); elET.setCustomValidity('La fecha/hora de fin debe ser posterior a la de inicio.'); return false; }
      if (sd.getFullYear()===ed.getFullYear() && sd.getMonth()===ed.getMonth() && sd.getDate()===ed.getDate()){
        if (eDT <= sDT){ elET.setCustomValidity('Para el mismo día, la hora fin debe ser mayor que la hora inicio.'); return false; }
      }
      var now = new Date(); var minStart = new Date(now.getTime() + LEAD_HOURS*3600*1000);
      if (sDT < minStart){ elSD.setCustomValidity('La reserva debe pedirse con al menos '+LEAD_HOURS+'h de antelación.'); elST.setCustomValidity('La reserva debe pedirse con al menos '+LEAD_HOURS+'h de antelación.'); return false; }
      return true;
    }
    function validatePhone(){
      elPhone.setCustomValidity('');
      var val = elPhone.value.trim();
      if (!val) return true;
      if (!validPhoneES(val)){ elPhone.setCustomValidity('Introduce un teléfono válido (9 dígitos, admite prefijo +34).'); return false; }
      return true;
    }

    function buildSummary(){
      var sd=parseDate(elSD.value), ed=parseDate(elED.value);
      var st=parseTime(elST.value), et=parseTime(elET.value);
      var sDT=(sd && st)?combine(sd,st):null, eDT=(ed && et)?combine(ed,et):null;

      var parts=[], svc=elService.value ? elService.options[elService.selectedIndex].text : '';
      if (svc) parts.push('Servicio: '+svc);
      if (sDT) parts.push('Inicio: ' + fmtDate(sDT) + ' ' + fmtTime(sDT));
      if (eDT) parts.push('Fin: '    + fmtDate(eDT) + ' ' + fmtTime(eDT));
      // visitas extra
      if (elService.value==='visitas'){
        var vpd = $('#visitsPerDay')?.value || '1';
        var vt  = $('#visitType')?.options[$('#visitType').selectedIndex].text || '';
        parts.push('Visitas/día: '+vpd);
        parts.push('Tipo visita: '+vt);
      }
      var pets = (function(){
        try{ return JSON.parse($('#tpl-pets-json')?.value||'[]'); }catch(_){ return []; }
      })();
      if (pets.length){
        parts.push('Mascotas: '+pets.map(p=>p.nombre||('Mascota '+p.idx)).join(', '));
      }
      var notes=(elNotes && elNotes.value.trim()) ? ('Notas: ' + elNotes.value.trim()) : '';
      if (notes) parts.push(notes);
      elSummary.value = parts.join(' • ');
    }

    ['change','input'].forEach(function(ev){
      [elService, elSD, elED, elST, elET, elNotes, $('#visitsPerDay'), $('#visitType'), $('#needTransport'), $('#km'), $('#animalType'), $('#breed'), $('#isPuppy'), $('#petCount')].forEach(function(el){
        if (!el) return;
        el.addEventListener(ev, function(){ toggleBlocks(); validateDates(); buildSummary(); window.TPL_BUDGET && TPL_BUDGET.update(); });
      });
    });

    // CP -> zona (opcional)
    function zoneForCP(cp){
      cp = (cp||'').trim();
      if (!/^[0-9]{5}$/.test(cp)) return null;
      var zones = window.TPL_CP_ZONES || [];
      var p3 = cp.slice(0,3), p2 = cp.slice(0,2);
      return zones.find(z=>z.prefix===p3) || zones.find(z=>z.prefix===p2) || null;
    }
    function sanitizeCpValue(v){ return String(v||'').replace(/\D+/g,'').slice(0,5); }
    function updateHiddenAndSummary(){
      var cpEl = $('#postalCode'), sum = $('#summaryField');
      var code = $('#tpl-zone-code'), name = $('#tpl-zone-name');
      if (!cpEl || !sum || !code || !name) return;
      var cp = sanitizeCpValue(cpEl.value);
      if (cp !== cpEl.value) cpEl.value = cp;
      var z = zoneForCP(cp);
      code.value = z ? z.code : '';
      name.value = z ? z.name : '';
      // no añadimos a resumen para no alargar; si lo quieres lo meto
    }
    $('#postalCode')?.addEventListener('input', updateHiddenAndSummary);
    $('#postalCode')?.addEventListener('blur',  updateHiddenAndSummary);

    document.addEventListener('DOMContentLoaded', function(){
      toggleBlocks(); buildSummary();
    });
    form.addEventListener('submit', function(){ validatePhone(); validateDates(); buildSummary(); }, true);
  })();
  </script>

  <!-- PRESUPUESTO (con todas las reglas que has pasado) -->
  <script>
  (function(){
    'use strict';

    // ======== CONSTANTES / TARIFAS ========
    const TRANSPORT = { BASE:20, PER_KM:1 };        // transporte estimado
    const ZONE_MULTIPLIERS = { /* 'MAD':1.05 */ };  // por si quieres zona

    const PRICING = {
      // Visitas (gatos) — por visita
      visitas: {
        base:   { '60':22, '90':30, 'med15':12 },
        d11:    { '60':18, '90':27, 'med15':10 },   // desde día 11
        // suplementos por nº de gatos (adicionales sobre el 1º), por visita
        catSuppl(extraCats){
          if (extraCats<=0) return 0;
          if (extraCats===1) return 12;
          if (extraCats===2) return 2*8;
          return extraCats*6;
        }
      },
      // Paseos (60 min) — bonos automáticos si días = 10/15/20/25/30
      paseos: {
        perWalk: 12,
        secondDogPerWalk: 8, // y siguientes
        bundles: { 10:115, 15:168, 20:220, 25:270, 30:318 } // 1 perro
      },
      // Guardería
      guarderia: {
        dayRates: { std:15, puppy:20 },                         // por día (1ª mascota)
        bundles:  { std:{10:135,20:250,30:315}, puppy:{10:185,20:350,30:465} }, // total (1ª)
        extraNonBundle: { second:12, thirdPlus:8 }              // €/día para 2ª y 3ª+
      },
      // Alojamiento (noche)
      alojamiento: {
        day: { std:30, puppy:35 },    // por noche 1ª
        d11: { std:27, puppy:32 },    // desde día 11
        secondDog: { day:25, d11:22 } // 2º perro por noche (y siguientes igual)
      },
      // Bodas y Postquirúrgicos: a consultar (sin cálculo)
      bodas: { consult:true },
      postq: { consult:true },
      // Exóticos (estimación simple, puedes detallar más)
      exoticos: {
        aves:20, reptiles:15, mamiferos:25, estancia:null // estancia: consultar
      }
    };

    const $ = (id)=> document.getElementById(id);
    const q = (sel,root)=> (root||document).querySelector(sel);

    function parseDate(s){ if(!s) return null; const p=s.split('-'); if(p.length!==3) return null; return new Date(+p[0], +p[1]-1, +p[2], 12,0,0,0); }
    function parseTime(s){ if(!s) return null; const p=s.split(':'); if(p.length<2) return null; return {h:+p[0], m:+p[1]}; }
    function combine(d,t){ if(!d||!t) return null; const x=new Date(d); x.setHours(t.h, t.m, 0, 0); return x; }
    function spanDays(a,b){ return Math.max(0, Math.ceil((b-a)/86400000)); }
    function spanHours(a,b){ return Math.max(0, (b-a)/36e5); }
    function formatEUR(n){ try{ return n.toLocaleString('es-ES',{style:'currency',currency:'EUR'});}catch(_){ return '€ '+(Math.round(n*100)/100).toFixed(2).replace('.',','); } }

    function getCommonInputs(){
      const svc  = $('service')?.value || '';
      const sd   = parseDate($('startDate')?.value||'');
      const ed   = parseDate($('endDate')?.value||'');
      const st   = parseTime($('start')?.value||'');
      const et   = parseTime($('end')?.value||'');
      const sdt  = (sd&&st)?combine(sd,st):null;
      const edt  = (ed&&et)?combine(ed,et):null;
      const days = (sdt&&edt)? Math.max(1, spanDays(sdt,edt)) : 1;
      const hours= (sdt&&edt)? spanHours(sdt,edt) : 0;
      const pets = parseInt($('petCount')?.value||'1',10)||1;
      const type = $('animalType')?.value || 'perro';
      const breed= $('breed')?.value || '';
      const puppy= $('isPuppy')?.checked || false;
      const needT= $('needTransport')?.checked || false;
      const km   = parseFloat($('km')?.value||'0')||0;
      const visitsPerDay = parseInt($('visitsPerDay')?.value||'1',10)||1;
      const visitType    = $('visitType')?.value || '60';
      return { svc, sdt, edt, days, hours, pets, type, breed, puppy, needT, km, visitsPerDay, visitType };
    }

    function updateBudget(){
      const i = getCommonInputs();

      // Texto cabecera
      const svcSel = $('service');
      const svcText = (svcSel && svcSel.options[svcSel.selectedIndex]) ? svcSel.options[svcSel.selectedIndex].text.trim() : '';
      const periodo = (i.sdt&&i.edt)
        ? (i.sdt.toLocaleDateString('es-ES') + ' ' + i.sdt.toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'})
           + ' → ' +
           i.edt.toLocaleDateString('es-ES') + ' ' + i.edt.toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'}))
        : '—';

      let total = null, durLabel = '—', extraLines = [];

      // Transporte
      let transportCost = 0;
      if (i.needT){
        transportCost = TRANSPORT.BASE + Math.max(0, i.km)*TRANSPORT.PER_KM;
        $('#tpl-b-trans-row').style.display = '';
        $('#tpl-b-trans').textContent = formatEUR(transportCost) + ' (20 € + '+(i.km||0)+' km)';
      } else {
        $('#tpl-b-trans-row').style.display = 'none';
      }

      // Servicio
      if (i.svc==='visitas'){
        // Visitas por día con duración
        const tab = (i.days>=11) ? PRICING.visitas.d11 : PRICING.visitas.base;
        const pricePerVisit = tab[i.visitType] || 0;

        // nº de gatos
        let catCount = i.pets;
        if (i.type!=='gato'){ catCount = 1; } // suplementos solo para gatos
        const extraCats = Math.max(0, catCount-1);
        const supplPerVisit = (i.type==='gato') ? PRICING.visitas.catSuppl(extraCats) : 0;

        const perVisitTotal = pricePerVisit + supplPerVisit;
        total = perVisitTotal * i.visitsPerDay * i.days;

        durLabel = i.days + (i.days===1?' día':' días') + ' · ' + i.visitsPerDay + (i.visitsPerDay===1?' visita/día':' visitas/día');

        extraLines.push('Tarifa por visita: '+formatEUR(pricePerVisit));
        if (supplPerVisit>0) extraLines.push('Suplementos por gatos/visita: '+formatEUR(supplPerVisit));
      }
      else if (i.svc==='paseos'){
        // Asumimos 1 paseo de 60’ por día
        const walks = i.days;
        const bundle = PRICING.paseos.bundles[walks] || null;
        const firstDog = bundle ?? (walks * PRICING.paseos.perWalk);
        const extraDogs = Math.max(0, i.pets-1) * (walks * PRICING.paseos.secondDogPerWalk);
        total = firstDog + extraDogs;
        durLabel = walks + (walks===1?' paseo':' paseos');

        if (bundle){ extraLines.push('Bono aplicado: '+walks+' paseos'); }
        if (extraDogs>0) extraLines.push('2ª+ mascota: '+formatEUR(extraDogs)+' ('+PRICING.paseos.secondDogPerWalk+' €/paseo)');
      }
      else if (i.svc==='guarderia'){
        const kind = i.puppy ? 'puppy' : 'std';
        const bundles = PRICING.guarderia.bundles[kind];
        const dayRate = PRICING.guarderia.dayRates[kind];
        const possibleBundle = bundles[i.days] || null;

        if (possibleBundle){
          // Bono automático
          const base1 = possibleBundle;
          let extras = 0;
          if (i.pets>=2) extras += PRICING.guarderia.extraNonBundle.second * i.days;
          if (i.pets>=3) extras += (i.pets-2) * PRICING.guarderia.extraNonBundle.thirdPlus * i.days;
          total = base1 + extras;
          durLabel = 'Bono '+i.days+' días' + (i.pets>1?(' · '+i.pets+' mascotas'):'');
          extraLines.push('Bono '+i.days+' (1ª mascota): '+formatEUR(base1));
          if (extras>0) extraLines.push('Suplementos (2ª y 3ª+): '+formatEUR(extras)+' ('+i.days+' días)');
        }else{
          // Diario
          const base1 = dayRate * i.days;
          let extras = 0;
          if (i.pets>=2) extras += PRICING.guarderia.extraNonBundle.second * i.days;
          if (i.pets>=3) extras += (i.pets-2) * PRICING.guarderia.extraNonBundle.thirdPlus * i.days;
          total = base1 + extras;
          durLabel = i.days + (i.days===1?' día':' días') + (i.pets>1?(' · '+i.pets+' mascotas'):'');
          extraLines.push('1ª mascota: '+formatEUR(base1));
          if (extras>0) extraLines.push('Suplementos (2ª y 3ª+): '+formatEUR(extras)+' ('+i.days+' días)');
        }
      }
      else if (i.svc==='alojamiento'){
        const kind = i.puppy ? 'puppy' : 'std';
        const baseRate = (i.days>=11) ? PRICING.alojamiento.d11[kind] : PRICING.alojamiento.day[kind];
        const secondRate = (i.days>=11) ? PRICING.alojamiento.secondDog.d11 : PRICING.alojamiento.secondDog.day;

        // 1ª mascota
        let base = baseRate * i.days;
        // resto
        let extras = 0;
        if (i.type==='perro' && i.pets>=2){
          extras += (i.pets-1) * secondRate * i.days;
        } else if (i.pets>=2){
          // si no es perro, replicamos tarifa de 1ª (ajústalo si quieres diferente)
          extras += (i.pets-1) * baseRate * i.days;
        }
        total = base + extras;
        durLabel = i.days + (i.days===1?' noche':' noches') + (i.pets>1?(' · '+i.pets+' mascotas'):'');
        extraLines.push('1ª mascota: '+formatEUR(base));
        if (extras>0) extraLines.push('Suplementos (adicionales): '+formatEUR(extras));
      }
      else if (i.svc==='bodas' || i.svc==='postq'){
        durLabel = i.days + (i.days===1?' día':' días');
        total = 0; // a consultar
        extraLines.push('Precio bajo presupuesto. Te llamaremos para concretar.');
      }
      else if (i.svc==='exoticos'){
        durLabel = i.days + (i.days===1?' día':' días');
        total = 0; // configurable
        extraLines.push('Precio según especie y cuidados. Te llamaremos para concretar.');
      }

      // Multiplicador por zona (si lo usas)
      const zc = $('tpl-zone-code')?.value || '';
      const mult = (ZONE_MULTIPLIERS[zc] ?? 1);
      if (total!=null) total = total * mult;

      // Suma transporte
      if (transportCost>0) total = (total||0) + transportCost;

      // Pintar
      if ($('tpl-b-svc'))      $('tpl-b-svc').textContent = svcText || '—';
      if ($('tpl-b-periodo'))  $('tpl-b-periodo').textContent = periodo;
      if ($('tpl-b-duracion')) $('tpl-b-duracion').textContent = durLabel;
      if ($('tpl-b-notas'))    $('tpl-b-notas').textContent = (q('#notes')?.value.trim() || '—');

      const txt = (total==null) ? '—' : formatEUR(total);
      if ($('tpl-b-total'))        $('tpl-b-total').innerHTML = '<strong>'+txt+'</strong>';
      if ($('tpl-budget-amount'))  $('tpl-budget-amount').textContent = txt;

      // Añade líneas explicativas a “Notas” si quieres (no saturamos la tabla)
      // console.log(extraLines);

      return { total };
    }

    // Mostrar/ocultar bloques, recalcular
    ['service','startDate','endDate','start','end','notes','visitsPerDay','visitType','needTransport','km','animalType','breed','isPuppy','petCount']
    .forEach(function(id){
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener('change', updateBudget);
      el.addEventListener('input',  updateBudget);
    });

    document.addEventListener('DOMContentLoaded', function(){ updateBudget(); });
    window.addEventListener('tpl-auth-ready', function(){ updateBudget(); });

    window.TPL_BUDGET = { update:updateBudget, PRICING, ZONE_MULTIPLIERS };
  })();
  </script>

  <!-- Tu lógica de envíos / overlays / EmailJS extra -->
  <script src="reservas.js" defer></script>
</body>
</html>
