<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Reserva · The Pets Lovers</title>

  <!-- Canonical guard (no afecta a localhost ni GitHub Pages) -->
  <script>
  (function(){
    var CANON = 'www.thepetslovers.es';
    var host = location.hostname || '';
    var IS_DEV = /^(localhost|127\.0\.0\.1|0\.0\.0\.0)$/i.test(host) || /github\.io$/i.test(host);
    if (host && host !== CANON && !IS_DEV) {
      location.replace(location.protocol + '//' + CANON + location.pathname + location.search + location.hash);
    }
  })();
  </script>

  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Poppins:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <!-- Estilos mínimos locales -->
  <style>
    :root{
      --color-principal:#339496; --color-texto:#58425a;
      --ok:#128a57; --warn:#c77d00; --muted:#666;
      --chip:#eef7f7; --chip-b:#cde6e6;
    }
    body{background:#fafafa}
    .booking-wrapper{max-width:980px;margin:120px auto 60px;padding:20px;background:#fff;border:1px solid #eee;border-radius:12px;box-shadow:0 2px 12px rgba(0,0,0,.05)}
    .booking-header{text-align:center;margin-bottom:18px}
    .booking-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px}
    .booking-field{display:flex;flex-direction:column;gap:6px}
    .booking-field label{font-weight:700;font-size:.95rem;color:var(--color-texto)}
    .booking-field input,.booking-field select,.booking-field textarea{padding:10px 12px;border:1px solid #ddd;border-radius:8px;font-family:inherit}
    .cta-button{background:var(--color-principal);color:#fff;border:none;border-radius:999px;padding:10px 16px;cursor:pointer;font-weight:700}
    .cta-button[disabled]{opacity:.6;cursor:not-allowed}
    .muted{color:var(--muted)}
    .booking-actions{display:flex;gap:12px;justify-content:center;margin-top:16px;flex-wrap:wrap}
    .tpl-section{margin-top:18px}
    .tpl-section h2{margin:6px 0 8px;font-size:1.15rem}
    .auth-wall{padding:14px;border:1px dashed #bbb;border-radius:10px;text-align:center;background:#fafafa;margin-bottom:16px}
    .auth-wall strong{color:var(--color-texto)}
    .disabled{opacity:.6;pointer-events:none}
    .inline-note{font-size:.9rem;color:#444;background:#fff4e5;border:1px solid #ffe3b3;border-radius:10px;padding:10px}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{background:var(--chip);border:1px solid var(--chip-b);padding:6px 10px;border-radius:999px;font-weight:600}

    /* Overlay genérico (éxito/error) – lo usa reservas.js */
    .tpl-overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:9999}
    .tpl-overlay.on{display:flex}
    .tpl-modal{background:#fff;padding:20px;border-radius:12px;max-width:520px;box-shadow:0 8px 30px rgba(0,0,0,.2);text-align:center}
    .tpl-modal p{margin:0 0 12px}

    /* Línea inferior fija dentro de la tarjeta (mini presupuesto + nota login + ayuda) */
    .booking-footer-line{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-top:8px;flex-wrap:wrap}
    .help-link{white-space:nowrap;text-decoration:none;border:1px solid var(--color-principal);border-radius:999px;padding:8px 12px;font-weight:600;color:var(--color-principal)}

    /* Tabla presupuesto */
    .budget-card{border:1px solid #eee;border-radius:12px;padding:14px}
    .budget-table{width:100%;border-collapse:collapse}
    .budget-table th,.budget-table td{padding:8px;border-bottom:1px solid #f1f1f1;text-align:left}
    .budget-table tfoot th,.budget-table tfoot td{border-top:2px solid #ddd;border-bottom:none}
    .line-muted{color:#666}
  </style>
</head>
<body>

  <!-- Navbar unificada (inyectada) -->
  <div id="tpl-navbar">
    <noscript>
      <nav class="navbar">
        <div class="logo">
          <a href="index.html"><img src="images/logo.png.png" alt="The Pets Lovers"></a>
        </div>
        <a href="index.html" class="home-button">Inicio</a>
        <ul class="nav-links">
          <li><a href="como-funciona.html">Cómo funciona</a></li>
          <li><a href="servicios.html">Servicios</a></li>
          <li><a href="index.html#contactanos">Contáctanos</a></li>
          <li><a href="index.html#hazte-cuidador">Conviértete en cuidador</a></li>
        </ul>
        <a class="login-button" href="iniciar-sesion.html?next=reservas.html">Iniciar sesión</a>
      </nav>
    </noscript>
  </div>

  <div class="booking-wrapper" aria-live="polite">
    <div class="booking-header">
      <h1>Reserva tu servicio</h1>
      <p>Para reservar debes iniciar sesión. Tras enviar, recibirás confirmación por email.</p>
      <p class="inline-note" role="note">
        <strong>Nota importante:</strong> El <em>precio final</em> se confirma contigo tras revisar detalles y disponibilidad.
        El presupuesto mostrado es una <strong>estimación</strong>.
      </p>
    </div>

    <!-- Muro de autenticación + login inline -->
    <div id="authWall" class="auth-wall" aria-live="polite">
      <p><strong>Debes iniciar sesión para enviar una reserva.</strong></p>
      <div id="tpl-inline-login" class="tpl-inline-login"></div>
    </div>

    <!-- Formulario -->
    <form
      id="bookingForm"
      class="disabled"
      novalidate
      data-tpl-success="Tu solicitud se ha enviado correctamente."
      data-tpl-redirect="perfil.html"
      data-tpl-emailjs="true"
      data-service-id="service_odjqrfl"
      data-template-id="template_rao5n0c"
      data-public-key="L2xAATfVuHJwj4EIV"
      data-to-email="gestion@thepetslovers.es"
      data-to-name="Gestión The Pets Lovers"
    >
      <!-- Datos del servicio -->
      <section class="tpl-section" aria-labelledby="sec-servicio">
        <h2 id="sec-servicio">Datos del servicio</h2>
        <div class="booking-grid">
          <div class="booking-field">
            <label for="service">Servicio</label>
            <select id="service" name="Servicio" required>
              <option value="" selected>Elige un servicio…</option>
              <option value="visitas">Visitas a domicilio</option>
              <option value="paseos">Paseos</option>
              <option value="guarderia">Guardería de día</option>
              <option value="alojamiento">Alojamiento</option>
              <option value="bodas">Bodas / exclusivos</option>
            </select>
          </div>
          <div class="booking-field">
            <label for="startDate">Fecha inicio</label>
            <input type="date" id="startDate" name="Fecha_inicio" required>
          </div>
          <div class="booking-field">
            <label for="endDate">Fecha fin</label>
            <input type="date" id="endDate" name="Fecha_fin" required>
          </div>
          <div class="booking-field">
            <label for="start">Hora inicio</label>
            <input type="time" id="start" name="Hora_inicio" required>
          </div>
          <div class="booking-field">
            <label for="end">Hora fin</label>
            <input type="time" id="end" name="Hora_fin" required>
          </div>
        </div>

        <!-- Chips contexto -->
        <div class="chips" id="chips-context" aria-hidden="true" style="margin-top:6px">
          <span class="chip" id="chip-days">—</span>
          <span class="chip" id="chip-duration">—</span>
          <span class="chip" id="chip-bundle" hidden>—</span>
        </div>
      </section>

      <!-- Opciones específicas: VISITAS -->
      <section class="tpl-section" id="sec-visitas" aria-labelledby="h-visitas" hidden>
        <h2 id="h-visitas">Opciones de visitas</h2>
        <div class="booking-grid">
          <div class="booking-field">
            <label for="visitCount">Visitas por día</label>
            <select id="visitCount" name="Visitas_por_dia">
              <option value="1" selected>1 visita/día</option>
              <option value="2">2 visitas/día</option>
              <option value="3">3 visitas/día</option>
            </select>
          </div>
          <div class="booking-field">
            <label for="visitMinutes">Duración por visita</label>
            <select id="visitMinutes" name="Minutos_por_visita">
              <option value="30" selected>30 min</option>
              <option value="45">45 min</option>
              <option value="60">60 min</option>
            </select>
          </div>
          <div class="booking-field">
            <label for="visitExtras">Extras (opcional)</label>
            <select id="visitExtras" name="Visitas_extras">
              <option value="" selected>Sin extras</option>
              <option value="medicacion">Administración de medicación</option>
              <option value="limpieza">Limpieza de arenero / zona</option>
            </select>
          </div>
        </div>
      </section>

      <!-- Opciones específicas: PASEOS -->
      <section class="tpl-section" id="sec-paseos" aria-labelledby="h-paseos" hidden>
        <h2 id="h-paseos">Opciones de paseos</h2>
        <div class="booking-grid">
          <div class="booking-field">
            <label for="walkMinutes">Duración del paseo</label>
            <select id="walkMinutes" name="Minutos_por_paseo">
              <option value="30" selected>30 min</option>
              <option value="45">45 min</option>
              <option value="60">60 min</option>
            </select>
          </div>
          <div class="booking-field">
            <label for="walkBundle">Bono</label>
            <select id="walkBundle" name="Bono_paseos">
              <option value="" selected>Sin bono (paseo suelto)</option>
              <option value="5">Bono 5 días</option>
              <option value="10">Bono 10 días</option>
              <option value="20">Bono 20 días</option>
            </select>
          </div>
          <div class="booking-field">
            <label for="extraPets">Perros adicionales</label>
            <select id="extraPets" name="Perros_adicionales">
              <option value="0" selected>0</option>
              <option value="1">+1</option>
              <option value="2">+2</option>
              <option value="3">+3</option>
            </select>
          </div>
        </div>
      </section>

      <!-- Opciones específicas: GUARDERÍA / ALOJAMIENTO / BODAS -->
      <section class="tpl-section" id="sec-otros" aria-labelledby="h-otros" hidden>
        <h2 id="h-otros">Preferencias del servicio</h2>
        <div class="booking-grid">
          <div class="booking-field">
            <label for="needsCare">Necesidades especiales</label>
            <select id="needsCare" name="Necesidades_especiales">
              <option value="" selected>Ninguna</option>
              <option value="medicacion">Requiere medicación</option>
              <option value="ansiedad">Ansiedad / pautas específicas</option>
              <option value="cachorro">Cachorro</option>
            </select>
          </div>
          <div class="booking-field">
            <label for="holiday">¿Incluye festivos/días señalados?</label>
            <select id="holiday" name="Festivo">
              <option value="" selected>No</option>
              <option value="si">Sí (recargo)</option>
            </select>
          </div>
        </div>
      </section>

      <!-- Mascota -->
      <section class="tpl-section" id="tpl-pet-section" aria-labelledby="sec-mascota" hidden>
        <h2 id="sec-mascota">Tu mascota</h2>
        <div class="booking-grid">
          <div class="booking-field">
            <label for="tpl-pet-select">Selecciona la mascota</label>
            <select id="tpl-pet-select" name="Mascota"></select>
          </div>
        </div>
      </section>

      <!-- Fallback mascota (si Firestore no responde) -->
      <section class="tpl-section" id="pet-fallback" aria-labelledby="sec-mascota-fb" hidden>
        <h2 id="sec-mascota-fb">Tu mascota</h2>
        <div class="booking-grid">
          <div class="booking-field">
            <label for="pf-name">Nombre</label>
            <input type="text" id="pf-name" placeholder="Nombre de la mascota">
          </div>
          <div class="booking-field">
            <label for="pf-species">Especie</label>
            <select id="pf-species">
              <option value="">Selecciona…</option>
              <option>Perro</option>
              <option>Gato</option>
              <option>Otro</option>
            </select>
          </div>
          <div class="booking-field">
            <label for="pf-breed">Raza (opcional)</label>
            <input type="text" id="pf-breed" placeholder="Ej. mestizo">
          </div>
        </div>
        <p class="muted" style="margin-top:6px">*Este bloque solo aparece si no pudimos cargar tus mascotas.</p>
      </section>

      <!-- Datos de contacto -->
      <section class="tpl-section" aria-labelledby="sec-titular">
        <h2 id="sec-titular">Datos de contacto</h2>
        <div class="booking-grid">
          <div class="booking-field">
            <label for="firstName">Nombre</label>
            <input type="text" id="firstName" name="Nombre" required autocomplete="given-name">
          </div>
          <div class="booking-field">
            <label for="lastName">Apellidos</label>
            <input type="text" id="lastName" name="Apellidos" required autocomplete="family-name">
          </div>
          <div class="booking-field">
            <label for="email">Email</label>
            <input type="email" id="email" name="Email" required autocomplete="email">
          </div>
          <div class="booking-field">
            <label for="phone">Teléfono</label>
            <input type="tel" id="phone" name="Telefono" required autocomplete="tel" inputmode="tel">
          </div>
          <div class="booking-field">
            <label for="postalCode">Código Postal</label>
            <input type="text" id="postalCode" name="CP" required inputmode="numeric" pattern="[0-9]{5}" maxlength="5" placeholder="Ej. 28012">
          </div>
          <div class="booking-field" style="grid-column:1/-1">
            <label for="notes">Notas (opcional)</label>
            <textarea id="notes" name="Notas" rows="3" placeholder="Rutinas, medicación, horarios…"></textarea>
          </div>
        </div>
        <p class="muted" style="margin-top:4px">El precio final puede variar por <em>desplazamiento</em>, horarios especiales, festivos o necesidades específicas.</p>
      </section>

      <!-- Resumen (email) -->
      <input type="hidden" name="Desglose" id="summaryField">

      <!-- Fallback por si algún script usa sendForm -->
      <input type="hidden" name="to_email" value="gestion@thepetslovers.es">
      <input type="hidden" name="to_name" value="Gestión The Pets Lovers">

      <!-- Ocultos EmailJS + tracking -->
      <input type="hidden" name="_replyto" id="tpl-replyto">
      <input type="hidden" name="uid" id="tpl-uid">
      <input type="hidden" name="perfil_url" id="tpl-perfil-url">

      <!-- Ocultos mascota elegida -->
      <input type="hidden" name="Mascota_nombre" id="tpl-pet-name">
      <input type="hidden" name="Mascota_especie" id="tpl-pet-species">
      <input type="hidden" name="Mascota_raza" id="tpl-pet-breed">
      <input type="hidden" name="Mascota_tamano" id="tpl-pet-size">
      <input type="hidden" name="Mascota_medicacion" id="tpl-pet-med">
      <input type="hidden" name="Mascota_necesidades" id="tpl-pet-needs">
      <input type="hidden" name="Mascota_id" id="tpl-pet-id">

      <!-- Ocultos zona por CP -->
      <input type="hidden" name="Zona_codigo" id="tpl-zone-code">
      <input type="hidden" name="Zona_nombre" id="tpl-zone-name">

      <div class="booking-actions">
        <button type="submit" class="cta-button">Solicitar reserva</button>
      </div>

      <!-- Línea inferior fija dentro de la tarjeta -->
      <div class="booking-footer-line" id="tpl-booking-footer">
        <span class="footer-left" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <span id="tpl-budget-mini">Presupuesto estimado: <strong id="tpl-budget-amount">—</strong></span>
          <span class="footer-note" id="tpl-login-note">• Envío requiere sesión iniciada. Te confirmaremos por email.</span>
        </span>
        <a href="ayuda.html" class="help-link" id="tpl-help-link">
          <i class="fa-regular fa-circle-question"></i> Centro de ayuda
        </a>
      </div>
    </form>

    <!-- Presupuesto detallado -->
    <section class="tpl-section budget-section" id="tpl-budget-section" aria-labelledby="sec-presupuesto" style="margin-top:24px">
      <h2 id="sec-presupuesto" style="margin:6px 0 8px;font-size:1.15rem">Presupuesto estimado</h2>
      <div class="budget-card">
        <table class="budget-table">
          <tbody>
            <tr><th>Servicio</th><td id="tpl-b-svc">—</td></tr>
            <tr><th>Periodo</th><td id="tpl-b-periodo">—</td></tr>
            <tr><th>Duración</th><td id="tpl-b-duracion">—</td></tr>
            <tr><th>Mascota</th><td id="tpl-b-mascota">—</td></tr>
            <tr><th>Notas</th><td id="tpl-b-notas">—</td></tr>
            <tr class="line-muted"><th colspan="2">Desglose</th></tr>
            <tr><th>Base</th><td id="tpl-line-base">—</td></tr>
            <tr><th>Extras</th><td id="tpl-line-extras">—</td></tr>
            <tr><th>Recargo festivo</th><td id="tpl-line-festivo">—</td></tr>
            <tr><th>Zona</th><td id="tpl-line-zona">—</td></tr>
            <tr><th>Señal</th><td id="tpl-line-senal">—</td></tr>
          </tbody>
          <tfoot>
            <tr class="total">
              <th>Total</th>
              <td id="tpl-b-total"><strong>—</strong></td>
            </tr>
          </tfoot>
        </table>
        <div class="budget-actions" style="display:flex;gap:12px;align-items:center;margin-top:10px;flex-wrap:wrap">
          <button type="button" class="cta-button" id="tpl-pay-btn">Pagar ahora</button>
          <small class="muted">El pago es una señal: ajustaremos diferencias si las hay.</small>
        </div>
      </div>
    </section>
  </div>

  <!-- Footer unificado (inyectado) -->
  <div id="tpl-footer"><noscript>…</noscript></div>

  <!-- Mini-injectors -->
  <script src="tpl-navbar.js" defer></script>
  <script src="tpl-footer.js" defer></script>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <!-- Inicialización de Firebase -->
  <script>
  (function(){
    const firebaseConfig = {
      apiKey: "AIzaSyDW73aFuz2AFS9VeWg_linHIRJYN4YMgTk",
      authDomain: "thepetslovers-c1111.firebaseapp.com",
      projectId: "thepetslovers-c1111",
      storageBucket: "thepetslovers-c1111.appspot.com",
      messagingSenderId: "415914577533",
      appId: "1:415914577533:web:0b7a056ebaa4f1de28ab14"
    };
    if (typeof firebase !== 'undefined') {
      if (firebase.apps.length === 0) firebase.initializeApp(firebaseConfig);
      try { firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL); } catch(_){}
    }
  })();
  </script>

  <!-- EmailJS + init (se mantiene exactamente igual) -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script>
    window.TPL_EMAILJS = {
      serviceId: 'service_odjqrfl',
      templateId: 'template_rao5n0c',
      publicKey:  'L2xAATfVuHJwj4EIV',
      toEmail: 'gestion@thepetslovers.es',
      toName:  'Gestión The Pets Lovers'
    };
    (function(){
      const cfg = window.TPL_EMAILJS || {};
      if (window.emailjs && (cfg.publicKey||cfg.userId)) {
        try{ emailjs.init({ publicKey: cfg.publicKey || cfg.userId }); }catch(_){}
      }
    })();
  </script>

  <!-- Página de login por defecto para los next= -->
  <script>window.TPL_LOGIN_PAGE = 'iniciar-sesion.html';</script>

  <!-- Bootstrap Auth unificado (igual que tenías) -->
  <script>
  (function(){
    'use strict';
    var DEBUG = /[?&]debugAuth=1\b/.test(location.search);
    function $(sel, root){ return (root||document).querySelector(sel); }
    var LOGIN_CANDIDATES = ['iniciar-sesion.html','iniciar-sesión.html','login.html'];
    function getLoginBase(){ return window.TPL_LOGIN_PAGE || LOGIN_CANDIDATES[0]; }
    function buildNext(){ var p=(location.pathname||'').replace(/^\//,''); return p+(location.search||'')+(location.hash||''); }
    function buildLoginUrl(nextOverride){ var base=getLoginBase(); var next=nextOverride||buildNext(); return base+'?next='+encodeURIComponent(next); }

    window.__TPL_AUTH__ = window.__TPL_AUTH__ || { user:null, ready:null };

    function updateUI(user){
      var wall = $('#authWall');
      var form = $('#bookingForm');
      var slot = $('#tpl-inline-login');
      if (!wall || !form) return;

      if (user) {
        wall.style.display = 'none';
        form.classList.remove('disabled');
        var note = document.getElementById('tpl-login-note'); if (note) note.style.display = 'none';
        var email = $('#email'); if (user.email && email && !email.value) email.value = user.email;
        var name  = $('#firstName');
        if (user.displayName && name && !name.value) {
          var dn = String(user.displayName).trim(); name.value = dn.split(' ')[0] || dn;
        }
      } else {
        wall.style.display = 'block';
        form.classList.add('disabled');
        var note = document.getElementById('tpl-login-note'); if (note) note.style.display = '';
        if (slot && !slot.hasChildNodes()) {
          var loginUrl = buildLoginUrl();
          slot.innerHTML =
            '<a class="cta-button" href="'+ loginUrl +'">Iniciar sesión</a> '+
            '<a class="help-link" style="border-color:#ccc;color:#666" href="index.html#iniciar-sesion">Volver al inicio</a>';
        }
        if (window.TPL_REQUIRE_LOGIN_ON_RESERVAS === true) { location.href = buildLoginUrl(); }
      }
    }

    function setupAuthBridge(){
      if (typeof firebase === 'undefined' || !firebase.auth) return;
      var auth = firebase.auth();
      if (!window.__TPL_AUTH__.ready) {
        window.__TPL_AUTH__.ready = new Promise(function(resolve){
          var first = true;
          function handle(user){
            window.__TPL_AUTH__.user = user || null;
            try { document.body.setAttribute('data-auth', user ? 'in' : 'out'); } catch(_){}
            try { window.dispatchEvent(new CustomEvent('tpl-auth-change', { detail:{ email: user ? (user.email||null) : null } })); } catch(_){}
            if (first) { first=false; try { window.dispatchEvent(new CustomEvent('tpl-auth-ready', { detail:{ user:user||null } })); } catch(_){} resolve(user||null); }
            if (DEBUG) console.log('[TPL][Auth] Estado:', user ? user.uid : null);
            updateUI(user);
          }
          auth.onAuthStateChanged(handle);
          handle(auth.currentUser);
        });
      } else {
        window.__TPL_AUTH__.ready.then(updateUI);
      }
    }
    setupAuthBridge();
    var tries=0, t=setInterval(function(){
      tries++;
      if (window.__TPL_AUTH__ && window.__TPL_AUTH__.ready) { clearInterval(t); return; }
      setupAuthBridge();
      if (tries > 30) clearInterval(t);
    }, 100);
  })();
  </script>

  <!-- Auto-recovery IMG *.png.png → *.png -->
  <script>
  (function(){
    window.addEventListener('error', function(e){
      var el = e.target;
      if (!el || !el.tagName) return;
      if (el.tagName === 'IMG' && /(\.png\.png)(\?.*)?$/i.test(el.src||'')) {
        var fixed = el.src.replace(/\.png\.png/i, '.png'); el.onerror = null; el.src = fixed;
      }
    }, true);
  })();
  </script>

  <!-- Paso 1: Autocomplete titular + hidden reply_to/uid -->
  <script>
  (function(){
    'use strict';
    window.TPL_REQUIRE_LOGIN_ON_RESERVAS = true;

    function $(sel, root){ return (root||document).querySelector(sel); }
    function setIfEmpty(input, val){ if (input && !input.value && val) input.value = val; }
    function splitFullName(full){
      if (!full) return { nombre:'', apellidos:'' };
      var s = String(full).trim().replace(/\s+/g,' ');
      var parts = s.split(' ');
      if (parts.length === 1) return { nombre: parts[0], apellidos: '' };
      return { nombre: parts[0], apellidos: parts.slice(1).join(' ') };
    }

    function syncHidden(user){
      var hidReply = $('#tpl-replyto');
      var hidUid   = $('#tpl-uid');
      var hidProf  = $('#tpl-perfil-url');
      if (hidUid && user && user.uid) hidUid.value = user.uid;
      if (hidProf) hidProf.value = 'perfil.html';
      var inputEmail = $('#email');
      var emailVal = (inputEmail && inputEmail.value) ? inputEmail.value : (user && user.email) || '';
      if (hidReply) hidReply.value = emailVal;
    }
    function bindReplySync(){
      var email = $('#email'); var hidReply = $('#tpl-replyto');
      if (!email || !hidReply) return;
      email.addEventListener('input', function(){ hidReply.value = email.value || ''; });
    }
    function onAuthReady(cb){
      if (window.__TPL_AUTH__ && window.__TPL_AUTH__.ready) { window.__TPL_AUTH__.ready.then(cb); }
      else { window.addEventListener('tpl-auth-ready', function(ev){ cb(ev.detail && ev.detail.user ? ev.detail.user : null); }, { once:true }); }
    }
    onAuthReady(function(user){
      try{
        if (user){
          if (user.email) setIfEmpty($('#email'), user.email);
          var sp = splitFullName(user.displayName || '');
          if (sp.nombre || sp.apellidos){ setIfEmpty($('#firstName'), sp.nombre); setIfEmpty($('#lastName'), sp.apellidos); }
        }
      }catch(_){}
      syncHidden(user);
      bindReplySync();
    });
    window.addEventListener('tpl-auth-change', function(){
      var user = (window.__TPL_AUTH__ && window.__TPL_AUTH__.user) || null;
      syncHidden(user);
    });
  })();
  </script>

  <!-- Paso 2: Selector de mascota (UDB/Firestore) con fallback -->
  <script>
  (function(){
    'use strict';
    var $ = function(sel, root){ return (root||document).querySelector(sel); };
    function udbKey(uid, key){ return 'tpl.udb.' + uid + '.' + key; }
    function udbGet(uid, key){
      try{ var raw = localStorage.getItem(udbKey(uid, key)); return raw ? JSON.parse(raw) : null; }catch(_){ return null; }
    }
    function toArrayMaybe(objOrArr){
      if (!objOrArr) return [];
      if (Array.isArray(objOrArr)) return objOrArr;
      return Object.keys(objOrArr).map(function(k){ return Object.assign({id:k}, objOrArr[k]); });
    }
    function normalizePet(p){
      if (!p) return null;
      var id  = p.id || p.uid || p._id || p.chip || p.chipid || p.microchip || null;
      var nombre = p.nombre || p.name || p.petName || '';
      var especie = p.especie || p.tipo || p.species || p.type || '';
      var raza = p.raza || p.breed || '';
      var tam = p.tamano || p['tamaño'] || p.size || '';
      var meds = p.medicacion || p['medicación'] || p.medication || '';
      var needs = p.necesidades || p.needs || p.specialNeeds || '';
      return { id:id, nombre:nombre, especie:especie, raza:raza, tamano:tam, medicacion:meds, necesidades:needs };
    }
    async function loadPetsFromFirestore(uid){
      var list = [];
      try{
        if (typeof firebase === 'undefined' || !firebase.firestore) return list;
        var db = firebase.firestore();
        var cols = ['owners','propietarios','profiles','usuarios'];
        for (var i=0;i<cols.length;i++){
          var ref = db.collection(cols[i]).doc(uid);
          try{
            var sub1 = await ref.collection('mascotas').get().catch(()=>null);
            if (sub1 && !sub1.empty){ sub1.forEach(function(d){ list.push(normalizePet(Object.assign({id:d.id}, d.data()))); }); }
            var sub2 = await ref.collection('pets').get().catch(()=>null);
            if (sub2 && !sub2.empty){ sub2.forEach(function(d){ list.push(normalizePet(Object.assign({id:d.id}, d.data()))); }); }
            var main = await ref.get().catch(()=>null);
            if (main && main.exists){
              var data = main.data()||{};
              toArrayMaybe(data.mascotas).forEach(function(p){ list.push(normalizePet(p)); });
              toArrayMaybe(data.pets).forEach(function(p){ list.push(normalizePet(p)); });
            }
            if (list.length) break;
          }catch(_){}
        }
        if (!list.length){
          var q1 = await db.collection('mascotas').where('ownerUid','==',uid).get().catch(()=>null);
          if (q1 && !q1.empty){ q1.forEach(function(d){ list.push(normalizePet(Object.assign({id:d.id}, d.data()))); }); }
          if (!list.length){
            var q2 = await db.collection('mascotas').where('uid','==',uid).get().catch(()=>null);
            if (q2 && !q2.empty){ q2.forEach(function(d){ list.push(normalizePet(Object.assign({id:d.id}, d.data()))); }); }
          }
        }
      }catch(_){}
      return list.filter(Boolean);
    }
    function applyPetHidden(p){
      var map = {
        'tpl-pet-id': p.id||'',
        'tpl-pet-name': p.nombre||'',
        'tpl-pet-species': p.especie||'',
        'tpl-pet-breed': p.raza||'',
        'tpl-pet-size': p.tamano||'',
        'tpl-pet-med': p.medicacion||'',
        'tpl-pet-needs': p.necesidades||''
      };
      Object.keys(map).forEach(function(id){
        var el = document.getElementById(id); if (el) el.value = map[id];
      });
      document.getElementById('tpl-b-mascota').textContent =
        [p.nombre, [p.especie, p.raza].filter(Boolean).join(', ') ? '('+[p.especie,p.raza].filter(Boolean).join(', ')+')':'' ].filter(Boolean).join(' ');
    }
    function labelFor(p){
      var meta = [p.especie||'', p.raza||''].filter(Boolean).join(', ');
      return (p.nombre || 'Mascota') + (meta ? ' ('+meta+')' : '');
    }
    function renderPets(uid, pets){
      var sec = $('#tpl-pet-section');
      var sel = $('#tpl-pet-select');
      pets = (pets||[]).map(normalizePet).filter(Boolean);
      if (!pets.length){ if (sec) sec.hidden = true; document.getElementById('pet-fallback').hidden=false; return; }
      document.getElementById('pet-fallback').hidden=true;
      if (pets.length === 1){ if (sec) sec.hidden = true; applyPetHidden(pets[0]); return; }
      if (!sec || !sel) return;
      sec.hidden = false; sel.innerHTML = '';
      pets.forEach(function(p){
        var opt = new Option(labelFor(p), p.id || p.nombre || '');
        try{ opt.dataset.pet = JSON.stringify(p); }catch(_){}
        sel.appendChild(opt);
      });
      sel.onchange = function(){
        var o = sel.options[sel.selectedIndex]; if (!o) return;
        var p = null; try{ p = JSON.parse(o.dataset.pet||'{}'); }catch(_){}
        if (p) applyPetHidden(p);
      };
      sel.onchange();
    }
    function onAuthReady(cb){
      if (window.__TPL_AUTH__ && window.__TPL_AUTH__.ready) window.__TPL_AUTH__.ready.then(cb);
      else window.addEventListener('tpl-auth-ready', function(ev){ cb(ev.detail ? ev.detail.user : null); }, {once:true});
    }
    onAuthReady(async function(user){
      var uid = user && user.uid; if (!uid){ document.getElementById('pet-fallback').hidden=false; return; }
      // 1º UDB local
      var udb = (function(){
        try{
          var raw = udbGet(uid,'mascotas') || udbGet(uid,'pets') || [];
          return toArrayMaybe(raw).map(normalizePet).filter(Boolean);
        }catch(_){ return []; }
      })();
      if (udb.length){ renderPets(uid, udb); return; }
      // 2º Firestore
      var fs = await loadPetsFromFirestore(uid);
      if (fs && fs.length) renderPets(uid, fs);
      else document.getElementById('pet-fallback').hidden=false;
    });

    // Fallback: si el usuario rellena manual, volcamos a ocultos
    ['pf-name','pf-species','pf-breed'].forEach(function(id){
      var el = document.getElementById(id);
      if (!el) return;
      el.addEventListener('input', function(){
        document.getElementById('tpl-pet-name').value = document.getElementById('pf-name').value || '';
        document.getElementById('tpl-pet-species').value = document.getElementById('pf-species').value || '';
        document.getElementById('tpl-pet-breed').value = document.getElementById('pf-breed').value || '';
        var txt = (document.getElementById('pf-name').value||'') + ' ' + ((document.getElementById('pf-species').value||'')? '('+document.getElementById('pf-species').value+')':'');
        document.getElementById('tpl-b-mascota').textContent = txt.trim() || '—';
      });
    });
  })();
  </script>

  <!-- Validaciones suaves + Desglose vivo + Teléfono ES + Url params -->
  <script>
  (function(){
    'use strict';
    var $ = function(sel, root){ return (root||document).querySelector(sel); };
    var form = $('#bookingForm'); if (!form) return;

    // Lead por servicio
    var LEAD_HOURS_MAP = { visitas:12, paseos:12, guarderia:24, alojamiento:48, bodas:72 };
    var DEFAULT_LEAD_HOURS = 24;

    function leadForSvc(key){ return LEAD_HOURS_MAP[key] || DEFAULT_LEAD_HOURS; }

    function parseDate(d){ if(!d) return null; var p=d.split('-'); if(p.length!==3) return null; return new Date(+p[0], +p[1]-1, +p[2], 12, 0, 0, 0); }
    function parseTime(t){ if(!t) return null; var p=t.split(':'); if(p.length<2) return null; return {h:+p[0], m:+p[1]}; }
    function combine(dt, tm){ if(!dt||!tm) return null; var d=new Date(dt); d.setHours(tm.h, tm.m, 0, 0); return d; }
    function fmtDate(d){ return d.toLocaleDateString('es-ES', {weekday:'short', day:'2-digit', month:'2-digit', year:'numeric'}); }
    function fmtTime(d){ return d.toLocaleTimeString('es-ES', {hour:'2-digit', minute:'2-digit'}); }
    function daysBetween(a,b){ var D=Math.ceil((b-a)/86400000); return Math.max(1, D); }

    function cleanPhone(s){ if (!s) return ''; return String(s).replace(/[\s\-().]/g,'').replace(/^(\+34)(34)/,'$1'); }
    function validPhoneES(s){ var x = cleanPhone(s); if (/^\+34\d{9}$/.test(x)) return true; if (/^\d{9}$/.test(x)) return true; return false; }

    var elService=$('#service'), elSD=$('#startDate'), elED=$('#endDate'), elST=$('#start'), elET=$('#end');
    var elPhone=$('#phone'), elEmail=$('#email'), elNotes=$('#notes'), elSummary=$('#summaryField');

    // Mostrar secciones según servicio
    function toggleServiceBlocks(){
      var v = (elService && elService.value)||'';
      $('#sec-visitas').hidden = (v!=='visitas');
      $('#sec-paseos').hidden  = (v!=='paseos');
      $('#sec-otros').hidden   = (v==='' || v==='paseos' || v==='visitas');
    }

    function validateDates(){
      elSD.setCustomValidity(''); elED.setCustomValidity(''); elST.setCustomValidity(''); elET.setCustomValidity('');
      var svc=(elService && elService.value)||'';
      var sd=parseDate(elSD.value), ed=parseDate(elED.value), st=parseTime(elST.value), et=parseTime(elET.value);
      if (!sd || !ed || !st || !et) return true;
      var sDT=combine(sd,st), eDT=combine(ed,et);
      if (eDT < sDT){ elED.setCustomValidity('La fecha/hora de fin debe ser posterior a la de inicio.'); elET.setCustomValidity('La fecha/hora de fin debe ser posterior a la de inicio.'); return false; }
      if (sd.getFullYear()===ed.getFullYear() && sd.getMonth()===ed.getMonth() && sd.getDate()===ed.getDate()){
        if (eDT <= sDT){ elET.setCustomValidity('Para el mismo día, la hora fin debe ser mayor que la hora inicio.'); return false; }
      }
      var now = new Date(); var minStart = new Date(now.getTime() + (leadForSvc(svc))*3600*1000);
      if (sDT < minStart){ elSD.setCustomValidity('Este servicio debe pedirse con al menos '+leadForSvc(svc)+'h de antelación.'); elST.setCustomValidity('Este servicio debe pedirse con al menos '+leadForSvc(svc)+'h de antelación.'); return false; }
      return true;
    }
    function validatePhone(){
      elPhone.setCustomValidity('');
      var val = elPhone.value.trim();
      if (!val) return true;
      if (!validPhoneES(val)){ elPhone.setCustomValidity('Introduce un teléfono válido (9 dígitos, admite prefijo +34).'); return false; }
      return true;
    }

    function currentPetText(){
      var n=document.getElementById('tpl-pet-name')?.value||'';
      var s=document.getElementById('tpl-pet-species')?.value||'';
      var b=document.getElementById('tpl-pet-breed')?.value||'';
      var meta=[s,b].filter(Boolean).join(', ');
      return [n, meta?('('+meta+')'):''].filter(Boolean).join(' ');
    }
    function buildSummary(){
      var sd=parseDate(elSD.value), ed=parseDate(elED.value);
      var st=parseTime(elST.value), et=parseTime(elET.value);
      var sDT=(sd && st)?combine(sd,st):null, eDT=(ed && et)?combine(ed,et):null;

      var parts=[], svc=elService.value ? elService.options[elService.selectedIndex].text : '';
      if (svc) parts.push('Servicio: '+svc);
      if (sDT) parts.push('Inicio: ' + fmtDate(sDT) + ' ' + fmtTime(sDT));
      if (eDT) parts.push('Fin: '    + fmtDate(eDT) + ' ' + fmtTime(eDT));
      var pet=currentPetText(); if (pet) parts.push('Mascota: ' + pet);

      // Servicio específico
      if ((elService.value||'')==='visitas'){
        var c=document.getElementById('visitCount')?.value||'';
        var m=document.getElementById('visitMinutes')?.value||'';
        if (c) parts.push('Visitas/día: '+c);
        if (m) parts.push('Min/visita: '+m);
        var ex=document.getElementById('visitExtras')?.value||'';
        if (ex) parts.push('Extra: '+ex);
      }
      if ((elService.value||'')==='paseos'){
        var w=document.getElementById('walkMinutes')?.value||'';
        var b=document.getElementById('walkBundle')?.value||'';
        var ap=document.getElementById('extraPets')?.value||'0';
        if (w) parts.push('Min/paseo: '+w);
        if (b) parts.push('Bono: '+b+' días');
        if (ap && ap!=='0') parts.push('Perros adicionales: '+ap);
      }
      var hol=document.getElementById('holiday')?.value||'';
      if (hol==='si') parts.push('Incluye festivo');

      var notes=(elNotes && elNotes.value.trim()) ? ('Notas: ' + elNotes.value.trim()) : '';
      if (notes) parts.push(notes);

      // CP/Zona se añaden desde el bloque CP
      elSummary.value = parts.join(' • ');
    }

    // Chips
    function updateChips(){
      var chipDays = $('#chip-days'), chipDur = $('#chip-duration'), chipB = $('#chip-bundle');
      var svc = (elService.value||'');
      var sd=parseDate(elSD.value), ed=parseDate(elED.value), st=parseTime(elST.value), et=parseTime(elET.value);
      var sDT=(sd && st)?combine(sd,st):null, eDT=(ed && et)?combine(ed,et):null;
      var days = (sd && ed) ? daysBetween(sd, ed) : 0;

      chipDays.textContent = days ? (days + (days===1?' día':' días')) : '—';
      chipDur.textContent = (function(){
        if (svc==='visitas'){
          var v = document.getElementById('visitMinutes')?.value||'';
          var c = document.getElementById('visitCount')?.value||'';
          return (v? (v+' min/visita'):'—') + (c? (' · '+c+' v/día'):'');
        }
        if (svc==='paseos'){
          var w = document.getElementById('walkMinutes')?.value||'';
          return w? (w+' min/paseo'):'—';
        }
        if (sDT && eDT) return 'Rango: '+sDT.toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'})+'–'+eDT.toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'});
        return '—';
      })();
      var b=document.getElementById('walkBundle')?.value||'';
      chipB.hidden = !(svc==='paseos' && b);
      if (!chipB.hidden) chipB.textContent = 'Bono '+b+' días';
    }

    [elService, elSD, elED, elST, elET, elNotes].forEach(function(el){
      if (!el) return;
      el.addEventListener('change', function(){ toggleServiceBlocks(); validateDates(); buildSummary(); updateChips(); });
      el.addEventListener('input',  function(){ toggleServiceBlocks(); validateDates(); buildSummary(); updateChips(); });
    });
    ['visitCount','visitMinutes','visitExtras','walkMinutes','walkBundle','extraPets','holiday']
      .forEach(function(id){
        var el = document.getElementById(id); if (!el) return;
        el.addEventListener('change', function(){ validateDates(); buildSummary(); updateChips(); window.TPL_BUDGET && TPL_BUDGET.update(); });
        el.addEventListener('input',  function(){ validateDates(); buildSummary(); updateChips(); window.TPL_BUDGET && TPL_BUDGET.update(); });
      });

    if (elPhone){ elPhone.addEventListener('input', validatePhone); elPhone.addEventListener('blur',  validatePhone); }
    document.addEventListener('DOMContentLoaded', function(){
      toggleServiceBlocks(); buildSummary(); updateChips();
      // Preselección desde query
      try{
        var usp=new URLSearchParams(location.search);
        var svc=usp.get('service'); if (svc && $('#service')){ $('#service').value=svc; }
        if (usp.get('duration')){ var d=usp.get('duration'); if (svc==='visitas') $('#visitMinutes').value=d; if (svc==='paseos') $('#walkMinutes').value=d; }
        if (usp.get('bundle') && svc==='paseos'){ $('#walkBundle').value=usp.get('bundle'); }
        if (usp.get('visits') && svc==='visitas'){ $('#visitCount').value=usp.get('visits'); }
        ['startDate','endDate','start','end'].forEach(function(k){ if (usp.get(k) && $('#'+k)) $('#'+k).value=usp.get(k); });
      }catch(_){}
    });

    form.addEventListener('submit', function(){ validatePhone(); validateDates(); buildSummary(); }, true);
  })();
  </script>

  <!-- CP → Zona (rellena ocultos y añade a desglose) -->
  <script>
  (function(){
    'use strict';
    var $ = function(s, r){ return (r||document).querySelector(s); };
    // Define aquí tus zonas (ejemplos):
    // window.TPL_CP_ZONES = [
    //   { prefix:'28', code:'MAD', name:'Madrid' },
    //   { prefix:'36', code:'PO',  name:'Pontevedra' },
    //   { prefix:'15', code:'C',   name:'A Coruña' },
    // ];
    function zoneForCP(cp){
      cp = (cp||'').trim();
      if (!/^[0-9]{5}$/.test(cp)) return null;
      var zones = window.TPL_CP_ZONES || [];
      var p3 = cp.slice(0,3), p2 = cp.slice(0,2);
      return zones.find(z=>z.prefix===p3) || zones.find(z=>z.prefix===p2) || null;
    }
    function sanitizeCpValue(v){ return String(v||'').replace(/\D+/g,'').slice(0,5); }
    function updateHiddenAndSummary(){
      var cpEl = $('#postalCode'), sum = $('#summaryField');
      var code = $('#tpl-zone-code'), name = $('#tpl-zone-name');
      if (!cpEl || !sum || !code || !name) return;
      var cp = sanitizeCpValue(cpEl.value);
      if (cp !== cpEl.value) cpEl.value = cp;

      var z = zoneForCP(cp);
      code.value = z ? z.code : '';
      name.value = z ? z.name : '';

      var parts = (sum.value || '').split(' • ').filter(Boolean);
      parts = parts.filter(p=> !/^CP:/i.test(p) && !/^Zona:/i.test(p));
      if (cp) parts.push('CP: ' + cp);
      if (z && (z.code || z.name)) parts.push('Zona: ' + (z.code ? (z.code + (z.name ? ' - '+z.name : '')) : z.name));
      sum.value = parts.join(' • ');

      // refrescar presupuesto
      try{ window.TPL_BUDGET.update(); }catch(_){}
    }
    var cp = $('#postalCode'); if (!cp) return;
    cp.setAttribute('type','text'); cp.setAttribute('pattern','[0-9]{5}'); cp.setAttribute('inputmode','numeric'); cp.setAttribute('maxlength','5');
    cp.addEventListener('input', updateHiddenAndSummary);
    cp.addEventListener('blur',  updateHiddenAndSummary);
    document.addEventListener('DOMContentLoaded', updateHiddenAndSummary);
  })();
  </script>

  <!-- Normalizador Nombre/Apellidos -->
  <script>
  (function(){
    'use strict';
    function $(id){ return document.getElementById(id); }
    function splitSmart(text){
      if (!text) return {nombre:'', apellidos:''};
      var s = String(text).trim().replace(/\s+/g,' ');
      if (s.includes(',')){
        var a = s.split(',');
        var left  = (a[0]||'').trim();
        var right = (a.slice(1).join(',')||'').trim();
        return { nombre: right || '', apellidos: left || '' };
      }
      var parts = s.split(' ');
      if (parts.length === 1) return { nombre: parts[0], apellidos: '' };
      return { nombre: parts[0], apellidos: parts.slice(1).join(' ') };
    }
    function normalizeNameFields(){
      var f = $('firstName'), l = $('lastName'); if (!f || !l) return;
      var fv = (f.value||'').trim(), lv = (l.value||'').trim();
      if (fv && (!lv || lv === fv || /\s/.test(fv))){
        var s = splitSmart(fv);
        if (s.nombre) f.value = s.nombre;
        if (s.apellidos && !lv) l.value = s.apellidos;
      }
    }
    document.addEventListener('DOMContentLoaded', normalizeNameFields);
    window.addEventListener('tpl-auth-ready', normalizeNameFields);
    window.addEventListener('tpl-auth-change', normalizeNameFields);
    var f = document.getElementById('firstName'); var l = document.getElementById('lastName');
    if (f) f.addEventListener('blur', normalizeNameFields);
    if (l) l.addEventListener('blur', normalizeNameFields);
  })();
  </script>

  <!-- PRESUPUESTO + PAGOS (Stripe Checkout) -->
  <script>
  (function(){
    'use strict';

    // 1) Tarifas (puedes ajustar números cuando quieras)
    const PRICING = {
      // Visitas por visita (según minutos)
      visitas: {
        mode:'visit',
        ratesByMin: { 30: 7, 45: 10.5, 60: 14 }, // € por visita
        extras: {
          medicacion: 3,   // € por visita
          limpieza:   2    // € por visita
        }
      },
      // Paseos por paseo (según minutos) + bonos con descuento
      paseos: {
        mode:'walk',
        ratesByMin: { 30: 6, 45: 9, 60: 12 }, // € por paseo suelto
        bundleDiscount: { 5: 0.05, 10: 0.10, 20: 0.15 }, // descuentos sobre SUELTO
        extraPetPerPaseo: 3 // € por perro adicional y paseo
      },
      guarderia:   { mode:'day',   rate:25, min:1 },
      alojamiento: { mode:'night', rate:28, min:1 },
      bodas:       { mode:'hour',  rate:35, min:2, step:1 }
    };

    // 2) Multiplicadores por zona (opcional)
    const ZONE_MULTIPLIERS = { /* 'MAD':1.05 */ };

    // 3) Recargos y señal
    const RECARGO_FESTIVOS = 0.15;     // 15%
    const SENAL_PORCENTAJE = 0.20;     // 20% de señal

    // 4) Stripe (configurar antes de producción)
    const STRIPE_PK = window.STRIPE_PK || ''; // pk_live_xxx / pk_test_xxx
    const PRICE_IDS = {
      // visitas:     'price_xxx_visita',
      // paseos:      'price_xxx_paseo',
      // guarderia:   'price_xxx_day',
      // alojamiento: 'price_xxx_night',
      // bodas:       'price_xxx_hour'
    };
    const SUCCESS_URL = (location.origin || '') + '/perfil.html?paid=1';
    const CANCEL_URL  = (location.href);

    const $ = (id)=> document.getElementById(id);
    const q = (sel,root)=> (root||document).querySelector(sel);

    function parseDate(s){ if(!s) return null; const p=s.split('-'); if(p.length!==3) return null; return new Date(+p[0], +p[1]-1, +p[2], 12,0,0,0); }
    function parseTime(s){ if(!s) return null; const p=s.split(':'); if(p.length<2) return null; return {h:+p[0], m:+p[1]}; }
    function combine(d,t){ if(!d||!t) return null; const x=new Date(d); x.setHours(t.h, t.m, 0, 0); return x; }
    function spanHours(a,b){ return Math.max(0, (b-a)/36e5); }
    function spanDays(a,b){ return Math.max(1, Math.ceil((b-a)/86400000)); }
    function formatEUR(n){
      try{ return n.toLocaleString('es-ES',{style:'currency',currency:'EUR'}); }
      catch(_){ return '€ '+(Math.round(n*100)/100).toFixed(2).replace('.',','); }
    }
    function currentPetText(){
      const n=$('tpl-pet-name')?.value||'';
      const s=$('tpl-pet-species')?.value||'';
      const b=$('tpl-pet-breed')?.value||'';
      const meta=[s,b].filter(Boolean).join(', ');
      return [n, meta?('('+meta+')'):''].filter(Boolean).join(' ');
    }

    function computeUnitsForRange(mode, sdt, edt){
      if (!sdt || !edt || edt<=sdt) return { label:'—', units:null, days:null, hours:null };
      if (mode==='hour'){
        const hrs = Math.round(spanHours(sdt,edt)*10)/10;
        return { label: hrs + ' h aprox.', units: hrs, days:null, hours:hrs };
      }
      if (mode==='day' || mode==='night'){
        const d = Math.max(1, spanDays(sdt,edt));
        const label = d + (mode==='day' ? (d===1?' día':' días') : (d===1?' noche':' noches'));
        return { label, units:d, days:d, hours:null };
      }
      // Para visitas/paseos, la duración se expresa en min/visita o min/paseo
      return { label: '—', units:null, days: Math.max(1, spanDays(sdt,edt)), hours:null };
    }

    function showLines({base, extras, festivo, zonaMult, senal, total}){
      $('tpl-line-base').textContent   = base>0   ? formatEUR(base)   : '—';
      $('tpl-line-extras').textContent = extras>0 ? formatEUR(extras) : '—';
      $('tpl-line-festivo').textContent= festivo>0? formatEUR(festivo): '—';
      $('tpl-line-zona').textContent   = (zonaMult && zonaMult!==1) ? ('x '+zonaMult.toFixed(2)) : '—';
      $('tpl-line-senal').textContent  = senal>0  ? formatEUR(senal)  : '—';
      $('tpl-b-total').innerHTML       = '<strong>'+formatEUR(total)+'</strong>';
      $('tpl-budget-amount').textContent = formatEUR(total);
    }

    function updateBudget(){
      const svcSel = $('service');
      const svcKey = svcSel?.value||'';
      const cfg    = PRICING[svcKey];

      const sd  = parseDate($('startDate')?.value||'');
      const ed  = parseDate($('endDate')?.value||'');
      const st  = parseTime($('start')?.value||'');
      const et  = parseTime($('end')?.value||'');
      const sdt = (sd&&st)?combine(sd,st):null;
      const edt = (ed&&et)?combine(ed,et):null;
      const range = computeUnitsForRange(cfg?.mode||'', sdt, edt);

      const svcText = (svcSel && svcSel.options[svcSel.selectedIndex]) ? svcSel.options[svcSel.selectedIndex].text.trim() : '';
      const periodo = (sdt&&edt)
        ? (sdt.toLocaleDateString('es-ES') + ' ' + sdt.toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'})
           + ' → ' +
           edt.toLocaleDateString('es-ES') + ' ' + edt.toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'}))
        : '—';

      if ($('tpl-b-svc'))      $('tpl-b-svc').textContent = svcText || '—';
      if ($('tpl-b-periodo'))  $('tpl-b-periodo').textContent = periodo;
      if ($('tpl-b-mascota'))  $('tpl-b-mascota').textContent = currentPetText() || '—';
      if ($('tpl-b-notas'))    $('tpl-b-notas').textContent = (q('#notes')?.value.trim() || '—');

      let base = 0, extras = 0, festivo = 0, total = 0, units = 0, zonaMultLabel = 1;

      const zc = $('tpl-zone-code')?.value || '';
      const zonaMult = (ZONE_MULTIPLIERS[zc] ?? 1);
      zonaMultLabel = zonaMult;

      if (!cfg){ showLines({base,extras,festivo,zonaMult:zonaMultLabel,senal:0,total:0}); $('tpl-b-duracion').textContent='—'; return {svcKey, total:0}; }

      // VISITAS
      if (cfg.mode==='visit'){
        const days = range.days || 1;
        const count = parseInt($('visitCount')?.value||'1',10) || 1;
        const minutes = parseInt($('visitMinutes')?.value||'30',10) || 30;
        const rate = (cfg.ratesByMin[minutes] ?? 0);
        units = days * count; // nº de visitas totales
        base = units * rate;

        const ex = $('visitExtras')?.value||'';
        if (ex && cfg.extras[ex]) extras += units * cfg.extras[ex];

        $('tpl-b-duracion').textContent = days+' '+(days===1?'día':'días')+' · '+count+' v/día · '+minutes+' min/visita';
      }

      // PASEOS
      else if (cfg.mode==='walk'){
        const days = range.days || 1;
        const minutes = parseInt($('walkMinutes')?.value||'30',10) || 30;
        const rateSuelto = (cfg.ratesByMin[minutes] ?? 0);
        const bundle = parseInt($('walkBundle')?.value||'',10) || 0;
        const extraPets = parseInt($('extraPets')?.value||'0',10) || 0;

        if (bundle){
          units = bundle; // nº de paseos (1 por día de bono)
          const desc = cfg.bundleDiscount[bundle] || 0;
          base = units * rateSuelto * (1 - desc);
        } else {
          // paseo suelto por cada día seleccionado
          units = days;
          base = units * rateSuelto;
        }

        // Perros adicionales
        if (extraPets>0){
          extras += units * (cfg.extraPetPerPaseo||0) * extraPets;
        }

        $('tpl-b-duracion').textContent = (bundle? ('Bono '+bundle+' días') : (days+' '+(days===1?'día':'días'))) + ' · '+minutes+' min/paseo';
      }

      // GUARDERÍA
      else if (cfg.mode==='day'){
        const d = Math.max(1, range.days||1);
        units = d;
        base = units * (cfg.rate||0);
        $('tpl-b-duracion').textContent = d + (d===1?' día':' días');
      }

      // ALOJAMIENTO
      else if (cfg.mode==='night'){
        const n = Math.max(1, range.days||1);
        units = n;
        base = units * (cfg.rate||0);
        $('tpl-b-duracion').textContent = n + (n===1?' noche':' noches');
      }

      // BODAS / EXCLUSIVOS
      else if (cfg.mode==='hour'){
        let hrs = Math.max(0, range.hours||0);
        const step = cfg.step || 1;
        hrs = Math.ceil(hrs/step)*step;
        if (cfg.min && hrs<cfg.min) hrs = cfg.min;
        units = hrs;
        base = units * (cfg.rate||0);
        $('tpl-b-duracion').textContent = hrs + ' h';
      }

      // Recargo festivo (si usuario marcó)
      const hol = $('holiday')?.value||'';
      if (hol==='si') festivo = (base + extras) * RECARGO_FESTIVOS;

      // Zona
      const afterZona = (base + extras + festivo) * zonaMult;

      // Señal
      const senal = afterZona * SENAL_PORCENTAJE;

      total = afterZona;

      showLines({base, extras, festivo, zonaMult:zonaMultLabel, senal, total});

      return { svcKey, cfg, units, total, periodo, svcText };
    }

    function toggleLoginNote(){
      const user = (window.__TPL_AUTH__ && window.__TPL_AUTH__.user) || null;
      const note = document.getElementById('tpl-login-note');
      if (!note) return;
      note.style.display = (user && !user.isAnonymous) ? 'none' : '';
    }

    async function ensureStripe(){
      if (window.Stripe) return window.Stripe(STRIPE_PK);
      await new Promise((res,rej)=>{
        const s=document.createElement('script');
        s.src='https://js.stripe.com/v3';
        s.onload=res; s.onerror=()=>rej(new Error('No se pudo cargar Stripe.js'));
        document.head.appendChild(s);
      });
      return window.Stripe(STRIPE_PK);
    }
    function quantityFor(svcKey, cfg, units){
      if (!cfg || units==null) return 1;
      // Para visitas/paseos: 1 línea = 1 “unidad base” → cantidad = nº de visitas/paseos
      if (cfg.mode==='visit' || cfg.mode==='walk') return Math.max(1, Math.round(units));
      if (cfg.mode==='hour' || cfg.mode==='day' || cfg.mode==='night') return Math.max(1, Math.round(units));
      return 1;
    }
    async function handlePay(){
      const calc = updateBudget();
      const { svcKey, cfg, units } = calc || {};
      if (!svcKey || !cfg || units==null || !PRICE_IDS[svcKey]){
        alert('Configura Stripe (STRIPE_PK y PRICE_IDS) para habilitar el pago.');
        return;
      }
      if (!STRIPE_PK){ alert('Falta tu STRIPE_PK (publishable key).'); return; }
      const qty = quantityFor(svcKey, cfg, units);
      const stripe = await ensureStripe();
      const result = await stripe.redirectToCheckout({
        mode: 'payment',
        lineItems: [{ price: PRICE_IDS[svcKey], quantity: qty }],
        successUrl: SUCCESS_URL,
        cancelUrl:  CANCEL_URL,
        allowPromotionCodes: true,
        clientReferenceId: ( document.getElementById('tpl-uid')?.value || '' ),
        customerEmail: ( document.getElementById('email')?.value || undefined ),
        submitType: 'pay'
      });
      if (result.error) alert(result.error.message || 'No se pudo iniciar el pago.');
    }

    // Enlaces
    ['service','startDate','endDate','start','end','notes',
     'visitCount','visitMinutes','visitExtras',
     'walkMinutes','walkBundle','extraPets',
     'tpl-pet-name','tpl-pet-species','tpl-pet-breed','tpl-zone-code','holiday'
    ].forEach(function(id){
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener('input',  updateBudget);
      el.addEventListener('change', updateBudget);
    });

    document.addEventListener('DOMContentLoaded', function(){
      updateBudget();
      toggleLoginNote();
      const payBtn = document.getElementById('tpl-pay-btn');
      if (payBtn) payBtn.addEventListener('click', handlePay);

      // Si no se seleccionó nada, ponemos valores por defecto suaves (mañana 10-12)
      try{
        var sd = document.getElementById('startDate'), ed = document.getElementById('endDate');
        var st = document.getElementById('start'),     et = document.getElementById('end');
        if (sd && !sd.value){
          var d = new Date(); d.setDate(d.getDate()+1);
          var y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0');
          sd.value = y+'-'+m+'-'+day; ed.value = y+'-'+m+'-'+day;
        }
        if (st && !st.value) st.value = '10:00';
        if (et && !et.value) et.value = '12:00';
      }catch(_){}
    });
    window.addEventListener('tpl-auth-ready', function(){ toggleLoginNote(); updateBudget(); });
    window.addEventListener('tpl-auth-change', function(){ toggleLoginNote(); updateBudget(); });

    window.TPL_BUDGET = { update:updateBudget, PRICING, ZONE_MULTIPLIERS };
  })();
  </script>

  <!-- Tu lógica de envíos / overlays / EmailJS extra (se mantiene) -->
  <script src="reservas.js" defer></script>
</body>
</html>
