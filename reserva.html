<!-- ===== Lógica de UI y precios (REEMPLAZAR TODO ESTE BLOQUE) ===== -->
<script>
  const form = document.getElementById('bookingForm');
  const wall = document.getElementById('authWall');

  // Mapeo de elementos principales
  const els = {
    service: document.getElementById('service'),
    species: document.getElementById('species'),
    isPuppy: document.getElementById('isPuppy'),
    numPets: document.getElementById('numPets'),
    startDate: document.getElementById('startDate'),
    endDate: document.getElementById('endDate'),
    region: document.getElementById('region'),
    needTravel: document.getElementById('needTravel'),
    sumBase: document.getElementById('sumBase'),
    sumPets: document.getElementById('sumPets'),
    sumFestivo: document.getElementById('sumFestivo'),
    sumSenalado: document.getElementById('sumSenalado'),
    sumSubtotal: document.getElementById('sumSubtotal'),
    sumDeposit: document.getElementById('sumDeposit'),
    summaryField: document.getElementById('summaryField'),
    contactPhone: document.getElementById('contactPhone'),
    contactEmail: document.getElementById('contactEmail'),
  };

  // ========= Precios base y utilidades =========
  const BASES = { visitas:22, paseos:12, guarderia:20, alojamiento:30, bodas:0 };
  function currency(n){ return (Math.round(n * 100) / 100).toFixed(2); }

  // Suplementos por nº de mascotas
  function calcPetSupplements(service, species, n){
    if(n <= 1) return 0;
    if(service === 'visitas'){
      const extra = n - 1;
      if(extra === 1) return 12;
      if(extra === 2) return 8 * 2;
      if(extra >= 3) return 6 * extra;
      return 0;
    }
    if(service === 'paseos'){ return 8 * (n - 1); }
    if(service === 'alojamiento' && species === 'perro'){ return 25 * (n - 1); }
    return 0;
  }

  function getBasePrice(service, isPuppy){
    let base = BASES[service] || 0;
    if(service === 'alojamiento' && isPuppy){ base = 35; }
    return base;
  }

  // ========= DEPÓSITO (inyectado para mantener tu estructura) =========
  (function injectDeposit(){
    if (document.getElementById('depositPct')) return;
    const container = document.querySelector('.booking-grid');
    const block = document.createElement('div');
    block.className = 'booking-field';
    block.innerHTML = `
      <label for="depositPct">Depósito (retención)</label>
      <select id="depositPct" name="Deposito_pct">
        <option value="0.2">20% (recomendado)</option>
        <option value="0.3">30%</option>
        <option value="0.5">50%</option>
      </select>`;
    container.appendChild(block);
  })();
  const depositSelect = document.getElementById('depositPct');

  // ========= FESTIVOS (auto) =========
  // Intentamos cargar un JSON oficial por CCAA. Si no existe, usamos fallback nacional + especiales.
  // Formato esperado del JSON: { "nacional":[ "2025-01-06", ... ], "madrid":[ ... ], "andalucia":[ ... ], ... }
  const SPECIAL_MMDD = ["12-24","12-25","12-31","01-01"]; // especiales
  let FESTIVOS = null; // se intentará cargar; si no, fallback

  function mmdd(d){ return `${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
  function ymd(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
  function eachDate(from, to){
    const res=[]; if(!from||!to) return res;
    const d1=new Date(from), d2=new Date(to);
    if(isNaN(d1)||isNaN(d2)||d2<d1) return res;
    const cur=new Date(d1); cur.setHours(0,0,0,0); d2.setHours(0,0,0,0);
    while(cur<=d2){ res.push(new Date(cur)); cur.setDate(cur.getDate()+1); }
    return res;
  }

  async function loadFestivos(){
    try{
      // Puedes cambiar la ruta si lo colocas en /data/festivos-es-2025.json
      const resp = await fetch('festivos-es-2025.json', {cache:'no-store'});
      if(!resp.ok) throw new Error('no festivos file');
      FESTIVOS = await resp.json();
    }catch(_){
      // Fallback nacional básico (2025) si no hay JSON
      FESTIVOS = {
        nacional: ['2025-01-06','2025-03-19','2025-05-01','2025-08-15','2025-10-12','2025-11-01','2025-12-06','2025-12-08','2025-12-25']
        // autonómicos se cargarán cuando subamos el JSON oficial
      };
    }
  }

  function calcFestivosAuto(region, start, end){
    const days = eachDate(start, end);
    let festivo = 0, senalado = 0;

    const nat = new Set((FESTIVOS?.nacional || []));
    const reg = new Set((FESTIVOS?.[region] || []));

    for(const d of days){
      const iso = ymd(d);
      const isNat = nat.has(iso);
      const isReg = reg.has(iso);
      const isSpecial = SPECIAL_MMDD.includes(mmdd(d));
      if(isNat || isReg) festivo += 10; // política: +10€ por festivo
      if(isSpecial)      senalado += 30; // especiales +30€
    }
    return { festivo, senalado };
  }

  // ========= Servicio autoseleccionado y bloqueado =========
  (function autoServiceFromLink(){
    const params = new URLSearchParams(location.search);
    const svcParam = params.get('svc') || params.get('service') || '';
    const map = { visitas:'visitas', paseos:'paseos', guarderia:'guarderia', alojamiento:'alojamiento', bodas:'bodas' };
    let svc = map[svcParam] || '';

    // Si no viene por query, intentamos deducir por referrer: servicio-xxx.htm
    if(!svc && document.referrer){
      const m = document.referrer.match(/servicio-([a-z-]+)\.htm/i);
      if(m && map[m[1]]) svc = map[m[1]];
    }

    if(svc && els.service){
      els.service.value = svc;
      els.service.setAttribute('disabled','disabled');
      // espejo oculto para que el valor viaje incluso estando disabled
      let mirror = document.getElementById('svcMirror');
      if(!mirror){
        mirror = document.createElement('input');
        mirror.type = 'hidden';
        mirror.name = 'Servicio';
        mirror.id = 'svcMirror';
        els.service.insertAdjacentElement('afterend', mirror);
      }
      mirror.value = els.service.options[els.service.selectedIndex]?.text || svc;
    }
  })();

  // ========= “Otros” en especie: abre campo libre =========
  (function speciesOtherToggle(){
    const sel = els.species;
    if(!sel) return;
    function ensureOtherInput(){
      let extra = document.getElementById('speciesOther');
      if(sel.value === 'otros'){
        if(!extra){
          extra = document.createElement('input');
          extra.id = 'speciesOther';
          extra.name = 'Tipo_animal_otro';
          extra.placeholder = 'Especifica el tipo de animal';
          extra.style.marginTop = '6px';
          sel.parentElement.appendChild(extra);
        }
        extra.required = true;
      }else{
        if(extra){ extra.remove(); }
      }
    }
    sel.addEventListener('change', ()=>{ ensureOtherInput(); recalc(); });
    ensureOtherInput();
  })();

  // ========= Burbuja de desplazamiento on/off =========
  (function travelHint(){
    const sel = els.needTravel;
    if(!sel) return;
    let hint = document.getElementById('travelHint');
    if(!hint){
      hint = document.createElement('div');
      hint.id = 'travelHint';
      hint.className = 'note';
      hint.style.display = 'none';
      hint.textContent = 'El coste por kilometraje se calculará cuando asignemos al cuidador/a que mejor se adapte a tus necesidades.';
      sel.parentElement.appendChild(hint);
    }
    function sync(){ hint.style.display = sel.value === 'si' ? 'block' : 'none'; }
    sel.addEventListener('change', sync); sync();
  })();

  // ========= Autocompletar contacto (email/teléfono) =========
  (function autofillContact(){
    const qs = new URLSearchParams(location.search);
    // Querystring tiene prioridad
    if(qs.get('email') && els.contactEmail) els.contactEmail.value = qs.get('email');
    if(qs.get('tel')   && els.contactPhone) els.contactPhone.value = qs.get('tel');

    // localStorage fallback
    try{
      if(!els.contactEmail?.value && localStorage.getItem('tpl_email')) els.contactEmail.value = localStorage.getItem('tpl_email');
      if(!els.contactPhone?.value && localStorage.getItem('tpl_phone')) els.contactPhone.value = localStorage.getItem('tpl_phone');
    }catch(_){}

    // Firebase (cuando esté inicializado)
    function tryAuthFill(){
      try{
        if(typeof firebase === 'undefined') return;
        const auth = firebase.auth();
        auth.onAuthStateChanged(u=>{
          if(u?.email && els.contactEmail && !els.contactEmail.value) els.contactEmail.value = u.email;
          // Si más adelante guardamos teléfono en users/{uid}, lo podemos leer aquí:
          // db.collection('users').doc(u.uid).get()...
        });
      }catch(_){}
    }
    // Intento inmediato y otro al load por si los SDKs cargan después
    tryAuthFill(); window.addEventListener('load', tryAuthFill);
  })();

  // ========= Auto "cachorro" desde perfil de mascota (<6 meses), si existe =========
  async function autoPuppyFromProfile(){
    try{
      if(typeof firebase === 'undefined') return;
      const auth = firebase.auth();
      const db   = firebase.firestore();
      const u = auth.currentUser;
      if(!u) return;
      const snap = await db.collection('users').doc(u.uid).collection('mascotas').limit(1).get();
      if(!snap.empty){
        const pet = snap.docs[0].data();
        if(pet?.birthdate){
          const b = new Date(pet.birthdate);
          const today = new Date();
          const months = (today.getFullYear()-b.getFullYear())*12 + (today.getMonth()-b.getMonth());
          els.isPuppy.value = months < 6 ? 'si' : 'no';
          els.isPuppy.disabled = true;
        }
      }
    }catch(_){}
  }
  window.addEventListener('load', autoPuppyFromProfile);

  // ========= Mostrar campos según servicio =========
  function toggleFields(){
    const svc = els.service?.value;
    if(svc === 'visitas' && els.species){ els.species.value = 'gato'; }
  }

  // ========= Recalcular desglose =========
  function recalc(){
    const svc = els.service?.value || '';
    const speciesSel = els.species?.value || 'perro';
    const n = parseInt(els.numPets?.value || '1', 10);
    const isPuppy = (els.isPuppy?.value === 'si');

    const base = getBasePrice(svc, isPuppy);
    const pets = calcPetSupplements(svc, speciesSel, n);

    const { festivo, senalado } = calcFestivosAuto(els.region?.value || 'nacional', els.startDate?.value, els.endDate?.value);

    const subtotal = base + pets + festivo + senalado;
    const depPctEl = document.getElementById('depositPct');
    const depPct = parseFloat(depPctEl?.value || '0.2');
    const deposit = subtotal * depPct;

    els.sumBase.textContent = base ? currency(base) : '—';
    els.sumPets.textContent = currency(pets);
    els.sumFestivo.textContent = currency(festivo);
    els.sumSenalado.textContent = currency(senalado);
    els.sumSubtotal.textContent = base ? currency(subtotal) : '—';
    els.sumDeposit.textContent = base ? currency(deposit) : '—';
  }

  // ========= Eventos =========
  ['change','input'].forEach(ev=>{
    ['service','species','isPuppy','numPets','startDate','endDate','region','needTravel','depositPct'].forEach(id=>{
      const el = document.getElementById(id);
      if(el) el.addEventListener(ev, ()=>{ toggleFields(); recalc(); });
    });
  });

  // Carga festivos y primer cálculo
  (async function initCalc(){
    await loadFestivos();
    toggleFields();
    recalc();
  })();

  // ========= Validaciones + preparar resumen ANTES de enviar =========
  form.addEventListener('submit', (e)=>{
    // Preferencia de contacto -> validar campos mínimos
    const pref = (new FormData(form).get('Preferencia_contacto')) || '';
    const tel  = els.contactPhone?.value.trim();
    const mail = els.contactEmail?.value.trim();
    if(pref === 'telefono' || pref === 'whatsapp'){
      if(!tel){ e.preventDefault(); alert('Por favor, indícanos tu teléfono para poder contactarte.'); return; }
    }else if(pref === 'email'){
      if(!mail){ e.preventDefault(); alert('Por favor, indícanos tu correo para poder contactarte.'); return; }
    }

    // Especie “Otros”
    let especie = els.species?.value || '';
    const speciesOther = document.getElementById('speciesOther');
    if(especie === 'otros' && speciesOther?.value){
      especie = `otros (${speciesOther.value.trim()})`;
    }

    // Preparar desglose para el correo
    const summary = [
      `Servicio: ${document.getElementById('svcMirror')?.value || els.service?.options[els.service.selectedIndex]?.text || ''}`,
      `Fecha: ${els.startDate?.value || '-'} a ${els.endDate?.value || '-'}`,
      `Tipo de animal: ${especie}`,
      `Cachorro: ${els.isPuppy?.value || 'no'}`,
      `Nº mascotas: ${els.numPets?.value || '1'}`,
      `Desplazamiento: ${els.needTravel?.value || 'no'}`,
      `Festivos (auto): ${document.getElementById('sumFestivo').textContent} €`,
      `Días especiales: ${document.getElementById('sumSenalado').textContent} €`,
      `Subtotal (sin desplazamiento): ${document.getElementById('sumSubtotal').textContent} €`,
      `Depósito a retener: ${document.getElementById('sumDeposit').textContent} €`,
      `CCAA: ${els.region?.options[els.region.selectedIndex]?.text || 'España'}`
    ].join(' | ');
    els.summaryField.value = summary;
  });
</script>  este era el ultimo que me funcionaba
