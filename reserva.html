<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Reservas · The Pets Lovers</title>

  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Poppins:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

  <style>
    :root{
      --tpl-accent: var(--color-principal, #339496);
      --tpl-accent-on: #fff;
      --tpl-muted:#6b7280;
      --tpl-border:#e5e7eb;
      --tpl-bg:#f9fafb;
      --tpl-card:#fff;
      --tpl-radius:14px;
      --tpl-shadow:0 2px 10px rgba(0,0,0,.05);
      --nav-offset:96px;
    }
    body{ background:#fff; }
    .page{ max-width:1040px; margin:0 auto; padding:20px; }
    .booking-header{ margin: calc(var(--nav-offset)) auto 16px; text-align:center; }
    .booking-header h1{ margin:0; }

    .shell{ background:var(--tpl-card); border:1px solid var(--tpl-border); border-radius: var(--tpl-radius); box-shadow: var(--tpl-shadow); padding:16px; }
    .card{ border:1px solid var(--tpl-border); border-radius: var(--tpl-radius); background:#fff; box-shadow: var(--tpl-shadow); padding:16px; }
    .section-title{ font-weight:700; font-size:1.06rem; margin:6px 0 10px; display:flex; align-items:center; gap:8px; }
    .section-title i{ color:var(--tpl-accent); }
    .divider{ border-top:1px dashed var(--tpl-border); margin:12px 0; }

    /* ===== MODO COMPACTO ===== */
    #reservaForm.compact{ --gap:12px; --gap-small:8px; --input-h:38px; --label:.92rem; --radius:10px; }
    #reservaForm.compact .grid{ display:grid; gap: var(--gap); }
    #reservaForm.compact .g-3{ grid-template-columns: repeat(3, minmax(0,1fr)); }
    #reservaForm.compact .g-2{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    #reservaForm.compact .g-1{ grid-template-columns: 1fr; }
    @media (max-width: 980px){ #reservaForm.compact .g-3{ grid-template-columns: repeat(2,1fr); } }
    @media (max-width: 680px){ #reservaForm.compact .g-3, #reservaForm.compact .g-2{ grid-template-columns:1fr; } }

    #reservaForm.compact .field{ display:flex; flex-direction:column; gap: var(--gap-small); min-width:0; }
    #reservaForm.compact label{ font-size: var(--label); color:#6b5f70; }
    #reservaForm.compact input,
    #reservaForm.compact select,
    #reservaForm.compact textarea{
      height: var(--input-h); padding:8px 10px; border-radius: var(--radius);
      border:1px solid #e4e3ea; font-size:14px; line-height:1.25;
    }
    #reservaForm.compact textarea{ height:auto; min-height:84px; }

    #reservaForm.compact .row-3{ display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap: var(--gap); }
    #reservaForm.compact .row-2{ display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: var(--gap); }
    @media (max-width: 680px){
      #reservaForm.compact .row-3, #reservaForm.compact .row-2{ grid-template-columns:1fr; }
    }

    #reservaForm.compact.card{ padding:16px; }

    /* ===== Mascotas compactas (lista vertical mini) ===== */
    #reservaForm.compact #petsGrid{ display:grid; grid-template-columns:1fr; gap:10px; }
    #reservaForm.compact .tpl-pet-item{
      position:relative; display:flex; align-items:center; gap:10px;
      border:1px solid #ece8f0; background:#fff; border-radius:999px; padding:8px 12px;
      box-shadow:0 1px 6px rgba(0,0,0,.04);
    }
    #reservaForm.compact .tpl-pet-thumb{
      width:40px; height:40px; border-radius:50%; object-fit:cover; border:2px solid #eee; flex:0 0 auto;
    }
    #reservaForm.compact .tpl-pet-meta{ display:flex; flex-direction:column; line-height:1.2; min-width:0; }
    #reservaForm.compact .tpl-pet-name{ font-weight:700; color:#453a49; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    #reservaForm.compact .tpl-pet-sub{ color:#7b6f86; font-size:.9rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    #reservaForm.compact .tpl-pet-item .pet-check{ position:absolute; top:8px; left:8px; width:18px; height:18px; transform:translate(-2px,-2px); }
    #reservaForm.compact .badge{ font-size:10px; padding:1px 6px; border-radius:999px; }

    /* ===== Resumen ===== */
    .summary{ background:var(--tpl-bg); margin-top:14px; padding:18px; }
    .summary .line{ display:flex; justify-content:space-between; margin:6px 0 }
    .summary .line .note{ color:var(--tpl-muted); font-size:.9rem }
    .summary .total{ font-weight:700; border-top:1px dashed var(--tpl-border); padding-top:8px; margin-top:6px }
    .pill{ display:inline-block; padding:3px 8px; border-radius:999px; background:var(--tpl-bg); border:1px solid var(--tpl-border); font-size:.8rem; color:#374151 }

    .actions-summary{ display:flex; justify-content:flex-end; gap:10px; margin-top:12px; }
    .btn{ display:inline-flex; align-items:center; gap:8px; padding:12px 16px; border-radius:12px; border:0; cursor:pointer; font-weight:700 }
    .btn-primary{ background:var(--tpl-accent); color:var(--tpl-accent-on) }
    .btn-ghost{ background:#fff; border:1px solid var(--tpl-border); color:#111827 }

    .auth-wall{ padding:16px; border:1px dashed #bbb; border-radius:12px; text-align:center; background:#fafafa; margin:0 0 16px; }
    .muted{ color:var(--tpl-muted); font-size:.9rem; }
    .disabled{ opacity:.6; pointer-events:none; filter:grayscale(1) }

    /* ===== Overlay de confirmación ===== */
    .overlay{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,.45); z-index:9999;
    }
    .overlay .modal{
      background:#fff; border-radius:16px; padding:20px; width:min(520px, 92vw);
      box-shadow:0 10px 30px rgba(0,0,0,.2); text-align:center;
    }
    .overlay .modal h3{ margin:0 0 8px }
    .overlay .modal p{ margin:0 0 14px }
  </style>
</head>
<body>

  <!-- Navbar inyectada -->
  <div id="tpl-navbar"></div>

  <div class="page">
    <header class="booking-header">
      <h1>Reserva tu servicio</h1>
    </header>

    <!-- Auth wall -->
    <div id="authWall" class="auth-wall" style="display:none">
      <p><strong>Para reservar debes iniciar sesión.</strong></p>
      <div id="tpl-inline-login"></div>
    </div>

    <div class="shell">
      <!-- TARJETA ÚNICA SUPERIOR -->
      <form id="reservaForm" class="card compact disabled" novalidate>

        <!-- DATOS DEL SERVICIO -->
        <div class="section-title"><i class="fa-solid fa-list-check"></i> Datos del servicio</div>

        <!-- Fila A: Servicio + Fechas -->
        <div class="row-3">
          <div class="field">
            <label for="serviceType">Servicio</label>
            <select id="serviceType" required>
              <option value="">Elige un servicio…</option>
              <option value="guarderia_dia">Guardería de día</option>
              <option value="alojamiento_nocturno">Alojamiento nocturno</option>
              <option value="paseo">Paseo (60’)</option>
              <option value="visita_gato">Visita a domicilio (gato)</option>
              <option value="exoticos">Servicio exóticos</option>
              <option value="transporte">Transporte</option>
            </select>
          </div>
          <div class="field">
            <label for="startDate">Fecha inicio</label>
            <input id="startDate" type="date" required>
          </div>
          <div class="field">
            <label for="endDate">Fecha fin</label>
            <input id="endDate" type="date" required>
          </div>
        </div>

        <!-- Fila B: Horas + Nº mascotas + Desplazamiento -->
        <div class="row-3">
          <div class="field">
            <label for="startTime">Hora inicio</label>
            <input id="startTime" type="time">
          </div>
          <div class="field">
            <label for="endTime">Hora fin</label>
            <input id="endTime" type="time">
          </div>
          <div class="field">
            <label for="numPets">Nº de mascotas</label>
            <select id="numPets">
              <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
            </select>
          </div>
        </div>

        <!-- Controles específicos: Visita gato -->
        <div id="visitCatControls" class="row-2" style="display:none">
          <div class="field">
            <label for="visitDuration">Duración</label>
            <select id="visitDuration"><option value="60">60 minutos</option><option value="90">90 minutos</option></select>
          </div>
          <div class="field">
            <label for="secondMedVisit">2ª visita (medicación 15’)</label>
            <select id="secondMedVisit"><option value="no">No</option><option value="si">Sí</option></select>
          </div>
        </div>

        <!-- Controles específicos: Exóticos -->
        <div id="exoticControls" class="row-2" style="display:none">
          <div class="field">
            <label for="exoticType">Tipo de exótico</label>
            <select id="exoticType">
              <option value="aves">Aves</option>
              <option value="reptiles">Reptiles</option>
              <option value="mamiferos">Pequeños mamíferos</option>
            </select>
          </div>
          <div class="field">
            <label for="travelNeeded">Desplazamiento</label>
            <select id="travelNeeded">
              <option value="no">No</option>
              <option value="si">Sí</option>
            </select>
          </div>
        </div>

        <div class="divider"></div>

        <!-- ELIGE TUS MASCOTAS -->
        <div class="section-title"><i class="fa-solid fa-paw"></i> Elige tus mascotas</div>
        <div id="petsGrid" class="pets-list"></div>

        <div class="divider"></div>

        <!-- DATOS DEL TITULAR (3 columnas) -->
        <div class="section-title"><i class="fa-solid fa-user"></i> Datos del titular</div>

        <div class="g-3 grid">
          <div class="field">
            <label for="ownerFullName">Nombre y apellidos</label>
            <input id="ownerFullName" autocomplete="name" required>
          </div>
          <div class="field">
            <label for="email">Email</label>
            <input id="email" type="email" autocomplete="email" required>
          </div>
          <div class="field">
            <label for="phone">Teléfono</label>
            <input id="phone" autocomplete="tel" required>
          </div>

          <div class="field">
            <label for="region">Comunidad Autónoma</label>
            <select id="region" required>
              <option value="">Selecciona…</option>
              <option>Andalucía</option><option>Aragón</option><option>Asturias</option><option>Baleares</option>
              <option>Canarias</option><option>Cantabria</option><option>Castilla-La Mancha</option><option>Castilla y León</option>
              <option>Cataluña</option><option>Comunidad Valenciana</option><option>Extremadura</option><option>Galicia</option>
              <option>La Rioja</option><option>Madrid</option><option>Murcia</option><option>Navarra</option><option>País Vasco</option><option>Ceuta</option><option>Melilla</option>
            </select>
          </div>
          <div class="field">
            <label for="address">Dirección</label>
            <input id="address" placeholder="Calle, nº, piso…">
          </div>
          <div class="field">
            <label for="postalCode">Código Postal</label>
            <input id="postalCode" placeholder="28001">
          </div>

          <div class="field">
            <label for="contactPref">Preferencia de contacto</label>
            <select id="contactPref">
              <option>Teléfono</option><option>WhatsApp</option><option>Email</option><option>Cualquiera</option>
            </select>
          </div>
          <div class="field">
            <label for="contactTime">Franja preferida</label>
            <select id="contactTime">
              <option>Mañana</option><option>Tarde</option><option>Noche</option>
            </select>
          </div>
          <!-- Se elimina “Cachorro (≤6 m)” de aquí como acordamos -->

          <div class="field" style="grid-column:1/-1">
            <label for="notes">Contacto de emergencia</label>
            <textarea id="notes" rows="3" placeholder="Nombre y teléfono de contacto de emergencia…"></textarea>
          </div>
        </div>
      </form>

      <!-- RESUMEN / DESGLOSE -->
      <section class="card summary">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div class="section-title" style="margin:0"><i class="fa-solid fa-receipt"></i> Resumen</div>
          <span id="summaryContext" class="pill">—</span>
        </div>
        <div id="summaryLines" style="margin-top:8px"></div>
        <div class="line total"><span>Subtotal</span><span id="subtotalTxt">—</span></div>
        <div class="line"><span>A pagar ahora</span><span id="payNowTxt">—</span></div>
        <div class="line"><span>Pendiente (12 días antes)</span><span id="payLaterTxt">—</span></div>
        <div class="actions-summary">
          <button id="btnReserve" type="button" class="btn btn-primary"><i class="fa-solid fa-lock"></i> Reservar ahora</button>
        </div>
        <p class="muted" style="margin-top:6px">Solo abonarás una parte ahora. El resto se pagará <strong>12 días</strong> antes del inicio.</p>
      </section>
    </div>

    <!-- Overlay de confirmación -->
    <div id="overlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="ovTitle">
      <div class="modal">
        <h3 id="ovTitle">¡Gracias! Tu solicitud está en revisión</h3>
        <p class="muted">Te llamaremos para confirmar los datos y asignarte el mejor cuidador. El resto se paga 12 días antes del inicio.</p>
        <a class="btn btn-primary" href="/perfil.html"><i class="fa-solid fa-user"></i> Ir a mi perfil</a>
      </div>
    </div>

    <!-- Gracias (oculto, compat) -->
    <div id="thanks" class="card" style="display:none; margin-top:16px">
      <h3>¡Gracias! Tu solicitud está en revisión</h3>
      <p class="muted">Te llamaremos para confirmar los datos y asignarte el mejor cuidador. El resto se paga 12 días antes del inicio.</p>
      <a class="btn btn-ghost" href="/perfil.html"><i class="fa-solid fa-user"></i> Ir a mi perfil</a>
    </div>
  </div>

  <!-- Footer -->
  <div id="tpl-footer"></div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script>
    (function(){
      const cfg = {
        apiKey: "AIzaSyDW73aFuz2AFS9VeWg_linHIRJYN4YMgTk",
        authDomain: "thepetslovers-c1111.firebaseapp.com",
        projectId: "thepetslovers-c1111",
        storageBucket: "thepetslovers-c1111.appspot.com",
        messagingSenderId: "415914577533",
        appId: "1:415914577533:web:0b7a056ebaa4f1de28ab14",
        measurementId: "G-FXPD69KXBG"
      };
      if (typeof firebase!=='undefined' && !firebase.apps.length){ firebase.initializeApp(cfg); }
    })();
  </script>

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <!-- Config + init EmailJS (NUEVO) -->
  <script>
    window.TPL_EMAILJS = {
      enabled: true,
      publicKey: "L2xAATfVuHJwj4EIV",
      serviceId: "service_odjqrfl",
      templateId: "template_rao5n0c",
      adminEmail: "gestion@thepetslovers.es"
    };
    (function initEmailJS(){
      try{
        if (window.emailjs && TPL_EMAILJS?.publicKey) {
          emailjs.init(TPL_EMAILJS.publicKey);
        }
      }catch(_){}
    })();
  </script>

  <!-- Navbar/Footer -->
  <script src="tpl-navbar.js" defer></script>
  <script src="tpl-footer.js" defer></script>

  <!-- Lógica principal -->
  <script src="tpl-reservas.js" defer></script>

  <!-- UI helpers: preselección servicio + controles -->
  <script>
    function toggleBlocks(){
      var s = document.getElementById('serviceType');
      var vCat = document.getElementById('visitCatControls');
      var vExo = document.getElementById('exoticControls');
      if(!s) return;
      if(vCat) vCat.style.display = (s.value === 'visita_gato') ? '' : 'none';
      if(vExo) vExo.style.display = (s.value === 'exoticos') ? '' : 'none';
    }
    document.addEventListener('change', (e)=>{ if(e.target.id==='serviceType') toggleBlocks(); });

    (function presetService(){
      var sel = document.getElementById('serviceType'); if(!sel) return;
      var qs = new URLSearchParams(location.search);
      var raw = (qs.get('service') || qs.get('svc') || '').toLowerCase();
      var map = {
        'guarderia':'guarderia_dia','guarderia_dia':'guarderia_dia','guarderia-de-dia':'guarderia_dia',
        'alojamiento':'alojamiento_nocturno','alojamiento_nocturno':'alojamiento_nocturno','estancias':'alojamiento_nocturno','noche':'alojamiento_nocturno',
        'paseo':'paseo','paseos':'paseo',
        'visitas':'visita_gato','visita_gato':'visita_gato',
        'exoticos':'exoticos','exoticos_aves':'exoticos','exoticos_reptiles':'exoticos','exoticos_mamiferos':'exoticos'
      };
      if(!raw && document.referrer){
        try{
          var u=new URL(document.referrer), p=(u.pathname||'').toLowerCase();
          if(/guarderia/.test(p)) raw='guarderia_dia';
          else if(/alojamiento|estancias|noche/.test(p)) raw='alojamiento_nocturno';
          else if(/paseo/.test(p)) raw='paseo';
          else if(/visita/.test(p)&&/gato/.test(p)) raw='visita_gato';
          else if(/exotico|exoticos/.test(p)) raw='exoticos';
        }catch(_){}
      }
      var canon = map[raw] || raw;
      if(canon && [...sel.options].some(o=>o.value===canon)){ sel.value = canon; }
      toggleBlocks();
    })();

    // Cachorro display (solo lectura) se mantiene para lógica interna si fuese necesaria
    function __updatePuppyDisplay(){
      var disp = document.getElementById('isPuppyDisplay'); // ya no existe en el HTML, no pasa nada
      var grid = document.getElementById('petsGrid');
      if(!disp || !grid){ return; }
      var any = false;
      grid.querySelectorAll('.tpl-pet-item').forEach(function(card){
        var chk = card.querySelector('.pet-check');
        if(chk && chk.checked){
          var birth = (card.getAttribute('data-birth')||'').trim();
          var species = (card.getAttribute('data-species')||'').trim().toLowerCase();
          if(species==='perro' && birth){
            var d = new Date(birth);
            if(!isNaN(d)){
              var t=new Date();
              var months=(t.getFullYear()-d.getFullYear())*12+(t.getMonth()-d.getMonth())-(t.getDate()<d.getDate()?1:0);
              if(months<=6) any = true;
            }
          }
        }
      });
    }
    document.addEventListener('change', (e)=>{ if(e.target.classList?.contains('pet-check')) __updatePuppyDisplay(); });

    // Hook a render de mascotas para adjuntar data-* (cachorro auto)
    (function enhancePets(){
      const _orig = window.renderPetsGrid;
      if(typeof _orig === 'function'){
        window.renderPetsGrid = function(pets){
          _orig(pets);
          var grid = document.getElementById('petsGrid');
          if(grid){
            grid.querySelectorAll('.tpl-pet-item').forEach(function(el){
              var id = el.querySelector('.pet-check')?.getAttribute('data-id');
              var p = (pets||[]).find(x=> String(x.id)===String(id));
              if(p){
                if(p.nacimiento||p.birthdate)   el.setAttribute('data-birth', String(p.nacimiento||p.birthdate));
                if(p.especie||p.tipo)           el.setAttribute('data-species', String((p.especie||p.tipo||'')).toLowerCase());
              }
            });
          }
          setTimeout(__updatePuppyDisplay, 0);
        };
      }
    })();
  </script>
</body>
</html>
