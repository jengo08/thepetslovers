<!-- ===== Lógica de UI y precios (REEMPLAZAR TODO ESTE BLOQUE) ===== -->
<script>
(() => {
  // ---------- Utilidades seguras
  const byId = (id) => document.getElementById(id);
  const on = (el, ev, fn) => el && el.addEventListener(ev, fn);
  const text = (el, val) => { if (el) el.textContent = val; };
  const currency = (n) => (Math.round((n ?? 0) * 100) / 100).toFixed(2);

  // ---------- Nodos principales (defensivo: pueden ser null)
  const form = byId('bookingForm');
  const wall = byId('authWall');

  const els = {
    service: byId('service'),
    species: byId('species'),
    isPuppy: byId('isPuppy'),
    numPets: byId('numPets'),
    startDate: byId('startDate'),
    endDate: byId('endDate'),
    region: byId('region'),
    needTravel: byId('needTravel'),
    sumBase: byId('sumBase'),
    sumPets: byId('sumPets'),
    sumFestivo: byId('sumFestivo'),
    sumSenalado: byId('sumSenalado'),
    sumSubtotal: byId('sumSubtotal'),
    sumDeposit: byId('sumDeposit'),
    summaryField: byId('summaryField'),
    contactPhone: byId('contactPhone'),
    contactEmail: byId('contactEmail'),
  };

  // ---------- Precios base
  const BASES = { visitas: 22, paseos: 12, guarderia: 20, alojamiento: 30, bodas: 0 };

  function getBasePrice(service, isPuppy) {
    let base = BASES[service] || 0;
    if (service === 'alojamiento' && isPuppy) base = 35; // cachorros en alojamiento
    return base;
  }

  // Suplementos por nº de mascotas
  function calcPetSupplements(service, species, n) {
    const num = Number.isFinite(+n) ? +n : 1;
    if (num <= 1) return 0;

    if (service === 'visitas') {
      const extra = num - 1;
      if (extra === 1) return 12;
      if (extra === 2) return 8 * 2;
      if (extra >= 3) return 6 * extra;
      return 0;
    }
    if (service === 'paseos') return 8 * (num - 1);
    if (service === 'alojamiento' && species === 'perro') return 25 * (num - 1);
    return 0;
  }

  // ---------- Inyección select Depósito (sin romper layout)
  function injectDeposit() {
    if (byId('depositPct')) return byId('depositPct');
    const container = document.querySelector('.booking-grid') || form;
    if (!container) return null;

    const block = document.createElement('div');
    block.className = 'booking-field';
    block.innerHTML = `
      <label for="depositPct">Depósito (retención)</label>
      <select id="depositPct" name="Deposito_pct">
        <option value="0.2">20% (recomendado)</option>
        <option value="0.3">30%</option>
        <option value="0.5">50%</option>
      </select>`;
    container.appendChild(block);
    return byId('depositPct');
  }
  const depositSelect = injectDeposit();

  // ---------- Festivos automáticos (Nager.Date) con fallback
  const REGION_TO_COUNTY = {
    andalucia: 'ES-AN', aragon: 'ES-AR', asturias: 'ES-AS', baleares: 'ES-IB', canarias: 'ES-CN', cantabria: 'ES-CB',
    'castilla-la-mancha': 'ES-CM', 'castilla-y-leon': 'ES-CL', cataluna: 'ES-CT', ceuta: 'ES-CE', valenciana: 'ES-VC',
    extremadura: 'ES-EX', galicia: 'ES-GA', 'la-rioja': 'ES-RI', madrid: 'ES-MD', melilla: 'ES-ML', murcia: 'ES-MC',
    navarra: 'ES-NC', euskadi: 'ES-PV', nacional: null
  };
  const SPECIAL_MMDD = ['12-24','12-25','12-31','01-01']; // +30€

  const _festivosCache = new Map();
  const mmdd = (d) => `${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
  const ymd = (d) => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;

  function eachDate(from, to) {
    const out = [];
    if (!from || !to) return out;
    const d1 = new Date(from), d2 = new Date(to);
    if (isNaN(d1) || isNaN(d2) || d2 < d1) return out;
    const cur = new Date(d1.getFullYear(), d1.getMonth(), d1.getDate());
    const end = new Date(d2.getFullYear(), d2.getMonth(), d2.getDate());
    while (cur <= end) { out.push(new Date(cur)); cur.setDate(cur.getDate() + 1); }
    return out;
  }

  async function fetchHolidaysForYear(year) {
    if (_festivosCache.has(year)) return _festivosCache.get(year);
    let pack;
    try {
      const ctrl = new AbortController();
      const t = setTimeout(() => ctrl.abort(), 6000);
      const resp = await fetch(`https://date.nager.at/api/v3/PublicHolidays/${year}/ES`, { signal: ctrl.signal, cache: 'force-cache' });
      clearTimeout(t);
      if (!resp.ok) throw new Error('nager fail');
      const data = await resp.json();
      const nacional = new Set();
      const porCcaa = new Map();
      for (const h of data) {
        const date = h.date;
        if (!h.counties || h.counties.length === 0) {
          nacional.add(date);
        } else {
          for (const c of h.counties) {
            if (!porCcaa.has(c)) porCcaa.set(c, new Set());
            porCcaa.get(c).add(date);
          }
        }
      }
      pack = { nacional, porCcaa };
    } catch {
      // Fallback nacional básico si la API está caída
      pack = {
        nacional: new Set([`${year}-01-06`, `${year}-05-01`, `${year}-08-15`, `${year}-10-12`, `${year}-11-01`, `${year}-12-06`, `${year}-12-08`, `${year}-12-25`]),
        porCcaa: new Map()
      };
    }
    _festivosCache.set(year, pack);
    return pack;
  }

  async function ensureYearsLoaded(start, end) {
    const years = new Set();
    if (els.startDate?.value) years.add(new Date(els.startDate.value).getFullYear());
    if (els.endDate?.value)   years.add(new Date(els.endDate.value).getFullYear());
    if (years.size === 0) years.add((new Date()).getFullYear());
    const result = {};
    for (const y of years) result[y] = await fetchHolidaysForYear(y);
    return result;
  }

  async function calcFestivosAutoAsync(region, start, end) {
    const loaded = await ensureYearsLoaded(start, end);
    const days = eachDate(start, end);
    let festivo = 0, senalado = 0;
    const county = REGION_TO_COUNTY[(region || 'nacional')] ?? null;

    for (const d of days) {
      const y = d.getFullYear();
      const pack = loaded[y];
      const iso = ymd(d);
      const isNat = pack?.nacional?.has(iso);
      const isReg = county ? (pack?.porCcaa?.get(county)?.has(iso) || false) : false;
      const isSpecial = SPECIAL_MMDD.includes(mmdd(d));
      if (isNat || isReg) festivo += 10;  // tu política de festivos
      if (isSpecial)      senalado += 30; // días señalados
    }
    return { festivo, senalado };
  }

  // ---------- Detección de servicio desde query/referrer y espejo oculto
  (function autoServiceFromLink() {
    if (!els.service) return;
    const params = new URLSearchParams(location.search);
    const map = { visitas:'visitas', paseos:'paseos', guarderia:'guarderia', alojamiento:'alojamiento', bodas:'bodas' };
    let svc = map[params.get('svc') || params.get('service') || ''] || '';

    if (!svc && document.referrer) {
      const m = document.referrer.match(/servicio-([a-z-]+)\.htm/i);
      if (m && map[m[1]]) svc = map[m[1]];
    }
    if (svc) {
      els.service.value = svc;
      els.service.setAttribute('disabled', 'disabled');
      let mirror = byId('svcMirror');
      if (!mirror) {
        mirror = document.createElement('input');
        mirror.type = 'hidden';
        mirror.name = 'Servicio';
        mirror.id = 'svcMirror';
        els.service.insertAdjacentElement('afterend', mirror);
      }
      mirror.value = els.service.options[els.service.selectedIndex]?.text || svc;
    }
  })();

  // ---------- “Otros” en especie -> input libre
  (function speciesOtherToggle() {
    const sel = els.species;
    if (!sel) return;
    function ensureOtherInput() {
      let extra = byId('speciesOther');
      if (sel.value === 'otros') {
        if (!extra) {
          extra = document.createElement('input');
          extra.id = 'speciesOther';
          extra.name = 'Tipo_animal_otro';
          extra.placeholder = 'Especifica el tipo de animal';
          extra.style.marginTop = '6px';
          sel.parentElement.appendChild(extra);
        }
        extra.required = true;
      } else if (extra) {
        extra.remove();
      }
    }
    on(sel, 'change', () => { ensureOtherInput(); recalcWithHolidays(); });
    ensureOtherInput();
  })();

  // ---------- Mensaje de desplazamiento
  (function travelHint() {
    const sel = els.needTravel;
    if (!sel) return;
    let hint = byId('travelHint');
    if (!hint) {
      hint = document.createElement('div');
      hint.id = 'travelHint';
      hint.className = 'note';
      hint.style.display = 'none';
      hint.textContent = 'El coste por kilometraje se calculará cuando asignemos al cuidador/a que mejor se adapte a tus necesidades.';
      sel.parentElement.appendChild(hint);
    }
    const sync = () => { hint.style.display = sel.value === 'si' ? 'block' : 'none'; };
    on(sel, 'change', sync); sync();
  })();

  // ---------- Autorrelleno contacto (query, localStorage, Firebase si existe)
  (function autofillContact() {
    const qs = new URLSearchParams(location.search);
    if (qs.get('email') && els.contactEmail && !els.contactEmail.value) els.contactEmail.value = qs.get('email');
    if (qs.get('tel')   && els.contactPhone && !els.contactPhone.value) els.contactPhone.value = qs.get('tel');

    try {
      if (els.contactEmail && !els.contactEmail.value && localStorage.getItem('tpl_email')) els.contactEmail.value = localStorage.getItem('tpl_email');
      if (els.contactPhone && !els.contactPhone.value && localStorage.getItem('tpl_phone')) els.contactPhone.value = localStorage.getItem('tpl_phone');
    } catch {}

    function tryAuthFill() {
      try {
        if (typeof firebase === 'undefined' || !firebase?.auth) return;
        const auth = firebase.auth();
        auth.onAuthStateChanged(u => {
          if (u?.email && els.contactEmail && !els.contactEmail.value) els.contactEmail.value = u.email;
        });
      } catch {}
    }
    tryAuthFill(); window.addEventListener('load', tryAuthFill);
  })();

  // ---------- Auto “cachorro” desde perfil (opcional, si Firebase está)
  async function autoPuppyFromProfile() {
    try {
      if (typeof firebase === 'undefined' || !firebase?.auth || !firebase?.firestore) return;
      const auth = firebase.auth();
      const db = firebase.firestore();
      const u = auth.currentUser;
      if (!u) return;
      const snap = await db.collection('users').doc(u.uid).collection('mascotas').limit(1).get();
      if (!snap.empty) {
        const pet = snap.docs[0].data();
        if (pet?.birthdate && els.isPuppy) {
          const b = new Date(pet.birthdate);
          const today = new Date();
          const months = (today.getFullYear() - b.getFullYear()) * 12 + (today.getMonth() - b.getMonth());
          els.isPuppy.value = months < 6 ? 'si' : 'no';
          els.isPuppy.disabled = true;
        }
      }
    } catch {}
  }
  window.addEventListener('load', autoPuppyFromProfile);

  // ---------- Mostrar campos según servicio
  function toggleFields() {
    const svc = els.service?.value;
    if (svc === 'visitas' && els.species) els.species.value = 'gato';
  }

  // ---------- Recalc principal (con festivos asíncronos)
  async function recalcWithHolidays() {
    const svc = els.service?.value || '';
    const speciesSel = els.species?.value || 'perro';
    const n = parseInt(els.numPets?.value || '1', 10);
    const isPuppy = (els.isPuppy?.value === 'si');

    const base = getBasePrice(svc, isPuppy);
    const pets = calcPetSupplements(svc, speciesSel, n);

    const region = els.region?.value || 'nacional';
    const start = els.startDate?.value;
    const end = els.endDate?.value;

    let festivo = 0, senalado = 0;
    try {
      ({ festivo, senalado } = await calcFestivosAutoAsync(region, start, end));
    } catch {
      // si algo falla, mantenemos 0 sin romper la UI
    }

    const subtotal = base + pets + festivo + senalado;
    const depPct = parseFloat(byId('depositPct')?.value || '0.2');
    const deposit = subtotal * (isFinite(depPct) ? depPct : 0.2);

    text(els.sumBase, base ? currency(base) : '—');
    text(els.sumPets, currency(pets));
    text(els.sumFestivo, currency(festivo));
    text(els.sumSenalado, currency(senalado));
    text(els.sumSubtotal, base ? currency(subtotal) : '—');
    text(els.sumDeposit, base ? currency(deposit) : '—');
  }

  // ---------- Eventos (solo si el elemento existe)
  ['service','species','isPuppy','numPets','startDate','endDate','region','needTravel','depositPct']
    .map(byId)
    .filter(Boolean)
    .forEach(el => {
      ['change','input'].forEach(ev => on(el, ev, () => { toggleFields(); recalcWithHolidays(); }));
    });

  // ---------- Init seguro
  (async function initCalc() {
    toggleFields();
    await recalcWithHolidays();
  })();

  // ---------- Envío: validaciones mínimas + resumen limpio
  if (form) {
    on(form, 'submit', (e) => {
      const fd = new FormData(form);
      const pref = fd.get('Preferencia_contacto') || '';
      const tel = els.contactPhone?.value?.trim();
      const mail = els.contactEmail?.value?.trim();

      if ((pref === 'telefono' || pref === 'whatsapp') && !tel) {
        e.preventDefault(); alert('Por favor, indícanos tu teléfono para poder contactarte.'); return;
      }
      if (pref === 'email' && !mail) {
        e.preventDefault(); alert('Por favor, indícanos tu correo para poder contactarte.'); return;
      }

      // especie “otros”
      let especie = els.species?.value || '';
      const speciesOther = byId('speciesOther');
      if (especie === 'otros' && speciesOther?.value) especie = `otros (${speciesOther.value.trim()})`;

      // resumen para el correo
      const summary = [
        `Servicio: ${byId('svcMirror')?.value || els.service?.options[els.service.selectedIndex]?.text || ''}`,
        `Fecha: ${els.startDate?.value || '-'} a ${els.endDate?.value || '-'}`,
        `Tipo de animal: ${especie}`,
        `Cachorro: ${els.isPuppy?.value || 'no'}`,
        `Nº mascotas: ${els.numPets?.value || '1'}`,
        `Desplazamiento: ${els.needTravel?.value || 'no'}`,
        `Festivos (auto): ${byId('sumFestivo')?.textContent || '0.00'} €`,
        `Días especiales: ${byId('sumSenalado')?.textContent || '0.00'} €`,
        `Subtotal (sin desplazamiento): ${byId('sumSubtotal')?.textContent || '0.00'} €`,
        `Depósito a retener: ${byId('sumDeposit')?.textContent || '0.00'} €`,
        `CCAA: ${els.region?.options?.[els.region.selectedIndex]?.text || 'España'}`
      ].join(' | ');

      if (els.summaryField) els.summaryField.value = summary;
    });
  }

  // ---------- Muro de login opcional (no deja la página en blanco)
  (function softAuthWall() {
    if (!wall) return;
    try {
      if (typeof firebase === 'undefined' || !firebase?.auth) {
        wall.style.display = 'none';
        return;
      }
      const auth = firebase.auth();
      auth.onAuthStateChanged(u => {
        wall.style.display = u ? 'none' : 'block';
      });
    } catch {
      wall.style.display = 'none';
    }
  })();
})();
</script>
<!-- ===== FIN Lógica de UI y precios ===== -->
