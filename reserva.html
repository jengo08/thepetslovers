<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Reserva · The Pets Lovers</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Poppins:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <style>
    .booking-wrapper{ max-width: 980px; margin: 120px auto 60px; padding: 20px; background: #fff; border:1px solid #eee; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,.05);}
    .booking-header{ text-align:center; margin-bottom: 18px; }
    .booking-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:16px; }
    .booking-field{ display:flex; flex-direction:column; gap:6px; }
    .booking-field label{ font-weight:700; font-size:.95rem; color: var(--color-texto); }
    .booking-field input, .booking-field select, .booking-field textarea{
      padding:10px 12px; border:1px solid #ddd; border-radius:8px; font-family:var(--fuente-texto);
    }
    .booking-actions{ display:flex; gap:12px; justify-content:center; margin-top: 16px; }
    .note{ font-size:.95rem; color:#666; text-align:center; margin: 10px 0 0; }
    .auth-wall{ padding:14px; border:1px dashed #bbb; border-radius:10px; text-align:center; background:#fafafa; margin-bottom:16px; }
    .auth-wall strong{ color: var(--color-texto); }
    .disabled{ opacity:.6; pointer-events:none; }

    /* TPL: INICIO BLOQUE NUEVO [Desglose de pago] */
    .summary-panel{ margin-top: 16px; background:#fafafa; border:1px solid #eee; border-radius:10px; padding:16px; }
    .summary-grid{ display:grid; grid-template-columns: 1fr auto; gap:8px; align-items:center; }
    .summary-row{ display:contents; }
    .summary-label{ color:#555; }
    .summary-value{ font-weight:700; color: var(--color-texto); text-align:right; }
    .summary-muted{ color:#999; font-weight:400; }
    .summary-total{ border-top:1px solid #e7e7e7; margin-top:8px; padding-top:8px; font-size:1.05rem; }
    .summary-badge{ display:inline-block; font-size:.85rem; padding:2px 8px; border-radius:999px; border:1px dashed #bbb; color:#666; }
    /* TPL: FIN BLOQUE NUEVO */
  </style>
</head>
<body>

  <!-- Navbar unificada (inyectada) -->
  <div id="tpl-navbar">
    <noscript>
      <nav class="navbar">
        <div class="logo">
          <a href="index.html"><img src="images/logo.png.png" alt="The Pets Lovers"></a>
        </div>
        <a href="index.html" class="home-button">Inicio</a>
        <ul class="nav-links">
          <li><a href="como-funciona.html">Cómo funciona</a></li>
          <li><a href="servicios.html">Servicios</a></li>
          <li><a href="index.html#contactanos">Contáctanos</a></li>
          <li><a href="index.html#hazte-cuidador">Conviértete en cuidador</a></li>
        </ul>
        <a class="login-button" href="#iniciar-sesion">Iniciar sesión</a>
      </nav>
    </noscript>
  </div>

  <div class="booking-wrapper">
    <div class="booking-header">
      <h1>Reserva tu servicio</h1>
      <p>Selecciona el servicio y la fecha. Para completar la reserva es necesario iniciar sesión y tener los datos de tu mascota guardados.</p>
    </div>

    <!-- Muro de autenticación -->
    <div id="authWall" class="auth-wall">
      <p><strong>Para reservar debes estar registrada o iniciar sesión.</strong></p>
      <div class="booking-actions">
        <a href="login.html?next=reserva.html" class="cta-button" id="btnLogin">Iniciar sesión</a>
        <a href="registro.html?next=reserva.html" class="cta-button" id="btnRegister" style="background:#fff;color:var(--color-principal);border:2px solid var(--color-principal);">Registrarme</a>
      </div>
      <p class="note">Cuando actives tu cuenta, podrás completar la reserva desde aquí.</p>
    </div>

    <!-- Formulario de reserva (bloqueado si no hay login) -->
    <!-- TPL: INICIO BLOQUE NUEVO [Conexión Formspree] -->
    <!-- Sustituye ACTION por tu endpoint real de Formspree cuando lo tengas -->
    <form id="bookingForm" class="disabled" novalidate action="https://formspree.io/f/xxxxxxxx" method="POST">
    <!-- TPL: FIN BLOQUE NUEVO -->
      <div class="booking-grid">
        <div class="booking-field">
          <label for="service">Servicio</label>
          <select id="service" name="Servicio" required>
            <option value="">Elige un servicio…</option>
            <option value="visitas">Visitas a domicilio (gatos)</option>
            <option value="paseos">Paseos</option>
            <option value="guarderia">Guardería de día</option>
            <option value="alojamiento">Alojamiento (por día)</option>
            <option value="bodas">Bodas y servicios exclusivos</option>
          </select>
        </div>

        <div class="booking-field">
          <label for="date">Fecha</label>
          <input type="date" id="date" name="Fecha" required>
        </div>

        <div class="booking-field">
          <label for="start">Hora de inicio</label>
          <input type="time" id="start" name="Hora_inicio" required>
        </div>

        <div class="booking-field">
          <label for="end">Hora de fin</label>
          <input type="time" id="end" name="Hora_fin" required>
        </div>

        <div class="booking-field">
          <label for="location">Lugar</label>
          <input type="text" id="location" name="Lugar" placeholder="Dirección o zona">
        </div>

        <!-- TPL: INICIO BLOQUE NUEVO [Tipo animal, nº mascotas y cachorro] -->
        <div class="booking-field" id="fieldSpecies" hidden>
          <label for="species">Tipo de animal</label>
          <select id="species" name="Tipo_animal">
            <option value="perro">Perro</option>
            <option value="gato">Gato</option>
          </select>
        </div>

        <div class="booking-field" id="fieldIsPuppy" hidden>
          <label for="isPuppy">¿Es cachorro (≤ 6 meses)?</label>
          <select id="isPuppy" name="Cachorro">
            <option value="no">No</option>
            <option value="si">Sí</option>
          </select>
        </div>

        <div class="booking-field" id="fieldNumPets" hidden>
          <label for="numPets">Nº de mascotas</label>
          <select id="numPets" name="N_mascotas">
            <option value="1">1</option><option value="2">2</option>
            <option value="3">3</option><option value="4">4</option>
            <option value="5">5</option>
          </select>
        </div>
        <!-- TPL: FIN BLOQUE NUEVO -->

        <!-- TPL: INICIO BLOQUE NUEVO [Extras generales] -->
        <div class="booking-field">
          <label for="festivo">¿Es festivo?</label>
          <select id="festivo" name="Festivo">
            <option value="0">No</option>
            <option value="10">Sí, +10 €</option>
          </select>
        </div>

        <div class="booking-field">
          <label for="senalado">¿Día señalado (Navidad, Nochevieja…)?</label>
          <select id="senalado" name="Dia_senalado">
            <option value="0">No</option>
            <option value="30">Sí, +30 €</option>
          </select>
        </div>

        <div class="booking-field">
          <label for="depositPct">Depósito (retención)</label>
          <select id="depositPct" name="Deposito_pct">
            <option value="0.2">20% (recomendado)</option>
            <option value="0.3">30%</option>
            <option value="0.5">50%</option>
          </select>
        </div>
        <!-- TPL: FIN BLOQUE NUEVO -->

        <div class="booking-field" style="grid-column: 1 / -1;">
          <label for="notes">Notas (opcional)</label>
          <textarea id="notes" name="Notas" rows="3" placeholder="Rutinas, medicación, instrucciones…"></textarea>
        </div>
      </div>

      <!-- Resumen / Desglose -->
      <div class="summary-panel" id="summary">
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
          <strong>Desglose preliminar</strong>
          <span class="summary-badge">El kilómetraje se añade al asignar cuidador</span>
        </div>
        <div class="summary-grid">
          <div class="summary-row">
            <div class="summary-label">Precio base</div>
            <div class="summary-value"><span id="sumBase">—</span> €</div>
          </div>
          <div class="summary-row">
            <div class="summary-label">Suplementos por mascotas</div>
            <div class="summary-value"><span id="sumPets">0.00</span> €</div>
          </div>
          <div class="summary-row">
            <div class="summary-label">Festivo</div>
            <div class="summary-value"><span id="sumFestivo">0.00</span> €</div>
          </div>
          <div class="summary-row">
            <div class="summary-label">Día señalado</div>
            <div class="summary-value"><span id="sumSenalado">0.00</span> €</div>
          </div>
          <div class="summary-row">
            <div class="summary-label">Desplazamiento</div>
            <div class="summary-value summary-muted">pendiente</div>
          </div>
          <div class="summary-row summary-total">
            <div class="summary-label">Subtotal (sin desplazamiento)</div>
            <div class="summary-value"><span id="sumSubtotal">—</span> €</div>
          </div>
          <div class="summary-row">
            <div class="summary-label">Depósito a retener</div>
            <div class="summary-value"><span id="sumDeposit">—</span> €</div>
          </div>
        </div>
        <p class="note" style="margin-top:10px;">
          Este cálculo es orientativo. El importe por kilometraje se añade al confirmar el cuidador más cercano.
          El depósito se retiene (autorización) y se captura tras aceptar la reserva.
        </p>
      </div>

      <!-- TPL: INICIO BLOQUE NUEVO [Campo oculto con el desglose para el email] -->
      <input type="hidden" name="Desglose" id="summaryField">
      <!-- TPL: FIN BLOQUE NUEVO -->

      <div class="booking-actions">
        <button type="submit" class="cta-button">Solicitar reserva</button>
      </div>
      <p class="note">Tras enviar, te llamaremos para conocernos y confirmar detalles. La primera visita con el cuidador es gratuita.</p>
    </form>
  </div>

  <script>
    // ====== TPL: INICIO BLOQUE NUEVO [Lógica de UI y precios] ======
    const form = document.getElementById('bookingForm');
    const wall = document.getElementById('authWall');

    const els = {
      service: document.getElementById('service'),
      species: document.getElementById('species'),
      isPuppy: document.getElementById('isPuppy'),
      numPets: document.getElementById('numPets'),
      festivo: document.getElementById('festivo'),
      senalado: document.getElementById('senalado'),
      depositPct: document.getElementById('depositPct'),

      fieldSpecies: document.getElementById('fieldSpecies'),
      fieldIsPuppy: document.getElementById('fieldIsPuppy'),
      fieldNumPets: document.getElementById('fieldNumPets'),

      sumBase: document.getElementById('sumBase'),
      sumPets: document.getElementById('sumPets'),
      sumFestivo: document.getElementById('sumFestivo'),
      sumSenalado: document.getElementById('sumSenalado'),
      sumSubtotal: document.getElementById('sumSubtotal'),
      sumDeposit: document.getElementById('sumDeposit'),

      summaryField: document.getElementById('summaryField')
    };

    // Precios base (coinciden con tu web actual)
    const BASES = {
      visitas: 22,       // 60' (incluye 1 gato)
      paseos: 12,
      guarderia: 20,     // día (hasta 8h)
      alojamiento: 30,   // por día (perro/gato) — sube a 35€ si cachorro
      bodas: 0           // a consultar
    };

    function currency(n){ return (Math.round(n * 100) / 100).toFixed(2); }

    // Suplementos dinámicos por nº de mascotas, según servicio
    function calcPetSupplements(service, species, n){
      if(n <= 1) return 0;

      // Visitas (gatos): 1 extra +12; 2 extras +8 c/u; + de 3 extras +6 c/u
      if(service === 'visitas'){
        const extra = n - 1;
        if(extra === 1) return 12;
        if(extra === 2) return 8 * 2;
        if(extra >= 3) return 6 * extra;
        return 0;
      }

      // Paseos: +8€ por cada mascota adicional
      if(service === 'paseos'){
        return 8 * (n - 1);
      }

      // Alojamiento: cada perro adicional 25€ / día
      if(service === 'alojamiento' && species === 'perro'){
        return 25 * (n - 1);
      }

      return 0;
    }

    function toggleFields(){
      const svc = els.service.value;

      // Mostrar tipo de animal y nº de mascotas en servicios que lo requieren
      const needSpeciesNum = (svc === 'visitas' || svc === 'alojamiento' || svc === 'paseos');
      els.fieldSpecies.hidden = !needSpeciesNum;
      els.fieldNumPets.hidden = !needSpeciesNum;

      // Selector "cachorro" sólo para alojamiento y guardería
      const needPuppy = (svc === 'alojamiento' || svc === 'guarderia');
      els.fieldIsPuppy.hidden = !needPuppy;

      // En visitas fijamos especie = gato
      if(svc === 'visitas'){ els.species.value = 'gato'; }
    }

    function getBasePrice(service){
      let base = BASES[service] || 0;
      const isPuppy = (els.isPuppy.value === 'si');

      // Regla de cachorro:
      // - Alojamiento: cachorros 35 €
      if(service === 'alojamiento' && isPuppy){ base = 35; }

      return base;
    }

    function recalc(){
      const svc = els.service.value || '';
      const species = (els.species.value || 'perro');
      const n = parseInt(els.numPets.value || '1', 10);

      const base = getBasePrice(svc);
      const pets = calcPetSupplements(svc, species, n);

      const festivo = parseFloat(els.festivo.value || 0);
      const senalado = parseFloat(els.senalado.value || 0);

      const subtotal = base + pets + festivo + senalado;
      const depPct = parseFloat(els.depositPct.value || 0.2);
      const deposit = subtotal * depPct;

      els.sumBase.textContent = base ? currency(base) : '—';
      els.sumPets.textContent = currency(pets);
      els.sumFestivo.textContent = currency(festivo);
      els.sumSenalado.textContent = currency(senalado);
      els.sumSubtotal.textContent = base ? currency(subtotal) : '—';
      els.sumDeposit.textContent = base ? currency(deposit) : '—';
    }

    ['change','input'].forEach(ev=>{
      ['service','species','isPuppy','numPets','festivo','senalado','depositPct'].forEach(id=>{
        const el = document.getElementById(id);
        if(el) el.addEventListener(ev, ()=>{ toggleFields(); recalc(); });
      });
    });

    toggleFields();
    recalc();

    // Antes de enviar a Formspree, guardamos el desglose en el campo oculto
    form.addEventListener('submit', (e)=>{
      const summary = [
        `Servicio: ${els.service.options[els.service.selectedIndex]?.text || ''}`,
        `Tipo de animal: ${els.species && !els.fieldSpecies.hidden ? els.species.value : '-'}`,
        `Cachorro: ${els.isPuppy && !els.fieldIsPuppy.hidden ? els.isPuppy.value : '-'}`,
        `Nº mascotas: ${els.numPets && !els.fieldNumPets.hidden ? els.numPets.value : '1'}`,
        `Festivo: ${els.festivo.value} €`,
        `Día señalado: ${els.senalado.value} €`,
        `Subtotal (sin desplazamiento): ${document.getElementById('sumSubtotal').textContent} €`,
        `Depósito a retener: ${document.getElementById('sumDeposit').textContent} €`,
        `Kilometraje: pendiente (al asignar cuidador)`
      ].join(' | ');
      els.summaryField.value = summary;
    });
    // ====== TPL: FIN BLOQUE NUEVO ======
  </script>

  <!-- Footer unificado (inyectado) -->
  <div id="tpl-footer">
    <noscript>
      <footer class="site-footer">
        <div class="container footer-row">
          <div class="footer-left">
            <nav class="footer-links-row">
              <a href="sobre-nosotros.html">Sobre nosotros</a><span class="sep">|</span>
              <a href="contacto.html">Contacta con nosotros</a><span class="sep">|</span>
              <a href="donde-estamos.html">Dónde estamos</a><span class="sep">|</span>
              <a href="trabaja-con-nosotros.html">Trabaja con nosotros</a><span class="sep">|</span>
              <a href="privacidad.html">Política de Privacidad</a><span class="sep">|</span>
              <a href="condiciones.html">Condiciones de Servicio</a><span class="sep">|</span>
              <a href="digital-services-act.html">Digital Services Act</a>
            </nav>
            <div class="footer-help">¿Necesitas ayuda? <a href="ayuda.html">Centro de ayuda</a></div>
          </div>
          <div class="footer-right socials">
            <a href="#" aria-label="WhatsApp"><i class="fab fa-whatsapp"></i></a>
            <a href="#" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
            <a href="#" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
            <a href="#" aria-label="TikTok"><i class="fab fa-tiktok"></i></a>
          </div>
        </div>
        <div class="footer-bottom footer-bottom--inline">
          <div class="footer-bottom-left">© <span class="year-span"></span> The Pets Lovers — Todos los derechos reservados</div>
          <nav class="footer-bottom-right legal-links">
            <a href="aviso-legal.html">Aviso legal</a><span class="sep">|</span>
            <a href="privacidad.html">Privacidad</a><span class="sep">|</span>
            <a href="cookies.html">Cookies</a><span class="sep">|</span>
            <a href="canal-denuncias.html">Canal de denuncias</a>
          </nav>
        </div>
      </footer>
    </noscript>
  </div>

  <!-- Mini-injectors -->
  <script src="tpl-navbar.js" defer></script>
  <script src="tpl-footer.js" defer></script>

  <!-- TPL: INICIO BLOQUE NUEVO [Firebase SDK para web estática - COMPAT correcto] -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
  <!-- (Opcional) Analytics: solo si quieres métricas -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-analytics-compat.js"></script>

  <script>
    // Configuración de tu proyecto
    const firebaseConfig = {
      apiKey: "AIzaSyDW73aFuz2AFS9VeWg_linHIRJYN4YMgTk",
      authDomain: "thepetslovers-c1111.firebaseapp.com",
      projectId: "thepetslovers-c1111",
      storageBucket: "thepetslovers-c1111.appspot.com",
      messagingSenderId: "415914577533",
      appId: "1:415914577533:web:0b7a056ebaa4f1de28ab14",
      measurementId: "G-FXPD69KXBG"
    };

    // Inicialización (compat expone 'firebase' global)
    if (firebase.apps.length === 0) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();
    if (firebase.analytics) { try { firebase.analytics(); } catch(e){} }

    // Mostrar/ocultar formulario según sesión
    function updateAuthUI(user){
      const logged = !!user;
      if (form) {
        form.classList.toggle('disabled', !logged);
      }
      if (wall) {
        wall.style.display = logged ? 'none' : 'block';
      }
    }
    auth.onAuthStateChanged(updateAuthUI);
  </script>
  <!-- TPL: FIN BLOQUE NUEVO -->

</body>
</html>
