<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Reserva · The Pets Lovers</title>

<!-- Fuente + iconos -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

<style>
  :root{
    --tpl-green:#16a34a;
    --tpl-green-700:#15803d;
    --tpl-dark:#0f172a;
    --tpl-gray:#6b7280;
    --tpl-border:#e5e7eb;
    --tpl-bg:#f8fafc;
    --tpl-white:#fff;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--tpl-bg);color:var(--tpl-dark);font-family:Poppins,system-ui,Segoe UI,Roboto,Arial}
  a{color:var(--tpl-green);text-decoration:none}
  .wrap{max-width:1100px;margin:auto;padding:24px}
  .hero{padding:18px 0 12px}
  .hero h1{margin:0;font-size:28px}
  .hero .sub{color:var(--tpl-gray);margin:6px 0 0}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .card{border:1px solid var(--tpl-border);border-radius:14px;padding:16px;background:#fff;margin-bottom:16px}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:0;cursor:pointer;font-weight:600}
  .btn-primary{background:var(--tpl-green);color:#fff}
  .btn-primary:hover{background:var(--tpl-green-700)}
  .btn-ghost{background:#fff;border:1px solid var(--tpl-border)}
  .muted{color:var(--tpl-gray)}
  .disabled{opacity:.55;pointer-events:none}
  label{display:block;margin:2px 0 6px;font-weight:600}
  input,select,textarea{width:100%;padding:10px;border:1px solid var(--tpl-border);border-radius:10px;background:#fff}
  textarea{min-height:100px;resize:vertical}
  table.summary{width:100%;border-collapse:separate;border-spacing:0 6px}
  table.summary th,table.summary td{padding:8px 10px;border-bottom:1px dashed var(--tpl-border);text-align:left}
  table.summary tr.total th,table.summary tr.total td{font-weight:700;border-bottom:none}
  #authWall{border:2px dashed var(--tpl-border);background:#fffcee}
  .full{grid-column:1 / -1}

  /* Navbar */
  .navwrap{background:var(--tpl-green);color:#fff}
  .navinner{max-width:1100px;margin:auto;display:flex;align-items:center;justify-content:space-between;padding:12px 24px}
  .navinner a{color:#fff}
  .navinner nav a{margin-left:16px}

  /* Footer */
  .footwrap{background:#fff;border-top:1px solid var(--tpl-border)}
  .footinner{max-width:1100px;margin:auto;padding:22px 24px;display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .footcopy{ text-align:center;color:#6b7280;padding:10px 0;border-top:1px solid var(--tpl-border)}

  /* Mascotas grid */
  .tpl-pets-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  @media(min-width:900px){.tpl-pets-grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
  .tpl-pet{display:flex;gap:10px;align-items:center;border:1px solid var(--tpl-border);border-radius:14px;padding:10px;background:#fff}
  .tpl-pet img{width:56px;height:56px;border-radius:50%;object-fit:cover;border:1px solid var(--tpl-border)}
  .tpl-pet input[type=checkbox]{width:18px;height:18px}
  .tpl-badge{font-size:11px;border-radius:999px;padding:2px 6px;border:1px solid #c7d2fe;background:#eef2ff;color:#3730a3;margin-left:6px}
</style>
</head>
<body>

<!-- NAVBAR -->
<header>
  <div class="navwrap">
    <div class="navinner">
      <a href="/" style="display:flex;align-items:center;gap:10px;font-weight:700">
        <i class="fa-solid fa-paw"></i> The Pets Lovers
      </a>
      <nav>
        <a href="/">Inicio</a>
        <a href="/servicios.html">Servicios</a>
        <a href="/reserva.html" style="font-weight:700">Reservas</a>
        <a href="/perfil.html"><i class="fa-regular fa-user"></i> Perfil</a>
      </nav>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- Botón Atrás -->
  <button type="button" class="btn btn-ghost" id="btnBack" style="margin-bottom:12px">
    <i class="fa-solid fa-arrow-left"></i> Atrás
  </button>

  <section class="hero">
    <h1>Reserva tu servicio</h1>
    <p class="sub">Selecciona el servicio y la fecha para completar la reserva.</p>
  </section>

  <!-- Muro de autenticación -->
  <section id="authWall" class="card" style="display:none">
    <h3 style="margin:0 0 8px">Inicia sesión para reservar</h3>
    <p class="muted" style="margin:0 0 12px">Para continuar debes iniciar sesión o crear tu cuenta.</p>
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <a class="btn btn-primary" href="/login.html"><i class="fa-solid fa-right-to-bracket"></i> Iniciar sesión</a>
      <a class="btn btn-ghost" href="/crear-cuenta.html"><i class="fa-solid fa-user-plus"></i> Crear cuenta</a>
    </div>
  </section>

  <!-- Formulario -->
  <form id="bookingForm" class="card disabled" data-tpl-redirect="/perfil.html" data-tpl-wait="800">

    <!-- Datos del servicio -->
    <section class="card" id="sec-servicio">
      <h3>Datos del servicio</h3>
      <div class="grid-2">
        <div>
          <label for="service">Servicio</label>
          <select id="service" name="service" required>
            <option value="">Selecciona…</option>
            <option value="guarderia">Guardería de día</option>
            <option value="alojamiento">Alojamiento nocturno</option>
            <option value="paseos">Paseo (60’)</option>
            <option value="visitas">Visita a domicilio (gato)</option>
            <option value="exoticos">Exóticos</option>
            <option value="transporte">Transporte</option>
          </select>
        </div>
        <div>
          <label for="startDate">Fecha inicio</label>
          <input id="startDate" name="startDate" type="date" required>
        </div>
        <div>
          <label for="endDate">Fecha fin</label>
          <input id="endDate" name="endDate" type="date" required>
        </div>
        <div>
          <label for="startTime">Hora inicio</label>
          <input id="startTime" name="Hora_inicio" type="time">
        </div>
        <div>
          <label for="endTime">Hora fin</label>
          <input id="endTime" name="Hora_fin" type="time">
        </div>
      </div>
    </section>

    <!-- Datos del titular -->
    <section class="card">
      <h3>Datos del titular</h3>
      <div class="grid-2">
        <div>
          <label for="firstName">Nombre y apellidos</label>
          <input id="firstName" name="firstName" required>
          <input id="lastName" name="lastName" style="display:none">
        </div>
        <div>
          <label for="email">Email</label>
          <input id="email" name="email" type="email" required>
        </div>
        <div>
          <label for="phone">Teléfono</label>
          <input id="phone" name="phone" required>
        </div>
        <div>
          <label for="region">Comunidad Autónoma</label>
          <select id="region" name="region" required>
            <option value="">Selecciona…</option>
            <option>Andalucía</option><option>Aragón</option><option>Asturias</option><option>Baleares</option>
            <option>Canarias</option><option>Cantabria</option><option>Castilla-La Mancha</option><option>Castilla y León</option>
            <option>Cataluña</option><option>Comunidad Valenciana</option><option>Extremadura</option><option>Galicia</option>
            <option>La Rioja</option><option>Madrid</option><option>Murcia</option><option>Navarra</option>
            <option>País Vasco</option><option>Ceuta</option><option>Melilla</option>
          </select>
        </div>
        <div>
          <label for="address">Dirección</label>
          <input id="address" name="address" placeholder="Calle, nº, piso…">
        </div>
        <div>
          <label for="postalCode">Código Postal</label>
          <input id="postalCode" name="postalCode" placeholder="28001">
        </div>
        <div class="full">
          <label for="observations">Observaciones</label>
          <textarea id="observations" name="observations" placeholder="Llaves, timbre, alergias…"></textarea>
        </div>
      </div>
    </section>

    <!-- Mascotas -->
    <section class="card" id="petsAnchor">
      <h3>Mascotas</h3>

      <!-- Especie visible en Visitas (gato) o Exóticos -->
      <div id="speciesBlock" style="display:none; margin-bottom:10px">
        <label for="species">Especie</label>
        <select id="species" name="species">
          <option value="gato">Gato</option>
          <option value="perro">Perro</option>
          <option value="conejo">Conejo</option>
          <option value="pajaro">Pájaro</option>
          <option value="huron">Hurón</option>
          <option value="iguana">Iguana</option>
          <option value="otro">Otro exótico</option>
        </select>
      </div>

      <!-- Cards generadas por JS -->
      <section id="tpl-pet-section" class="tpl-section" aria-label="Mascotas seleccionables"></section>
    </section>

    <!-- Desglose -->
    <section class="card">
      <h3>Desglose</h3>
      <table class="summary">
        <thead><tr><th>Concepto</th><th>Importe</th></tr></thead>
        <tbody id="summaryBody">
          <tr><th>Base suelto</th><td id="sumBase">0.00</td></tr>
          <tr><th>Visitas (principal)</th><td id="sumVisit1">0.00</td></tr>
          <tr><th>Visitas (medicación)</th><td id="sumVisit2">0.00</td></tr>
          <tr><th>Suplementos/bono</th><td id="sumFestivo">0.00</td></tr>
          <tr><th>Días</th><td id="sumSenalado">0</td></tr>
          <tr><th>Suplementos mascotas</th><td id="sumPets">0.00</td></tr>
          <tr class="total"><th>Subtotal</th><td id="sumSubtotal">0.00</td></tr>
          <tr class="total"><th>A pagar ahora</th><td id="sumDeposit">0.00</td></tr>
          <tr class="total"><th>Pendiente (12 días antes)</th><td id="sumResto">0.00</td></tr>
        </tbody>
      </table>
      <input type="hidden" id="summaryField" name="summaryField" value="">
      <p class="muted" style="margin-top:8px">
        Solo abonarás una pequeña parte ahora. El resto se pagará <strong>12 días antes</strong> del inicio del servicio.
      </p>
    </section>

    <!-- CTA -->
    <div style="display:flex;gap:10px;justify-content:flex-end">
      <button type="submit" class="btn btn-primary"><i class="fa-solid fa-lock"></i> Reservar ahora</button>
    </div>
  </form>
</main>

<!-- FOOTER -->
<footer>
  <div class="footwrap">
    <div class="footinner">
      <div>
        <strong style="display:block;margin-bottom:8px">The Pets Lovers</strong>
        <div style="color:#6b7280">Cuidado profesional con amor.</div>
        <div style="margin-top:10px;display:flex;gap:12px">
          <a aria-label="Instagram" href="https://instagram.com/thepetslovers" target="_blank" rel="noopener" style="color:#16a34a">
            <i class="fa-brands fa-instagram"></i>
          </a>
          <a aria-label="WhatsApp" href="https://wa.me/34XXXXXXXXX" target="_blank" rel="noopener" style="color:#16a34a">
            <i class="fa-brands fa-whatsapp"></i>
          </a>
          <a aria-label="Email" href="mailto:gestion@thepetslovers.es" style="color:#16a34a">
            <i class="fa-regular fa-envelope"></i>
          </a>
        </div>
      </div>
      <div>
        <div style="font-weight:600;margin-bottom:8px">Enlaces</div>
        <div style="display:flex;gap:14px;flex-wrap:wrap">
          <a href="/aviso-legal.html">Aviso legal</a>
          <a href="/privacidad.html">Privacidad</a>
          <a href="/cookies.html">Cookies</a>
        </div>
      </div>
    </div>
    <div class="footcopy">© <span id="yearCopy"></span> The Pets Lovers</div>
  </div>
</footer>

<!-- Firebase compat (necesario para Auth/Firestore). Si ya lo cargas globalmente, déjalo igual -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<!-- INIT Firebase: usa el que ya tienes. Opciones:
     A) Si tu sitio ya inicializa Firebase globalmente, NO toques nada.
     B) Si no, define window.TPL_FIREBASE_CONFIG antes o pega aquí tu config real. -->
<script>
  (function(){
    document.getElementById('yearCopy').textContent = new Date().getFullYear();
    if (typeof firebase === 'undefined') return;
    try{
      if (!firebase.apps.length) {
        if (window.TPL_FIREBASE_CONFIG) {
          firebase.initializeApp(window.TPL_FIREBASE_CONFIG);
        } else {
          // TODO: Pega tu config real aquí si lo necesitas en esta página aislada:
          // firebase.initializeApp({ apiKey:"...", authDomain:"...", projectId:"...", ... });
        }
      }
    }catch(e){ console.warn('Firebase init:', e); }
  })();
</script>

<!-- EmailJS -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script>
  // Tus IDs reales (los que ya tenías en el proyecto)
  window.TPL_EMAILJS = {
    serviceId: "service_odjqrfl",
    publicKey: "L2xAATfVuHJwj4EIV",
    templates: {
      cliente: "template_rao5n0c",
      gestion: "template_rao5n0c"
    },
    adminEmail: "gestion@thepetslovers.es"
  };
  try{ if(window.TPL_EMAILJS.publicKey){ emailjs.init(window.TPL_EMAILJS.publicKey); } }catch(e){}
</script>

<!-- BRIDGE de sesión (Firebase Auth) -->
<script>
(function(){
  if (window.__TPL_AUTH_BRIDGE__) return; window.__TPL_AUTH_BRIDGE__=true;

  function normEmail(s){ return String(s||'').trim().toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,''); }

  const ADMIN_EMAILS = (window.__TPL_ADMIN_EMAILS || [
    '4b.jenny.gomez@gmail.com','gestion@thepetslovers.es'
  ]).map(normEmail);

  const st = window.__TPL_AUTH_STATE = window.__TPL_AUTH_STATE || {
    ready:false, user:null, email:null, isAdmin:false, uid:null
  };

  function apply(email, uid){
    const e = email ? String(email) : null;
    st.user  = e ? {email:e, uid: uid||null} : null;
    st.email = e;
    st.uid   = uid||null;
    st.isAdmin = ADMIN_EMAILS.includes(normEmail(e));
    st.ready = true;
    try { localStorage.setItem('tpl.auth.email', e||''); } catch(_){}
    window.dispatchEvent(new CustomEvent('tpl-auth-change', { detail:{ user: st.user } }));
  }

  function initWithFirebase(){
    if (typeof firebase === 'undefined' || !firebase.auth) return false;
    try{
      firebase.auth().onAuthStateChanged(function(user){
        if(user && user.email){ apply(user.email, user.uid||null); }
        else { apply(null, null); }
      });
    }catch(e){ console.warn('AUTH-BRIDGE: Firebase auth listener error', e); }
    return true;
  }

  function initWithLocal(){
    try{
      const e = localStorage.getItem('tpl.profile.email') || localStorage.getItem('tpl.auth.email') || null;
      if(e) apply(e, null); else apply(null, null);
    }catch(_){ apply(null, null); }
  }

  window.TPL_AUTH = {
    get state(){ return Object.assign({}, st); },
    isLogged(){ return !!st.email; },
    email(){ return st.email||null; },
    uid(){ return st.uid||null; },
    isAdmin(){ return !!st.isAdmin; }
  };

  document.addEventListener('DOMContentLoaded', function(){
    const ok = initWithFirebase();
    if(!ok) initWithLocal();
    window.dispatchEvent(new CustomEvent('tpl-auth-ready'));
  });
})();
</script>

<!-- MOTOR DE RESERVAS -->
<script>
(function(){
  'use strict';

  /* Utils */
  const €fmt = new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' });
  const fmtEUR = (n) => €fmt.format(Math.round((+n || 0) * 100) / 100);
  const currency = (n) => (Math.round((n || 0) * 100) / 100).toFixed(2);
  const $  = (s,root=document)=>root.querySelector(s);
  const $$ = (s,root=document)=>Array.from(root.querySelectorAll(s));
  function parseDateSafe(str){ if(!str) return null; const d = new Date(str); return isNaN(d) ? null : d; }
  const todayStr = ()=>{const d=new Date();const m=String(d.getMonth()+1).padStart(2,"0");const dd=String(d.getDate()).padStart(2,"0");return `${d.getFullYear()}-${m}-${dd}`};
  const monthDayKey = (date)=>{ const d=parseDateSafe(date); if(!d) return ""; const m=String(d.getMonth()+1).padStart(2,"0"); const dd=String(d.getDate()).padStart(2,"0"); return `${m}-${dd}`; };
  const BIG_DAYS = ["12-24","12-25","12-31","01-01"]; // MM-DD

  function svcKey(){
    const raw = ($('#service')?.value || '').toString().trim().toLowerCase();
    const map = {
      'guarderia':'guarderia','guardería':'guarderia','daycare':'guarderia',
      'alojamiento':'alojamiento','estancias':'alojamiento','estancia':'alojamiento',
      'paseos':'paseos','paseo':'paseos','walks':'paseos',
      'visitas':'visitas','visita':'visitas','gatos':'visitas',
      'exoticos':'exoticos','exóticos':'exoticos','exotico':'exoticos',
      'transporte':'transporte','postquirurgico':'postquirurgico','bodas':'bodas'
    };
    return map[raw] || raw;
  }
  function getDays(){
    const s=$('#startDate')?.value, e=$('#endDate')?.value;
    if(!s || !e) return 0;
    const d1 = new Date(s), d2 = new Date(e);
    if(isNaN(d1) || isNaN(d2)) return 0;
    const diff = Math.floor((d2 - d1) / (1000*60*60*24));
    return diff >= 0 ? diff + 1 : 0;
  }
  function updateDaysRow(nDias){
    const td = $('#sumSenalado')?.parentElement;
    if(td) td.innerHTML = `<span id="sumSenalado">${nDias===1?'1 día':`${nDias} días`}</span>`;
  }

  /* Unificar nombre */
  function unifyNameFields(){
    const first = $('#firstName'), last = $('#lastName');
    if(!first || !last) return;
    const label = document.querySelector('label[for="firstName"]'); if(label) label.textContent='Nombre y apellidos';
    if(first.placeholder) first.placeholder='Nombre y apellidos';
    function up(){ const parts=first.value.trim().split(/\s+/); last.value=(parts.length>=2)?parts.slice(1).join(' '):''; }
    function merge(){ const n=(first.value||'').trim(), s=(last.value||'').trim(); if(s && !n.toLowerCase().includes(s.toLowerCase())) first.value=`${n} ${s}`.trim(); }
    function hide(){ const c=last.closest('.booking-field')||last.parentElement; if(c) c.style.display='none'; }
    setTimeout(()=>{ merge(); hide(); up(); }, 800);
    first.addEventListener('input', up); last.addEventListener('input', ()=>{ merge(); hide(); up(); });
  }

  /* Mascotas */
  function ensurePetsContainer(){
    let grid = $('#petsGrid');
    if(!grid){
      const anchor = $('#tpl-pet-section') || $('#petsAnchor') || $('#bookingForm') || document.body;
      const sec = document.createElement('section'); sec.id='petsSection';
      sec.innerHTML = `
        <h3 style="margin-top:12px">Mascotas</h3>
        <div id="petsGrid" class="tpl-pets-grid"></div>
        <p class="muted">Selecciona hasta 3 mascotas para esta reserva.</p>
      `;
      anchor.parentNode.insertBefore(sec, anchor.nextSibling);
      grid = sec.querySelector('#petsGrid');
    }
    return grid;
  }
  function ageMonths(b){ const d=parseDateSafe(b); if(!d) return null; const n=new Date(); let m=(n.getFullYear()-d.getFullYear())*12+(n.getMonth()-d.getMonth()); if(n.getDate()<d.getDate()) m--; return m; }
  function isPuppyPet(p){ return p?.species==="perro" && (ageMonths(p.birth)??99) <= 6; }
  function ensurePetsMock(profile){
    if(profile && Array.isArray(profile.pets) && profile.pets.length) return profile;
    const mock = profile || {};
    mock.pets = [
      {id:"luna", name:"Luna", species:"perro", birth:"2025-07-10", img:"https://images.unsplash.com/photo-1517849845537-4d257902454a?w=160"},
      {id:"michi", name:"Michi", species:"gato",  birth:"2022-05-01", img:"https://images.unsplash.com/photo-1592194996308-7b43878e84a6?w=160"},
      {id:"kiko", name:"Kiko", species:"exotico",subtype:"ave", birth:"2021-03-03", img:"https://images.unsplash.com/photo-1501706362039-c06b2d715385?w=160"}
    ];
    return mock;
  }
  function renderPets(profile){
    const grid = ensurePetsContainer(); grid.innerHTML="";
    const pets = (profile?.pets)||[];
    pets.slice(0,50).forEach(p=>{
      const puppy = isPuppyPet(p);
      const el = document.createElement('label'); el.className='tpl-pet';
      el.innerHTML = `
        <input type="checkbox" class="pet-check" data-id="${p.id}">
        <img src="${p.img||""}" alt="${p.name}">
        <div style="flex:1">
          <div><strong>${p.name||"Mascota"}</strong>
            ${p.species==="perro" ? '<i class="fa-solid fa-dog"></i>' :
              p.species==="gato" ? '<i class="fa-solid fa-cat"></i>' :
              '<i class="fa-solid fa-kiwi-bird"></i>'}
            ${puppy?'<span class="tpl-badge">Cachorro (≤6m)</span>':''}
          </div>
          <div class="muted">${p.species==="exotico"?(p.subtype?("Exótico · "+p.subtype):"Exótico"):p.species} · Nac: ${p.birth||"—"}</div>
        </div>
      `;
      grid.appendChild(el);
    });
    grid.addEventListener('change', ()=>{
      const count = $$('.pet-check:checked', grid).length;
      const numSel = $('#numPets');
      if(numSel){
        if(count>=6){ numSel.value='6+'; const ex = $('#numPetsExact'); if(ex) ex.value = String(count); }
        else numSel.value = String(Math.max(1,count||1));
        try{ numSel.dispatchEvent(new Event('change',{bubbles:true})); }catch(_){}
      }
      const selectedObjs = selectedPets(profile);
      const anyPuppy = selectedObjs.some(isPuppyPet);
      lockPuppyUI(anyPuppy);
      computeCosts();
    });
  }
  function selectedPets(profile){ const ids=$$('.pet-check:checked').map(x=>x.getAttribute('data-id')); const all=(profile?.pets)||[]; return all.filter(p=>ids.includes(p.id)).slice(0,3); }
  function lockPuppyUI(force){ const sel=$('#isPuppy'); if(sel){ sel.value = force?'si':'no'; sel.disabled=!!force; } }

  /* Tarifas */
  const PRICES = {
    base: { visitas: 22, paseos: 12, guarderia: 15, alojamiento: 30, bodas: 0, postquirurgico: 0, transporte: 20, exoticos: 0 },
    puppyBase: { guarderia: 20, alojamiento: 35 },
    visita60: 22, visita90: 30, visita60_larga: 18, visita90_larga: 27, visitaMed: 12, visitaMed_larga: 10,
    paseoStd: 12, paseoExtraPerro: 8, paseoBonos: { 10:115, 15:168, 20:220, 25:270, 30:318 },
    alojSegundoPerroDia: 25, alojSegundoPerroD11: 22
  };
  const BUNDLE_GUARDERIA = {
    adult: { 10: 135, 20: 250, 30: 315 },
    puppy: { 10: 185, 20: 350, 30: 465 }
  };
  const EXOTIC_PRICES = { conejo: 25, pajaro: 20, huron: 25, iguana: 20, otro: null };
  const AUX = {
    guarderia: { adulto:12, cachorro:17, bonosAdult:{10:11,20:10,30:9}, bonosPuppy:{10:16,20:14,30:12} },
    alojamiento: { std:{ normal:25, desde11:22 }, puppy:{ normal:30, desde11:27 }, segundo:{ normal:20, desde11:17 } },
    paseo: { base:10, extra_mascota:5, bonos:{10:8,15:7.5,20:7,25:6.5,30:6} },
    visitas: { base60:17, base90:25, d11_60:12, d11_90:21, med15_publicEqualsAux:true, gatosExtra:{ one:10, twoEach:6, moreEach:4 } },
    exoticos:{ aves:15, reptiles:15, mamiferos:20 },
    transporte:{ base:15 }
  };
  const URGENCIA_PLUS = 10, FESTIVO_NORMAL_PLUS = 10, FESTIVO_NORMAL_AUX = 8, BIG_DAY_PLUS = 30, BIG_DAY_AUX = 15;

  function getNumMascotas(){ const count=$$('.pet-check:checked').length; return Math.max(1,count||1); }

  function toggleExoticSpecies(){
    const svc = svcKey(), block=$('#speciesBlock'), species=$('#species');
    if(!block||!species) return;
    if(svc==='visitas'){ block.style.display='block'; species.value='gato'; species.disabled=true; }
    else if(svc==='exoticos'){ block.style.display='block'; species.disabled=false; }
    else { block.style.display='none'; }
  }

  function ensureSummaryNodes(){
    if(!$('#summaryBody')){
      const sec = document.createElement('section'); sec.id='budget-summary'; sec.className='tpl-summary card';
      const h3 = document.createElement('h3'); h3.textContent='Desglose';
      const tbl = document.createElement('table'); tbl.className='summary';
      const thead = document.createElement('thead'); thead.innerHTML='<tr><th>Concepto</th><th>Importe</th></tr>';
      const body = document.createElement('tbody'); body.id='summaryBody';
      body.innerHTML = `
        <tr><th>Base suelto</th><td id="sumBase">0.00</td></tr>
        <tr><th>Visitas (principal)</th><td id="sumVisit1">0.00</td></tr>
        <tr><th>Visitas (medicación)</th><td id="sumVisit2">0.00</td></tr>
        <tr><th>Suplementos/bono</th><td id="sumFestivo">0.00</td></tr>
        <tr><th>Días</th><td id="sumSenalado">0</td></tr>
        <tr><th>Suplementos mascotas</th><td id="sumPets">0.00</td></tr>
        <tr class="total"><th>Subtotal</th><td id="sumSubtotal">0.00</td></tr>
        <tr class="total"><th>A pagar ahora</th><td id="sumDeposit">0.00</td></tr>
        <tr class="total"><th>Pendiente (12 días antes)</th><td id="sumResto">0.00</td></tr>
      `;
      tbl.appendChild(thead); tbl.appendChild(body); sec.appendChild(h3); sec.appendChild(tbl);
      ($('#bookingForm') || document.body).appendChild(sec);
    }
  }

  function getVisitDuration(){ const v=parseInt(($('#visitDuration')?.value ?? '60'), 10); return Number.isFinite(v)?v:60; }
  function getVisitDaily(){ return Math.max(1, parseInt(($('#visitDaily')?.value ?? '1'), 10)); }

  function computeCosts(){
    const svc = svcKey();
    const species = ($('#species')?.value || 'perro');
    const visitDur  = getVisitDuration();
    const visitDaily= getVisitDaily();
    const nMasc = getNumMascotas();

    let nDias = getDays();
    if(!Number.isFinite(nDias) || nDias <= 0){ nDias = (['transporte','bodas','postquirurgico','exoticos','visitas','paseos'].includes(svc)) ? 1 : 0; }
    updateDaysRow(nDias);

    let baseCost=0, visit1Cost=0, visit2Cost=0, supplementPetsCost=0, packCost=0, exoticUnpriced=false, auxTotal=0;

    const sDate = $('#startDate')?.value || todayStr();
    const eDate = $('#endDate')?.value || sDate;
    const mdS=monthDayKey(sDate), mdE=monthDayKey(eDate);

    let plusFestivoCliente=0, plusFestivoAux=0;
    if(BIG_DAYS.includes(mdS) || BIG_DAYS.includes(mdE)){ plusFestivoCliente+=BIG_DAY_PLUS; plusFestivoAux+=BIG_DAY_AUX; }
    else { const fest=false; if(fest){ plusFestivoCliente+=FESTIVO_NORMAL_PLUS; plusFestivoAux+=FESTIVO_NORMAL_AUX; } }

    const plusUrgencia = 0;

    if(svc === 'visitas'){
      const long = nDias>=11;
      const tarifa1 = (visitDur===90) ? (long?PRICES.visita90_larga:PRICES.visita90)
                      : (visitDur===15)?(long?PRICES.visitaMed_larga:PRICES.visitaMed)
                                       :(long?PRICES.visita60_larga:PRICES.visita60);
      visit1Cost = tarifa1 * nDias;
      const aux1  = (visitDur===90) ? (long?AUX.visitas.d11_90:AUX.visitas.base90)
                     : (visitDur===15)?(AUX.visitas.med15_publicEqualsAux ? (long?PRICES.visitaMed_larga:PRICES.visitaMed):0)
                                      :(long?AUX.visitas.d11_60:AUX.visitas.base60);
      auxTotal += aux1 * nDias;

      const extras = Math.max(0, visitDaily-1);
      if(extras>0){ const tMed= long?PRICES.visitaMed_larga:PRICES.visitaMed; visit2Cost = tMed * nDias * extras; auxTotal += tMed * nDias * extras; }

      const totalVis = nDias * Math.max(1, visitDaily);
      if(nMasc>1){
        const extra = nMasc-1; let perC=0, perA=0;
        if(extra===1){ perC=12; perA=AUX.visitas.gatosExtra.one; }
        else if(extra===2){ perC=8; perA=AUX.visitas.gatosExtra.twoEach; }
        else { perC=6; perA=AUX.visitas.gatosExtra.moreEach; }
        supplementPetsCost = perC * extra * totalVis;
        auxTotal           += perA * extra * totalVis;
      }

    } else if(svc === 'paseos'){
      const pp = PRICES.paseoStd; let pack=0;
      if(nDias>=30) pack=30; else if(nDias>=25) pack=25; else if(nDias>=20) pack=20; else if(nDias>=15) pack=15; else if(nDias>=10) pack=10;
      if(pack>0){ const price=PRICES.paseoBonos[pack]; const rem=nDias-pack; packCost=price; baseCost=rem*pp; auxTotal += AUX.paseo.bonos[pack]*pack + AUX.paseo.base*rem; }
      else { baseCost = nDias*pp; auxTotal += AUX.paseo.base*nDias; }
      if(nMasc>1){ supplementPetsCost = (nMasc-1)*nDias*PRICES.paseoExtraPerro; auxTotal += (nMasc-1)*nDias*AUX.paseo.extra_mascota; }

    } else if(svc === 'guarderia'){
      const selectedObjs = selectedPets(currentProfile);
      const anyPup = selectedObjs.some(isPuppyPet);
      const perDay = anyPup?PRICES.puppyBase.guarderia:PRICES.base.guarderia;
      const table  = anyPup?BUNDLE_GUARDERIA.puppy:BUNDLE_GUARDERIA.adult;
      const auxDay = anyPup?AUX.guarderia.cachorro:AUX.guarderia.adulto;
      const auxB   = anyPup?AUX.guarderia.bonosPuppy:AUX.guarderia.bonosAdult;
      let pack=0; if(nDias>=30)pack=30; else if(nDias>=20)pack=20; else if(nDias>=10)pack=10;
      if(pack>0){ const price=table[pack]; const rem=nDias-pack; packCost=price; baseCost=rem*perDay; auxTotal+=auxB[pack]*pack + auxDay*rem; }
      else { baseCost = perDay*nDias; auxTotal += auxDay*nDias; }

    } else if(svc === 'alojamiento'){
      const petsCount=Math.max(1,nMasc);
      for(let i=1;i<=petsCount;i++){
        const isSecond=(i>=2);
        for(let d=1; d<=nDias; d++){
          const d11=(d>=11); let pPub=0,pAux=0;
          if(isSecond){ pPub=d11?PRICES.alojSegundoPerroD11:PRICES.alojSegundoPerroDia; pAux=d11?AUX.alojamiento.segundo.desde11:AUX.alojamiento.segundo.normal; }
          else{
            const anyPup = selectedPets(currentProfile).some(isPuppyPet);
            pPub = d11 ? (anyPup?32:27) : (anyPup?PRICES.puppyBase.alojamiento:PRICES.base.alojamiento);
            pAux = d11 ? (anyPup?AUX.alojamiento.puppy.desde11:AUX.alojamiento.std.desde11)
                       : (anyPup?AUX.alojamiento.puppy.normal:AUX.alojamiento.std.normal);
          }
          baseCost += pPub; auxTotal += pAux;
        }
      }

    } else if(svc === 'exoticos'){
      const type=species||'otro'; const price=EXOTIC_PRICES[type];
      if(price!=null){ const vxd=Math.max(1,getVisitDaily()); baseCost=price*nDias*vxd; const aux=(type==="pajaro")?AUX.exoticos.aves:(type==="iguana")?AUX.exoticos.reptiles:(type==="conejo"||type==="huron")?AUX.exoticos.mamiferos:0; auxTotal+=aux*nDias*vxd; }
      else { exoticUnpriced=true; baseCost=0; }

    } else if(svc==='transporte'){ baseCost=PRICES.base.transporte; auxTotal+=AUX.transporte.base; }
    else { baseCost=PRICES.base[svc]||0; }

    const supCliente = plusUrgencia + plusFestivoCliente;
    const supAux     = plusFestivoAux;

    const subtotal = (!exoticUnpriced) ? (baseCost+visit1Cost+visit2Cost+supplementPetsCost+packCost+supCliente) : 0;
    const payNow   = Math.max(0, subtotal - (auxTotal + supAux));
    const payLater = Math.max(0, subtotal - payNow);

    $('#sumBase')?.textContent    = (!exoticUnpriced ? currency(baseCost) : '—');
    $('#sumVisit1')?.textContent  = currency(visit1Cost);
    $('#sumVisit2')?.textContent  = currency(visit2Cost);
    $('#sumFestivo')?.textContent = currency(packCost + supCliente);
    $('#sumSenalado')?.textContent= (nDias>0)?(nDias===1?'1 día':`${nDias} días`):'0';
    $('#sumPets')?.textContent    = currency(supplementPetsCost);
    $('#sumSubtotal')?.textContent= (!exoticUnpriced) ? currency(subtotal) : '—';
    $('#sumDeposit')?.textContent = (!exoticUnpriced) ? currency(payNow)  : '—';
    $('#sumResto')?.textContent   = (!exoticUnpriced) ? currency(payLater): '—';

    const hidden = $('#summaryField');
    if(hidden){
      const s=[];
      s.push(`Días: ${nDias}`);
      if(!exoticUnpriced){
        if(packCost>0) s.push(`Coste del bono: ${currency(packCost)} €`);
        if(baseCost>0) s.push(`Base suelto: ${currency(baseCost)} €`);
        if(visit1Cost>0) s.push(`Visitas (principal): ${currency(visit1Cost)} €`);
        if(visit2Cost>0) s.push(`Visitas (medicación): ${currency(visit2Cost)} €`);
        if(supplementPetsCost>0) s.push(`Suplementos mascotas: ${currency(supplementPetsCost)} €`);
        if(supCliente>0) s.push(`Suplementos varios: ${currency(supCliente)} €`);
        s.push(`Subtotal: ${currency(subtotal)} €`);
        s.push(`A pagar ahora: ${currency(payNow)} €`);
        s.push(`Pendiente: ${currency(payLater)} €`);
      } else s.push('Precio a consultar');
      hidden.value = s.join(' | ');
    }

    try{ sessionStorage.setItem("tpl.lastCalc", JSON.stringify({svc,nDias,nMasc,baseCost,visit1Cost,visit2Cost,supplementPetsCost,packCost, supCliente, subtotal, auxTotal, supAux, payNow, payLater})); }catch(_){}
  }

  function bindEvents(){
    ['service','species','startDate','endDate','startTime','endTime','visitDuration','visitDaily'].forEach(id=>{
      const el=document.getElementById(id); if(!el) return;
      const h=()=>{ toggleExoticSpecies(); computeCosts(); };
      el.addEventListener('change', h); el.addEventListener('input', h);
    });
    $('#btnBack')?.addEventListener('click', ()=>{ if(document.referrer) history.back(); else window.location.href='/servicios.html'; });
  }

  function getProfile(){ try{ return JSON.parse(localStorage.getItem("tpl.profile")||"null"); }catch(_){ return null; } }
  let currentProfile = null;
  function fillOwnerFromProfile(p){ $('#firstName')&&p?.fullName &&($('#firstName').value=p.fullName);
    $('#lastName')&&($('#lastName').value=''); $('#email')&&p?.email &&($('#email').value=p.email);
    $('#phone')&&p?.phone &&($('#phone').value=p.phone); $('#address')&&p?.address &&($('#address').value=p.address);
    $('#postalCode')&&p?.postalCode&&($('#postalCode').value=p.postalCode); $('#region')&&p?.region&&($('#region').value=p.region); }

  document.addEventListener('DOMContentLoaded', ()=>{
    ensureSummaryNodes(); unifyNameFields(); bindEvents(); toggleExoticSpecies(); computeCosts(); setTimeout(computeCosts,300);
    const form=$('#bookingForm'), wall=$('#authWall');
    function applyAuthUI(logged){ form?.classList.toggle('disabled', !logged); if(wall) wall.style.display= logged? 'none':'block'; }

    function hydrate(){
      const br=window.TPL_AUTH; const logged= br?.isLogged? br.isLogged(): !!getProfile(); applyAuthUI(!!logged);
      const uid= br?.uid? br.uid(): null;
      if(logged && typeof firebase!=='undefined' && firebase.firestore && uid){
        firebase.firestore().collection((window.TPL_COLLECTIONS?.owners)||'propietarios').doc(uid).get()
        .then(doc=>{ const d=doc.exists?doc.data():null; currentProfile=ensurePetsMock(d||getProfile()||{}); fillOwnerFromProfile(currentProfile); renderPets(currentProfile); computeCosts(); })
        .catch(_=>{ currentProfile=ensurePetsMock(getProfile()||{}); fillOwnerFromProfile(currentProfile); renderPets(currentProfile); computeCosts(); });
      } else { currentProfile=ensurePetsMock(getProfile()||{}); fillOwnerFromProfile(currentProfile); renderPets(currentProfile); computeCosts(); }
    }
    hydrate(); window.addEventListener('tpl-auth-ready', hydrate); window.addEventListener('tpl-auth-change', hydrate);

    if(form){
      form.addEventListener('submit', async (ev)=>{
        ev.preventDefault(); ev.stopPropagation();
        const br=window.TPL_AUTH; const logged= br?.isLogged? br.isLogged(): false; if(!logged){ alert('Debes iniciar sesión para reservar.'); return; }
        const uid= br?.uid? br.uid(): null; const mail= br?.email? br.email(): null;

        try{
          if(typeof firebase!=='undefined' && firebase.firestore && uid){
            const db=firebase.firestore(); const col=(window.TPL_COLLECTIONS?.owners)||'propietarios'; const doc=await db.collection(col).doc(uid).get();
            if(!doc.exists){ alert('Completa tu perfil antes de hacer una reserva.'); if(location.pathname.indexOf('perfil')===-1) location.href='perfil.html'; return; }
          }
        }catch(_){}

        computeCosts();
        const fd=new FormData(form); const payload={}; for(const [k,v] of fd.entries()) payload[k]=v;

        let calc=null; try{ calc=JSON.parse(sessionStorage.getItem("tpl.lastCalc")||"null"); }catch(_){}
        const subtotal=calc?.subtotal||0, payNow=calc?.payNow||0, payLater=calc?.payLater||Math.max(0, subtotal-payNow);

        payload._estado='paid_review'; payload._uid=uid||null; payload._email=mail||payload.email||null;
        payload._createdAt = (typeof firebase!=='undefined' && firebase.firestore && firebase.firestore.FieldValue)
          ? firebase.firestore.FieldValue.serverTimestamp() : new Date().toISOString();
        payload.total_cliente=Number(subtotal.toFixed(2)); payload.pagar_ahora=Number(payNow.toFixed(2)); payload.pendiente=Number(payLater.toFixed(2));

        let saved=false, docId=null;
        try{
          if(typeof firebase!=='undefined' && firebase.firestore){
            const ref=await firebase.firestore().collection('reservas').add(payload);
            saved=true; docId=ref.id;
          }
        }catch(err){ console.warn('No se pudo guardar en Firestore', err); }

        try{
          const key="tpl.reservas"; const r={ id: docId||("resv_"+Date.now()), status: payload._estado, createdAt:new Date().toISOString(),
            service: payload.service || svcKey(), dates:{start:payload.startDate||todayStr(), end:payload.endDate||payload.startDate||todayStr()},
            owner:{name:(payload.firstName||'').trim(), email:(payload.email||mail||''), phone:(payload.phone||'')},
            petsCount:getNumMascotas(), pricing:{ total:subtotal, payNow, payLater } };
          let arr=[]; try{ arr=JSON.parse(localStorage.getItem(key)||"[]"); }catch(_){}
          arr.unshift(r); localStorage.setItem(key, JSON.stringify(arr));
        }catch(_){}

        let mailed=false;
        try{
          if(window.emailjs){
            const cfg=window.TPL_EMAILJS||{}; const service=cfg.serviceId||'service_odjqrfl'; const pub=cfg.publicKey||'L2xAATfVuHJwj4EIV';
            const tplC=(cfg.templates&&cfg.templates.cliente)||'template_rao5n0c'; const tplG=(cfg.templates&&cfg.templates.gestion)||'template_rao5n0c';
            const params=Object.assign({}, payload, { reserva_id:docId, total_txt:fmtEUR(subtotal), pay_now_txt:fmtEUR(payNow), pay_later_txt:fmtEUR(payLater), admin_email: cfg.adminEmail||'gestion@thepetslovers.es' });
            const r1=await emailjs.send(service, tplC, params, pub); const r2=await emailjs.send(service, tplG, params, pub);
            if((r1 && r1.status>=200 && r1.status<300) || (r2 && r2.status>=200 && r2.status<300)) mailed=true;
          }
        }catch(err){ console.warn('EmailJS error', err); }

        if(saved || mailed){
          alert('Tu reserva se ha registrado. Está en revisión.');
          const redirect=form.dataset.tplRedirect||form.getAttribute('data-tpl-redirect'); const wait=parseInt(form.dataset.tplWait||form.getAttribute('data-tpl-wait')||'800',10);
          if(redirect){ setTimeout(()=>{ location.href=redirect; }, wait); } else { form.reset(); computeCosts(); }
        }else{
          alert('No se pudo enviar la reserva. Inténtalo de nuevo.');
        }
      });
    }
  });

  // Parche “si algo falla, no bloquees el form” (puedes quitarlo cuando todo te funcione)
  document.addEventListener('DOMContentLoaded', function(){
    setTimeout(function(){
      var form=document.getElementById('bookingForm'), wall=document.getElementById('authWall');
      if(form) form.classList.remove('disabled');
      if(wall) wall.style.display='none';
    }, 1000);
  });

})();
</script>

</body>
</html>
