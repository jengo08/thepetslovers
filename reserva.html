<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Reserva · The Pets Lovers</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Poppins:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <style>
    .booking-wrapper{ max-width: 980px; margin: 120px auto 60px; padding: 20px; background: #fff; border:1px solid #eee; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,.05);}
    .booking-header{ text-align:center; margin-bottom: 18px; }
    .booking-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:16px; }
    .booking-field{ display:flex; flex-direction:column; gap:6px; }
    .booking-field label{ font-weight:700; font-size:.95rem; color: var(--color-texto); }
    .booking-field input, .booking-field select, .booking-field textarea{
      padding:10px 12px; border:1px solid #ddd; border-radius:8px; font-family:var(--fuente-texto);
    }
    .booking-actions{ display:flex; gap:12px; justify-content:center; margin-top: 16px; flex-wrap: wrap; }
    .note{ font-size:.95rem; color:#666; text-align:center; margin: 10px 0 0; }
    .auth-wall{ padding:14px; border:1px dashed #bbb; border-radius:10px; text-align:center; background:#fafafa; margin-bottom:16px; }
    .auth-wall strong{ color: var(--color-texto); }
    .disabled{ opacity:.6; pointer-events:none; }

    /* Ocultación por defecto + modo visitas */
    .booking-field[hidden]{ display:none !important; }
    .tpl-visitas-only{ display:none !important; }
    .tpl-visitas-on .tpl-visitas-only{ display:block !important; }

    /* Desglose */
    .summary-panel{ margin-top: 16px; background:#fafafa; border:1px solid #eee; border-radius:10px; padding:16px; }
    .summary-grid{ display:grid; grid-template-columns: 1fr auto; gap:8px; align-items:center; }
    .summary-row{ display:contents; }
    .summary-label{ color:#555; }
    .summary-value{ font-weight:700; color: var(--color-texto); text-align:right; }
    .summary-muted{ color:#999; font-weight:400; }
    .summary-total{ border-top:1px solid #e7e7e7; margin-top:8px; padding-top:8px; font-size:1.05rem; }

    /* Autocompletar dirección */
    .tpl-addr-wrap{ position: relative; }
    .tpl-addr-suggest{ position:absolute; inset:auto 0 0 0; transform: translateY(calc(100% + 6px));
      background:#fff; border:1px solid #ddd; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,.08); z-index: 999;
      max-height: 240px; overflow:auto; display:none; }
    .tpl-addr-item{ padding:10px 12px; cursor:pointer; }
    .tpl-addr-item:hover, .tpl-addr-item:focus{ background:#f5f7f8; outline:none; }

    /* Acciones: submit centrado + ayuda derecha */
    .tpl-actions{
      display:grid; grid-template-columns: 1fr auto 1fr;
      align-items:center; gap:12px; width:100%;
    }
    .tpl-actions .tpl-spacer{ display:block; }
    .tpl-actions .tpl-help{ font-size:.9rem; padding:8px 10px; border:2px solid var(--color-principal); color:var(--color-principal); background:#fff; border-radius:8px; justify-self:end; }

    /* Burbuja desplazamiento */
    .travel-bubble{ display:none; margin-top:6px; padding:10px 12px; border:1px dashed #bbb; border-radius:10px; background:#f9f9f9; color:#666; text-align:left;}

    /* Secciones */
    .tpl-section{ margin-top: 18px; }
    .tpl-section h2{ margin: 6px 0 8px; font-size:1.15rem; }

    /* Login inline */
    .tpl-login-card{border:1px solid #eee;border-radius:12px;padding:16px;background:#fff;max-width:520px;margin:14px auto 0;box-shadow:0 2px 12px rgba(0,0,0,.05)}
    .tpl-login-title{margin:0 0 8px;color:#58425a;font-weight:700;font-size:1.05rem;text-align:center}
    .tpl-socials{display:grid;gap:10px;margin-bottom:8px}
    .tpl-btn-social{display:flex;align-items:center;justify-content:center;gap:8px;border:1px solid #ddd;border-radius:999px;padding:10px 14px;background:#fff;cursor:pointer;font-weight:600;color:var(--color-principal)}
    .tpl-btn-social i{font-size:1rem}
    .tpl-sep{position:relative;text-align:center;margin:6px 0 8px;color:#999;font-size:.9rem}
    .tpl-sep span{background:#fff;padding:0 8px;position:relative;z-index:1}
    .tpl-sep::before{content:"";position:absolute;left:0;right:0;top:50%;height:1px;background:#eee}
    .tpl-login-form{display:grid;gap:8px}
    .tpl-login-form label{font-size:.9rem;color:#58425a}
    .tpl-login-form input{border:1px solid #ddd;border-radius:10px;padding:10px 12px;font-size:1rem}
    .tpl-btn{background:#339496;color:#fff;border:none;border-radius:999px;padding:10px 14px;cursor:pointer;font-weight:600}
    .tpl-btn-outline{background:#fff;color:#339496;border:1px solid #339496;border-radius:999px;padding:10px 14px;cursor:pointer;font-weight:600}
    .tpl-link{background:none;border:none;color:#339496;text-decoration:underline;cursor:pointer;padding:6px 0;justify-self:center}
    .tpl-login-msg{min-height:1.2em;text-align:center;color:#58425a;margin-top:4px}

    /* Overlay éxito / modal */
    .tpl-overlay{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:9999; }
    .tpl-overlay.on{ display:flex; }
    .tpl-modal{ background:#fff; padding:20px; border-radius:12px; max-width:520px; box-shadow:0 8px 30px rgba(0,0,0,.2); text-align:center; }
    .tpl-modal p{ margin:0 0 12px; }

    <!-- TPL: INICIO BLOQUE NUEVO [Estilos selector de mascotas] -->
    .tpl-petpicker-overlay{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:9999; }
    .tpl-petpicker-overlay.on{ display:flex; }
    .tpl-petpicker{ background:#fff; padding:16px; border-radius:12px; max-width:560px; width:92%; box-shadow:0 8px 30px rgba(0,0,0,.18); }
    .tpl-petpicker h3{ margin:0 0 8px; color:#58425a; font-size:1.05rem; }
    .tpl-petpicker-list{ max-height:260px; overflow:auto; border:1px solid #eee; border-radius:10px; padding:8px; }
    .tpl-pet-item{ display:flex; align-items:center; gap:10px; padding:8px 6px; border-bottom:1px dashed #eee; }
    .tpl-pet-item:last-child{ border-bottom:none; }
    .tpl-pet-name{ font-weight:700; color:#58425a; }
    .tpl-pet-meta{ color:#666; font-size:.9rem; }
    .tpl-petpicker-actions{ display:flex; justify-content:flex-end; gap:10px; margin-top:10px; }
    <!-- TPL: FIN BLOQUE NUEVO -->
  </style>
</head>
  <!-- TPL: INICIO BLOQUE NUEVO [Diagnóstico en vivo RESERVAS] -->
<script>
(function(){
  if (window.__TPL_DIAG_RESERVAS__) return; window.__TPL_DIAG_RESERVAS__ = true;

  const css = `
  #tpl-rdiag-toggle{position:fixed;right:12px;bottom:12px;z-index:99999;background:#339496;color:#fff;border:none;border-radius:999px;padding:10px 14px;font-weight:700;box-shadow:0 4px 16px rgba(0,0,0,.2);cursor:pointer}
  #tpl-rdiag{position:fixed;right:12px;bottom:60px;z-index:99999;background:#fff;border:1px solid #e7e7e7;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.25);width:min(420px,calc(100vw - 24px));max-height:60vh;display:none;overflow:auto}
  #tpl-rdiag.on{display:block}
  #tpl-rdiag .hd{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid #eee}
  #tpl-rdiag .hd strong{color:#58425a}
  #tpl-rdiag .bd{padding:10px 12px;display:grid;gap:10px}
  .tpl-kv{display:grid;grid-template-columns:auto 1fr;gap:6px 10px;font-size:.95rem}
  .tpl-kv b{color:#666}
  .tpl-ok{color:#1b8c59;font-weight:700}
  .tpl-bad{color:#b00020;font-weight:700}
  .tpl-actions{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .tpl-actions button{border:1px solid #ddd;border-radius:10px;padding:8px 10px;background:#fff;cursor:pointer}
  .tpl-log{font-family:ui-monospace,Consolas,monospace;background:#fafafa;border:1px solid #eee;border-radius:10px;padding:8px;max-height:160px;overflow:auto;font-size:.85rem}
  `;
  const st = document.createElement('style'); st.textContent = css; document.head.appendChild(st);

  const toggle = document.createElement('button');
  toggle.id = 'tpl-rdiag-toggle';
  toggle.type = 'button';
  toggle.textContent = 'Diagnóstico reservas';
  document.body.appendChild(toggle);

  const panel = document.createElement('div');
  panel.id = 'tpl-rdiag';
  panel.innerHTML = `
    <div class="hd"><strong>Diagnóstico · Reservas</strong><button type="button" id="tpl-rdiag-close">✕</button></div>
    <div class="bd">
      <div class="tpl-kv">
        <b>Firebase cargado:</b><span id="r-fb">—</span>
        <b>App inicializada:</b><span id="r-app">—</span>
        <b>Auth disponible:</b><span id="r-auth">—</span>
        <b>Usuario logueado:</b><span id="r-user">—</span>
        <b>Firestore disponible:</b><span id="r-fs">—</span>
        <b>EmailJS cargado:</b><span id="r-ejs">—</span>
        <b>Cfg EmailJS (service/template/key):</b><span id="r-ejscfg">—</span>
      </div>
      <div class="tpl-actions">
        <button id="r-test-fs">Probar Firestore</button>
        <button id="r-test-ejs">Probar EmailJS</button>
        <button id="r-test-google">Probar Login Google</button>
        <button id="r-signout">Cerrar sesión</button>
      </div>
      <div class="tpl-log" id="r-log"></div>
      <p style="margin:0;color:#666;font-size:.85rem">⚠️ Si algo sale en rojo, suele ser: <u>dominio no autorizado</u> (Firebase Auth o EmailJS) o <u>falta configurar service/template/publicKey</u>.</p>
    </div>`;
  document.body.appendChild(panel);

  const $ = (id)=> document.getElementById(id);
  const logBox = $('r-log');
  function log(msg){ const t = `[${new Date().toLocaleTimeString()}] ${msg}\n`; logBox.textContent = t + logBox.textContent; }
  function mark(id, ok, extra){
    const el = $(id);
    if (!el) return;
    if (ok === true) el.innerHTML = '<span class="tpl-ok">OK</span>' + (extra?` — ${extra}`:'');
    else if (ok === false) el.innerHTML = '<span class="tpl-bad">ERROR</span>' + (extra?` — ${extra}`:'');
    else el.textContent = extra || '—';
  }

  toggle.onclick = ()=> panel.classList.toggle('on');
  $('tpl-rdiag-close').onclick = ()=> panel.classList.remove('on');

  function baseChecks(){
    const fb = typeof firebase !== 'undefined';
    mark('r-fb', fb);
    mark('r-app', fb ? (firebase.apps.length>0) : false, fb?`apps=${firebase.apps.length}`:'firebase undef');
    mark('r-auth', fb ? !!firebase.auth : false);
    mark('r-fs',   fb ? !!firebase.firestore : false);
    const ejs = !!window.emailjs;
    mark('r-ejs', ejs);
    const cfg = window.TPL_EMAILJS || {};
    const hasCfg = !!(cfg.serviceId || cfg.service) && !!(cfg.templateId || (cfg.templates && (cfg.templates.reserva || cfg.templates.booking)) || cfg.template) && !!(cfg.publicKey || cfg.userId);
    mark('r-ejscfg', ejs ? hasCfg : false, ejs ? (hasCfg ? 'config detectada' : 'falta service/template/publicKey') : 'SDK no cargado');
    if (!fb) log('Firebase no cargado en esta página.');
    if (fb && firebase.apps.length===0) log('Firebase cargado pero no inicializado (falta initializeApp).');
    if (!ejs) log('EmailJS no cargado (revisa el script CDN).');
    if (ejs && !hasCfg) log('EmailJS sin configuración (añade serviceId, templateId y publicKey en window.TPL_EMAILJS).');
  }
  async function checkUser(){
    try{
      if (!firebase || !firebase.auth){ mark('r-user', false, 'auth no disponible'); return; }
      const u = firebase.auth().currentUser;
      if (u){ mark('r-user', true, u.email || u.uid); }
      else { mark('r-user', false, 'no logueado'); }
    }catch(e){ mark('r-user', false, e.code||e.message||'error'); }
  }

  $('r-test-fs').onclick = async ()=>{
    try{
      if (!firebase || !firebase.firestore) throw new Error('firestore-no-disponible');
      const db = firebase.firestore();
      const ref = await db.collection('tpl_tests').add({ kind:'reserva', at:new Date().toISOString(), page:location.href });
      log('Firestore OK. Doc id: '+(ref && ref.id));
    }catch(e){
      log('Firestore ERROR: '+(e.message||e.code||e));
      if (String(e).includes('Missing or insufficient permissions') || String(e).includes('permission-denied')) log('⚠️ Reglas Firestore bloquean escritura. Revisa reglas para colecciones "reservas" y "tpl_tests".');
    }
  };

  $('r-test-ejs').onclick = async ()=>{
    try{
      const cfg = window.TPL_EMAILJS || {};
      const SERVICE = cfg.serviceId || cfg.service;
      const TEMPLATE = cfg.templateId || (cfg.templates && (cfg.templates.reserva || cfg.templates.booking)) || cfg.template;
      const USER = cfg.publicKey || cfg.userId;
      if (!window.emailjs) throw new Error('EmailJS SDK no cargado');
      if (!SERVICE || !TEMPLATE || !USER) throw new Error('Falta serviceId/templateId/publicKey en window.TPL_EMAILJS');
      await emailjs.send(SERVICE, TEMPLATE, {
        _tipo:'test-reserva', _page:location.href, to_email:(cfg.admin||cfg.adminEmail||'gestion@thepetslovers.es'), subject:'TEST EmailJS RESERVAS', message:'Prueba desde diagnóstico'
      }, USER);
      log('EmailJS OK (test enviado).');
    }catch(e){
      log('EmailJS ERROR: '+(e.text||e.message||e));
      if (String(e).toLowerCase().includes('origin')) log('⚠️ Añade tu dominio en EmailJS → Account → Domains (https://www.thepetslovers.es y https://thepetslovers.es).');
    }
  };

  $('r-test-google').onclick = async ()=>{
    try{
      if (!firebase || !firebase.auth) throw new Error('auth-no-disponible');
      const auth = firebase.auth();
      const provider = new firebase.auth.GoogleAuthProvider();
      await auth.signInWithPopup(provider);
      log('Login Google: disparado (si falla, mira consola).');
    }catch(e){
      log('Google Login ERROR: '+(e.code||e.message||e));
      if (String(e.code).includes('auth/unauthorized-domain')) log('⚠️ Añade tu dominio en Firebase Auth → Dominios autorizados.');
      if (String(e.code).includes('auth/popup')) log('ℹ️ Popup bloqueado/cerrado: prueba con redirect.');
    } finally { checkUser(); }
  };

  $('r-signout').onclick = async ()=>{
    try{ if (firebase && firebase.auth) await firebase.auth().signOut(); log('Sesión cerrada.'); }
    catch(e){ log('SignOut ERROR: '+(e.message||e)); }
    checkUser();
  };

  baseChecks(); checkUser();
})();
</script>
<!-- TPL: FIN BLOQUE NUEVO -->
  <!-- TPL: INICIO BLOQUE NUEVO [RESERVAS: handler v3 opcional] -->
<script>
(function(){
  if (window.__TPL_RESERVAS_V3__) return; window.__TPL_RESERVAS_V3__ = true;

  function form(){ 
    return document.querySelector('form#bookingForm[data-tpl-type="reserva"], form#bookingForm[data-tpl-handler="v3"], form[data-tpl-handler="v3"]') 
           || null; 
  }
  function msgBox(f){
    let box = f.querySelector('#tpl-booking-msg');
    if (!box){ box = document.createElement('div'); box.id='tpl-booking-msg'; box.style.cssText='margin-top:10px;color:#58425a;font-weight:600'; f.appendChild(box); }
    return box;
  }
  function say(f, text, type){ const b = msgBox(f); b.textContent = text; b.style.color = (type==='ok')?'#1b8c59':(type==='error'?'#b00020':'#58425a'); }
  function t(el){ return (el && el.textContent || '').replace('—','0').trim(); }
  function v(el){ return (el && el.value || '').trim(); }
  function optTxt(sel){ return (sel && sel.selectedOptions && sel.selectedOptions[0] && sel.selectedOptions[0].text) || (sel && sel.value) || ''; }

  async function saveFirestore(payload){
    try{
      if (!firebase || !firebase.firestore) return false;
      const db = firebase.firestore();
      if (firebase.firestore.FieldValue) payload._createdAt = firebase.firestore.FieldValue.serverTimestamp();
      const auth = firebase.auth ? firebase.auth() : null;
      const u = auth && auth.currentUser ? auth.currentUser : null;
      if (u){ payload._uid = u.uid; payload._email = u.email || null; }
      const ref = await db.collection('reservas').add(payload);
      return !!ref && !!ref.id;
    }catch(e){ console.warn('Firestore reservas error:', e); return false; }
  }

  async function sendEmailJS(payload){
    const cfg = window.TPL_EMAILJS || {};
    if (!window.emailjs) throw new Error('EmailJS SDK no cargado');
    const SERVICE  = cfg.serviceId || cfg.service;
    const TEMPLATE = cfg.templateId || (cfg.templates && (cfg.templates.reserva || cfg.templates.booking)) || cfg.template;
    const USER     = cfg.publicKey || cfg.userId;
    if (!SERVICE || !TEMPLATE || !USER) throw new Error('Falta serviceId/templateId/publicKey en window.TPL_EMAILJS');

    const adminTo = cfg.admin || cfg.adminEmail || 'gestion@thepetslovers.es';
    const payloadAdmin = { ...payload, to_email: payload.to_email || adminTo };
    await emailjs.send(SERVICE, TEMPLATE, payloadAdmin, USER);

    if ((payload.owner_email||'').includes('@')){
      const copy = { ...payload, to_email: payload.owner_email, reply_to: payload.owner_email };
      await emailjs.send(SERVICE, TEMPLATE, copy, USER);
    }
    return true;
  }

  function ensureOverlay(msg, href){
    var wrap = document.getElementById('tpl-overlay');
    if(!wrap){
      wrap = document.createElement('div');
      wrap.id='tpl-overlay';
      wrap.className='tpl-overlay on';
      wrap.innerHTML = '<div class="tpl-modal" role="dialog" aria-live="polite"><p></p><button type="button" class="cta-button" id="tpl-ov-accept">Aceptar</button></div>';
      document.body.appendChild(wrap);
    }
    wrap.querySelector('p').textContent = msg || 'Tu reserva se ha enviado correctamente.';
    wrap.classList.add('on');
    wrap.querySelector('#tpl-ov-accept').onclick = ()=>{ location.href = href || 'perfil.html'; };
  }

  function attach(){
    const f = form();
    if (!f) return;

    // 🔒 Solo activamos si el formulario lleva data-tpl-handler="v3" (tu confirmación explícita)
    const enabled = f.hasAttribute('data-tpl-handler') && f.getAttribute('data-tpl-handler') === 'v3';
    if (!enabled) return;

    // Nos adelantamos a otros listeners, pero no tocamos tu diseño
    f.addEventListener('submit', async function(ev){
      ev.preventDefault(); ev.stopImmediatePropagation();

      // Validación mínima
      const required = ['service','startDate','endDate','start','end','region','firstName','lastName'];
      for (const id of required){
        const el = document.getElementById(id);
        if (el && !el.value){ el.focus(); say(f, 'Falta: ' + (el.previousElementSibling?.innerText || id), 'error'); return; }
      }

      const btn = f.querySelector('button[type="submit"]'); const oldText = btn && btn.textContent;
      if (btn){ btn.disabled = true; btn.textContent = 'Enviando…'; }
      say(f, 'Enviando…', 'info');

      // Construimos payload desde tu DOM actual
      const payload = {
        _tipo: 'reserva',
        _estado: 'enviada',
        _page: location.href,

        servicio:          optTxt(document.getElementById('service')),
        servicio_val:      v(document.getElementById('service')),
        fecha_inicio:      v(document.getElementById('startDate')),
        fecha_fin:         v(document.getElementById('endDate')),
        hora_inicio:       v(document.getElementById('start')),
        hora_fin:          v(document.getElementById('end')),

        tipo_animal:       v(document.getElementById('species')),
        cachorro:          (document.getElementById('isPuppy')?.value || 'no'),

        n_mascotas:        (document.getElementById('numPets')?.value || '1'),
        n_mascotas_exactas:(document.getElementById('numPetsExact')?.value || ''),
        mascotas:          (document.getElementById('petsListHidden')?.value || '').trim(),

        owner_nombre_only: v(document.getElementById('firstName')),
        owner_apellidos:   v(document.getElementById('lastName')),
        owner_nombre:      `${v(document.getElementById('firstName'))} ${v(document.getElementById('lastName'))}`.trim(),
        owner_email:       v(document.getElementById('email')),
        owner_telefono:    v(document.getElementById('phone')),
        owner_direccion:   v(document.getElementById('location')),
        owner_cp:          v(document.getElementById('postalCode')),
        owner_ccaa:        optTxt(document.getElementById('region')),

        preferencia_contacto: (new FormData(f).get('Preferencia_contacto') || 'cualquiera'),
        hora_preferida_contacto: v(document.getElementById('contactTime')),

        visitas_duracion:  v(document.getElementById('visitDuration')),
        visitas_diarias:   v(document.getElementById('visitDaily')),
        desplazamiento:    v(document.getElementById('needTravel')),
        notas:             v(document.getElementById('notes')),

        sum_base:      t(document.getElementById('sumBase')),
        sum_visit1:    t(document.getElementById('sumVisit1')),
        sum_visit2:    t(document.getElementById('sumVisit2')),
        sum_pets:      t(document.getElementById('sumPets')),
        sum_festivo:   t(document.getElementById('sumFestivo')),
        sum_senalado:  t(document.getElementById('sumSenalado')),
        sum_bono:      t(document.getElementById('sumBono')),
        subtotal:      t(document.getElementById('sumSubtotal')),
        deposito:      t(document.getElementById('sumDeposit')),
        resumen:       v(document.getElementById('summaryField')),

        reserva_id:    `R-${Date.now().toString(36)}-${Math.floor(Math.random()*1e4).toString().padStart(4,'0')}`
      };

      // Guardado Firestore (best-effort)
      let fsOK = false;
      try{ fsOK = await saveFirestore({...payload,
        Servicio: payload.servicio, Fecha_inicio: payload.fecha_inicio, Fecha_fin: payload.fecha_fin,
        Hora_inicio: payload.hora_inicio, Hora_fin: payload.hora_fin, Mascotas_lista: payload.mascotas
      }); }catch(_){}

      // EmailJS
      let mailOK = false, mailErr=null;
      try{ mailOK = await sendEmailJS(payload); }catch(e){ mailErr = e; }

      // Mensaje final
      if (!mailOK){
        say(f, 'No se pudo enviar el email de reserva. Abre “Diagnóstico reservas” y pulsa “Probar EmailJS”.', 'error');
        console.warn('EmailJS reservas error:', mailErr);
      } else {
        say(f, '¡Reserva enviada! Te hemos mandado una copia por email.', 'ok');
      }

      // Overlay + redirección
      ensureOverlay(f.dataset.tplSuccess || 'Tu reserva se ha enviado correctamente.', f.dataset.tplRedirect || 'perfil.html');

      // Snapshot local para tu panel
      try{
        const uid = localStorage.getItem('tpl.currentUser') || localStorage.getItem('tpl_auth_uid') || 'default';
        localStorage.setItem(`tpl.udb.${uid}.lastReservation`, JSON.stringify({
          Servicio: payload.servicio, Fecha_inicio: payload.fecha_inicio, Fecha_fin: payload.fecha_fin, _estado:'enviada', Mascotas_lista: payload.mascotas
        }));
      }catch(_){}

      if (btn){ btn.disabled = false; btn.textContent = oldText; }
    }, true); // capture=true
  }

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', attach);
  else attach();
})();
</script>
<!-- TPL: FIN BLOQUE NUEVO -->
<body>

  <!-- Navbar (inyectada) -->
  <div id="tpl-navbar">
    <noscript>
      <nav class="navbar">
        <div class="logo">
          <a href="index.html"><img src="images/logo.png.png" alt="The Pets Lovers"></a>
        </div>
        <a href="index.html" class="home-button">Inicio</a>
        <ul class="nav-links">
          <li><a href="como-funciona.html">Cómo funciona</a></li>
          <li><a href="servicios.html">Servicios</a></li>
          <li><a href="index.html#contactanos">Contáctanos</a></li>
          <li><a href="index.html#hazte-cuidador">Conviértete en cuidador</a></li>
        </ul>
        <a class="login-button" href="#iniciar-sesion">Iniciar sesión</a>
      </nav>
    </noscript>
  </div>

  <div class="booking-wrapper">
    <div class="booking-header">
      <h1>Reserva tu servicio</h1>
      <p>Selecciona el servicio y la fecha. Para completar la reserva es necesario iniciar sesión y tener los datos de tu mascota guardados.</p>
    </div>

    <!-- Muro de autenticación -->
    <div id="authWall" class="auth-wall">
      <p><strong>Para reservar debes estar registrada o iniciar sesión.</strong></p>
      <p class="note">Cuando accedas, el formulario se activará automáticamente.</p>
      <div id="tpl-inline-login"></div>
    </div>

    <!-- Formulario de reserva -->
    <form
      id="bookingForm"
      class="disabled"
      novalidate
      data-tpl-type="reserva"
      data-tpl-success="Tu reserva se ha enviado. Podrás ver su estado (enviada, en revisión o aceptada) en tu panel."
      data-tpl-redirect="perfil.html"
      data-tpl-wait="800"
    >
      <!-- =================== DATOS DEL SERVICIO =================== -->
      <section class="tpl-section" aria-labelledby="sec-servicio">
        <h2 id="sec-servicio">Datos del servicio</h2>
        <div class="booking-grid">
          <div class="booking-field">
            <label for="service">Servicio</label>
            <select id="service" name="Servicio" required>
              <option value="">Elige un servicio…</option>
              <option value="visitas">Visitas a domicilio (gatos)</option>
              <option value="paseos">Paseos</option>
              <option value="guarderia">Guardería de día</option>
              <option value="alojamiento">Alojamiento (por día)</option>
              <option value="bodas">Bodas y servicios exclusivos</option>
              <option value="postquirurgico">Postquirúrgico</option>
              <option value="transporte">Transporte</option>
              <option value="exoticos">Exóticos</option>
            </select>
          </div>

          <div class="booking-field">
            <label for="startDate">Fecha de inicio</label>
            <input type="date" id="startDate" name="Fecha_inicio" required>
          </div>
          <div class="booking-field">
            <label for="endDate">Fecha de fin</label>
            <input type="date" id="endDate" name="Fecha_fin" required>
          </div>

          <div class="booking-field">
            <label for="start">Hora de inicio</label>
            <input type="time" id="start" name="Hora_inicio" required>
          </div>
          <div class="booking-field">
            <label for="end">Hora de fin</label>
            <input type="time" id="end" name="Hora_fin" required>
          </div>

          <div class="booking-field" id="fieldNumPets">
            <label for="numPets">Nº de mascotas</label>
            <select id="numPets" name="N_mascotas">
              <option value="1">1</option><option value="2">2</option>
              <option value="3">3</option><option value="4">4</option>
              <option value="5">5</option><option value="6+">6+</option>
            </select>
            <input type="number" id="numPetsExact" name="N_mascotas_exactas" min="6" step="1" placeholder="Indica cuántas" style="display:none;margin-top:6px;">
          </div>

          <div class="booking-field" id="fieldSpecies">
            <label for="species">Tipo de animal</label>
            <select id="species" name="Tipo_animal">
              <option value="perro">Perro</option>
              <option value="gato">Gato</option>
              <option value="otros">Otros</option>
            </select>
          </div>

          <!-- SOLO para visitas (gatos) -->
          <div class="booking-field tpl-visitas-only" id="fieldVisitDuration" hidden>
            <label for="visitDuration">Duración de la visita (gatos)</label>
            <select id="visitDuration" name="Visita_duracion">
              <option value="60">60 minutos</option>
              <option value="90">90 minutos</option>
            </select>
          </div>
          <div class="booking-field tpl-visitas-only" id="fieldVisitDaily" hidden>
            <label for="visitDaily">Visitas diarias</label>
            <select id="visitDaily" name="Visitas_diarias">
              <option value="1">1 visita/día</option>
              <option value="2">2 visitas/día (2ª es medicación)</option>
            </select>
          </div>

          <div class="booking-field" id="fieldIsPuppy">
            <label for="isPuppy">¿Es cachorro (≤ 6 meses)?</label>
            <select id="isPuppy" name="Cachorro" disabled title="Se calcula automáticamente según la edad de tu mascota">
              <option value="no" selected>No</option>
              <option value="si">Sí</option>
            </select>
          </div>
        </div>
      </section>

      <!-- =================== MASCOTAS (NOMBRES) =================== -->
      <section class="tpl-section" aria-labelledby="sec-mascotas">
        <h2 id="sec-mascotas">Mascotas</h2>
        <div class="booking-grid" id="petsContainer"></div>
        <datalist id="tplPetNamesList"></datalist>

        <div class="booking-actions" style="justify-content:flex-start;margin-top:6px">
          <button type="button" class="tpl-btn-outline" id="tpl-open-petpicker">
            <i class="fa-solid fa-list-check"></i> Elegir de mis mascotas
          </button>
        </div>
      </section>

      <!-- =================== DATOS DE LA PERSONA =================== -->
      <section class="tpl-section" aria-labelledby="sec-titular">
        <h2 id="sec-titular">Datos de la persona titular</h2>
        <div class="booking-grid">
          <div class="booking-field">
            <label for="firstName">Nombre</label>
            <input type="text" id="firstName" name="Nombre" placeholder="Tu nombre" autocomplete="given-name" required>
          </div>
          <div class="booking-field">
            <label for="lastName">Apellidos</label>
            <input type="text" id="lastName" name="Apellidos" placeholder="Tus apellidos" autocomplete="family-name" required>
          </div>

          <div class="booking-field" style="grid-column: 1 / -1;">
            <label for="location">Dirección</label>
            <div class="tpl-addr-wrap">
              <input type="text" id="location" name="Direccion" placeholder="Calle y número, piso…" autocomplete="street-address" required>
              <div id="tplAddrSuggest" class="tpl-addr-suggest" role="listbox" aria-label="Sugerencias de direcciones"></div>
            </div>
          </div>

          <div class="booking-field">
            <label for="region">Comunidad Autónoma</label>
            <select id="region" name="CCAA" required>
              <option value="" disabled hidden>Selecciona tu CCAA…</option>
              <option value="madrid" selected>Comunidad de Madrid</option>
              <option value="andalucia">Andalucía</option>
              <option value="aragon">Aragón</option>
              <option value="asturias">Asturias</option>
              <option value="baleares">Illes Balears</option>
              <option value="canarias">Canarias</option>
              <option value="cantabria">Cantabria</option>
              <option value="castilla-la-mancha">Castilla-La Mancha</option>
              <option value="castilla-y-leon">Castilla y León</option>
              <option value="cataluna">Cataluña</option>
              <option value="valenciana">Comunitat Valenciana</option>
              <option value="extremadura">Extremadura</option>
              <option value="galicia">Galicia</option>
              <option value="la-rioja">La Rioja</option>
              <option value="melilla">Melilla</option>
              <option value="murcia">Región de Murcia</option>
              <option value="navarra">Navarra</option>
              <option value="euskadi">País Vasco</option>
              <option value="ceuta">Ceuta</option>
              <option value="nacional">Solo festivos nacionales</option>
            </select>
          </div>
          <div class="booking-field">
            <label for="postalCode">Código Postal</label>
            <input type="text" id="postalCode" name="CP" placeholder="Ej. 28001" inputmode="numeric" pattern="[0-9]{5}" autocomplete="postal-code" required>
          </div>

          <div class="booking-field">
            <label for="email">Email</label>
            <input type="email" id="email" name="Email" placeholder="Tu correo electrónico" autocomplete="email">
          </div>
          <div class="booking-field">
            <label for="phone">Teléfono</label>
            <input type="tel" id="phone" name="Telefono" placeholder="Tu número de teléfono" autocomplete="tel">
          </div>

          <div class="booking-field" style="grid-column: 1 / -1;">
            <label>¿Por dónde prefieres que contactemos?</label>
            <div>
              <label><input type="radio" name="Preferencia_contacto" value="telefono"> Teléfono</label>
              <label style="margin-left:12px;"><input type="radio" name="Preferencia_contacto" value="whatsapp"> WhatsApp</label>
              <label style="margin-left:12px;"><input type="radio" name="Preferencia_contacto" value="email"> Email</label>
              <label style="margin-left:12px;"><input type="radio" name="Preferencia_contacto" value="cualquiera" checked> Cualquiera</label>
            </div>
          </div>

          <div class="booking-field">
            <label for="contactTime">¿A qué hora prefieres que te contactemos?</label>
            <input type="time" id="contactTime" name="Hora_preferida_contacto">
          </div>

          <!-- Desplazamiento -->
          <div class="booking-field" style="grid-column: 1 / -1;">
            <label for="needTravel">¿Necesitas desplazamiento?</label>
            <select id="needTravel" name="Desplazamiento">
              <option value="no">No</option>
              <option value="si">Sí</option>
            </select>
            <div id="travelBubble" class="travel-bubble">
              <i class="fa-solid fa-circle-info"></i>
              El desplazamiento se cobrará cuando asignemos al cuidador/a más cercano y adecuado.
              <br>Este importe quedará <strong>pendiente</strong> en la factura final.
            </div>
          </div>

          <div class="booking-field" style="grid-column: 1 / -1;">
            <label for="notes">Notas (opcional)</label>
            <textarea id="notes" name="Notas" rows="3" placeholder="Rutinas, medicación, instrucciones…"></textarea>
          </div>
        </div>
      </section>

      <!-- Resumen / Desglose -->
      <div class="summary-panel" id="summary">
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
          <strong>Desglose preliminar</strong>
        </div>
        <div class="summary-grid">
          <div class="summary-row">
            <div class="summary-label">Precio base</div>
            <div class="summary-value"><span id="sumBase">—</span> €</div>
          </div>
          <div class="summary-row" id="rowVisit1" style="display:none;">
            <div class="summary-label">1ª visita (60/90)</div>
            <div class="summary-value"><span id="sumVisit1">0.00</span> €</div>
          </div>
          <div class="summary-row" id="rowVisit2" style="display:none;">
            <div class="summary-label">2ª visita (medicación)</div>
            <div class="summary-value"><span id="sumVisit2">0.00</span> €</div>
          </div>
          <div class="summary-row">
            <div class="summary-label">Suplementos por mascotas</div>
            <div class="summary-value"><span id="sumPets">0.00</span> €</div>
          </div>
          <div class="summary-row">
            <div class="summary-label">Festivos (auto)</div>
            <div class="summary-value"><span id="sumFestivo">0.00</span> €</div>
          </div>
          <div class="summary-row">
            <div class="summary-label">Días especiales (auto)</div>
            <div class="summary-value"><span id="sumSenalado">0.00</span> €</div>
          </div>
          <div class="summary-row">
            <div class="summary-label">Desplazamiento</div>
            <div class="summary-value"><span id="sumTravel" class="summary-muted">pendiente</span></div>
          </div>
          <div class="summary-row" id="rowBono" style="display:none;">
            <div class="summary-label">Bono guardería (descuento)</div>
            <div class="summary-value">−<span id="sumBono">0.00</span> €</div>
          </div>
          <div class="summary-row summary-total">
            <div class="summary-label">Subtotal (sin desplazamiento)</div>
            <div class="summary-value"><span id="sumSubtotal">—</span> €</div>
          </div>
          <div class="summary-row">
            <div class="summary-label">Depósito a retener</div>
            <div class="summary-value"><span id="sumDeposit">—</span> €</div>
          </div>
        </div>
        <p class="note" style="margin-top:10px;">
          Este cálculo es orientativo. El importe por kilometraje se añade al confirmar el cuidador más cercano.
          El depósito se retiene (autorización) y se captura tras aceptar la reserva.
        </p>
      </div>

      <!-- Campos ocultos para email -->
      <input type="hidden" name="Desglose" id="summaryField">
      <input type="hidden" name="Mascotas_lista" id="petsListHidden">

      <!-- Detalle propietario + mascotas para EmailJS -->
      <input type="hidden" name="Owner_detalle" id="ownerDetail">
      <input type="hidden" name="Mascotas_detalle" id="petsDetail">
      <input type="hidden" name="Mascotas_detalle_json" id="petsDetailJson">

      <div class="booking-actions tpl-actions">
        <span class="tpl-spacer" aria-hidden="true"></span>
        <button type="submit" class="cta-button">Solicitar reserva</button>
        <a class="tpl-help" href="ayuda.html#reservas" aria-label="Centro de ayuda">Centro de ayuda</a>
      </div>

      <p class="note">Tras enviar, te llamaremos para conocernos y confirmar detalles. La primera visita con el cuidador es gratuita.</p>
    </form>
  </div>

  <!-- ====== Constantes de precios y bonos ====== -->
  <script>
    const PRICES = {
      base: { visitas: 22, paseos: 12, guarderia: 15, alojamiento: 30, bodas: 0, postquirurgico: 0, transporte: 0, exoticos: 0 },
      puppyBase: { guarderia: 20, alojamiento: 35 },
      visita60: 22, visita90: 30,
      visita60_larga: 18, visita90_larga: 27,
      visitaMed: 12, visitaMed_larga: 10,
      depositPct: 0.20
    };
    const BUNDLE_GUARDERIA = {
      adult:  { 10: 135, 20: 250, 30: 315 },
      puppy:  { 10: 185, 20: 350, 30: 465 }
    };
  </script>

  <!-- ====== Lógica de reservas (UI + cálculo) ====== -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('bookingForm');
    const wall = document.getElementById('authWall');

    const els = {
      service: byId('service'),
      region: byId('region'),
      startDate: byId('startDate'),
      endDate: byId('endDate'),
      start: byId('start'),
      end: byId('end'),

      address: byId('location'),
      addrSuggest: byId('tplAddrSuggest'),
      postalCode: byId('postalCode'),

      species: byId('species'),
      isPuppy: byId('isPuppy'),
      numPets: byId('numPets'),
      numPetsExact: byId('numPetsExact'),

      needTravel: byId('needTravel'),
      travelBubble: byId('travelBubble'),

      visitDuration: byId('visitDuration'),
      visitDaily: byId('visitDaily'),
      fieldVisitDuration: byId('fieldVisitDuration'),
      fieldVisitDaily: byId('fieldVisitDaily'),

      firstName: byId('firstName'),
      lastName: byId('lastName'),
      phone: byId('phone'),
      email: byId('email'),
      contactTime: byId('contactTime'),

      petsContainer: byId('petsContainer'),
      petsListHidden: byId('petsListHidden'),
      petNamesList: byId('tplPetNamesList'),

      sumBase: byId('sumBase'),
      sumVisit1: byId('sumVisit1'),
      sumVisit2: byId('sumVisit2'),
      rowVisit1: byId('rowVisit1'),
      rowVisit2: byId('rowVisit2'),
      sumPets: byId('sumPets'),
      sumFestivo: byId('sumFestivo'),
      sumSenalado: byId('sumSenalado'),
      sumTravel: byId('sumTravel'),
      sumBono: byId('sumBono'),
      rowBono: byId('rowBono'),
      sumSubtotal: byId('sumSubtotal'),
      sumDeposit: byId('sumDeposit'),

      summaryField: byId('summaryField'),
    };

    function byId(id){ return document.getElementById(id); }
    const qs = (k) => new URLSearchParams(location.search).get(k);
    const currency = (n) => (Math.round((n || 0) * 100) / 100).toFixed(2);
    const SPECIAL_MMDD = ['12-24','12-25','12-31','01-01'];
    const REGION_TO_COUNTY = {
      andalucia:'ES-AN', aragon:'ES-AR', asturias:'ES-AS', baleares:'ES-IB', canarias:'ES-CN', cantabria:'ES-CB',
      'castilla-la-mancha':'ES-CM', 'castilla-y-leon':'ES-CL', cataluna:'ES-CT', ceuta:'ES-CE', valenciana:'ES-VC',
      extremadura:'ES-EX', galicia:'ES-GA', 'la-rioja':'ES-RI', madrid:'ES-MD', melilla:'ES-ML', murcia:'ES-MC',
      navarra:'ES-NC', euskadi:'ES-PV', nacional:null
    };
    const COUNTY_TO_REGIONKEY = {
      'ES-AN':'AN','ES-AR':'AR','ES-AS':'AS','ES-IB':'IB','ES-CN':'CN','ES-CB':'CB','ES-CM':'CM','ES-CL':'CL','ES-CT':'CT','ES-VC':'VC',
      'ES-EX':'EX','ES-GA':'GA','ES-RI':'RI','ES-MD':'MD','ES-MC':'MC','ES-NC':'NC','ES-PV':'PV','ES-CE':'CE','ES-ML':'ML'
    };

    function mmdd(d){ return `${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
    function ymd(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
    function eachDate(from,to){
      const res=[]; if(!from||!to) return res;
      const d1=new Date(from), d2=new Date(to);
      if(isNaN(d1)||isNaN(d2)||d2<d1) return res;
      const cur=new Date(d1); cur.setHours(0,0,0,0); d2.setHours(0,0,0,0);
      while(cur<=d2){ res.push(new Date(cur)); cur.setDate(cur.getDate()+1); }
      return res;
    }
    function debounce(fn, wait=300){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; }

    /* Preselección de servicio (URL o referrer) */
    function inferServiceFromReferrer(){
      try{
        const u = new URL(document.referrer || '');
        const p = (u.pathname || '').toLowerCase();
        if(p.includes('servicio-guarderia') || p.includes('guarderia')) return 'guarderia';
        if(p.includes('servicio-estancias') || p.includes('alojamiento') || p.includes('estancias')) return 'alojamiento';
        if(p.includes('servicio-paseos') || p.includes('paseos')) return 'paseos';
        if(p.includes('servicio-visitas') || p.includes('visitas')) return 'visitas';
        if(p.includes('servicio-bodas')   || p.includes('bodas')) return 'bodas';
        if(p.includes('postquir')) return 'postquirurgico';
        if(p.includes('transporte')) return 'transporte';
        if(p.includes('exotico')) return 'exoticos';
      }catch(_){}
      return null;
    }
    (function presetService(){
      const raw = (qs('service') || qs('svc') || '').toLowerCase();
      const norm = raw.normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'-');
      const map = {
        visitas:'visitas','visitas-gatos':'visitas',
        paseos:'paseos',
        guarderia:'guarderia','guarderia-dia':'guarderia',
        alojamiento:'alojamiento','estancias':'alojamiento',
        bodas:'bodas','boda':'bodas',
        postquirurgico:'postquirurgico','post-quirurgico':'postquirurgico','postquirugico':'postquirurgico',
        transporte:'transporte',
        exoticos:'exoticos','exotico':'exoticos'
      };
      let val = map[norm] || inferServiceFromReferrer();
      if(val && els.service){ els.service.value = val; els.service.disabled = false; }
    })();

    function toggleFields(){
      const svc = els.service?.value;
      const isVisitas = (svc === 'visitas');
      if(form){ form.classList.toggle('tpl-visitas-on', isVisitas); }
      if(els.fieldVisitDuration){ els.fieldVisitDuration.hidden = !isVisitas; }
      if(els.fieldVisitDaily){ els.fieldVisitDaily.hidden = !isVisitas; }
      if(els.visitDuration){ els.visitDuration.disabled = !isVisitas; if(!isVisitas) els.visitDuration.value='60'; }
      if(els.visitDaily){ els.visitDaily.disabled = !isVisitas; if(!isVisitas) els.visitDaily.value='1'; }
      const species = els.species?.value || 'perro';
      const puppyApplies = (svc === 'guarderia' || svc === 'alojamiento') && species !== 'otros' && !isVisitas;
      if(els.isPuppy) els.isPuppy.parentElement.hidden = !puppyApplies;
      if(isVisitas && els.species) els.species.value = 'gato';
    }

    function getNumMascotas(){
      let n = els.numPets?.value || '1';
      if(n === '6+') n = Math.max(6, parseInt(els.numPetsExact?.value,10) || 6);
      return parseInt(n,10);
    }
    function syncPetsExact(){
      if(els.numPets?.value === '6+'){
        els.numPetsExact.style.display = 'block';
        els.numPetsExact.required = true;
      }else{
        els.numPetsExact.style.display = 'none';
        els.numPetsExact.required = false;
      }
    }

    // ======= Prefill propietario =======
    function getCurrentUserId(){
      try{
        const explicit = localStorage.getItem('tpl.currentUser');
        if (explicit) return explicit;
        const uidLS = localStorage.getItem('tpl_auth_uid');
        if (uidLS) return uidLS;
        if (window.firebase && typeof firebase.auth === 'function'){
          const u = firebase.auth().currentUser;
          if (u && !u.isAnonymous && u.uid) return u.uid;
        }
      }catch(_){}
      return 'default';
    }
    function udbKey(uid, key){ return `tpl.udb.${uid}.${key}`; }
    function udbGet(uid, key, fallback){
      try{ const v = localStorage.getItem(udbKey(uid,key)); return v ? JSON.parse(v) : fallback; }catch(_){ return fallback; }
    }
    function getOwnerLocal(){ return udbGet(getCurrentUserId(), 'owner', null); }

    async function autoContactFromProfile(u){
      try{
        // Firebase profile
        if(u && typeof firebase !== 'undefined'){
          const db = firebase.firestore();
          const doc = await db.collection('users').doc(u.uid).get();
          const d = doc.exists ? doc.data() : {};
          if (d){
            if (d?.nombre)    els.firstName.value = d.nombre;
            if (d?.apellidos) els.lastName.value  = d.apellidos;
            if (d?.email)     els.email.value     = d.email;
            if (d?.telefono)  els.phone.value     = d.telefono;
            if (d?.direccion) els.address.value   = d.direccion;
            if (d?.cp)        els.postalCode.value= d.cp;
            if (d?.ccaa && els.region){
              const val = (''+d.ccaa).toLowerCase();
              if([...els.region.options].some(o=>o.value===val)) els.region.value = val;
            }
          }
        }
        // fallback local
        const fb = getOwnerLocal() || {};
        els.firstName.value = els.firstName.value || fb.nombre || '';
        els.lastName.value  = els.lastName.value  || fb.apellidos || '';
        els.email.value     = els.email.value     || fb.email || '';
        els.phone.value     = els.phone.value     || fb.telefono || '';
        els.address.value   = els.address.value   || fb.direccion || '';
        els.postalCode.value= els.postalCode.value|| fb.cp || '';
        if (els.region && !els.region.value && fb.ccaa){
          const val = (''+fb.ccaa).toLowerCase();
          if([...els.region.options].some(o=>o.value===val)) els.region.value = val;
        }
      }catch(_){}
    }

    // ======= Datalist + Selector de mascotas =======
    let PROFILE_PETS = []; // {id,nombre,raza,edad,tamano,peso,birthdate,...}
    function fillPetDatalist(){
      if(!els.petNamesList) return;
      const names = PROFILE_PETS.map(p => (p?.nombre||'').trim()).filter(Boolean);
      els.petNamesList.innerHTML = names.map(n => `<option value="${(n||'').replace(/"/g,'&quot;')}"></option>`).join('');
    }

    function renderPetNameFields(n){
      n = Math.max(1, n|0);
      const wrap = els.petsContainer; if(!wrap) return;
      const current = wrap.querySelectorAll('[data-pet-row]').length;
      for(let i=current+1;i<=n;i++){
        const row = document.createElement('div');
        row.className = 'booking-field';
        row.setAttribute('data-pet-row', i.toString());
        row.innerHTML = `
          <label for="petName_${i}">Nombre de la mascota ${n>1?`#${i}`:''}</label>
          <input type="text" id="petName_${i}" name="Mascota_${i}" list="tplPetNamesList" placeholder="Ej. Nala" autocomplete="off">
        `;
        wrap.appendChild(row);
      }
      const rows = wrap.querySelectorAll('[data-pet-row]'); rows.forEach(r=>{ const idx = parseInt(r.getAttribute('data-pet-row'),10); if(idx>n) r.remove(); });
      updatePetsListHidden();
      wrap.querySelectorAll('input[id^="petName_"]').forEach(inp=>{ inp.addEventListener('input', updatePetsListHidden); });
    }
    function updatePetsListHidden(){
      const names = [...els.petsContainer.querySelectorAll('input[id^="petName_"]')].map(i=>i.value.trim()).filter(Boolean);
      els.petsListHidden.value = names.join(', ');
    }

    // <!-- TPL: INICIO BLOQUE NUEVO [UI Selector de mascotas] -->
    (function setupPetPicker(){
      const btn = document.getElementById('tpl-open-petpicker');
      if(!btn) return;
      let overlay;
      function ensureOverlay(){
        if (overlay) return overlay;
        overlay = document.createElement('div');
        overlay.className = 'tpl-petpicker-overlay';
        overlay.innerHTML = `
          <div class="tpl-petpicker" role="dialog" aria-label="Selecciona mascotas">
            <h3>Elige tus mascotas</h3>
            <div class="tpl-petpicker-list" id="tpl-petpicker-list"></div>
            <div class="tpl-petpicker-actions">
              <button type="button" class="tpl-btn-outline" id="tpl-petpicker-cancel">Cancelar</button>
              <button type="button" class="tpl-btn" id="tpl-petpicker-apply">Aplicar</button>
            </div>
          </div>
        `;
        document.body.appendChild(overlay);
        overlay.addEventListener('click', (e)=>{ if(e.target===overlay) overlay.classList.remove('on'); });
        overlay.querySelector('#tpl-petpicker-cancel').addEventListener('click', ()=> overlay.classList.remove('on'));
        overlay.querySelector('#tpl-petpicker-apply').addEventListener('click', ()=>{
          const checks = overlay.querySelectorAll('input[type="checkbox"]:checked');
          const names = [...checks].map(c=>c.dataset.name).filter(Boolean);
          if (!names.length && PROFILE_PETS.length===1){
            names.push(PROFILE_PETS[0].nombre);
          }
          if (names.length){
            // Ajusta nº mascotas según selección
            if (names.length >= 6){ els.numPets.value = '6+'; els.numPetsExact.value = names.length; }
            else { els.numPets.value = String(names.length); }
            renderPetNameFields(getNumMascotas());
            // Volcar nombres
            [...els.petsContainer.querySelectorAll('input[id^="petName_"]')].forEach((inp, i)=>{ inp.value = names[i] || ''; });
            updatePetsListHidden();
          }
          overlay.classList.remove('on');
        });
        return overlay;
      }
      function renderList(){
        const host = ensureOverlay().querySelector('#tpl-petpicker-list');
        if(!host) return;
        if(!PROFILE_PETS.length){
          host.innerHTML = `<div class="tpl-pet-item">No encontramos mascotas guardadas en tu perfil.</div>`;
          return;
        }
        host.innerHTML = PROFILE_PETS.map((p,idx)=>{
          const meta = [
            p.especie || p.species || '',
            p.raza || '',
            p.edad ? `${p.edad} años` : '',
            p.tamano || p.tamaño || '',
            p.peso ? `${p.peso} kg` : ''
          ].filter(Boolean).join(' · ');
          const n = (p.nombre || `Mascota ${idx+1}`).replace(/"/g,'&quot;');
          return `
            <label class="tpl-pet-item">
              <input type="checkbox" data-name="${n}">
              <span class="tpl-pet-name">${n}</span>
              <span class="tpl-pet-meta">${meta}</span>
            </label>
          `;
        }).join('');
      }
      btn.addEventListener('click', ()=>{
        renderList();
        ensureOverlay().classList.add('on');
      });
      // Autoselección si solo hay 1
      document.addEventListener('tpl-pets-ready', ()=>{
        if (PROFILE_PETS.length === 1){
          els.numPets.value = '1';
          renderPetNameFields(1);
          const input = document.getElementById('petName_1');
          if (input){ input.value = PROFILE_PETS[0].nombre || ''; updatePetsListHidden(); }
        }
      });
    })();
    // <!-- TPL: FIN BLOQUE NUEVO -->

    function travelSync(){
      if(els.travelBubble) els.travelBubble.style.display = els.needTravel?.value === 'si' ? 'block' : 'none';
      if(els.sumTravel) els.sumTravel.textContent = (els.needTravel?.value === 'si') ? 'pendiente' : '—';
    }

    // ======= Festivos =======
    const _festivosCache = new Map();
    async function fetchLocalHolidays(year){
      const urls = [`/festivos-es-${year}.json`, `festivos-es-${year}.json`];
      for(const url of urls){
        try{
          const r = await fetch(url, {cache:'no-store'});
          if(!r.ok) continue;
          const data = await r.json();
          const nacional = new Set((data.national || data.nacional || []).map(x => x.date || x));
          const porCcaa = new Map();
          if(data.regions){ Object.entries(data.regions).forEach(([k, arr])=>{ porCcaa.set(k, new Set((arr||[]).map(x => x.date || x))); }); }
          return { nacional, porCcaa, _src:'local' };
        }catch(_){}
      }
      return null;
    }
    async function fetchNagerHolidays(year){
      const r = await fetch(`https://date.nager.at/api/v3/PublicHolidays/${year}/ES`, {cache:'force-cache'});
      if(!r.ok) throw new Error('Nager fail');
      const data = await r.json();
      const nacional = new Set();
      const porCcaa = new Map();
      for(const h of data){
        const date = h.date;
        if(!h.counties || !h.counties.length){ nacional.add(date); }
        else{
          for(const c of h.counties){
            const key = COUNTY_TO_REGIONKEY[c] || c;
            if(!porCcaa.has(key)) porCcaa.set(key, new Set());
            porCcaa.get(key).add(date);
          }
        }
      }
      return { nacional, porCcaa, _src:'nager' };
    }
    async function fetchHolidaysForYear(year){
      if(_festivosCache.has(year)) return _festivosCache.get(year);
      try{
        const raw = localStorage.getItem(`tpl_festivos_${year}`);
        if(raw){
          const parsed = JSON.parse(raw);
          if(parsed?.t && Date.now() - parsed.t <= 24*3600*1000){
            const nacional = new Set(parsed.d || []);
            const porCcaa = new Map((parsed.r || []).map(([k,arr])=>[k,[...arr]]).map(([k,arr])=>[k,new Set(arr)]));
            const cached = {nacional, porCcaa, _src:'localStorage'};
            _festivosCache.set(year, cached); return cached;
          }
        }
      }catch(_){}
      const local = await fetchLocalHolidays(year);
      if(local){ _festivosCache.set(year, local); return local; }
      try{
        const nager = await fetchNagerHolidays(year);
        _festivosCache.set(year, nager);
        try{
          localStorage.setItem(`tpl_festivos_${year}`, JSON.stringify({ t:Date.now(), d:[...nager.nacional], r:[...nager.porCcaa.entries()].map(([k,v])=>[k,[...v]]) }));
        }catch(_){}
        return nager;
      }catch(_){}
      const basic = { nacional: new Set([`${year}-01-06`, `${year}-05-01`, `${year}-08-15`, `${year}-10-12`, `${year}-11-01`, `${year}-12-06`, `${year}-12-08`, `${year}-12-25`]), porCcaa: new Map(), _src:'basic' };
      _festivosCache.set(year, basic); return basic;
    }
    async function calcFestivosAutoAsync(region, start, end){
      const days = eachDate(start, end);
      if(!days.length) return { festivo:0, senalado:0, nDias:0 };
      let festivo = 0, senalado = 0;
      for(const d of days){
        const year = d.getFullYear();
        const iso = ymd(d);
        const pack = await fetchHolidaysForYear(year);
        const county = REGION_TO_COUNTY[region || 'nacional'] || null;
        const regKey = COUNTY_TO_REGIONKEY[county] || county;
        const isNat = !!pack?.nacional?.has(iso);
        const isReg = regKey ? !!(pack?.porCcaa?.get(regKey)?.has(iso) || pack?.porCcaa?.get(county)?.has(iso)) : false;
        const isSpecial = SPECIAL_MMDD.includes(mmdd(d));
        if(isNat || isReg) festivo += 10;
        if(isSpecial) senalado += 30;
      }
      return { festivo, senalado, nDias: days.length };
    }
    function calcPetSupplements(service, species, n){
      if(n <= 1) return 0;
      if(service === 'visitas'){
        const extra = n - 1;
        if(extra === 1) return 12;
        if(extra === 2) return 8 * 2;
        if(extra >= 3) return 6 * extra;
        return 0;
      }
      if(service === 'paseos') return 8 * (n - 1);
      if(service === 'alojamiento' && species === 'perro') return 25 * (n - 1);
      return 0;
    }
    function getBasePrice(service, species, isPuppy){
      if(service === 'visitas') return 0;
      if(service === 'alojamiento'){
        return isPuppy ? (PRICES.puppyBase.alojamiento ?? PRICES.base.alojamiento) : PRICES.base.alojamiento;
      }
      if(service === 'guarderia'){
        return isPuppy ? (PRICES.puppyBase.guarderia ?? PRICES.base.guarderia) : PRICES.base.guarderia;
      }
      return PRICES.base[service] || 0;
    }
    function calcVisitas(visitDurationMin, dailyVisits, nDias){
      const longStay = (nDias >= 11);
      const price1 = (visitDurationMin === 90) ? (longStay ? PRICES.visita90_larga : PRICES.visita90) : (longStay ? PRICES.visita60_larga : PRICES.visita60);
      const price2 = dailyVisits === 2 ? (longStay ? PRICES.visitaMed_larga : PRICES.visitaMed) : 0;
      return { price1, price2 };
    }
    function calcBonoGuarderia(nDias, isPuppy){
      const perDay = isPuppy ? (PRICES.puppyBase.guarderia ?? PRICES.base.guarderia) : PRICES.base.guarderia;
      const table  = isPuppy ? BUNDLE_GUARDERIA.puppy : BUNDLE_GUARDERIA.adult;
      const bundlePrice = table[nDias];
      if (!bundlePrice) return 0;
      const normalTotal = perDay * nDias;
      return Math.max(0, normalTotal - bundlePrice);
    }

    async function recalc(){
      const svc = els.service?.value || '';
      const species = (els.species?.value || 'perro');
      const isExotic = species === 'otros';
      const isVisitas = (svc === 'visitas');
      const puppyAllowed = (svc === 'alojamiento' || svc === 'guarderia') && !isExotic && !isVisitas;
      const isPuppy = puppyAllowed && (els.isPuppy?.value === 'si');

      const nMasc = getNumMascotas();
      const region = els.region?.value || 'nacional';
      const start = els.startDate?.value;
      const end   = els.endDate?.value;
      const { festivo, senalado, nDias } = await calcFestivosAutoAsync(region, start, end);

      let base = 0, visit1 = 0, visit2 = 0, bono = 0;
      let pets = 0;

      if(isVisitas){
        const dur = parseInt(els.visitDuration?.value || '60', 10);
        const daily = parseInt(els.visitDaily?.value || '1', 10);
        const perDay = calcVisitas(dur, daily, nDias);
        visit1 = perDay.price1 * nDias;
        visit2 = perDay.price2 * nDias;
        base = 0;
        pets = calcPetSupplements(svc, 'gato', nMasc);
      } else {
        base = getBasePrice(svc, species, isPuppy) * nDias;
        pets = calcPetSupplements(svc, species, nMasc);
        if(svc === 'guarderia'){ bono = calcBonoGuarderia(nDias, isPuppy); }
      }

      const subtotal = (base + visit1 + visit2 + pets + festivo + senalado) - bono;
      const deposit = subtotal * (PRICES.depositPct || 0.2);

      els.sumBase.textContent = isVisitas ? '—' : (subtotal>0 ? currency(base) : '—');
      els.rowVisit1.style.display = isVisitas ? '' : 'none';
      els.rowVisit2.style.display = (isVisitas && visit2 > 0) ? '' : 'none';
      els.sumVisit1.textContent = currency(visit1);
      els.sumVisit2.textContent = currency(visit2);
      els.sumPets.textContent = currency(pets);
      els.sumFestivo.textContent = currency(festivo);
      els.sumSenalado.textContent = currency(senalado);
      els.rowBono.style.display = (svc === 'guarderia' && bono > 0) ? '' : 'none';
      els.sumBono.textContent = currency(bono);
      els.sumSubtotal.textContent = (subtotal>0) ? currency(subtotal) : '—';
      els.sumDeposit.textContent = (subtotal>0) ? currency(deposit) : '—';
    }
    async function recalcAll(){ toggleFields(); syncPetsExact(); renderPetNameFields(getNumMascotas()); await recalc(); }

    ['change','input'].forEach(ev=>{
      ['service','species','isPuppy','numPets','numPetsExact','region','startDate','endDate','visitDuration','visitDaily','needTravel'].forEach(id=>{
        const el = byId(id); if(el) el.addEventListener(ev, recalcAll);
      });
    });

    // Init
    renderPetNameFields(1);
    recalcAll();

    // Autocompletado dirección (OSM)
    async function searchAddresses(q){
      const url = `https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=6&countrycodes=es&q=${encodeURIComponent(q)}`;
      const r = await fetch(url, { headers: { 'Accept':'application/json' }});
      if(!r.ok) return [];
      return r.json();
    }
    function renderAddrSuggestions(list){
      if(!els.addrSuggest) return;
      if(!list.length){ els.addrSuggest.style.display='none'; els.addrSuggest.innerHTML=''; return; }
      els.addrSuggest.innerHTML = list.map((it)=>(`
        <div class="tpl-addr-item" role="option" tabindex="0" data-raw='${JSON.stringify(it).replace(/'/g,"&#39;")}'>
          ${it.display_name}
        </div>`)).join('');
      els.addrSuggest.style.display = 'block';
      els.addrSuggest.querySelectorAll('.tpl-addr-item').forEach(node=>{
        node.addEventListener('click', ()=> chooseAddr(JSON.parse(node.dataset.raw.replace(/&#39;/g,"'"))));
        node.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') chooseAddr(JSON.parse(node.dataset.raw.replace(/&#39;/g,"'"))); });
      });
    }
    function chooseAddr(item){
      els.address.value = (item?.display_name || '').replace(/, España$/,'');
      const pc = item?.address?.postcode || '';
      if(els.postalCode){ els.postalCode.value = pc; }
      els.addrSuggest.style.display='none';
    }
    const addressInputHandler = debounce(async ()=>{
      const q = (els.address?.value || '').trim();
      if(q.length < 4){ renderAddrSuggestions([]); return; }
      try{ renderAddrSuggestions(await searchAddresses(q) || []); }
      catch(_){ renderAddrSuggestions([]); }
    }, 380);
    if(els.address){
      els.address.addEventListener('input', addressInputHandler);
      els.address.addEventListener('focus', addressInputHandler);
      document.addEventListener('click', (e)=>{ if(!els.addrSuggest.contains(e.target) && e.target!==els.address){ els.addrSuggest.style.display='none'; }});
    }

    // Auto-cachorro desde perfil
    async function autoPuppyFromProfile(){
      try{
        if(typeof firebase === 'undefined') return;
        const auth = firebase.auth();
        const db = firebase.firestore();
        const u = auth.currentUser;
        if(!u) return;
        const snap = await db.collection('users').doc(u.uid).collection('mascotas').limit(1).get();
        if(!snap.empty){
          const pet = snap.docs[0].data();
          if(pet?.birthdate){
            const b = new Date(pet.birthdate);
            const today = new Date();
            const months = (today.getFullYear()-b.getFullYear())*12 + (today.getMonth()-b.getMonth());
            const isP = months < 6;
            const svc = els.service?.value || '';
            const species = els.species?.value || 'perro';
            const puppyAllowed = (svc === 'alojamiento' || svc === 'guarderia') && species !== 'otros' && svc !== 'visitas';
            if(els.isPuppy && puppyAllowed){ els.isPuppy.value = isP ? 'si' : 'no'; }
            await recalc();
          }
        }
      }catch(_){}
    }

    // Prefill propietario + carga mascotas
    if (typeof firebase !== 'undefined') {
      const auth = firebase.auth();
      function updateAuthUI(user){
        const logged = !!user;
        if (form) form.classList.toggle('disabled', !logged);
        if (wall) wall.style.display = logged ? 'none' : 'block';
        autoContactFromProfile(user);
        if (logged) autoPuppyFromProfile();

        // Cargar mascotas del perfil
        (async ()=>{
          try{
            if (!logged) return;
            const db = firebase.firestore();
            const petsSnap = await db.collection('users').doc(user.uid).collection('mascotas').get();
            PROFILE_PETS = petsSnap.docs.map(d=>({ id:d.id, ...d.data() }));
            fillPetDatalist();
            document.dispatchEvent(new CustomEvent('tpl-pets-ready'));
          }catch(_){}
        })();
      }
      auth.onAuthStateChanged(updateAuthUI);
    } else {
      // sin Firebase, fallback local
      autoContactFromProfile(null);
    }

    // ========= Validación contacto según preferencia =========
    function validateContactPreference(e){
      const pref = (new FormData(form).get('Preferencia_contacto')) || 'cualquiera';
      const tel  = els.phone?.value?.trim();
      const mail = els.email?.value?.trim();
      if(pref === 'telefono' || pref === 'whatsapp'){
        if(!tel){ e.preventDefault(); alert('Por favor, indícanos tu teléfono para poder contactarte.'); return false; }
      }else if(pref === 'email'){
        if(!mail){ e.preventDefault(); alert('Por favor, indícanos tu correo para poder contactarte.'); return false; }
      }
      return true;
    }

    // ========= Antes de enviar: resumen (para el correo) =========
    function buildSummaryLines(){
      const regionText = els.region?.options?.[els.region.selectedIndex]?.text || 'España';
      let petsVal = els.numPets?.value || '1';
      if(petsVal === '6+') petsVal = Math.max(6, parseInt(els.numPetsExact?.value,10) || 6).toString();
      updatePetsListHidden();

      const lines = [];
      lines.push(`Servicio: ${els.service?.options?.[els.service.selectedIndex]?.text || ''}`);
      lines.push(`Fechas: ${els.startDate?.value || '-'} a ${els.endDate?.value || '-'}`);
      lines.push(`Hora: ${els.start?.value || '-'} a ${els.end?.value || '-'}`);
      if(els.service?.value === 'visitas'){
        lines.push(`Visita: ${els.visitDuration?.value || '60'} min, ${els.visitDaily?.value || '1'} visita(s)/día`);
      }else{
        const puppyAllowed = (els.service?.value === 'alojamiento' || els.service?.value === 'guarderia') && (els.species?.value !== 'otros');
        lines.push(`Tipo de animal: ${els.species?.value || '-'}`);
        lines.push(`Cachorro: ${puppyAllowed ? (els.isPuppy?.value || 'no') : 'no procede'}`);
      }
      lines.push(`Nº mascotas: ${petsVal}`);
      const petNames = els.petsListHidden.value || '';
      if(petNames) lines.push(`Nombres mascotas: ${petNames}`);
      lines.push(`Dirección: ${els.address?.value || '-'}`);
      lines.push(`CP: ${els.postalCode?.value || '-'}`);
      lines.push(`CCAA: ${regionText}`);
      lines.push(`Preferencia contacto: ${new FormData(form).get('Preferencia_contacto') || 'cualquiera'}`);
      if(els.contactTime?.value) lines.push(`Hora preferida contacto: ${els.contactTime.value}`);
      lines.push(`Festivos (auto): ${els.sumFestivo?.textContent || '0.00'} €`);
      lines.push(`Días especiales (auto): ${els.sumSenalado?.textContent || '0.00'} €`);
      if(els.service?.value === 'guarderia' && els.rowBono?.style.display !== 'none'){
        lines.push(`Bono guardería (descuento): −${els.sumBono?.textContent || '0.00'} €`);
      }
      lines.push(`Subtotal (sin desplazamiento): ${els.sumSubtotal?.textContent || '0.00'} €`);
      lines.push(`Depósito a retener: ${els.sumDeposit?.textContent || '0.00'} €`);
      return lines;
    }

    form.addEventListener('submit', async (e)=>{
      if(!validateContactPreference(e)) return;
      els.summaryField.value = buildSummaryLines().join(' | ');
    });

    // Hooks
    els.numPets && els.numPets.addEventListener('change', ()=>{ syncPetsExact(); renderPetNameFields(getNumMascotas()); updatePetsListHidden(); });
    els.numPetsExact && els.numPetsExact.addEventListener('input', ()=>{ renderPetNameFields(getNumMascotas()); updatePetsListHidden(); });
    els.needTravel && els.needTravel.addEventListener('change', travelSync);
    travelSync();

  });
  </script>

  <!-- Footer (inyectado) -->
  <div id="tpl-footer">
    <noscript>
      <footer class="site-footer">
        <div class="container footer-row">
          <div class="footer-left">
            <nav class="footer-links-row">
              <a href="sobre-nosotros.html">Sobre nosotros</a><span class="sep">|</span>
              <a href="contacto.html">Contacta con nosotros</a><span class="sep">|</span>
              <a href="donde-estamos.html">Dónde estamos</a><span class="sep">|</span>
              <a href="trabaja-con-nosotros.html">Trabaja con nosotros</a><span class="sep">|</span>
              <a href="privacidad.html">Política de Privacidad</a><span class="sep">|</span>
              <a href="condiciones.html">Condiciones de Servicio</a><span class="sep">|</span>
              <a href="digital-services-act.html">Digital Services Act</a>
            </nav>
            <div class="footer-help">¿Necesitas ayuda? <a href="ayuda.html">Centro de ayuda</a></div>
          </div>
          <div class="footer-right socials">
            <a href="#" aria-label="WhatsApp"><i class="fab fa-whatsapp"></i></a>
            <a href="#" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
            <a href="#" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
            <a href="#" aria-label="TikTok"><i class="fab fa-tiktok"></i></a>
          </div>
        </div>
        <div class="footer-bottom footer-bottom--inline">
          <div class="footer-bottom-left">© <span class="year-span"></span> The Pets Lovers — Todos los derechos reservados</div>
          <nav class="footer-bottom-right legal-links">
            <a href="aviso-legal.html">Aviso legal</a><span class="sep">|</span>
            <a href="privacidad.html">Privacidad</a><span class="sep">|</span>
            <a href="cookies.html">Cookies</a><span class="sep">|</span>
            <a href="canal-denuncias.html">Canal de denuncias</a>
          </nav>
        </div>
      </footer>
    </noscript>
  </div>

  <!-- Mini-injectors -->
  <script>document.querySelectorAll('.year-span').forEach(s=>s.textContent=new Date().getFullYear())</script>
  <script src="tpl-navbar.js" defer></script>
  <script src="tpl-footer.js" defer></script>

  <!-- Firebase SDK compat -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-analytics-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDW73aFuz2AFS9VeWg_linHIRJYN4YMgTk",
      authDomain: "thepetslovers-c1111.firebaseapp.com",
      projectId: "thepetslovers-c1111",
      storageBucket: "thepetslovers-c1111.appspot.com",
      messagingSenderId: "415914577533",
      appId: "1:415914577533:web:0b7a056ebaa4f1de28ab14",
      measurementId: "G-FXPD69KXBG"
    };
    if (typeof firebase !== 'undefined') {
      if (firebase.apps.length === 0) firebase.initializeApp(firebaseConfig);
      if (firebase.analytics) { try { firebase.analytics(); } catch(e){} }
    }
  </script>

  <!-- EmailJS (envío directo) -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <!-- CONFIG OPCIONAL: puedes pegar aquí tus IDs de EmailJS o ponerlos en otro .js -->
  <script>
    // OPCIONAL: déjalo vacío si ya configuras window.TPL_EMAILJS en otro sitio
    window.TPL_EMAILJS = window.TPL_EMAILJS || {
      // serviceId: 'TU_SERVICE_ID',
      // templateId: 'TU_TEMPLATE_ID',
      // publicKey:  'TU_PUBLIC_KEY'
    };
    (function(){
      const cfg = window.TPL_EMAILJS || {};
      if (window.emailjs) {
        const pub = cfg.publicKey || cfg.userId || null;
        if (pub) { try{ emailjs.init({ publicKey: pub }); }catch(_){/* noop */} }
      }
    })();
  </script>

  <!-- Login inline (Email + Google) para muro -->
  <script>
    (function(){
      if (typeof firebase === 'undefined') return;
      const auth = firebase.auth();
      const isIOS = /iP(ad|hone|od)/i.test(navigator.userAgent);
      const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

      function renderInlineLogin(){
        const host = document.getElementById('tpl-inline-login');
        if(!host) return;
        host.innerHTML = `
          <div class="tpl-login-card" role="region" aria-label="Acceso rápido">
            <h3 class="tpl-login-title">Accede aquí mismo</h3>
            <div class="tpl-socials">
              <button type="button" class="tpl-btn-social" id="tpl-google-btn">
                <i class="fa-brands fa-google"></i> Continuar con Google
              </button>
            </div>
            <div class="tpl-sep"><span>o</span></div>
            <form class="tpl-login-form" id="tpl-inline-form" novalidate>
              <label>Email</label>
              <input type="email" name="email" required autocomplete="email" />
              <label>Contraseña</label>
              <input type="password" name="password" required autocomplete="current-password" />
              <button type="submit" class="tpl-btn">Iniciar sesión</button>
              <a class="tpl-btn-outline" href="registro.html?next=reserva.html">Regístrate</a>
              <button type="button" class="tpl-link" id="tpl-reset">¿Has olvidado la contraseña?</button>
              <p class="tpl-login-msg" aria-live="polite"></p>
            </form>
          </div>
        `;

        const form = document.getElementById('tpl-inline-form');
        const msg  = host.querySelector('.tpl-login-msg');
        const btnG = document.getElementById('tpl-google-btn');
        const btnReset = document.getElementById('tpl-reset');

        form.addEventListener('submit', async (e)=>{
          e.preventDefault();
          msg.textContent = 'Accediendo…';
          const email = form.email.value.trim();
          const pass  = form.password.value;
          try{
            await auth.signInWithEmailAndPassword(email, pass);
            msg.textContent = '¡Listo!';
            location.reload();
          }catch(err){
            msg.textContent = (err && err.message) || 'No se pudo iniciar sesión.';
          }
        });

        btnG.addEventListener('click', async (e)=>{
          e.preventDefault();
          msg.textContent = 'Conectando con Google…';
          try{
            const provider = new firebase.auth.GoogleAuthProvider();
            if (isIOS && isSafari) { await auth.signInWithRedirect(provider); }
            else { await auth.signInWithPopup(provider); }
          }catch(err){
            msg.textContent = (err && err.message) || 'No se pudo iniciar con Google.';
          }
        });

        btnReset.addEventListener('click', async (e)=>{
          e.preventDefault();
          const email = form.email.value.trim();
          if(!email){ msg.textContent='Escribe tu email arriba para enviarte el enlace.'; return; }
          try{
            await auth.sendPasswordResetEmail(email);
            msg.textContent = 'Revisa tu correo para restablecer la contraseña.';
          }catch(err){
            msg.textContent = (err && err.message) || 'No se pudo enviar el email.';
          }
        });
      }

      auth.onAuthStateChanged(u=>{ if(!u) renderInlineLogin(); });
    })();
  </script>

  <!-- Guardado en Firestore + EmailJS + Overlay éxito -->
  <script>
    (function(){
      function getCurrentUserId(){
        try{
          const explicit = localStorage.getItem('tpl.currentUser');
          if (explicit) return explicit;
          const uidLS = localStorage.getItem('tpl_auth_uid');
          if (uidLS) return uidLS;
          if (window.firebase && typeof firebase.auth === 'function'){
            const u = firebase.auth().currentUser;
            if (u && !u.isAnonymous && u.uid) return u.uid;
          }
        }catch(_){}
        return 'default';
      }
      function udbKey(uid, key){ return `tpl.udb.${uid}.${key}`; }
      function saveLastReservationLocally(obj){
        try{
          const uid = getCurrentUserId();
          localStorage.setItem(udbKey(uid,'lastReservation'), JSON.stringify(obj));
          localStorage.setItem('tpl.udb.lastChange', String(Date.now()));
        }catch(_){}
      }

      function showSuccessOverlay(form){
        var msg = form?.dataset?.tplSuccess || 'Tu solicitud se ha enviado correctamente.';
        var go  = form?.dataset?.tplRedirect || 'perfil.html';
        var wrap = document.getElementById('tpl-overlay');
        if(!wrap){
          wrap = document.createElement('div');
          wrap.id = 'tpl-overlay';
          wrap.className = 'tpl-overlay';
          wrap.innerHTML = '<div class="tpl-modal" role="dialog" aria-live="polite"><p></p><button type="button" class="cta-button" id="tpl-ov-accept">Aceptar</button></div>';
          document.body.appendChild(wrap);
        }
        wrap.querySelector('.tpl-modal p').textContent = msg;
        wrap.classList.add('on');
        wrap.querySelector('#tpl-ov-accept').onclick = function(){ location.href = go; };
      }

      async function tryEmailJS(fd, extra){
        if(!window.emailjs) return false;
        try{
          var cfg = window.TPL_EMAILJS || {};
          var service  = cfg.serviceId || cfg.service;
          var template = cfg.templateId || (cfg.templates && (cfg.templates.reserva || cfg.templates.booking)) || cfg.templateReserva || cfg.templateBooking || cfg.template;
          var pubKey   = cfg.publicKey || cfg.userId;

          if(service && template){
            var payload = Object.fromEntries(fd.entries());
            Object.assign(payload, extra || {});
            if (pubKey) { await emailjs.send(service, template, payload, pubKey); }
            else { await emailjs.send(service, template, payload); }
            return true;
          }
        }catch(err){
          console.warn('EmailJS error', err);
        }
        return false;
      }

      // (Este bloque mantiene compatibilidad, pero la lógica real de submit la gestiona el "Hotfix" de abajo)
      document.addEventListener('DOMContentLoaded', function () {
        var form = document.getElementById('bookingForm');
        if (!form) return;
        //
