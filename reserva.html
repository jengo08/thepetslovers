<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Reserva · The Pets Lovers</title>

  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Poppins:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <style>
    :root{ --color-principal:#339496; --color-texto:#58425a; --fuente-texto:'Poppins',system-ui,sans-serif; }
    body{ background:#fafafa; font-family:var(--fuente-texto); margin:0; }
    .navbar{position:fixed;top:0;left:0;right:0;z-index:1000;background:#fff;border-bottom:1px solid #eee;display:flex;align-items:center;gap:16px;padding:10px 16px}
    .navbar .logo img{height:42px}
    .navbar .home-button{font-weight:600;color:var(--color-principal);text-decoration:none;border:1px solid #e6f3f3;padding:8px 12px;border-radius:10px}
    .navbar .nav-links{list-style:none;margin:0;padding:0;display:flex;gap:12px;flex:1}
    .navbar .nav-links a{color:#444;text-decoration:none;padding:8px 10px;border-radius:8px}
    .navbar .login-button{margin-left:auto;background:var(--color-principal);color:#fff;text-decoration:none;padding:8px 12px;border-radius:999px;font-weight:700}

    .booking-wrapper{ max-width: 980px; margin: 120px auto 60px; padding: 20px; background: #fff; border:1px solid #eee; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,.05);}
    .booking-header{ text-align:center; margin-bottom: 18px; }
    .booking-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:16px; }
    .booking-field{ display:flex; flex-direction:column; gap:6px; }
    .booking-field label{ font-weight:700; font-size:.95rem; color: var(--color-texto); }
    .booking-field input, .booking-field select, .booking-field textarea{
      padding:10px 12px; border:1px solid #ddd; border-radius:8px; font-family:var(--fuente-texto);
    }
    .booking-actions{ display:flex; gap:12px; justify-content:center; margin-top: 16px; flex-wrap: wrap; }
    .cta-button{background:var(--color-principal);color:#fff;border:none;border-radius:999px;padding:10px 16px;cursor:pointer;font-weight:700}
    .note{ font-size:.95rem; color:#666; text-align:center; margin: 10px 0 0; }

    .auth-wall{ padding:14px; border:1px dashed #bbb; border-radius:10px; text-align:center; background:#fafafa; margin-bottom:16px; }
    .auth-wall strong{ color: var(--color-texto); }
    .disabled{ opacity:.6; pointer-events:none; }

    .booking-field[hidden]{ display:none !important; }
    .tpl-visitas-only{ display:none !important; }
    .tpl-visitas-on .tpl-visitas-only{ display:block !important; }

    .summary-panel{ margin-top: 16px; background:#fafafa; border:1px solid #eee; border-radius:10px; padding:16px; }
    .summary-grid{ display:grid; grid-template-columns: 1fr auto; gap:8px; align-items:center; }
    .summary-row{ display:contents; }
    .summary-label{ color:#555; }
    .summary-value{ font-weight:700; color: var(--color-texto); text-align:right; }
    .summary-muted{ color:#999; font-weight:400; }
    .summary-total{ border-top:1px solid #e7e7e7; margin-top:8px; padding-top:8px; font-size:1.05rem; }

    .tpl-actions{ display:grid; grid-template-columns: 1fr auto 1fr; align-items:center; gap:12px; width:100%; }
    .tpl-actions .tpl-spacer{ display:block; }
    .tpl-actions .tpl-help{ font-size:.9rem; padding:8px 10px; border:2px solid var(--color-principal); color:var(--color-principal); background:#fff; border-radius:8px; justify-self:end; text-decoration:none }

    .travel-bubble{ display:none; margin-top:6px; padding:10px 12px; border:1px dashed #bbb; border-radius:10px; background:#f9f9f9; color:#666; text-align:left;}

    .tpl-section{ margin-top: 18px; }
    .tpl-section h2{ margin: 6px 0 8px; font-size:1.15rem; }

    #location{ width:100%; max-width:100%; }

    /* Login inline (si no has iniciado sesión) */
    .tpl-login-card{border:1px solid #eee;border-radius:12px;padding:16px;background:#fff;max-width:520px;margin:14px auto 0;box-shadow:0 2px 12px rgba(0,0,0,.05)}
    .tpl-login-title{margin:0 0 8px;color:#58425a;font-weight:700;font-size:1.05rem;text-align:center}
    .tpl-socials{display:grid;gap:10px;margin-bottom:8px}
    .tpl-btn-social{display:flex;align-items:center;justify-content:center;gap:8px;border:1px solid #ddd;border-radius:999px;padding:10px 14px;background:#fff;cursor:pointer;font-weight:600;color:var(--color-principal)}
    .tpl-btn-social i{font-size:1rem}
    .tpl-sep{position:relative;text-align:center;margin:6px 0 8px;color:#999;font-size:.9rem}
    .tpl-sep span{background:#fff;padding:0 8px;position:relative;z-index:1}
    .tpl-sep::before{content:"";position:absolute;left:0;right:0;top:50%;height:1px;background:#eee}
    .tpl-login-form{display:grid;gap:8px}
    .tpl-login-form label{font-size:.9rem;color:#58425a}
    .tpl-login-form input{border:1px solid #ddd;border-radius:10px;padding:10px 12px;font-size:1rem}
    .tpl-btn{background:#339496;color:#fff;border:none;border-radius:999px;padding:10px 14px;cursor:pointer;font-weight:600}
    .tpl-btn-outline{background:#fff;color:#339496;border:1px solid #339496;border-radius:999px;padding:10px 14px;cursor:pointer;font-weight:600}
    .tpl-link{background:none;border:none;color:#339496;text-decoration:underline;cursor:pointer;padding:6px 0;justify-self:center}
    .tpl-login-msg{min-height:1.2em;text-align:center;color:#58425a;margin-top:4px}

    .tpl-overlay{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:9999; }
    .tpl-overlay.on{ display:flex; }
    .tpl-modal{ background:#fff; padding:20px; border-radius:12px; max-width:520px; box-shadow:0 8px 30px rgba(0,0,0,.2); text-align:center; }
    .tpl-modal p{ margin:0 0 12px; }

    /* Footer simple (se inyecta en la PARTE 5, estilos aquí) */
    footer.site-footer{background:#fff;border-top:1px solid #eee;padding:24px 16px;margin-top:40px}
    footer.site-footer .inner{max-width:980px;margin:0 auto;color:#666;display:grid;gap:10px}
    footer.site-footer a{color:var(--color-principal);text-decoration:none}
  </style>
</head>
<body>

  <!-- Navbar fija (no dependemos de inyección externa para evitar “no sale lo de arriba”) -->
  <nav class="navbar" aria-label="Principal">
    <div class="logo">
      <a href="index.html"><img src="images/logo.png.png" alt="The Pets Lovers"></a>
    </div>
    <a href="index.html" class="home-button">Inicio</a>
    <ul class="nav-links">
      <li><a href="como-funciona.html">Cómo funciona</a></li>
      <li><a href="servicios.html">Servicios</a></li>
      <li><a href="index.html#contactanos">Contáctanos</a></li>
      <li><a href="index.html#hazte-cuidador">Conviértete en cuidador</a></li>
    </ul>
    <a class="login-button" href="#iniciar-sesion">Iniciar sesión</a>
  </nav>

  <div class="booking-wrapper">
    <div class="booking-header">
      <h1>Reserva tu servicio</h1>
      <p>Selecciona el servicio y la fecha. Para completar la reserva es necesario iniciar sesión y tener los datos de tu mascota guardados.</p>
    </div>

    <!-- Muro de autenticación (solo informativo, el formulario NO se bloquea) -->
    <div id="authWall" class="auth-wall" role="region" aria-label="Acceso">
      <p><strong>Para reservar debes estar registrada o iniciar sesión.</strong></p>
      <p class="note">Cuando accedas, el formulario se activará automáticamente.</p>
      <div id="tpl-inline-login"></div>
    </div>

    <!-- Formulario -->
    <form
      id="bookingForm"
      novalidate
      data-tpl-type="reserva"
      data-tpl-success="Tu reserva se ha enviado. Podrás ver su estado en tu panel."
      data-tpl-redirect="perfil.html"
      data-tpl-wait="800"
    >
      <!-- ===== Datos del servicio ===== -->
      <section class="tpl-section" aria-labelledby="sec-servicio">
        <h2 id="sec-servicio">Datos del servicio</h2>
        <div class="booking-grid">
          <div class="booking-field">
            <label for="service">Servicio</label>
            <select id="service" name="Servicio" required>
              <option value="">Elige un servicio…</option>
              <option value="visitas">Visitas a domicilio (gatos)</option>
              <option value="paseos">Paseos</option>
              <option value="guarderia">Guardería de día</option>
              <option value="alojamiento">Alojamiento (por día)</option>
              <option value="bodas">Bodas y servicios exclusivos</option>
              <option value="postquirurgico">Postquirúrgico</option>
              <option value="transporte">Transporte</option>
              <option value="exoticos">Exóticos</option>
            </select>
          </div>

          <div class="booking-field">
            <label for="startDate">Fecha de inicio</label>
            <input type="date" id="startDate" name="Fecha_inicio" required>
          </div>
          <div class="booking-field">
            <label for="endDate">Fecha de fin</label>
            <input type="date" id="endDate" name="Fecha_fin" required>
          </div>

          <div class="booking-field">
            <label for="start">Hora de inicio</label>
            <input type="time" id="start" name="Hora_inicio" required>
          </div>
          <div class="booking-field">
            <label for="end">Hora de fin</label>
            <input type="time" id="end" name="Hora_fin" required>
          </div>

          <div class="booking-field" id="fieldNumPets">
            <label for="numPets">Nº de mascotas</label>
            <select id="numPets" name="N_mascotas">
              <option value="1">1</option><option value="2">2</option>
              <option value="3">3</option><option value="4">4</option>
              <option value="5">5</option><option value="6+">6+</option>
            </select>
            <input type="number" id="numPetsExact" name="N_mascotas_exactas" min="6" step="1" placeholder="Indica cuántas" style="display:none;margin-top:6px;">
          </div>

          <div class="booking-field" id="fieldSpecies">
            <label for="species">Tipo de animal</label>
            <select id="species" name="Tipo_animal">
              <option value="perro">Perro</option>
              <option value="gato">Gato</option>
              <option value="otros">Otros</option>
            </select>
          </div>

          <!-- SOLO visitas (gatos) -->
          <div class="booking-field tpl-visitas-only" id="fieldVisitDuration" hidden>
            <label for="visitDuration">Duración de la visita (gatos)</label>
            <select id="visitDuration" name="Visita_duracion">
              <option value="60">60 minutos</option>
              <option value="90">90 minutos</option>
            </select>
          </div>
          <div class="booking-field tpl-visitas-only" id="fieldVisitDaily" hidden>
            <label for="visitDaily">Visitas diarias</label>
            <select id="visitDaily" name="Visitas_diarias">
              <option value="1">1 visita/día</option>
              <option value="2">2 visitas/día (2ª es medicación)</option>
            </select>
          </div>

          <div class="booking-field" id="fieldIsPuppy">
            <label for="isPuppy">¿Es cachorro (≤ 6 meses)?</label>
            <select id="isPuppy" name="Cachorro" disabled title="Se calcula automáticamente según la edad de tu mascota">
              <option value="no" selected>No</option>
              <option value="si">Sí</option>
            </select>
          </div>
        </div>
      </section>

      <!-- ===== Mascotas ===== -->
      <section class="tpl-section" aria-labelledby="sec-mascotas">
        <h2 id="sec-mascotas">Mascotas</h2>
        <div class="booking-grid" id="petsContainer"></div>
        <datalist id="tplPetNamesList"></datalist>

        <div class="booking-actions" style="justify-content:flex-start;margin-top:6px">
          <button type="button" class="tpl-btn-outline" id="tpl-open-petpicker">
            <i class="fa-solid fa-list-check"></i> Elegir de mis mascotas
          </button>
        </div>
      </section>

      <!-- ===== Datos de la persona ===== -->
      <section class="tpl-section" aria-labelledby="sec-titular">
        <h2 id="sec-titular">Datos de la persona titular</h2>
        <div class="booking-grid">
          <div class="booking-field">
            <label for="firstName">Nombre y Apellidos</label>
            <input type="text" id="firstName" name="Nombre" placeholder="Tu nombre" autocomplete="given-name" required>
          </div>
          <div class="booking-field">
            <label for="location">Dirección</label>
            <div class="tpl-addr-wrap">
              <input type="text" id="location" name="Direccion" placeholder="Calle y número, piso…" autocomplete="street-address" required>
              <div id="tplAddrSuggest" class="tpl-addr-suggest" role="listbox" aria-label="Sugerencias de direcciones"></div>
            </div>
          </div>

          <div class="booking-field">
            <label for="region">Comunidad Autónoma</label>
            <select id="region" name="CCAA" required>
              <option value="" disabled hidden>Selecciona tu CCAA…</option>
              <option value="madrid" selected>Comunidad de Madrid</option>
              <option value="andalucia">Andalucía</option>
              <option value="aragon">Aragón</option>
              <option value="asturias">Asturias</option>
              <option value="baleares">Illes Balears</option>
              <option value="canarias">Canarias</option>
              <option value="cantabria">Cantabria</option>
              <option value="castilla-la-mancha">Castilla-La Mancha</option>
              <option value="castilla-y-leon">Castilla y León</option>
              <option value="cataluna">Cataluña</option>
              <option value="valenciana">Comunitat Valenciana</option>
              <option value="extremadura">Extremadura</option>
              <option value="galicia">Galicia</option>
              <option value="la-rioja">La Rioja</option>
              <option value="melilla">Melilla</option>
              <option value="murcia">Región de Murcia</option>
              <option value="navarra">Navarra</option>
              <option value="euskadi">País Vasco</option>
              <option value="ceuta">Ceuta</option>
              <option value="nacional">Solo festivos nacionales</option>
            </select>
          </div>
          <div class="booking-field">
            <label for="postalCode">Código Postal</label>
            <input type="text" id="postalCode" name="CP" placeholder="Ej. 28001" inputmode="numeric" pattern="[0-9]{5}" autocomplete="postal-code" required>
          </div>

          <div class="booking-field">
            <label for="email">Email</label>
            <input type="email" id="email" name="Email" placeholder="Tu correo electrónico" autocomplete="email">
          </div>
          <div class="booking-field">
            <label for="phone">Teléfono</label>
            <input type="tel" id="phone" name="Telefono" placeholder="Tu número de teléfono" autocomplete="tel">
          </div>

          <div class="booking-field" style="grid-column: 1 / -1;">
            <label>¿Por dónde prefieres que contactemos?</label>
            <div>
              <label><input type="radio" name="Preferencia_contacto" value="telefono"> Teléfono</label>
              <label style="margin-left:12px;"><input type="radio" name="Preferencia_contacto" value="whatsapp"> WhatsApp</label>
              <label style="margin-left:12px;"><input type="radio" name="Preferencia_contacto" value="email"> Email</label>
              <label style="margin-left:12px;"><input type="radio" name="Preferencia_contacto" value="cualquiera" checked> Cualquiera</label>
            </div>
          </div>

          <div class="booking-field">
            <label for="contactTime">¿A qué hora prefieres que te contactemos?</label>
            <input type="time" id="contactTime" name="Hora_preferida_contacto">
          </div>

          <div class="booking-field" style="grid-column: 1 / -1;">
            <label for="needTravel">¿Necesitas desplazamiento?</label>
            <select id="needTravel" name="Desplazamiento">
              <option value="no">No</option>
              <option value="si">Sí</option>
            </select>
            <div id="travelBubble" class="travel-bubble">
              <i class="fa-solid fa-circle-info"></i>
              El desplazamiento se cobrará cuando asignemos al cuidador/a más cercano y adecuado.
              <br>Este importe quedará <strong>pendiente</strong> en la factura final.
            </div>
          </div>

          <div class="booking-field" style="grid-column: 1 / -1;">
            <label for="notes">Notas (opcional)</label>
            <textarea id="notes" name="Notas" rows="3" placeholder="Rutinas, medicación, instrucciones…"></textarea>
          </div>
        </div>
      </section>

      <!-- ===== Desglose ===== -->
      <div class="summary-panel" id="summary">
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
          <strong>Desglose preliminar</strong>
        </div>
        <div class="summary-grid">
          <div class="summary-row">
            <div class="summary-label">Precio base</div>
            <div class="summary-value"><span id="sumBase">—</span> €</div>
          </div>

          <!-- NUEVA FILA: Precio bono (oculta por defecto; se mostrará si hay bono) -->
          <div class="summary-row" id="rowBonoBase" style="display:none;">
            <div class="summary-label">Precio bono</div>
            <div class="summary-value"><span id="sumBonoBase">0.00</span> €</div>
          </div>

          <div class="summary-row" id="rowVisit1" style="display:none;">
            <div class="summary-label">1ª visita (60/90)</div>
            <div class="summary-value"><span id="sumVisit1">0.00</span> €</div>
          </div>
          <div class="summary-row" id="rowVisit2" style="display:none;">
            <div class="summary-label">2ª visita (medicación)</div>
            <div class="summary-value"><span id="sumVisit2">0.00</span> €</div>
          </div>

          <div class="summary-row">
            <div class="summary-label">Suplementos por mascotas</div>
            <div class="summary-value"><span id="sumPets">0.00</span> €</div>
          </div>

          <!-- ETIQUETA ACTUALIZADA: Festivos auton./nacionales (auto) -->
          <div class="summary-row">
            <div class="summary-label">Festivos auton./nacionales (auto)</div>
            <div class="summary-value"><span id="sumFestivo">0.00</span> €</div>
          </div>

          <div class="summary-row">
            <div class="summary-label">Días especiales (auto)</div>
            <div class="summary-value"><span id="sumSenalado">0.00</span> €</div>
          </div>

          <div class="summary-row">
            <div class="summary-label">Desplazamiento</div>
            <div class="summary-value"><span id="sumTravel" class="summary-muted">—</span></div>
          </div>

          <!-- Descuento bono (guardería y paseos cuando aplique) -->
          <div class="summary-row" id="rowBono" style="display:none;">
            <div class="summary-label">Bono (descuento)</div>
            <div class="summary-value">−<span id="sumBono">0.00</span> €</div>
          </div>

          <div class="summary-row summary-total">
            <div class="summary-label">Subtotal (sin desplazamiento)</div>
            <div class="summary-value"><span id="sumSubtotal">—</span> €</div>
          </div>
          <div class="summary-row">
            <div class="summary-label">Depósito a retener</div>
            <div class="summary-value"><span id="sumDeposit">—</span> €</div>
          </div>
        </div>
        <p class="note" style="margin-top:10px;">
          Este cálculo es orientativo. El importe por kilometraje se añade al confirmar el cuidador más cercano.
          El desplazamiento se mostrará como <strong>pendiente</strong> sólo si lo marcas y no se suma al subtotal.
          El depósito se retiene y se captura tras aceptar la reserva.
        </p>
      </div>

      <!-- Hidden para email -->
      <input type="hidden" name="Desglose" id="summaryField">
      <input type="hidden" name="Mascotas_lista" id="petsListHidden">
      <input type="hidden" name="Mascotas_detalle" id="petsDetail">
      <input type="hidden" name="Mascotas_detalle_json" id="petsDetailJson">

      <!-- TPL: INICIO BLOQUE NUEVO [Paquete de ocultos para EmailJS: Propietario_*, Mascota_*, Reserva_*] -->
      <div id="tpl-hidden-pack" aria-hidden="true" style="display:none"></div>
      <!-- TPL: FIN BLOQUE NUEVO -->

      <!-- Acciones -->
      <div class="booking-actions tpl-actions">
        <span class="tpl-spacer" aria-hidden="true"></span>
        <button type="submit" class="cta-button">Solicitar reserva</button>
        <a class="tpl-help" href="ayuda.html#reservas" aria-label="Centro de ayuda">Centro de ayuda</a>
      </div>

      <p class="note">Tras enviar, te llamaremos para confirmar detalles. La primera visita con el cuidador es gratuita.</p>
    </form>
  </div>
  <!-- SDKs Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <!-- Init Firebase -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDW73aFuz2AFS9VeWg_linHIRJYN4YMgTk",
      authDomain: "thepetslovers-c1111.firebaseapp.com",
      projectId: "thepetslovers-c1111",
      storageBucket: "thepetslovers-c1111.appspot.com",
      messagingSenderId: "415914577533",
      appId: "1:415914577533:web:0b7a056ebaa4f1de28ab14"
    };
    if (typeof firebase !== 'undefined') {
      if (firebase.apps.length === 0) firebase.initializeApp(firebaseConfig);
      try { firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL); } catch(_){}
    }
  </script>

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script>
    window.TPL_EMAILJS = {
      publicKey: 'L2xAATfVuHJwj4EIV',
      serviceId: 'service_odjqrfl',
      templates: { reserva: 'template_rao5n0c' },
      adminEmail: 'gestion@thepetslovers.es'
    };
    (function(){
      const cfg = window.TPL_EMAILJS || {};
      if (window.emailjs) {
        const pub = cfg.publicKey || cfg.userId || null;
        if (pub) { try{ emailjs.init({ publicKey: pub }); }catch(_){/* noop */} }
      }
    })();
  </script>

  <!-- ===== Precios y bonos ===== -->
  <script>
    const PRICES = {
      // base (transporte base 20 € + km “pendiente”)
      base: { visitas: 22, paseos: 12, guarderia: 15, alojamiento: 30, bodas: 0, postquirurgico: 0, transporte: 20, exoticos: 0 },
      puppyBase: { guarderia: 20, alojamiento: 35 },

      // visitas (gatos)
      visita60: 22, visita90: 30,
      visita60_larga: 18, visita90_larga: 27,
      visitaMed: 12, visitaMed_larga: 10,

      // paseos
      paseoStd: 12,
      paseoExtraPerro: 8,
      // Bonos paseos SOLO a partir de 10 días (clave = nº de días)
      paseoBonos: { 10:115, 15:168, 20:220, 25:270, 30:318 },

      // alojamiento (2º+ perro por día)
      alojSegundoPerroDia: 25,   // hasta 10 días
      alojSegundoPerroD11: 22,   // desde 11 días

      // depósito
      depositPct: 0.30
    };

    // Bonos guardería (precio 1er perro)
    const BUNDLE_GUARDERIA = {
      adult:  { 10: 135, 20: 250, 30: 315 },
      puppy:  { 10: 185, 20: 350, 30: 465 }
    };

    /* Opcional: extras fijos para bonos guardería (2ª/3ª+) → si no defines, se usa 12€/día 2ª y 8€/día 3ª+ × nº días */
    // window.TPL_GUARDERIA_BUNDLE_EXTRAS = {
    //   adult: { 10:{second:120, thirdPlus:80}, 20:{second:240, thirdPlus:160}, 30:{second:360, thirdPlus:240} },
    //   puppy: { 10:{second:120, thirdPlus:80}, 20:{second:240, thirdPlus:160}, 30:{second:360, thirdPlus:240} }
    // };
  </script>

  <!-- ===== Lógica UI + cálculo + autorrelleno ===== -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('bookingForm');
    const wall = document.getElementById('authWall');

    const els = {
      service: byId('service'), region: byId('region'),
      startDate: byId('startDate'), endDate: byId('endDate'),
      start: byId('start'), end: byId('end'),
      address: byId('location'), addrSuggest: byId('tplAddrSuggest'), postalCode: byId('postalCode'),
      species: byId('species'), isPuppy: byId('isPuppy'),
      numPets: byId('numPets'), numPetsExact: byId('numPetsExact'),
      needTravel: byId('needTravel'), travelBubble: byId('travelBubble'),
      visitDuration: byId('visitDuration'), visitDaily: byId('visitDaily'),
      fieldVisitDuration: byId('fieldVisitDuration'), fieldVisitDaily: byId('fieldVisitDaily'),
      firstName: byId('firstName'), lastName: byId('lastName'),
      phone: byId('phone'), email: byId('email'), contactTime: byId('contactTime'),
      petsContainer: byId('petsContainer'), petsListHidden: byId('petsListHidden'), petNamesList: byId('tplPetNamesList'),

      sumBase: byId('sumBase'), sumVisit1: byId('sumVisit1'), sumVisit2: byId('sumVisit2'),
      rowVisit1: byId('rowVisit1'), rowVisit2: byId('rowVisit2'),
      sumPets: byId('sumPets'), sumFestivo: byId('sumFestivo'), sumSenalado: byId('sumSenalado'),
      sumTravel: byId('sumTravel'), sumBono: byId('sumBono'), rowBono: byId('rowBono'),
      sumSubtotal: byId('sumSubtotal'), sumDeposit: byId('sumDeposit'),
      summaryField: byId('summaryField'),
      hiddenPack: byId('tpl-hidden-pack'),
      // nuevos para “Precio bono”
      rowBonoBase: byId('rowBonoBase'),
      sumBonoBase: byId('sumBonoBase')
    };
    function byId(id){ return document.getElementById(id); }
    const qs = (k) => new URLSearchParams(location.search).get(k);
    const currency = (n) => (Math.round((n || 0) * 100) / 100).toFixed(2);

    // ===== Festivos & señalados =====
    const SPECIAL_MMDD = ['12-24','12-25','12-31','01-01'];
    const REGION_TO_COUNTY = {
      andalucia:'ES-AN', aragon:'ES-AR', asturias:'ES-AS', baleares:'ES-IB', canarias:'ES-CN', cantabria:'ES-CB',
      'castilla-la-mancha':'ES-CM', 'castilla-y-leon':'ES-CL', cataluna:'ES-CT', ceuta:'ES-CE', valenciana:'ES-VC',
      extremadura:'ES-EX', galicia:'ES-GA', 'la-rioja':'ES-RI', madrid:'ES-MD', melilla:'ES-ML', murcia:'ES-MC',
      navarra:'ES-NC', euskadi:'ES-PV', nacional:null
    };
    const COUNTY_TO_REGIONKEY = {
      'ES-AN':'AN','ES-AR':'AR','ES-AS':'AS','ES-IB':'IB','ES-CN':'CN','ES-CB':'CB','ES-CM':'CM','ES-CL':'CL','ES-CT':'CT','ES-VC':'VC',
      'ES-EX':'EX','ES-GA':'GA','ES-RI':'RI','ES-MD':'MD','ES-MC':'MC','ES-NC':'NC','ES-PV':'PV','ES-CE':'CE','ES-ML':'ML'
    };

    function mmdd(d){ return `${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
    function ymd(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
    function eachDate(from,to){
      const res=[]; if(!from||!to) return res;
      const d1=new Date(from), d2=new Date(to);
      if(isNaN(d1)||isNaN(d2)||d2<d1) return res;
      const cur=new Date(d1); cur.setHours(0,0,0,0); d2.setHours(0,0,0,0);
      while(cur<=d2){ res.push(new Date(cur)); cur.setDate(cur.getDate()+1); }
      return res;
    }

    const _festivosCache = new Map();
    async function fetchLocalHolidays(year){
      const urls = [`/festivos-es-${year}.json`, `festivos-es-${year}.json`];
      for(const url of urls){
        try{
          const r = await fetch(url, {cache:'no-store'});
          if(!r.ok) continue;
          const data = await r.json();
          const nacional = new Set((data.national || data.nacional || []).map(x => x.date || x));
          const porCcaa = new Map();
          if(data.regions){ Object.entries(data.regions).forEach(([k, arr])=>{ porCcaa.set(k, new Set((arr||[]).map(x => x.date || x))); }); }
          return { nacional, porCcaa, _src:'local' };
        }catch(_){}
      }
      return null;
    }
    async function fetchNagerHolidays(year){
      const r = await fetch(`https://date.nager.at/api/v3/PublicHolidays/${year}/ES`, {cache:'force-cache'});
      if(!r.ok) throw new Error('Nager fail');
      const data = await r.json();
      const nacional = new Set();
      const porCcaa = new Map();
      for(const h of data){
        const date = h.date;
        if(!h.counties || !h.counties.length){ nacional.add(date); }
        else{
          for(const c of h.counties){
            const key = COUNTY_TO_REGIONKEY[c] || c;
            if(!porCcaa.has(key)) porCcaa.set(key, new Set());
            porCcaa.get(key).add(date);
          }
        }
      }
      return { nacional, porCcaa, _src:'nager' };
    }
    async function fetchHolidaysForYear(year){
      if(_festivosCache.has(year)) return _festivosCache.get(year);
      try{
        const raw = localStorage.getItem(`tpl_festivos_${year}`);
        if(raw){
          const parsed = JSON.parse(raw);
          if(parsed?.t && Date.now() - parsed.t <= 24*3600*1000){
            const nacional = new Set(parsed.d || []);
            const porCcaa = new Map((parsed.r || []).map(([k,arr])=>[k, new Set(arr||[])]));
            const cached = {nacional, porCcaa, _src:'localStorage'};
            _festivosCache.set(year, cached); return cached;
          }
        }
      }catch(_){}
      const local = await fetchLocalHolidays(year);
      if(local){ _festivosCache.set(year, local); return local; }
      try{
        const nager = await fetchNagerHolidays(year);
        _festivosCache.set(year, nager);
        try{
          localStorage.setItem(`tpl_festivos_${year}`, JSON.stringify({ t:Date.now(), d:[...nager.nacional], r:[...nager.porCcaa.entries()].map(([k,v])=>[k,[...v]]) }));
        }catch(_){}
        return nager;
      }catch(_){}
      const basic = { nacional: new Set([`${year}-01-06`, `${year}-05-01`, `${year}-08-15`, `${year}-10-12`, `${year}-11-01`, `${year}-12-06`, `${year}-12-08`, `${year}-12-25`]), porCcaa: new Map(), _src:'basic' };
      _festivosCache.set(year, basic); return basic;
    }
    async function calcFestivosAutoAsync(region, start, end){
      const days = eachDate(start, end);
      if(!days.length) return { festivo:0, senalado:0, nDias:0 };
      let festivo = 0, senalado = 0;
      for(const d of days){
        const year = d.getFullYear();
        const iso = ymd(d);
        const pack = await fetchHolidaysForYear(year);
        const county = REGION_TO_COUNTY[region || 'nacional'] || null;
        const regKey = COUNTY_TO_REGIONKEY[county] || county;
        const isNat = !!pack?.nacional?.has(iso);
        const isReg = regKey ? !!(pack?.porCcaa?.get(regKey)?.has(iso) || pack?.porCcaa?.get(county)?.has(iso)) : false;
        const isSpecial = SPECIAL_MMDD.includes(mmdd(d));
        if(isNat || isReg) festivo += 10;  // auton./nacionales
        if(isSpecial) senalado += 30;       // días especiales
      }
      return { festivo, senalado, nDias: days.length };
    }

    // ===== Helpers generales =====
    function debounce(fn, wait=300){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; }
    function getNumMascotas(){
      let n = els.numPets?.value || '1';
      if(n === '6+') n = Math.max(6, parseInt(els.numPetsExact?.value,10) || 6);
      return parseInt(n,10);
    }
    function toggleFields(){
      const svc = els.service?.value;
      const isVisitas = (svc === 'visitas');
      if(form){ form.classList.toggle('tpl-visitas-on', isVisitas); }
      if(els.fieldVisitDuration){ els.fieldVisitDuration.hidden = !isVisitas; }
      if(els.fieldVisitDaily){ els.fieldVisitDaily.hidden = !isVisitas; }
      if(els.visitDuration){ els.visitDuration.disabled = !isVisitas; if(!isVisitas) els.visitDuration.value='60'; }
      if(els.visitDaily){ els.visitDaily.disabled = !isVisitas; if(!isVisitas) els.visitDaily.value='1'; }
      const species = els.species?.value || 'perro';
      const puppyApplies = (svc === 'guarderia' || svc === 'alojamiento') && species !== 'otros' && !isVisitas;
      if(els.isPuppy) els.isPuppy.parentElement.hidden = !puppyApplies;
      if(isVisitas && els.species) els.species.value = 'gato';
    }
    function syncPetsExact(){
      if(els.numPets?.value === '6+'){
        els.numPetsExact.style.display = 'block';
        els.numPetsExact.required = true;
      }else{
        els.numPetsExact.style.display = 'none';
        els.numPetsExact.required = false;
      }
    }

    // ===== Suplementos por mascotas (siempre fuera del “precio base”) =====
    function calcPetSupplements(service, species, nMasc, nDias){
      if (nMasc <= 1) return 0;

      if (service === 'visitas'){
        // Escalonado gatos:
        const extra = nMasc - 1;
        if(extra === 1) return 12 * nDias;
        if(extra === 2) return (8 * 2) * nDias;       // 2 extras → 16 €/día
        if(extra >= 3) return (6 * extra) * nDias;    // 3º+ → 6 €/día por mascota extra
        return 0;
      }

      if (service === 'paseos'){
        const walks = Math.max(1, nDias);
        return Math.max(0, nMasc-1) * (walks * PRICES.paseoExtraPerro);
      }

      if (service === 'guarderia'){
        // Por defecto: 2ª = 12 €/día; 3ª+ = 8 €/día
        let sup = 0;
        if (nMasc >= 2) sup += 12 * nDias;
        if (nMasc >= 3) sup += (nMasc-2) * 8 * nDias;
        return sup;
      }

      if (service === 'alojamiento' && species === 'perro'){
        const extraRate = (nDias>=11) ? PRICES.alojSegundoPerroD11 : PRICES.alojSegundoPerroDia;
        return (nMasc-1) * extraRate * nDias;
      }

      return 0;
    }

    async function calcVisitas(visitDurationMin, dailyVisits, nDias){
      const longStay = (nDias >= 11);
      const price1 = (visitDurationMin === 90) ? (longStay ? PRICES.visita90_larga : PRICES.visita90) : (longStay ? PRICES.visita60_larga : PRICES.visita60);
      const price2 = dailyVisits === 2 ? (longStay ? PRICES.visitaMed_larga : PRICES.visitaMed) : 0;
      return { price1, price2 };
    }

    // ======= RECALC “drop-in” (muestra Base normal, Precio bono y Descuento bono; extras fuera del base) =======
    async function recalc(){
      const svc = els.service?.value || '';
      const species = els.species?.value || 'perro';
      const isVisitas = (svc==='visitas');
      const puppyAllowed = (svc==='alojamiento'||svc==='guarderia') && species!=='otros' && !isVisitas;
      const isPuppy = puppyAllowed && (els.isPuppy?.value==='si');

      const nMasc = getNumMascotas();
      const region = els.region?.value || 'nacional';
      const start = els.startDate?.value;
      const end   = els.endDate?.value;
      const { festivo, senalado, nDias } = await calcFestivosAutoAsync(region, start, end);

      let baseNormal=0, baseApplied=0, bonoBase=null, bonoDesc=0;
      let petSupp=0, visit1=0, visit2=0;

      if (isVisitas){
        const dur = parseInt(els.visitDuration?.value || '60', 10);
        const daily = parseInt(els.visitDaily?.value || '1', 10);
        const perDay = await calcVisitas(dur, daily, nDias);
        visit1 = perDay.price1 * nDias;     // 1ª visita
        visit2 = perDay.price2 * nDias;     // 2ª visita (medicación)
        // Si mantenéis suplemento de más gatos en visitas, dejad esta línea; si no, poned 0
        petSupp = calcPetSupplements('visitas', species, nMasc, nDias) || 0;

      } else if (svc === 'paseos'){
        const walks = Math.max(1, nDias);
        const normalFirst = PRICES.paseoStd * walks;                 // 1er perro sin bono
        const bonoWalks   = PRICES.paseoBonos[walks] || null;        // 1er perro con bono si aplica
        baseNormal = normalFirst;
        if (bonoWalks){
          bonoBase  = bonoWalks;
          bonoDesc  = Math.max(0, normalFirst - bonoWalks);
          baseApplied = bonoBase;
        }else{
          baseApplied = baseNormal;
        }
        // 2º+ perro = suplemento (8 €/paseo) -> fuera del base
        petSupp = Math.max(0, nMasc-1) * (PRICES.paseoExtraPerro * walks);

      } else if (svc === 'guarderia'){
        const perDay = isPuppy ? (PRICES.puppyBase.guarderia ?? PRICES.base.guarderia) : PRICES.base.guarderia;
        baseNormal = perDay * nDias; // 1ª mascota, sin bono
        const table  = isPuppy ? BUNDLE_GUARDERIA.puppy : BUNDLE_GUARDERIA.adult;
        const bundle = table[nDias] || null;
        if (bundle){
          bonoBase  = bundle;                 // 1ª mascota con bono
          bonoDesc  = Math.max(0, baseNormal - bundle);
          baseApplied = bonoBase;
        }else{
          baseApplied = baseNormal;
        }
        // Suplementos fuera del base: 2ª = 12 €/día; 3ª+ = 8 €/día
        if (nMasc>=2) petSupp += 12 * nDias;
        if (nMasc>=3) petSupp += (nMasc-2) * 8 * nDias;

      } else if (svc === 'alojamiento'){
        const rate1 = (nDias>=11) ? (isPuppy ? 32 : 27)
                                   : (isPuppy ? PRICES.puppyBase.alojamiento : PRICES.base.alojamiento);
        baseNormal  = rate1 * nDias;   // 1ª mascota
        baseApplied = baseNormal;
        // 2ª+ perro = suplemento por día (misma para 3º+)
        if (species==='perro' && nMasc>=2){
          const extraRate = (nDias>=11) ? PRICES.alojSegundoPerroD11 : PRICES.alojSegundoPerroDia;
          petSupp += (nMasc-1) * extraRate * nDias;
        }

      } else if (svc === 'transporte'){
        baseNormal = PRICES.base.transporte; // 20€ base + km “pendiente” (no entra en subtotal)
        baseApplied = baseNormal;

      } else {
        baseNormal  = (PRICES.base[svc] || 0) * Math.max(1, nDias || 1);
        baseApplied = baseNormal;
        petSupp     = calcPetSupplements(svc, species, nMasc, nDias) || 0;
      }

      // Subtotal = base aplicado + visitas + suplementos + festivos + especiales − descuento bono
      const subtotal = (baseApplied + visit1 + visit2 + petSupp + festivo + senalado) - bonoDesc;
      const deposit  = subtotal * (PRICES.depositPct || 0.3);

      // UI
      els.sumBase.textContent = (svc==='visitas') ? '—' : (subtotal>0 ? currency(baseNormal) : '—');

      if (bonoBase != null){
        if (els.rowBonoBase) els.rowBonoBase.style.display = '';
        if (els.sumBonoBase) els.sumBonoBase.textContent = currency(bonoBase);
      } else {
        if (els.rowBonoBase) els.rowBonoBase.style.display = 'none';
        if (els.sumBonoBase) els.sumBonoBase.textContent = '0.00';
      }
      els.rowBono.style.display = (bonoDesc > 0) ? '' : 'none';
      els.sumBono.textContent   = currency(bonoDesc);

      els.rowVisit1.style.display = (svc==='visitas') ? '' : 'none';
      els.rowVisit2.style.display = (svc==='visitas' && visit2 > 0) ? '' : 'none';
      els.sumVisit1.textContent = currency(visit1);
      els.sumVisit2.textContent = currency(visit2);

      els.sumPets.textContent     = currency(petSupp);
      els.sumFestivo.textContent  = currency(festivo);
      els.sumSenalado.textContent = currency(senalado);

      els.sumSubtotal.textContent = (subtotal>0) ? currency(subtotal) : '—';
      els.sumDeposit.textContent  = (subtotal>0) ? currency(deposit)  : '—';

      // Desplazamiento: solo mostrar “pendiente” si eligen Sí; nunca suma
      if (els.needTravel?.value === 'si'){ els.sumTravel.textContent = 'pendiente'; }
      else { els.sumTravel.textContent = '—'; }
    }

    async function recalcAll(){ toggleFields(); syncPetsExact(); await recalc(); }

    // Eventos UI que disparan recálculo
    ['change','input'].forEach(ev=>{
      ['service','species','isPuppy','numPets','numPetsExact','region','startDate','endDate','visitDuration','visitDaily','needTravel']
        .forEach(id=>{
          const el = byId(id); if(el) el.addEventListener(ev, recalcAll);
        });
    });

    // Init mínimos
    recalcAll();

    // ===== Autocompletado dirección (OpenStreetMap/Nominatim) =====
    async function searchAddresses(q){
      const url = `https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=6&countrycodes=es&q=${encodeURIComponent(q)}`;
      const r = await fetch(url, { headers: { 'Accept':'application/json' }});
      if(!r.ok) return [];
      return r.json();
    }
    function renderAddrSuggestions(list){
      if(!els.addrSuggest) return;
      if(!list.length){ els.addrSuggest.style.display='none'; els.addrSuggest.innerHTML=''; return; }
      els.addrSuggest.innerHTML = list.map((it)=>(`
        <div class="tpl-addr-item" role="option" tabindex="0" data-raw='${JSON.stringify(it).replace(/'/g,"&#39;")}'>
          ${it.display_name}
        </div>`)).join('');
      els.addrSuggest.style.display = 'block';
      els.addrSuggest.querySelectorAll('.tpl-addr-item').forEach(node=>{
        node.addEventListener('click', ()=> chooseAddr(JSON.parse(node.dataset.raw.replace(/&#39;/g,"'"))));
        node.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') chooseAddr(JSON.parse(node.dataset.raw.replace(/&#39;/g,"'"))); });
      });
    }
    function chooseAddr(item){
      els.address.value = (item?.display_name || '').replace(/, España$/,'');
      const pc = item?.address?.postcode || '';
      if(els.postalCode){ els.postalCode.value = pc; }
      els.addrSuggest.style.display='none';
    }
    const addressInputHandler = (function debounce(fn, wait=380){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; })(async ()=>{
      const q = (els.address?.value || '').trim();
      if(q.length < 4){ renderAddrSuggestions([]); return; }
      try{ renderAddrSuggestions(await searchAddresses(q) || []); }
      catch(_){ renderAddrSuggestions([]); }
    });
    if(els.address){
      els.address.addEventListener('input', addressInputHandler);
      els.address.addEventListener('focus', addressInputHandler);
      document.addEventListener('click', (e)=>{ if(!els.addrSuggest.contains(e.target) && e.target!==els.address){ els.addrSuggest.style.display='none'; }});
    }
  });
  </script>
  <!-- (Sigue en PARTE 3/6) -->
<!-- ========== LOGIN INLINE (si no hay sesión) ========== -->
<script>
(function(){
  if (typeof firebase === 'undefined') return;
  const auth = firebase.auth();
  const isIOS = /iP(ad|hone|od)/i.test(navigator.userAgent);
  const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

  function renderInlineLogin(){
    const host = document.getElementById('tpl-inline-login');
    if(!host) return;
    host.innerHTML = `
      <div class="tpl-login-card" role="region" aria-label="Acceso rápido">
        <h3 class="tpl-login-title">Accede aquí mismo</h3>
        <div class="tpl-socials">
          <button type="button" class="tpl-btn-social" id="tpl-google-btn">
            <i class="fa-brands fa-google"></i> Continuar con Google
          </button>
        </div>
        <div class="tpl-sep"><span>o</span></div>
        <form class="tpl-login-form" id="tpl-inline-form" novalidate>
          <label>Email</label>
          <input type="email" name="email" required autocomplete="email" />
          <label>Contraseña</label>
          <input type="password" name="password" required autocomplete="current-password" />
          <button type="submit" class="tpl-btn">Iniciar sesión</button>
          <a class="tpl-btn-outline" href="registro.html?next=reservas.html">Regístrate</a>
          <button type="button" class="tpl-link" id="tpl-reset">¿Has olvidado la contraseña?</button>
          <p class="tpl-login-msg" aria-live="polite"></p>
        </form>
      </div>
    `;
    const form = document.getElementById('tpl-inline-form');
    const msg  = host.querySelector('.tpl-login-msg');
    const btnG = document.getElementById('tpl-google-btn');
    const btnReset = document.getElementById('tpl-reset');

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      msg.textContent = 'Accediendo…';
      const email = form.email.value.trim();
      const pass  = form.password.value;
      try{
        await auth.signInWithEmailAndPassword(email, pass);
        msg.textContent = '¡Listo!';
        location.reload();
      }catch(err){
        msg.textContent = (err && err.message) || 'No se pudo iniciar sesión.';
      }
    });

    btnG.addEventListener('click', async (e)=>{
      e.preventDefault();
      msg.textContent = 'Conectando con Google…';
      try{
        const provider = new firebase.auth.GoogleAuthProvider();
        if (isIOS && isSafari) { await auth.signInWithRedirect(provider); }
        else { await auth.signInWithPopup(provider); }
      }catch(err){
        msg.textContent = (err && err.message) || 'No se pudo iniciar con Google.';
      }
    });

    btnReset.addEventListener('click', async (e)=>{
      e.preventDefault();
      const email = form.email.value.trim();
      if(!email){ msg.textContent='Escribe tu email arriba para enviarte el enlace.'; return; }
      try{
        await auth.sendPasswordResetEmail(email);
        msg.textContent = 'Revisa tu correo para restablecer la contraseña.';
      }catch(err){
        msg.textContent = (err && err.message) || 'No se pudo enviar el email.';
      }
    });
  }

  // Mostrar mini-login solo si NO hay sesión.
  auth.onAuthStateChanged(u=>{ if(!u) renderInlineLogin(); });
})();
</script>

<!-- ========== ENVÍO: Firestore + EmailJS + overlay de éxito ========== -->
<script>
/* EmailJS helper */
async function tryEmailJS(fd, extra){
  if (!window.emailjs) return false;
  try{
    const cfg = window.TPL_EMAILJS || {};
    const service  = cfg.serviceId || cfg.service;
    const template = (cfg.templates && (cfg.templates.reserva || cfg.templates.booking)) || cfg.templateReserva || cfg.templateBooking || cfg.templateId;
    const pubKey   = cfg.publicKey || cfg.userId;
    const adminTo  = (cfg.adminEmail || '').trim();

    if (!service || !template || !pubKey) return false;

    const payload = Object.fromEntries(fd.entries());
    const subtotalUI = (document.getElementById('sumSubtotal')?.textContent || '').trim();
    const depositoUI = (document.getElementById('sumDeposit')?.textContent || '').trim();
    const resumenUI  = (document.getElementById('summaryField')?.value || '').trim();

    function genId(){ return 'R-' + Date.now().toString(36).toUpperCase().slice(-6) + '-' + Math.random().toString(36).slice(2,6).toUpperCase(); }
    const reservaId = (extra && (extra.reserva_id || extra.doc_id)) || payload.reserva_id || genId();

    const serviceText = document.getElementById('service')?.selectedOptions?.[0]?.text || (payload.Servicio || '');
    const regionText  = document.getElementById('region')?.selectedOptions?.[0]?.text || (payload.CCAA || '');
    const ownerNombre = ((payload.Nombre||'') + ' ' + (payload.Apellidos||'')).trim();

    const baseParams = {
      owner_nombre: ownerNombre,
      owner_nombre_only: payload.Nombre || '',
      owner_apellidos: payload.Apellidos || '',
      owner_email: payload.Email || '',
      owner_telefono: payload.Telefono || '',
      owner_direccion: payload.Direccion || '',
      owner_cp: payload.CP || '',
      owner_ccaa: regionText || '',

      mascotas: payload.Mascotas_lista || '',
      mascotas_detalle: payload.Mascotas_detalle || '',
      mascotas_detalle_json: payload.Mascotas_detalle_json || '[]',

      servicio: serviceText || payload.Servicio || '',
      fecha_inicio: payload.Fecha_inicio || '',
      fecha_fin: payload.Fecha_fin || '',
      hora_inicio: payload.Hora_inicio || '',
      hora_fin: payload.Hora_fin || '',
      subtotal: subtotalUI || payload.Subtotal || payload.subtotal || '',
      deposito: depositoUI || payload.Deposito || payload.deposito || '',
      resumen:  resumenUI || payload.Desglose || payload.Resumen || payload.resumen || '',
      reserva_id: reservaId,

      _estado: (extra && extra._estado) || payload._estado || 'enviada',
      _page:   (extra && extra._page)   || payload._page || location.href
    };

    const recipients = [];
    if (adminTo) recipients.push(adminTo);
    if ((baseParams.owner_email||'').trim()) recipients.push(baseParams.owner_email.trim());
    if (!recipients.length) return false;

    let ok = 0;
    for (const to of recipients){
      const params = { ...baseParams, to_email: to };
      const resp = await emailjs.send(service, template, params, pubKey);
      if (resp && resp.status >= 200 && resp.status < 300) ok++;
    }
    return ok>0;
  }catch(_){ return false; }
}

/* Overlay de éxito simple */
function showSuccessOverlay(){
  const form = document.getElementById('bookingForm');
  const msg = form?.dataset?.tplSuccess || 'Tu solicitud se ha enviado correctamente.';
  const go  = form?.dataset?.tplRedirect || 'perfil.html';
  let wrap = document.getElementById('tpl-overlay');
  if(!wrap){
    wrap = document.createElement('div');
    wrap.id = 'tpl-overlay';
    wrap.className = 'tpl-overlay';
    wrap.innerHTML = '<div class="tpl-modal" role="dialog" aria-live="polite"><p></p><button type="button" class="cta-button" id="tpl-ov-accept">Aceptar</button></div>';
    document.body.appendChild(wrap);
  }
  wrap.querySelector('.tpl-modal p').textContent = msg;
  wrap.classList.add('on');
  wrap.querySelector('#tpl-ov-accept').onclick = function(){ location.href = go; };
}

/* Envío principal: Firestore + EmailJS + overlay */
(function(){
  const form = document.getElementById('bookingForm');
  if (!form) return;

  form.addEventListener('submit', async function (e) {
    e.preventDefault();

    // Construir detalle de mascotas para el email
    try{
      const uid = (firebase?.auth?.().currentUser?.uid) || 'default';
      const key = (k)=>`tpl.udb.${uid}.${k}`;
      const hasPets = localStorage.getItem(key('pets')) !== null;
      let arr = hasPets ? JSON.parse(localStorage.getItem(key('pets'))||'[]') : JSON.parse(localStorage.getItem(key('mascotas'))||'[]');
      if (!Array.isArray(arr)) arr = [];
      const selectedNames = (document.getElementById('petsListHidden')?.value || '').split(',').map(s=>s.trim()).filter(Boolean);
      let chosen = [];
      if (selectedNames.length){ chosen = arr.filter(p => selectedNames.includes((p?.nombre||'').trim())); }
      else if (arr.length === 1){ chosen = [arr[0]]; }

      const rows = chosen.map(p => ({
        Nombre:(p?.nombre||'').trim(), Especie:(p?.especie||p?.tipo||'').trim(), Raza:(p?.raza||p?.tipoExotico||'').trim(),
        Edad:(p?.edad||'').trim(), Peso:(p?.peso||'').trim(), Microchip:(p?.microchip||'').trim(), Esterilizado:(p?.esterilizado||'').trim(),
        Vacunas:(p?.vacunas||'').trim(), Salud:(p?.salud||'').trim(), Tratamiento:(p?.tratamiento||'').trim(), Comportamiento:(p?.comportamiento||'').trim()
      }));
      const text = rows.map(r=>`Mascota: ${r.Nombre} | ${[r.Especie,r.Raza].filter(Boolean).join(' · ')}${r.Microchip? ' | Chip: '+r.Microchip:''}`).join(' || ');
      document.getElementById('petsDetail').value = text;
      document.getElementById('petsDetailJson').value = JSON.stringify(rows);
    }catch(_){}

    const fd = new FormData(form);
    const payload = Object.fromEntries(fd.entries());
    let extra = { _page: location.href, _tipo: 'reserva', _estado: 'enviada' };

    // Guardar en Firestore
    let saved = false;
    try{
      if (firebase?.firestore){
        const db = firebase.firestore();
        const auth = firebase.auth?.();
        const u = auth?.currentUser || null;
        payload._page = location.href; payload._estado = 'enviada';
        if (firebase.firestore.FieldValue) payload._createdAt = firebase.firestore.FieldValue.serverTimestamp();
        if (u) { payload._uid = u.uid; payload._email = u.email || null; }
        const docRef = await db.collection('reservas').add(payload);
        extra.reserva_id = docRef.id; extra.doc_id = docRef.id;
        saved = true;
      }
    }catch(err){ console.warn('No se pudo guardar en Firestore', err); }

    // Enviar por EmailJS
    let mailed = false;
    try{
      mailed = await tryEmailJS(new FormData(form), extra);
    }catch(err){ console.warn('EmailJS falló', err); }

    if (saved || mailed) showSuccessOverlay();
    else alert('No se pudo enviar la reserva. Por favor, inténtalo de nuevo en unos minutos.');
  });
})();
</script>
<!-- (Sigue en PARTE 4/6) -->
<!-- ========== MODAL: Selector de mascotas (UI) ========== -->
<div id="tpl-petpicker" class="tpl-overlay" aria-hidden="true" style="display:none">
  <div class="tpl-modal" role="dialog" aria-labelledby="tpl-petpicker-title">
    <h3 id="tpl-petpicker-title" style="margin-top:0">Elige tus mascotas</h3>
    <div id="tpl-petpicker-list" style="display:grid;gap:10px;max-height:320px;overflow:auto;margin:10px 0"></div>
    <div style="display:flex;gap:8px;justify-content:center;margin-top:10px">
      <button type="button" class="tpl-btn" id="tpl-petpicker-apply">Usar selección</button>
      <button type="button" class="tpl-btn-outline" id="tpl-petpicker-cancel">Cancelar</button>
    </div>
  </div>
</div>

<!-- ========== Lógica del selector de mascotas ========== -->
<script>
(function(){
  'use strict';
  if (window.__TPL_RESERV_PICKER__) return;
  window.__TPL_RESERV_PICKER__ = true;

  function getCurrentUserId(){
    try{
      const u = firebase?.auth?.().currentUser;
      if (u && !u.isAnonymous && u.uid) return u.uid;
    }catch(_){/* noop */}
    return 'default';
  }
  function udbKey(uid, key){ return `tpl.udb.${uid}.${key}`; }
  function udbGet(uid, key, fallback){
    try{ const v = localStorage.getItem(udbKey(uid,key)); return v ? JSON.parse(v) : fallback; }catch(_){ return fallback; }
  }
  const norm = (s)=>String(s||'').trim();

  function getPets(){
    const uid = getCurrentUserId();
    const hasPets = localStorage.getItem(udbKey(uid,'pets')) !== null;
    let arr = hasPets ? (udbGet(uid,'pets',[])||[]) : (udbGet(uid,'mascotas',[])||[]);
    if (!Array.isArray(arr)) arr = [];
    const seen = new Set(), out=[];
    arr.forEach(p=>{
      const key = `${norm(p?.nombre).toLowerCase()}|${norm(p?.microchip).toLowerCase()}|${norm(p?.especie||p?.tipo||'').toLowerCase()}`;
      if (seen.has(key)) return; seen.add(key); out.push(p);
    });
    return out;
  }

  let SELECTED_INDEXES = [];
  function openPetPicker(){
    const pets = getPets();
    if (!pets.length){ alert('No tienes mascotas guardadas todavía. Añádelas desde tu perfil.'); return; }

    const overlay = document.getElementById('tpl-petpicker');
    const list = document.getElementById('tpl-petpicker-list');
    const btnApply = document.getElementById('tpl-petpicker-apply');
    const btnCancel = document.getElementById('tpl-petpicker-cancel');
    if (!overlay || !list || !btnApply || !btnCancel) return;

    list.innerHTML = pets.map((p, i)=>{
      const foto = (typeof p.foto === 'string' && p.foto) ? `<img src="${p.foto}" alt="" style="width:42px;height:42px;object-fit:cover;border-radius:50%;border:1px solid #eee">` : `<span style="width:42px;height:42px;display:inline-flex;align-items:center;justify-content:center;border-radius:50%;border:1px solid #eee;color:#9aa0a6"><i class="fa-solid fa-paw"></i></span>`;
      const raza = norm(p.raza || p.tipoExotico || '');
      const esp  = norm(p.especie || p.tipo || '');
      const sub  = [esp, raza].filter(Boolean).join(' · ');
      const checked = SELECTED_INDEXES.includes(i) ? 'checked' : '';
      return `
        <label style="display:flex;align-items:center;gap:10px;border:1px solid #eee;border-radius:10px;padding:8px 10px">
          <input type="checkbox" class="tpl-petpick" value="${i}" ${checked} style="transform:scale(1.2)">
          ${foto}
          <span style="display:flex;flex-direction:column;line-height:1.25">
            <strong>${norm(p.nombre)||'Sin nombre'}</strong>
            <span style="color:#666;font-size:.92rem">${sub||''}</span>
          </span>
        </label>
      `;
    }).join('');

    function close(){ overlay.classList.remove('on'); overlay.style.display='none'; document.body.style.overflow=''; overlay.setAttribute('aria-hidden','true'); }
    overlay.classList.add('on'); overlay.style.display='flex'; document.body.style.overflow='hidden'; overlay.setAttribute('aria-hidden','false');

    btnCancel.onclick = close;
    overlay.addEventListener('click', (e)=>{ if (e.target === overlay) close(); }, { once:true });

    btnApply.onclick = function(){
      const checks = list.querySelectorAll('.tpl-petpick:checked');
      if (!checks.length){ alert('Selecciona al menos una mascota.'); return; }
      SELECTED_INDEXES = Array.from(checks).map(ch => parseInt(ch.value,10)).filter(n=>!isNaN(n));

      const pets = getPets();
      const names = SELECTED_INDEXES.map(ix => pets[ix]).filter(Boolean).map(p=>norm(p.nombre)).filter(Boolean);

      const numSel = document.getElementById('numPets');
      if (numSel){
        const n = Math.min(5, Math.max(1, names.length));
        numSel.value = String(n);
        numSel.dispatchEvent(new Event('change', { bubbles:true }));
      }

      setTimeout(()=>{
        names.forEach((n, idx)=>{
          const inp = document.getElementById('petName_'+(idx+1));
          if (inp){ inp.value = n; inp.dispatchEvent(new Event('input', { bubbles:true })); }
        });
      }, 120);

      close();
    };
  }

  function attachPickerButton(){
    const btn = document.getElementById('tpl-open-petpicker');
    if (!btn) return;
    btn.addEventListener('click', function(e){ e.preventDefault(); openPetPicker(); });
  }

  function attachSubmitValidator(){
    const form = document.getElementById('bookingForm');
    if (!form) return;
    form.addEventListener('submit', function(e){
      try{
        const uid = getCurrentUserId();
        const hasPets = localStorage.getItem(udbKey(uid,'pets')) !== null;
        const pets = hasPets ? (udbGet(uid,'pets',[])||[]) : (udbGet(uid,'mascotas',[])||[]);
        if (Array.isArray(pets) && pets.length >= 2){
          const list = (document.getElementById('petsListHidden')?.value || '').trim();
          if (!list){
            e.preventDefault();
            e.stopImmediatePropagation();
            alert('Por favor, elige la(s) mascota(s) con el botón “Elegir de mis mascotas”.');
            return false;
          }
        }
      }catch(err){ console.warn('[TPL reservas] validación mascotas:', err); }
    }, true);
  }

  function autoFillSinglePet(){
    const uid = getCurrentUserId();
    const hasPets = localStorage.getItem(udbKey(uid,'pets')) !== null;
    const pets = hasPets ? (udbGet(uid,'pets',[])||[]) : (udbGet(uid,'mascotas',[])||[]);
    if (Array.isArray(pets) && pets.length === 1){
      const name = (pets[0]?.nombre || '').trim();
      const numSel = document.getElementById('numPets');
      if (numSel){
        numSel.value = '1';
        numSel.dispatchEvent(new Event('change', { bubbles:true }));
      }
      setTimeout(()=>{
        const inp = document.getElementById('petName_1');
        if (inp && !inp.value){
          inp.value = name;
          inp.dispatchEvent(new Event('input', { bubbles:true }));
        }
      }, 120);
    }
  }

  function init(){ attachPickerButton(); attachSubmitValidator(); autoFillSinglePet(); }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init); else init();
})();
</script>

<!-- ========== PATCH FINAL: Desglose actualizado (festivos auton./nacionales + precio bono) + RGPD ========== -->
<script>
(function(){
  'use strict';

  // Helpers
  const $ = (id)=>document.getElementById(id);
  const currency = (n)=> (Math.round((n || 0) * 100) / 100).toFixed(2);

  // 1) Cambiar etiqueta de Festivos
  function patchFestivosLabel(){
    try{
      const grid = document.querySelector('.summary-grid');
      if(!grid) return;
      const rows = grid.querySelectorAll('.summary-row');
      rows.forEach(r=>{
        const lbl = r.querySelector('.summary-label');
        if(!lbl) return;
        if (lbl.textContent.trim() === 'Festivos (auto)'){
          lbl.textContent = 'Festivos auton./nacionales (auto)';
        }
      });
    }catch(_){}
  }

  // 2) Insertar fila "Precio bono" debajo de "Precio base" (si no existe)
  function ensurePrecioBonoRow(){
    if ($('rowBonoBase')) return;
    const grid = document.querySelector('.summary-grid');
    if(!grid) return;
    const baseRow = Array.from(grid.children).find(n=>{
      return n.classList?.contains('summary-row') && n.querySelector('.summary-label')?.textContent?.trim() === 'Precio base';
    });
    const row = document.createElement('div');
    row.className = 'summary-row';
    row.id = 'rowBonoBase';
    row.style.display = 'none';
    row.innerHTML = `
      <div class="summary-label">Precio bono</div>
      <div class="summary-value"><span id="sumBonoBase">0.00</span> €</div>
    `;
    // Insertar justo después del base
    if (baseRow && baseRow.nextSibling) grid.insertBefore(row, baseRow.nextSibling);
    else grid.appendChild(row);
  }

  // 3) RGPD (si no estuviera)
  function ensureRGPD(){
    if ($('consent')) return;
    const form = $('bookingForm');
    const actions = form?.querySelector('.tpl-actions');
    if (!form || !actions) return;
    const wrap = document.createElement('div');
    wrap.className = 'booking-field';
    wrap.style.gridColumn = '1 / -1';
    wrap.innerHTML = `
      <label style="display:flex;align-items:flex-start;gap:8px;line-height:1.35">
        <input type="checkbox" id="consent" required style="margin-top:2px">
        <span>He leído y acepto la <a href="privacidad.html" target="_blank" rel="noopener">Política de Privacidad</a>.</span>
      </label>
    `;
    actions.parentNode.insertBefore(wrap, actions);
  }

  // 4) Validación ligera en submit (fechas + RGPD)
  function attachLightValidation(){
    const form = $('bookingForm');
    if (!form) return;
    form.addEventListener('submit', function(ev){
      const s = $('startDate')?.value || '';
      const e = $('endDate')?.value || '';
      const c = $('consent');
      if (s && e){
        const d1 = new Date(s), d2 = new Date(e);
        if (isNaN(d1) || isNaN(d2) || d2<d1){
          ev.preventDefault(); ev.stopImmediatePropagation();
          alert('Revisa las fechas: la fecha fin no puede ser anterior a la de inicio.');
          return false;
        }
      }
      if (!c || !c.checked){
        ev.preventDefault(); ev.stopImmediatePropagation();
        alert('Debes aceptar la Política de Privacidad para continuar.');
        return false;
      }
      return true;
    }, true);
  }

  // 5) Cálculo actualizado (base normal + precio bono + descuento; suplementos fuera del base)
  //    Usa tus PRICES, BUNDLE_GUARDERIA y calcFestivosAutoAsync ya definidos en PARTES anteriores.
  window.tplRecalcSummary = async function(){
    const svc      = $('service')?.value || '';
    const species  = $('species')?.value || 'perro';
    const region   = $('region')?.value || 'nacional';
    const start    = $('startDate')?.value;
    const end      = $('endDate')?.value;
    const isVisitas= (svc === 'visitas');

    const nMasc = (function(){
      let n = $('numPets')?.value || '1';
      if (n==='6+') n = Math.max(6, parseInt($('numPetsExact')?.value || '6', 10) || 6);
      return parseInt(n,10)||1;
    })();

    // Cachorro solo en guardería/alojamiento y no “otros”
    const puppyAllowed = (svc==='alojamiento'||svc==='guarderia') && species!=='otros' && !isVisitas;
    const isPuppy = puppyAllowed && (($('isPuppy')?.value || 'no') === 'si');

    // Festivos (auton./nacionales) + especiales + nDias
    const festFn = (typeof window.calcFestivosAutoAsync === 'function') ? window.calcFestivosAutoAsync : async()=>({ festivo:0, senalado:0, nDias:0 });
    const { festivo, senalado, nDias } = await festFn(region, start, end);

    let baseNormal=0, baseApplied=0, bonoBase=null, bonoDesc=0;
    let petSupp=0, visit1=0, visit2=0;

    // VISITAS (gatos)
    if (isVisitas){
      const longStay = (nDias >= 11);
      const dur   = parseInt($('visitDuration')?.value || '60', 10);
      const daily = parseInt($('visitDaily')?.value || '1', 10);
      const v60  = longStay ? PRICES.visita60_larga : PRICES.visita60;
      const v90  = longStay ? PRICES.visita90_larga : PRICES.visita90;
      const vMed = longStay ? PRICES.visitaMed_larga : PRICES.visitaMed;
      const price1 = (dur===90) ? v90 : v60;
      const price2 = (daily===2) ? vMed : 0;
      visit1 = price1 * nDias;     // 1ª visita
      visit2 = price2 * nDias;     // 2ª visita (medicación)
      // Si mantenéis suplemento extra por más gatos, ajusta aquí (actualmente fuera del base)
      petSupp = 0;
    }
    // PASEOS
    else if (svc === 'paseos'){
      const walks = Math.max(1, nDias);
      const normalFirst = PRICES.paseoStd * walks;                 // 1er perro sin bono
      const bonoWalks   = PRICES.paseoBonos[walks] || null;        // 1er perro con bono
      baseNormal = normalFirst;
      if (bonoWalks){
        bonoBase  = bonoWalks;
        bonoDesc  = Math.max(0, normalFirst - bonoWalks);
        baseApplied = bonoBase;
      }else{
        baseApplied = baseNormal;
      }
      // 2º+ perro = suplemento (8 €/paseo) -> fuera del base
      petSupp = Math.max(0, nMasc-1) * (PRICES.paseoExtraPerro * walks);
    }
    // GUARDERÍA
    else if (svc === 'guarderia'){
      const perDay = isPuppy ? (PRICES.puppyBase.guarderia ?? PRICES.base.guarderia) : PRICES.base.guarderia;
      baseNormal = perDay * nDias; // 1ª mascota, sin bono
      const table  = isPuppy ? BUNDLE_GUARDERIA.puppy : BUNDLE_GUARDERIA.adult;
      const bundle = table[nDias] || null;
      if (bundle){
        bonoBase  = bundle;                 // 1ª mascota con bono
        bonoDesc  = Math.max(0, baseNormal - bundle);
        baseApplied = bonoBase;
      }else{
        baseApplied = baseNormal;
      }
      // Suplementos DIARIOS fuera del base: 2ª = 12 €/día; 3ª+ = 8 €/día (override si define TPL_GUARDERIA_BUNDLE_EXTRAS)
      const ov = (window.TPL_GUARDERIA_BUNDLE_EXTRAS && (window.TPL_GUARDERIA_BUNDLE_EXTRAS[isPuppy?'puppy':'adult']||{})[nDias]) || null;
      const second   = ov?.second ?? (12 * nDias);
      const thirdPlu = ov?.thirdPlus ?? (8 * nDias);
      if (nMasc>=2) petSupp += second;
      if (nMasc>=3) petSupp += (nMasc-2) * thirdPlu;
    }
    // ALOJAMIENTO
    else if (svc === 'alojamiento'){
      const rate1 = (nDias>=11) ? (isPuppy ? 32 : 27)
                                 : (isPuppy ? PRICES.puppyBase.alojamiento : PRICES.base.alojamiento);
      baseNormal  = rate1 * nDias;   // 1ª mascota
      baseApplied = baseNormal;
      // 2º+ perro suplemento por día
      if (species==='perro' && nMasc>=2){
        const extraRate = (nDias>=11) ? PRICES.alojSegundoPerroD11 : PRICES.alojSegundoPerroDia;
        petSupp += (nMasc-1) * extraRate * nDias;
      }
    }
    // TRANSPORTE / otros
    else if (svc === 'transporte'){
      baseNormal = PRICES.base.transporte; // 20€ base (km pendiente fuera)
      baseApplied = baseNormal;
    } else {
      baseNormal  = (PRICES.base[svc] || 0) * Math.max(1, nDias||1);
      baseApplied = baseNormal;
    }

    // Subtotal = base aplicado + visitas + suplementos + festivos + especiales − descuento bono
    const subtotal = (baseApplied + visit1 + visit2 + petSupp + (festivo||0) + (senalado||0)) - (bonoDesc||0);
    const deposit  = subtotal * (PRICES.depositPct || 0.3);

    // ——— Pintado UI
    const rowBonoBase = $('rowBonoBase'), sumBonoBase=$('sumBonoBase');
    const rowBono     = $('rowBono'),     sumBono    = $('sumBono');

    // Precio base (muestra siempre el NORMAL del 1er animal; en visitas = —)
    $('sumBase').textContent = (isVisitas) ? '—' : (subtotal>0 ? currency(baseNormal) : '—');

    // Precio bono (nuevo)
    if (bonoBase != null){
      if (rowBonoBase) rowBonoBase.style.display = '';
      if (sumBonoBase) sumBonoBase.textContent = currency(bonoBase);
    } else {
      if (rowBonoBase) rowBonoBase.style.display = 'none';
      if (sumBonoBase) sumBonoBase.textContent = '0.00';
    }

    // Descuento bono (ya existía)
    if (rowBono) rowBono.style.display = (bonoDesc>0) ? '' : 'none';
    if (sumBono) sumBono.textContent   = currency(bonoDesc||0);

    // Visitas
    const rowV1=$('rowVisit1'), rowV2=$('rowVisit2');
    if (rowV1) rowV1.style.display = isVisitas ? '' : 'none';
    if (rowV2) rowV2.style.display = (isVisitas && visit2>0) ? '' : 'none';
    $('sumVisit1').textContent = currency(visit1);
    $('sumVisit2').textContent = currency(visit2);

    // Suplementos / Festivos / Señalados
    $('sumPets').textContent     = currency(petSupp);
    $('sumFestivo').textContent  = currency(festivo||0);
    $('sumSenalado').textContent = currency(senalado||0);

    // Totales
    $('sumSubtotal').textContent = (subtotal>0) ? currency(subtotal) : '—';
    $('sumDeposit').textContent  = (subtotal>0) ? currency(deposit)  : '—';

    // Desplazamiento: solo “pendiente” si marcan Sí; nunca suma
    const needTravel = $('needTravel')?.value === 'si';
    $('sumTravel').textContent = needTravel ? 'pendiente' : '—';
  };

  // Lanzar parches e iniciar recálculo cuando haya DOM
  function boot(){
    patchFestivosLabel();
    ensurePrecioBonoRow();
    ensureRGPD();
    attachLightValidation();

    // recalcular al inicio y en cambios relevantes
    const again = ()=>window.tplRecalcSummary && window.tplRecalcSummary();
    ['change','input'].forEach(ev=>{
      ['service','species','isPuppy','numPets','numPetsExact','region','startDate','endDate','visitDuration','visitDaily','needTravel']
        .forEach(id=>{ const el=$(id); if(el) el.addEventListener(ev, again); });
    });
    setTimeout(again, 80);
  }

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', boot);
  else boot();
})();
</script>
<!-- (Sigue en PARTE 5/6) -->
<!-- (PARTE 5/6) ===================================================== -->
<!-- ===== Parche seguro de etiquetas del desglose (por si quedaba el texto antiguo) ===== -->
<script>
(function(){
  // Cambia “Festivos (auto)” -> “Festivos auton./nacionales (auto)”
  try{
    var rows = document.querySelectorAll('#summary .summary-row .summary-label');
    rows.forEach(function(lbl){
      var t = (lbl.textContent || '').trim().toLowerCase();
      if (t === 'festivos (auto)'){
        lbl.textContent = 'Festivos auton./nacionales (auto)';
      }
    });
  }catch(_){}
})();
</script>

<!-- ===== Inyector de NAVBAR (fallback si no está tpl-navbar.js externo) ===== -->
<script>
(function(){
  var host = document.getElementById('tpl-navbar');
  if (!host) return;

  // Si ya hay algo (inyectado) no hacemos nada
  if (host.dataset._tplReady === '1') return;

  // Construimos un navbar consistente con tu diseño
  host.innerHTML = `
    <nav class="navbar" style="position:fixed;top:0;left:0;right:0;z-index:1000;background:#fff;border-bottom:1px solid #eee;display:flex;align-items:center;gap:14px;padding:10px 14px">
      <div class="logo" style="display:flex;align-items:center">
        <a href="index.html" style="display:inline-flex;align-items:center;gap:8px;text-decoration:none">
          <img src="images/logo.png.png" alt="The Pets Lovers" style="height:34px;width:auto">
          <strong style="color:#58425a">The Pets Lovers</strong>
        </a>
      </div>
      <a href="index.html" class="home-button" style="margin-left:auto;color:#339496;text-decoration:none;font-weight:600">Inicio</a>
      <ul class="nav-links" style="display:flex;gap:14px;list-style:none;margin:0 10px 0 10px;padding:0">
        <li><a href="como-funciona.html" style="color:#58425a;text-decoration:none">Cómo funciona</a></li>
        <li><a href="servicios.html" style="color:#58425a;text-decoration:none">Servicios</a></li>
        <li><a href="index.html#contactanos" style="color:#58425a;text-decoration:none">Contáctanos</a></li>
        <li><a href="index.html#hazte-cuidador" style="color:#58425a;text-decoration:none">Conviértete en cuidador</a></li>
      </ul>
      <a class="login-button" href="#iniciar-sesion" id="tpl-login-top" style="color:#fff;background:#339496;border-radius:999px;padding:8px 12px;text-decoration:none;font-weight:700">Iniciar sesión</a>
    </nav>
  `;
  host.dataset._tplReady = '1';

  // Si hay sesión, cambiar CTA
  try{
    if (typeof firebase !== 'undefined'){
      firebase.auth().onAuthStateChanged(function(u){
        var btn = document.getElementById('tpl-login-top');
        if (!btn) return;
        if (u){
          btn.textContent = 'Mi perfil';
          btn.href = 'perfil.html';
        }else{
          btn.textContent = 'Iniciar sesión';
          btn.href = '#iniciar-sesion';
        }
      });
    }
  }catch(_){}
})();
</script>

<!-- ===== FOOTER completo ===== -->
<footer id="tpl-footer" style="margin-top:50px;background:#fff;border-top:1px solid #eee">
  <div style="max-width:1100px;margin:0 auto;padding:24px 16px;display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:18px">
    <div>
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
        <img src="images/logo.png.png" alt="The Pets Lovers" style="height:34px;width:auto">
        <strong style="color:#58425a">The Pets Lovers</strong>
      </div>
      <p style="color:#666;line-height:1.5;margin:0">
        Cuidadores de confianza para tus peludos. Reservas seguras y soporte humano.
      </p>
      <p style="margin:10px 0 0;color:#999;font-size:.92rem">© <span id="tpl-year"></span> The Pets Lovers</p>
    </div>

    <div>
      <strong style="color:#58425a">Enlaces</strong>
      <ul style="list-style:none;margin:8px 0 0;padding:0;display:grid;gap:6px">
        <li><a href="index.html" style="text-decoration:none;color:#339496">Inicio</a></li>
        <li><a href="servicios.html" style="text-decoration:none;color:#339496">Servicios</a></li>
        <li><a href="como-funciona.html" style="text-decoration:none;color:#339496">Cómo funciona</a></li>
        <li><a href="ayuda.html" style="text-decoration:none;color:#339496">Centro de ayuda</a></li>
      </ul>
    </div>

    <div>
      <strong style="color:#58425a">Legal</strong>
      <ul style="list-style:none;margin:8px 0 0;padding:0;display:grid;gap:6px">
        <li><a href="privacidad.html" style="text-decoration:none;color:#339496">Privacidad</a></li>
        <li><a href="terminos.html" style="text-decoration:none;color:#339496">Términos y condiciones</a></li>
        <li><a href="cookies.html" style="text-decoration:none;color:#339496">Cookies</a></li>
      </ul>
    </div>

    <div>
      <strong style="color:#58425a">Contacto</strong>
      <ul style="list-style:none;margin:8px 0 0;padding:0;display:grid;gap:6px;color:#666">
        <li><i class="fa-solid fa-envelope"></i> gestion@thepetslovers.es</li>
        <li><i class="fa-brands fa-whatsapp"></i> +34 600 000 000</li>
      </ul>
      <div style="display:flex;gap:10px;margin-top:8px">
        <a href="#" aria-label="Instagram" style="color:#339496"><i class="fa-brands fa-instagram"></i></a>
        <a href="#" aria-label="Facebook" style="color:#339496"><i class="fa-brands fa-facebook"></i></a>
        <a href="#" aria-label="TikTok" style="color:#339496"><i class="fa-brands fa-tiktok"></i></a>
      </div>
    </div>
  </div>
</footer>
<script>
  (function(){ try{ document.getElementById('tpl-year').textContent = String(new Date().getFullYear()); }catch(_){}})();
</script>
<!-- (FIN PARTE 5/6) ================================================ -->
<!-- (PARTE 6/6) ===================================================== -->
<!-- ===== Fixers finales (idempotentes) ===== -->
<script>
(function(){
  // 1) Asegura la fila "Precio bono" justo debajo de "Precio base"
  try{
    var grid = document.querySelector('#summary .summary-grid');
    var baseRow = grid ? grid.querySelector('.summary-row:first-child .summary-label') : null;
    var bonoRow = document.getElementById('rowBonoBase');
    if (grid && baseRow && !bonoRow){
      var wrap = document.createElement('div');
      wrap.className = 'summary-row';
      wrap.id = 'rowBonoBase';
      wrap.style.display = 'none';
      wrap.innerHTML = '<div class="summary-label">Precio bono</div><div class="summary-value"><span id="sumBonoBase">0.00</span> €</div>';

      // Insertar tras la primera fila (Precio base)
      var firstRow = grid.querySelector('.summary-row');
      if (firstRow && firstRow.nextSibling){
        grid.insertBefore(wrap, firstRow.nextSibling);
      } else if (firstRow){
        firstRow.after(wrap);
      } else {
        grid.appendChild(wrap);
      }
    }
  }catch(_){}

  // 2) Asegura el texto “Festivos auton./nacionales (auto)”
  try{
    var labels = document.querySelectorAll('#summary .summary-label');
    labels.forEach(function(el){
      var t = (el.textContent||'').trim().toLowerCase();
      if (t === 'festivos (auto)'){
        el.textContent = 'Festivos auton./nacionales (auto)';
      }
    });
  }catch(_){}

  // 3) Forzar un recálculo al terminar de construir el DOM
  try{
    if (typeof recalc === 'function'){
      recalc();
    } else if (typeof window.updateSummaryFromJS === 'function'){
      window.updateSummaryFromJS();
    }
  }catch(_){}
})();
</script>

<!-- ===== Cierre seguro ===== -->
</body>
</html>
