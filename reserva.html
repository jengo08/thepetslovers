<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Reserva · The Pets Lovers</title>

  <!-- TPL: INICIO BLOQUE NUEVO [Host canónico con guard para desarrollo] -->
  <script>
  (function(){
    var CANON = 'www.thepetslovers.es';
    var host = location.hostname || '';
    var IS_DEV = /^(localhost|127\.0\.0\.1|0\.0\.0\.0)$/i.test(host) || /github\.io$/i.test(host);
    if (host && host !== CANON && !IS_DEV) {
      location.replace(location.protocol + '//' + CANON + location.pathname + location.search + location.hash);
    }
  })();
  </script>
  <!-- TPL: FIN BLOQUE NUEVO -->

  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Poppins:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <!-- Estilos mínimos locales -->
  <style>
    :root{ --color-principal:#339496; --color-texto:#58425a; }
    .booking-wrapper{max-width:980px;margin:120px auto 60px;padding:20px;background:#fff;border:1px solid #eee;border-radius:12px;box-shadow:0 2px 12px rgba(0,0,0,.05)}
    .booking-header{text-align:center;margin-bottom:18px}
    .booking-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px}
    .booking-field{display:flex;flex-direction:column;gap:6px}
    .booking-field label{font-weight:700;font-size:.95rem;color:var(--color-texto)}
    .booking-field input,.booking-field select,.booking-field textarea{padding:10px 12px;border:1px solid #ddd;border-radius:8px;font-family:inherit}
    .booking-actions{display:flex;gap:12px;justify-content:center;margin-top:16px;flex-wrap:wrap}
    .note{font-size:.95rem;color:#666;text-align:center;margin:10px 0 0}
    .auth-wall{padding:14px;border:1px dashed #bbb;border-radius:10px;text-align:center;background:#fafafa;margin-bottom:16px}
    .auth-wall strong{color:var(--color-texto)}
    .disabled{opacity:.6;pointer-events:none}
    .tpl-section{margin-top:18px}
    .tpl-section h2{margin:6px 0 8px;font-size:1.15rem}
    .tpl-overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:9999}
    .tpl-overlay.on{display:flex}
    .tpl-modal{background:#fff;padding:20px;border-radius:12px;max-width:520px;box-shadow:0 8px 30px rgba(0,0,0,.2);text-align:center}
    .tpl-modal p{margin:0 0 12px}
    .tpl-inline-login .tpl-btn{background:var(--color-principal);color:#fff;border:none;border-radius:999px;padding:10px 14px;cursor:pointer;font-weight:600}
    .tpl-inline-login .tpl-btn-outline{background:#fff;color:var(--color-principal);border:1px solid var(--color-principal);border-radius:999px;padding:10px 14px;cursor:pointer;font-weight:600}
  </style>
</head>
<body>

  <!-- Navbar unificada (inyectada) -->
  <div id="tpl-navbar">
    <noscript>
      <nav class="navbar">
        <div class="logo">
          <a href="index.html"><img src="images/logo.png.png" alt="The Pets Lovers"></a>
        </div>
        <a href="index.html" class="home-button">Inicio</a>
        <ul class="nav-links">
          <li><a href="como-funciona.html">Cómo funciona</a></li>
          <li><a href="servicios.html">Servicios</a></li>
          <li><a href="index.html#contactanos">Contáctanos</a></li>
          <li><a href="index.html#hazte-cuidador">Conviértete en cuidador</a></li>
        </ul>
        <!-- TPL: INICIO BLOQUE NUEVO [Fix noscript login → iniciar-sesion con next] -->
        <a class="login-button" href="iniciar-sesion.html?next=reservas.html">Iniciar sesión</a>
        <!-- TPL: FIN BLOQUE NUEVO -->
      </nav>
    </noscript>
  </div>

  <div class="booking-wrapper">
    <div class="booking-header">
      <h1>Reserva tu servicio</h1>
      <p>Para reservar debes iniciar sesión. Tras enviar, recibirás confirmación por email.</p>
    </div>

    <!-- Muro de autenticación + login inline -->
    <div id="authWall" class="auth-wall" aria-live="polite">
      <p><strong>Debes iniciar sesión para enviar una reserva.</strong></p>
      <div id="tpl-inline-login" class="tpl-inline-login"></div>
    </div>

    <!-- Formulario -->
    <form
      id="bookingForm"
      class="disabled"
      novalidate
      data-tpl-success="Tu solicitud se ha enviado correctamente."
      data-tpl-redirect="perfil.html"
      data-tpl-emailjs="true"
      data-service-id="service_odjqrfl"
      data-template-id="template_rao5n0c"
      data-public-key="L2xAATfVuHJwj4EIV"
      data-to-email="gestion@thepetslovers.es"
      data-to-name="Gestión The Pets Lovers"
    >
      <section class="tpl-section" aria-labelledby="sec-servicio">
        <h2 id="sec-servicio">Datos del servicio</h2>
        <div class="booking-grid">
          <div class="booking-field">
            <label for="service">Servicio</label>
            <select id="service" name="Servicio" required>
              <option value="" selected>Elige un servicio…</option>
              <option value="visitas">Visitas a domicilio</option>
              <option value="paseos">Paseos</option>
              <option value="guarderia">Guardería de día</option>
              <option value="alojamiento">Alojamiento</option>
              <option value="bodas">Bodas / exclusivos</option>
            </select>
          </div>
          <div class="booking-field">
            <label for="startDate">Fecha inicio</label>
            <input type="date" id="startDate" name="Fecha_inicio" required>
          </div>
          <div class="booking-field">
            <label for="endDate">Fecha fin</label>
            <input type="date" id="endDate" name="Fecha_fin" required>
          </div>
          <div class="booking-field">
            <label for="start">Hora inicio</label>
            <input type="time" id="start" name="Hora_inicio" required>
          </div>
          <div class="booking-field">
            <label for="end">Hora fin</label>
            <input type="time" id="end" name="Hora_fin" required>
          </div>
        </div>
      </section>

      <section class="tpl-section" aria-labelledby="sec-titular">
        <h2 id="sec-titular">Datos de contacto</h2>
        <div class="booking-grid">
          <div class="booking-field">
            <label for="firstName">Nombre</label>
            <input type="text" id="firstName" name="Nombre" required autocomplete="given-name">
          </div>
          <div class="booking-field">
            <label for="lastName">Apellidos</label>
            <input type="text" id="lastName" name="Apellidos" required autocomplete="family-name">
          </div>
          <div class="booking-field">
            <label for="email">Email</label>
            <input type="email" id="email" name="Email" required autocomplete="email">
          </div>
          <div class="booking-field">
            <label for="phone">Teléfono</label>
            <input type="tel" id="phone" name="Telefono" required autocomplete="tel" inputmode="tel">
          </div>
          <div class="booking-field" style="grid-column:1/-1">
            <label for="notes">Notas (opcional)</label>
            <textarea id="notes" name="Notas" rows="3" placeholder="Rutinas, medicación, horarios…"></textarea>
          </div>
        </div>
      </section>

      <!-- TPL: INICIO BLOQUE NUEVO [Paso 2: contenedor del selector de mascota (solo visible si >1)] -->
      <section class="tpl-section" id="tpl-pet-section" aria-labelledby="sec-mascota" hidden>
        <h2 id="sec-mascota">Tu mascota</h2>
        <div class="booking-grid">
          <div class="booking-field">
            <label for="tpl-pet-select">Selecciona la mascota</label>
            <select id="tpl-pet-select" name="Mascota"></select>
          </div>
        </div>
      </section>
      <!-- TPL: FIN BLOQUE NUEVO -->

      <!-- Resumen para el correo (lo rellena JS) -->
      <input type="hidden" name="Desglose" id="summaryField">

      <!-- Fallback si algún script usa sendForm en lugar de send -->
      <input type="hidden" name="to_email" value="gestion@thepetslovers.es">
      <input type="hidden" name="to_name" value="Gestión The Pets Lovers">

      <!-- TPL: INICIO BLOQUE NUEVO [Campos ocultos para EmailJS + tracking] -->
      <input type="hidden" name="_replyto" id="tpl-replyto">
      <input type="hidden" name="uid" id="tpl-uid">
      <input type="hidden" name="perfil_url" id="tpl-perfil-url">
      <!-- TPL: FIN BLOQUE NUEVO -->

      <!-- TPL: INICIO BLOQUE NUEVO [Hidden con datos de la mascota elegida] -->
      <input type="hidden" name="Mascota_nombre" id="tpl-pet-name">
      <input type="hidden" name="Mascota_especie" id="tpl-pet-species">
      <input type="hidden" name="Mascota_raza" id="tpl-pet-breed">
      <input type="hidden" name="Mascota_tamano" id="tpl-pet-size">
      <input type="hidden" name="Mascota_medicacion" id="tpl-pet-med">
      <input type="hidden" name="Mascota_necesidades" id="tpl-pet-needs">
      <input type="hidden" name="Mascota_id" id="tpl-pet-id">
      <!-- TPL: FIN BLOQUE NUEVO -->

      <div class="booking-actions">
        <button type="submit" class="cta-button">Solicitar reserva</button>
      </div>

      <p class="note">El envío requiere sesión iniciada. Te confirmaremos por email.</p>
    </form>
  </div>

  <!-- Footer unificado (inyectado) -->
  <div id="tpl-footer">
    <noscript>…</noscript>
  </div>

  <!-- Mini-injectors -->
  <script src="tpl-navbar.js" defer></script>
  <script src="tpl-footer.js" defer></script>

  <!-- Firebase SDKs (SIN defer, antes del init y del reservas.js) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <!-- Inicialización de Firebase -->
  <script>
    (function(){
      const firebaseConfig = {
        apiKey: "AIzaSyDW73aFuz2AFS9VeWg_linHIRJYN4YMgTk",
        authDomain: "thepetslovers-c1111.firebaseapp.com",
        projectId: "thepetslovers-c1111",
        storageBucket: "thepetslovers-c1111.appspot.com",
        messagingSenderId: "415914577533",
        appId: "1:415914577533:web:0b7a056ebaa4f1de28ab14"
      };
      if (typeof firebase !== 'undefined') {
        if (firebase.apps.length === 0) firebase.initializeApp(firebaseConfig);
        try { firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL); } catch(_){}
      }
    })();
  </script>

  <!-- EmailJS + init -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script>
    window.TPL_EMAILJS = {
      serviceId: 'service_odjqrfl',
      templateId: 'template_rao5n0c',
      publicKey:  'L2xAATfVuHJwj4EIV',
      toEmail: 'gestion@thepetslovers.es',
      toName:  'Gestión The Pets Lovers'
    };
    (function(){
      const cfg = window.TPL_EMAILJS || {};
      if (window.emailjs && (cfg.publicKey||cfg.userId)) {
        try{ emailjs.init({ publicKey: cfg.publicKey || cfg.userId }); }catch(_){}
      }
    })();
  </script>

  <!-- TPL: INICIO BLOQUE NUEVO [Config fija de página de login] -->
  <script>window.TPL_LOGIN_PAGE = 'iniciar-sesion.html';</script>
  <!-- TPL: FIN BLOQUE NUEVO -->

  <!-- TPL: INICIO BLOQUE NUEVO [Bootstrap Auth unificado + builder de login URL + muro] -->
  <script>
  (function(){
    'use strict';
    var DEBUG = /[?&]debugAuth=1\b/.test(location.search);
    function $(sel, root){ return (root||document).querySelector(sel); }
    var LOGIN_CANDIDATES = ['iniciar-sesion.html','iniciar-sesión.html','login.html'];
    function getLoginBase(){ return window.TPL_LOGIN_PAGE || LOGIN_CANDIDATES[0]; }
    function buildNext(){ var p=(location.pathname||'').replace(/^\//,''); return p+(location.search||'')+(location.hash||''); }
    function buildLoginUrl(nextOverride){ var base=getLoginBase(); var next=nextOverride||buildNext(); return base+'?next='+encodeURIComponent(next); }

    window.__TPL_AUTH__ = window.__TPL_AUTH__ || { user:null, ready:null };

    function setupAuthBridge(){
      if (typeof firebase === 'undefined' || !firebase.auth) return;
      var auth = firebase.auth();
      if (!window.__TPL_AUTH__.ready) {
        window.__TPL_AUTH__.ready = new Promise(function(resolve){
          var first = true;
          function handle(user){
            window.__TPL_AUTH__.user = user || null;
            try {
              document.body.setAttribute('data-auth', user ? 'in' : 'out');
              if (user && !user.isAnonymous){
                localStorage.setItem('tpl_auth_email', user.email || '');
                localStorage.setItem('tpl_auth_uid',   user.uid   || '');
              } else {
                localStorage.removeItem('tpl_auth_email');
                localStorage.removeItem('tpl_auth_uid');
              }
            } catch(_e){}
            try { window.dispatchEvent(new CustomEvent('tpl-auth-change', { detail:{ email: user ? (user.email||null) : null } })); } catch(_e){}
            if (first) { first=false; try { window.dispatchEvent(new CustomEvent('tpl-auth-ready', { detail:{ user:user||null } })); } catch(_e){} resolve(user||null); }
            if (DEBUG) console.log('[TPL][Auth] Estado:', user ? user.uid : null);
            updateUI(user);
          }
          auth.onAuthStateChanged(handle);
          handle(auth.currentUser);
        });
      } else {
        window.__TPL_AUTH__.ready.then(updateUI);
      }
    }

    function updateUI(user){
      var wall = $('#authWall');
      var form = $('#bookingForm');
      var slot = $('#tpl-inline-login');
      if (!wall || !form) return;

      if (user) {
        wall.style.display = 'none';
        form.classList.remove('disabled');
        var email = $('#email'); if (user.email && email && !email.value) email.value = user.email;
        var name  = $('#firstName');
        if (user.displayName && name && !name.value) {
          var dn = String(user.displayName).trim();
          name.value = dn.split(' ')[0] || dn;
        }
      } else {
        wall.style.display = 'block';
        form.classList.add('disabled');
        if (slot && !slot.hasChildNodes()) {
          var loginUrl = buildLoginUrl();
          slot.innerHTML =
            '<a class="tpl-btn" href="'+ loginUrl +'">Iniciar sesión</a> '+
            '<a class="tpl-btn-outline" href="index.html#iniciar-sesion">Volver al inicio</a>';
        }
        if (window.TPL_REQUIRE_LOGIN_ON_RESERVAS === true) {
          location.href = buildLoginUrl();
        }
      }
    }

    setupAuthBridge();
    var tries=0, t=setInterval(function(){
      tries++;
      if (window.__TPL_AUTH__ && window.__TPL_AUTH__.ready) { clearInterval(t); return; }
      setupAuthBridge();
      if (tries > 30) clearInterval(t);
    }, 100);
  })();
  </script>
  <!-- TPL: FIN BLOQUE NUEVO -->

  <!-- TPL: INICIO BLOQUE NUEVO [Auto-recovery IMG *.png.png → *.png] -->
  <script>
  (function(){
    window.addEventListener('error', function(e){
      var el = e.target;
      if (!el || !el.tagName) return;
      if (el.tagName === 'IMG' && /(\.png\.png)(\?.*)?$/i.test(el.src||'')) {
        var fixed = el.src.replace(/\.png\.png/i, '.png');
        el.onerror = null;
        el.src = fixed;
      }
    }, true);
  })();
  </script>
  <!-- TPL: FIN BLOQUE NUEVO -->

  <!-- TPL: INICIO BLOQUE NUEVO [Login page redirect por ?next= (solo en iniciar-sesion.html)] -->
  <script>
  (function(){
    if (!/\/iniciar-sesion\.html$/i.test((location.pathname||''))) return;
    if (typeof firebase === 'undefined' || !firebase.auth) return;
    var auth = firebase.auth();
    function qs(k){ try { return new URLSearchParams(location.search).get(k); } catch(_){ return null; } }
    var NEXT = qs('next') || 'perfil.html';
    auth.onAuthStateChanged(function(user){
      if (user && !user.isAnonymous) { location.replace(NEXT); }
    });
  })();
  </script>
  <!-- TPL: FIN BLOQUE NUEVO -->

  <!-- TPL: INICIO BLOQUE NUEVO [Paso 1: Autocomplete titular + hidden reply_to/uid + forzar login (+ Fallback Firestore)] -->
  <script>
  (function(){
    'use strict';
    window.TPL_REQUIRE_LOGIN_ON_RESERVAS = true; // siempre requiere login

    var DEBUG = /[?&]debugReservas=1\b/.test(location.search);
    var $ = function(sel, root){ return (root||document).querySelector(sel); };

    function getProfileHref(){
      var a = document.getElementById('tpl-login-link');
      if (a && /perfil/.test((a.getAttribute('href')||''))) return a.getAttribute('href');
      return 'perfil.html';
    }

    function udbKey(uid, key){ return 'tpl.udb.' + uid + '.' + key; }
    function udbGet(uid, key){
      try{ var raw = localStorage.getItem(udbKey(uid, key)); return raw ? JSON.parse(raw) : null; }catch(_){ return null; }
    }

    // 🧠 Split robusto
    function splitFullName(full){
      if (!full) return { nombre:'', apellidos:'' };
      var s = String(full).trim().replace(/\s+/g,' ');
      if (!s) return { nombre:'', apellidos:'' };
      var parts = s.split(' ');
      if (parts.length === 1) return { nombre: parts[0], apellidos: '' };
      return { nombre: parts[0], apellidos: parts.slice(1).join(' ') };
    }

    function setIfEmpty(input, val){ if (input && !input.value && val) input.value = val; }

    function fillFromOwner(owner){
      if (!owner) return;
      var n = owner.nombre || owner.name || owner.nombreCompleto || owner.fullName || '';
      var a = owner.apellidos || owner.surnames || '';
      if (!a && n && (n.includes(' ') || /,/.test(n))) {
        var sp = splitFullName(n); n = sp.nombre; a = sp.apellidos;
      }
      setIfEmpty($('#firstName'), n || '');
      setIfEmpty($('#lastName'),  a || '');
      setIfEmpty($('#email'),     owner.email || '');
      setIfEmpty($('#phone'),     owner.telefono || owner.phone || '');
      if (DEBUG) console.log('[TPL][Perfil] Rellenado desde', owner.__src || 'desconocido', owner);
    }

    function syncHidden(user){
      var hidReply = $('#tpl-replyto');
      var hidUid   = $('#tpl-uid');
      var hidProf  = $('#tpl-perfil-url');
      if (hidUid && user && user.uid) hidUid.value = user.uid;
      if (hidProf) hidProf.value = getProfileHref();
      var inputEmail = $('#email');
      var emailVal = (inputEmail && inputEmail.value) ? inputEmail.value : (user && user.email) || '';
      if (hidReply) hidReply.value = emailVal;
    }

    function bindReplySync(){
      var email = $('#email');
      var hidReply = $('#tpl-replyto');
      if (!email || !hidReply) return;
      email.addEventListener('input', function(){ hidReply.value = email.value || ''; });
    }

    // ===== Fallback Firestore (perfil) =====
    /* TPL: INICIO SUBBLOQUE NUEVO [Firestore perfil] */
    async function loadOwnerFromFirestore(uid){
      try{
        if (typeof firebase === 'undefined' || !firebase.firestore) return null;
        var db = firebase.firestore();
        var candidates = ['owners','propietarios','profiles','usuarios'];
        for (var i=0;i<candidates.length;i++){
          var col = candidates[i];
          try{
            var snap = await db.collection(col).doc(uid).get();
            if (snap.exists){
              var d = snap.data() || {};
              d.__src = 'fs:'+col;
              return d;
            }
          }catch(e){ /* silencio */ }
        }
      }catch(e){ /* silencio */ }
      return null;
    }
    /* TPL: FIN SUBBLOQUE NUEVO */

    function onAuthReady(cb){
      if (window.__TPL_AUTH__ && window.__TPL_AUTH__.ready) {
        window.__TPL_AUTH__.ready.then(cb);
      } else {
        window.addEventListener('tpl-auth-ready', function(ev){
          cb(ev.detail && ev.detail.user ? ev.detail.user : null);
        }, { once:true });
      }
    }

    onAuthReady(async function(user){
      try{
        var uid = user && user.uid;
        var filled = false;

        // 1) UDB local
        if (uid){
          var owner = udbGet(uid, 'owner') || udbGet(uid, 'propietario');
          if (owner){ fillFromOwner(owner); filled = true; }
        }

        // 2) Firebase Auth
        if (user){
          if (user.email) setIfEmpty($('#email'), user.email);
          if ($('#firstName') && !$('#firstName').value || $('#lastName') && !$('#lastName').value){
            var sp = splitFullName(user.displayName || '');
            if (sp.nombre || sp.apellidos){ setIfEmpty($('#firstName'), sp.nombre); setIfEmpty($('#lastName'), sp.apellidos); filled = true; }
          }
        }

        // 3) Firestore (si sigue faltando algo)
        if (uid && (!$('#firstName').value || !$('#lastName').value || !$('#email').value || !$('#phone').value)){
          var fsOwner = await loadOwnerFromFirestore(uid);
          if (fsOwner){ fillFromOwner(fsOwner); filled = true; }
        }

        if (DEBUG) console.log('[TPL][Perfil] filled?', filled);

      }catch(_){}

      syncHidden(user);
      bindReplySync();
    });

    window.addEventListener('tpl-auth-change', function(){
      var user = (window.__TPL_AUTH__ && window.__TPL_AUTH__.user) || null;
      syncHidden(user);
    });
  })();
  </script>
  <!-- TPL: FIN BLOQUE NUEVO -->

  <!-- TPL: INICIO BLOQUE NUEVO [Paso 2: Selector de mascota con UDB (auto si 1; select si >1) + Fallback Firestore] -->
  <script>
  (function(){
    'use strict';
    var DEBUG = /[?&]debugReservas=1\b/.test(location.search);
    var $ = function(sel, root){ return (root||document).querySelector(sel); };

    function udbKey(uid, key){ return 'tpl.udb.' + uid + '.' + key; }
    function udbGet(uid, key){
      try{ var raw = localStorage.getItem(udbKey(uid, key)); return raw ? JSON.parse(raw) : null; }catch(_){ return null; }
    }

    function normalizePet(p){
      if (!p) return null;
      var id  = p.id || p.uid || p._id || p.chip || p.chipid || p.microchip || null;
      var nombre = p.nombre || p.name || p.petName || '';
      var especie = p.especie || p.tipo || p.species || p.type || '';
      var raza = p.raza || p.breed || '';
      var tam = p.tamano || p.tamaño || p.size || '';
      var meds = p.medicacion || p.medicación || p.medication || '';
      var needs = p.necesidades || p.needs || p.specialNeeds || '';
      return { id:id, nombre:nombre, especie:especie, raza:raza, tamano:tam, medicacion:meds, necesidades:needs, _raw:p };
    }
    function toArrayMaybe(objOrArr){
      if (!objOrArr) return [];
      if (Array.isArray(objOrArr)) return objOrArr;
      return Object.keys(objOrArr).map(function(k){ return Object.assign({id:k}, objOrArr[k]); });
    }

    function loadPetsFromUdb(uid){
      var arr = [];
      var p1 = udbGet(uid, 'pets');
      var p2 = udbGet(uid, 'mascotas');
      var raw = p1 || p2 || [];
      toArrayMaybe(raw).forEach(function(p){
        var n = normalizePet(p);
        if (n && (n.nombre || n.id)) arr.push(n);
      });
      return arr;
    }

    // ===== Fallback Firestore (mascotas) =====
    /* TPL: INICIO SUBBLOQUE NUEVO [Firestore mascotas] */
    async function loadPetsFromFirestore(uid){
      var list = [];
      try{
        if (typeof firebase === 'undefined' || !firebase.firestore) return list;
        var db = firebase.firestore();
        var profileCols = ['owners','propietarios','profiles','usuarios'];
        // 1) subcolecciones 'mascotas' o 'pets' dentro del perfil
        for (var i=0;i<profileCols.length;i++){
          var col = profileCols[i];
          try{
            var docRef = db.collection(col).doc(uid);
            var sub1 = await docRef.collection('mascotas').get().catch(()=>null);
            if (sub1 && !sub1.empty){
              sub1.forEach(function(doc){ var n=normalizePet(Object.assign({id:doc.id}, doc.data())); if(n) list.push(n); });
            }
            var sub2 = await docRef.collection('pets').get().catch(()=>null);
            if (sub2 && !sub2.empty){
              sub2.forEach(function(doc){ var n=normalizePet(Object.assign({id:doc.id}, doc.data())); if(n) list.push(n); });
            }
            // 2) arrays/campos en el doc
            var main = await docRef.get().catch(()=>null);
            if (main && main.exists){
              var d = main.data()||{};
              toArrayMaybe(d.mascotas).forEach(function(p){ var n=normalizePet(p); if(n) list.push(n); });
              toArrayMaybe(d.pets).forEach(function(p){ var n=normalizePet(p); if(n) list.push(n); });
            }
            if (list.length) return list;
          }catch(e){ /* silencio */ }
        }
      }catch(e){ /* silencio */ }
      return list;
    }
    /* TPL: FIN SUBBLOQUE NUEVO */

    function applySinglePet(p){
      $('#tpl-pet-section') && ($('#tpl-pet-section').hidden = true);
      $('#tpl-pet-id')      && ($('#tpl-pet-id').value = p.id || '');
      $('#tpl-pet-name')    && ($('#tpl-pet-name').value = p.nombre || '');
      $('#tpl-pet-species') && ($('#tpl-pet-species').value = p.especie || '');
      $('#tpl-pet-breed')   && ($('#tpl-pet-breed').value = p.raza || '');
      $('#tpl-pet-size')    && ($('#tpl-pet-size').value = p.tamano || '');
      $('#tpl-pet-med')     && ($('#tpl-pet-med').value = p.medicacion || '');
      $('#tpl-pet-needs')   && ($('#tpl-pet-needs').value = p.necesidades || '');
      if (DEBUG) console.log('[TPL][Mascota] única aplicada:', p);
      // Intento suave de refrescar el resumen
      try{ document.getElementById('summaryField') && document.getElementById('summaryField').dispatchEvent(new Event('change')); }catch(_){}
    }

    function labelFor(p){
      var bits = [];
      if (p.especie) bits.push(p.especie);
      if (p.raza) bits.push(p.raza);
      var meta = bits.length ? ' (' + bits.join(', ') + ')' : '';
      return (p.nombre || 'Mascota') + meta;
    }

    function rememberLast(uid, petId){
      try{ localStorage.setItem(udbKey(uid,'lastPetId'), String(petId||'')); }catch(_){}
    }
    function recallLast(uid){
      try{ return localStorage.getItem(udbKey(uid,'lastPetId')) || null; }catch(_){ return null; }
    }

    function applyMultiplePets(uid, pets){
      var sec = $('#tpl-pet-section');
      var sel = $('#tpl-pet-select');
      if (!sec || !sel) return;
      sel.innerHTML = '';

      var last = recallLast(uid);
      pets.forEach(function(p){
        var opt = new Option(labelFor(p), p.id || p.nombre || '');
        opt.dataset.pet = JSON.stringify(p);
        sel.appendChild(opt);
        if (last && (last === (p.id || p.nombre))) opt.selected = true;
      });

      sec.hidden = false;

      function syncFromSelect(){
        var o = sel.options[sel.selectedIndex];
        if (!o) return;
        var p = null;
        try{ p = JSON.parse(o.dataset.pet || '{}'); }catch(_){}
        if (!p) return;
        applySinglePet(p);
        rememberLast(uid, p.id || p.nombre || '');
      }
      sel.addEventListener('change', syncFromSelect);
      syncFromSelect();
      if (DEBUG) console.log('[TPL][Mascotas] selector pintado con', pets.length, 'opciones');
    }

    function onAuthReady(cb){
      if (window.__TPL_AUTH__ && window.__TPL_AUTH__.ready) {
        window.__TPL_AUTH__.ready.then(cb);
      } else {
        window.addEventListener('tpl-auth-ready', function(ev){
          cb(ev.detail && ev.detail.user ? ev.detail.user : null);
        }, { once:true });
      }
    }

    onAuthReady(async function(user){
      var uid = user && user.uid;
      if (!uid) return;

      // 1) UDB
      var pets = loadPetsFromUdb(uid);

      // 2) Firestore si no hay
      if (!pets.length){
        var fsPets = await loadPetsFromFirestore(uid);
        if (fsPets && fsPets.length) pets = fsPets;
      }

      if (!pets.length){
        // Limpia hidden y oculta sección
        ['tpl-pet-id','tpl-pet-name','tpl-pet-species','tpl-pet-breed','tpl-pet-size','tpl-pet-med','tpl-pet-needs'].forEach(function(id){
          var el = document.getElementById(id); if (el) el.value = '';
        });
        $('#tpl-pet-section') && ($('#tpl-pet-section').hidden = true);
        if (DEBUG) console.log('[TPL][Mascotas] no hay datos');
        return;
      }

      if (pets.length === 1){ applySinglePet(pets[0]); }
      else { applyMultiplePets(uid, pets); }
    });

    // Si otra pestaña cambia las mascotas en UDB
    window.addEventListener('storage', function(ev){
      if (!ev || !ev.key || !/\.mascotas$|\.pets$/.test(ev.key)) return;
      var user = (window.__TPL_AUTH__ && window.__TPL_AUTH__.user) || null;
      if (!user) return;
      var uid = user.uid;
      var pets = loadPetsFromUdb(uid);
      if (pets.length === 1) applySinglePet(pets[0]);
      if (pets.length > 1)  applyMultiplePets(uid, pets);
    });
  })();
  </script>
  <!-- TPL: FIN BLOQUE NUEVO -->

  <!-- TPL: INICIO BLOQUE NUEVO [Paso 3: Validaciones suaves + Desglose vivo + Teléfono ES] -->
  <script>
  (function(){
    'use strict';
    var $ = function(sel, root){ return (root||document).querySelector(sel); };
    var form = $('#bookingForm');
    if (!form) return;

    var LEAD_HOURS = (typeof window.TPL_RESERVAS_LEAD_HOURS === 'number') ? window.TPL_RESERVAS_LEAD_HOURS : 24;

    function parseDate(d){ if(!d) return null; var p=d.split('-'); if(p.length!==3) return null; return new Date(+p[0], +p[1]-1, +p[2], 12, 0, 0, 0); }
    function parseTime(t){ if(!t) return null; var p=t.split(':'); if(p.length<2) return null; return {h:+p[0], m:+p[1]}; }
    function combine(dt, tm){ if(!dt||!tm) return null; var d=new Date(dt); d.setHours(tm.h, tm.m, 0, 0); return d; }
    function fmtDate(d){ return d.toLocaleDateString('es-ES', {weekday:'short', day:'2-digit', month:'2-digit', year:'numeric'}); }
    function fmtTime(d){ return d.toLocaleTimeString('es-ES', {hour:'2-digit', minute:'2-digit'}); }

    function cleanPhone(s){
      if (!s) return '';
      return String(s).replace(/[\s\-().]/g,'').replace(/^(\+34)(34)/,'$1');
    }
    function validPhoneES(s){
      var x = cleanPhone(s);
      if (/^\+34\d{9}$/.test(x)) return true;
      if (/^\d{9}$/.test(x))     return true;
      return false;
    }

    var elService   = $('#service');
    var elSD        = $('#startDate');
    var elED        = $('#endDate');
    var elST        = $('#start');
    var elET        = $('#end');
    var elPhone     = $('#phone');
    var elEmail     = $('#email');
    var elNotes     = $('#notes');
    var elSummary   = $('#summaryField');

    function validateDates(){
      elSD.setCustomValidity('');
      elED.setCustomValidity('');
      elST.setCustomValidity('');
      elET.setCustomValidity('');

      var sd = parseDate(elSD.value);
      var ed = parseDate(elED.value);
      var st = parseTime(elST.value);
      var et = parseTime(elET.value);
      if (!sd || !ed || !st || !et) return true;

      var sDT = combine(sd, st);
      var eDT = combine(ed, et);

      if (eDT < sDT){
        elED.setCustomValidity('La fecha/hora de fin debe ser posterior a la de inicio.');
        elET.setCustomValidity('La fecha/hora de fin debe ser posterior a la de inicio.');
        return false;
      }

      if (sd.getFullYear()===ed.getFullYear() && sd.getMonth()===ed.getMonth() && sd.getDate()===ed.getDate()){
        if (eDT <= sDT){
          elET.setCustomValidity('Para el mismo día, la hora fin debe ser mayor que la hora inicio.');
          return false;
        }
      }

      var now = new Date();
      var minStart = new Date(now.getTime() + LEAD_HOURS*3600*1000);
      if (sDT < minStart){
        elSD.setCustomValidity('La reserva debe pedirse con al menos '+LEAD_HOURS+'h de antelación.');
        elST.setCustomValidity('La reserva debe pedirse con al menos '+LEAD_HOURS+'h de antelación.');
        return false;
      }
      return true;
    }

    function validatePhone(){
      elPhone.setCustomValidity('');
      var val = elPhone.value.trim();
      if (!val) return true;
      if (!validPhoneES(val)){
        elPhone.setCustomValidity('Introduce un teléfono válido (9 dígitos, admite prefijo +34).');
        return false;
      }
      return true;
    }

    function currentPetText(){
      var name  = document.getElementById('tpl-pet-name')?.value || '';
      var spec  = document.getElementById('tpl-pet-species')?.value || '';
      var breed = document.getElementById('tpl-pet-breed')?.value || '';
      var bits = [];
      if (name) bits.push(name);
      var meta = [spec, breed].filter(Boolean).join(', ');
      if (meta) bits.push('('+meta+')');
      return bits.join(' ');
    }

    function buildSummary(){
      var sd = parseDate(elSD.value), ed=parseDate(elED.value);
      var st = parseTime(elST.value), et=parseTime(elET.value);
      var sDT = (sd && st) ? combine(sd, st) : null;
      var eDT = (ed && et) ? combine(ed, et) : null;

      var parts = [];
      var svc = elService.value ? elService.options[elService.selectedIndex].text : '';
      if (svc) parts.push('Servicio: '+svc);
      if (sDT) parts.push('Inicio: ' + fmtDate(sDT) + ' ' + fmtTime(sDT));
      if (eDT) parts.push('Fin: '    + fmtDate(eDT) + ' ' + fmtTime(eDT));

      var pet = currentPetText(); if (pet) parts.push('Mascota: ' + pet);
      var notes = (elNotes && elNotes.value.trim()) ? ('Notas: ' + elNotes.value.trim()) : '';
      if (notes) parts.push(notes);

      elSummary.value = parts.join(' • ');
    }

    [elService, elSD, elED, elST, elET, elNotes].forEach(function(el){
      if (!el) return;
      el.addEventListener('change', function(){ validateDates(); buildSummary(); });
      el.addEventListener('input',  function(){ validateDates(); buildSummary(); });
    });
    if (elPhone){
      elPhone.addEventListener('input', validatePhone);
      elPhone.addEventListener('blur',  validatePhone);
    }
    document.addEventListener('DOMContentLoaded', buildSummary);

    form.addEventListener('submit', function(){
      validatePhone();
      validateDates();
      buildSummary();
    }, true);

  })();
  </script>
  <!-- TPL: FIN BLOQUE NUEVO -->

  <!-- Lógica de reservas (tuya, intacta) -->
  <script src="reservas.js" defer></script>
</body>
</html>
