<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Reserva · The Pets Lovers</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Poppins:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <style>
    .booking-wrapper{ max-width: 980px; margin: 120px auto 60px; padding: 20px; background: #fff; border:1px solid #eee; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,.05);}
    .booking-header{ text-align:center; margin-bottom: 18px; }
    .booking-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:16px; }
    .booking-field{ display:flex; flex-direction:column; gap:6px; }
    .booking-field label{ font-weight:700; font-size:.95rem; color: var(--color-texto); }
    .booking-field input, .booking-field select, .booking-field textarea{
      padding:10px 12px; border:1px solid #ddd; border-radius:8px; font-family:var(--fuente-texto);
    }
    .booking-actions{ display:flex; gap:12px; justify-content:center; margin-top: 16px; }
    .note{ font-size:.95rem; color:#666; text-align:center; margin: 10px 0 0; }
    .auth-wall{ padding:14px; border:1px dashed #bbb; border-radius:10px; text-align:center; background:#fafafa; margin-bottom:16px; }
    .auth-wall strong{ color: var(--color-texto); }
    .disabled{ opacity:.6; pointer-events:none; }

    /* TPL: INICIO BLOQUE NUEVO [Desglose de pago] */
    .summary-panel{ margin-top: 16px; background:#fafafa; border:1px solid #eee; border-radius:10px; padding:16px; }
    .summary-grid{ display:grid; grid-template-columns: 1fr auto; gap:8px; align-items:center; }
    .summary-row{ display:contents; }
    .summary-label{ color:#555; }
    .summary-value{ font-weight:700; color: var(--color-texto); text-align:right; }
    .summary-muted{ color:#999; font-weight:400; }
    .summary-total{ border-top:1px solid #e7e7e7; margin-top:8px; padding-top:8px; font-size:1.05rem; }
    .summary-badge{ display:inline-block; font-size:.85rem; padding:2px 8px; border-radius:999px; border:1px dashed #bbb; color:#666; }
    /* TPL: FIN BLOQUE NUEVO */

    /* TPL: INICIO BLOQUE NUEVO [Pequeños detalles] */
    .readonly-chip{ background:#f2f8f8; border:1px dashed #cfe7e7; border-radius:8px; padding:10px 12px; font-size:.95rem; }
    .inline{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    /* TPL: FIN BLOQUE NUEVO */
  </style>
</head>
<body>

  <!-- Navbar unificada (inyectada) -->
  <div id="tpl-navbar">
    <noscript>
      <nav class="navbar">
        <div class="logo">
          <a href="index.html"><img src="images/logo.png.png" alt="The Pets Lovers"></a>
        </div>
        <a href="index.html" class="home-button">Inicio</a>
        <ul class="nav-links">
          <li><a href="como-funciona.html">Cómo funciona</a></li>
          <li><a href="servicios.html">Servicios</a></li>
          <li><a href="index.html#contactanos">Contáctanos</a></li>
          <li><a href="index.html#hazte-cuidador">Conviértete en cuidador</a></li>
        </ul>
        <a class="login-button" href="#iniciar-sesion">Iniciar sesión</a>
      </nav>
    </noscript>
  </div>

  <div class="booking-wrapper">
    <div class="booking-header">
      <h1>Reserva tu servicio</h1>
      <p>Selecciona el servicio y la fecha. Para completar la reserva es necesario iniciar sesión y tener los datos de tu mascota guardados.</p>
    </div>

    <!-- Muro de autenticación -->
    <div id="authWall" class="auth-wall">
      <p><strong>Para reservar debes estar registrada o iniciar sesión.</strong></p>
      <div class="booking-actions">
        <a href="login.html?next=reserva.html" class="cta-button" id="btnLogin">Iniciar sesión</a>
        <a href="registro.html?next=reserva.html" class="cta-button" id="btnRegister" style="background:#fff;color:var(--color-principal);border:2px solid var(--color-principal);">Registrarme</a>
      </div>
      <p class="note">Cuando actives tu cuenta, podrás completar la reserva desde aquí.</p>
    </div>

    <!-- Formulario de reserva -->
    <!-- TPL: INICIO BLOQUE NUEVO [Conexión Formspree – endpoint ya configurado] -->
    <form id="bookingForm" class="disabled" novalidate action="https://formspree.io/f/mdkdvlpr" method="POST">
    <!-- TPL: FIN BLOQUE NUEVO -->

      <div class="booking-grid">
        <div class="booking-field">
          <label for="service">Servicio</label>
          <select id="service" name="Servicio" required>
            <option value="">Elige un servicio…</option>
            <option value="visitas">Visitas a domicilio (gatos)</option>
            <option value="paseos">Paseos</option>
            <option value="guarderia">Guardería de día</option>
            <option value="alojamiento">Alojamiento (por día)</option>
            <option value="bodas">Bodas y servicios exclusivos</option>
          </select>
        </div>

        <!-- TPL: INICIO BLOQUE NUEVO [CCAA para autonómicos] -->
        <div class="booking-field">
          <label for="region">Comunidad Autónoma</label>
          <select id="region" name="CCAA">
            <option value="madrid" selected>Comunidad de Madrid</option>
            <option value="andalucia">Andalucía</option>
            <option value="aragon">Aragón</option>
            <option value="asturias">Asturias</option>
            <option value="baleares">Illes Balears</option>
            <option value="canarias">Canarias</option>
            <option value="cantabria">Cantabria</option>
            <option value="castilla-la-mancha">Castilla-La Mancha</option>
            <option value="castilla-y-leon">Castilla y León</option>
            <option value="cataluna">Cataluña</option>
            <option value="valenciana">Comunitat Valenciana</option>
            <option value="extremadura">Extremadura</option>
            <option value="galicia">Galicia</option>
            <option value="la-rioja">La Rioja</option>
            <option value="melilla">Melilla</option>
            <option value="murcia">Región de Murcia</option>
            <option value="navarra">Navarra</option>
            <option value="euskadi">País Vasco</option>
            <option value="ceuta">Ceuta</option>
            <option value="nacional">Solo festivos nacionales</option>
          </select>
        </div>
        <!-- TPL: FIN BLOQUE NUEVO -->

        <!-- TPL: INICIO BLOQUE NUEVO [Fechas inicio/fin] -->
        <div class="booking-field">
          <label for="date">Fecha de inicio</label>
          <input type="date" id="date" name="Fecha_inicio" required>
        </div>
        <div class="booking-field">
          <label for="dateEnd">Fecha de fin</label>
          <input type="date" id="dateEnd" name="Fecha_fin">
        </div>
        <!-- TPL: FIN BLOQUE NUEVO -->

        <div class="booking-field">
          <label for="start">Hora de inicio</label>
          <input type="time" id="start" name="Hora_inicio" required>
        </div>

        <div class="booking-field">
          <label for="end">Hora de fin</label>
          <input type="time" id="end" name="Hora_fin" required>
        </div>

        <div class="booking-field">
          <label for="location">Lugar</label>
          <input type="text" id="location" name="Lugar" placeholder="Dirección o zona">
        </div>

        <!-- TPL: INICIO BLOQUE NUEVO [Tipo animal, nº mascotas y cachorro] -->
        <div class="booking-field" id="fieldSpecies" hidden>
          <label for="species">Tipo de animal</label>
          <select id="species" name="Tipo_animal">
            <option value="perro">Perro</option>
            <option value="gato">Gato</option>
            <option value="otros">Otros</option>
          </select>
        </div>

        <div class="booking-field" id="fieldIsPuppy" hidden>
          <label for="isPuppy">¿Es cachorro (≤ 6 meses)?</label>
          <select id="isPuppy" name="Cachorro">
            <option value="no">No</option>
            <option value="si">Sí</option>
          </select>
        </div>

        <div class="booking-field" id="fieldNumPets" hidden>
          <label for="numPets">Nº de mascotas</label>
          <select id="numPets" name="N_mascotas">
            <option value="1">1</option><option value="2">2</option>
            <option value="3">3</option><option value="4">4</option>
            <option value="5">5</option>
            <option value="6+">6+</option>
          </select>
          <!-- TPL: INICIO BLOQUE NUEVO [Nº exacto >6] -->
          <input id="numPetsExact" name="N_mascotas_exactas" type="number" min="6" step="1" placeholder="¿Cuántas en total?" style="margin-top:6px; display:none;">
          <!-- TPL: FIN BLOQUE NUEVO -->
        </div>
        <!-- TPL: FIN BLOQUE NUEVO -->

        <!-- TPL: INICIO BLOQUE NUEVO [Preferencia de contacto] -->
        <div class="booking-field">
          <label for="contactPref">¿Cómo prefieres que te contactemos?</label>
          <select id="contactPref" name="Preferencia_contacto">
            <option value="whatsapp">WhatsApp</option>
            <option value="telefono">Teléfono</option>
            <option value="email">Email</option>
          </select>
        </div>
        <!-- TPL: FIN BLOQUE NUEVO -->

        <!-- TPL: INICIO BLOQUE NUEVO [Datos cliente autocompletados] -->
        <div class="booking-field" style="grid-column:1/-1;">
          <label>Tu información (desde tu cuenta)</label>
          <div class="readonly-chip inline">
            <span id="uiName">Nombre: —</span>
            <span id="uiEmail">Email: —</span>
            <span id="uiPhone">Tel.: —</span>
          </div>
        </div>
        <input type="hidden" id="custName" name="Cliente_nombre">
        <input type="hidden" id="custEmail" name="Cliente_email">
        <input type="hidden" id="custPhone" name="Cliente_telefono">
        <!-- TPL: FIN BLOQUE NUEVO -->

        <!-- Campos festivo/señalado AUTOMÁTICOS (ocultos) -->
        <!-- TPL: INICIO BLOQUE NUEVO [Festivos automáticos ocultos] -->
        <input type="hidden" id="festivo" name="Festivo" value="0">
        <input type="hidden" id="senalado" name="Dia_senalado" value="0">
        <!-- TPL: FIN BLOQUE NUEVO -->

        <div class="booking-field" style="grid-column: 1 / -1;">
          <label for="notes">Notas (opcional)</label>
          <textarea id="notes" name="Notas" rows="3" placeholder="Rutinas, medicación, instrucciones…"></textarea>
        </div>
      </div>

      <!-- Resumen / Desglose -->
      <div class="summary-panel" id="summary">
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
          <strong>Desglose preliminar</strong>
          <span class="summary-badge">El kilómetraje se añade al asignar cuidador</span>
        </div>
        <div class="summary-grid">
          <div class="summary-row">
            <div class="summary-label">Precio base</div>
            <div class="summary-value"><span id="sumBase">—</span> €</div>
          </div>
          <div class="summary-row">
            <div class="summary-label">Suplementos por mascotas</div>
            <div class="summary-value"><span id="sumPets">0.00</span> €</div>
          </div>
          <div class="summary-row">
            <div class="summary-label">Festivo (auto)</div>
            <div class="summary-value"><span id="sumFestivo">0.00</span> €</div>
          </div>
          <div class="summary-row">
            <div class="summary-label">Día señalado (auto)</div>
            <div class="summary-value"><span id="sumSenalado">0.00</span> €</div>
          </div>
          <div class="summary-row">
            <div class="summary-label">Desplazamiento</div>
            <div class="summary-value summary-muted">pendiente</div>
          </div>
          <div class="summary-row summary-total">
            <div class="summary-label">Subtotal (sin desplazamiento)</div>
            <div class="summary-value"><span id="sumSubtotal">—</span> €</div>
          </div>
          <div class="summary-row">
            <div class="summary-label">Depósito a retener</div>
            <div class="summary-value"><span id="sumDeposit">—</span> €</div>
          </div>
        </div>
        <p class="note" style="margin-top:10px;">
          Este cálculo es orientativo. El importe por kilometraje se añade al confirmar el cuidador más cercano.
          El depósito se retiene (autorización) y se captura tras aceptar la reserva.
        </p>
      </div>

      <!-- TPL: INICIO BLOQUE NUEVO [Campo oculto con el desglose para el email] -->
      <input type="hidden" name="Desglose" id="summaryField">
      <!-- TPL: FIN BLOQUE NUEVO -->

      <div class="booking-actions">
        <button type="submit" class="cta-button">Solicitar reserva</button>
      </div>
      <p class="note">Tras enviar, te llamaremos para conocernos y confirmar detalles. La primera visita con el cuidador es gratuita.</p>
    </form>
  </div>

  <!-- ====== TPL: INICIO BLOQUE NUEVO [Lógica reservas + Nager.Date + fallback JSON/local] ====== -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('bookingForm');

    const els = {
      service: document.getElementById('service'),
      region: document.getElementById('region'),
      date: document.getElementById('date'),
      dateEnd: document.getElementById('dateEnd'),
      species: document.getElementById('species'),
      isPuppy: document.getElementById('isPuppy'),
      numPets: document.getElementById('numPets'),
      numPetsExact: document.getElementById('numPetsExact'),
      festivo: document.getElementById('festivo'),
      senalado: document.getElementById('senalado'),
      depositPct: document.getElementById('depositPct'),
      fieldSpecies: document.getElementById('fieldSpecies'),
      fieldIsPuppy: document.getElementById('fieldIsPuppy'),
      fieldNumPets: document.getElementById('fieldNumPets'),
      sumBase: document.getElementById('sumBase'),
      sumPets: document.getElementById('sumPets'),
      sumFestivo: document.getElementById('sumFestivo'),
      sumSenalado: document.getElementById('sumSenalado'),
      sumSubtotal: document.getElementById('sumSubtotal'),
      sumDeposit: document.getElementById('sumDeposit'),
      summaryField: document.getElementById('summaryField'),
      // cliente
      uiName: document.getElementById('uiName'),
      uiEmail: document.getElementById('uiEmail'),
      uiPhone: document.getElementById('uiPhone'),
      custName: document.getElementById('custName'),
      custEmail: document.getElementById('custEmail'),
      custPhone: document.getElementById('custPhone'),
      // depósito (selector existente en tu versión)
      depositPctSelect: document.getElementById('depositPct')
    };

    // Base de precios (tu lógica)
    const BASES = { visitas:22, paseos:12, guarderia:20, alojamiento:30, bodas:0 };
    const SPECIAL_MMDD = ['12-24','12-25','12-31','01-01']; // Días señalados +30€
    const REGION_TO_COUNTY = {
      andalucia:'ES-AN', aragon:'ES-AR', asturias:'ES-AS', baleares:'ES-IB', canarias:'ES-CN', cantabria:'ES-CB',
      'castilla-la-mancha':'ES-CM', 'castilla-y-leon':'ES-CL', cataluna:'ES-CT', ceuta:'ES-CE', valenciana:'ES-VC',
      extremadura:'ES-EX', galicia:'ES-GA', 'la-rioja':'ES-RI', madrid:'ES-MD', melilla:'ES-ML', murcia:'ES-MC',
      navarra:'ES-NC', euskadi:'ES-PV', nacional:null
    };
    const COUNTY_TO_REGIONKEY = {
      'ES-AN':'AN','ES-AR':'AR','ES-AS':'AS','ES-IB':'IB','ES-CN':'CN','ES-CB':'CB','ES-CM':'CM','ES-CL':'CL','ES-CT':'CT','ES-VC':'VC',
      'ES-EX':'EX','ES-GA':'GA','ES-RI':'RI','ES-MD':'MD','ES-MC':'MC','ES-NC':'NC','ES-PV':'PV','ES-CE':'CE','ES-ML':'ML'
    };
    const _festivosCache = new Map();

    // Autorellenar servicio por ?service= o ?svc=
    (function prefillService(){
      const params = new URLSearchParams(location.search);
      const map = { visitas:'visitas', paseos:'paseos', guarderia:'guarderia', alojamiento:'alojamiento', bodas:'bodas' };
      const svc = map[params.get('service')] || map[params.get('svc')] || '';
      if(svc && els.service){ els.service.value = svc; els.service.disabled = true; }
    })();

    function currency(n){ return (Math.round((n || 0) * 100) / 100).toFixed(2); }
    function mmdd(d){ return `${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
    function ymd(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }

    function calcPetSupplements(service, species, n){
      const num = parseInt(n || '1', 10);
      if(num <= 1) return 0;
      if(service === 'visitas'){
        const extra = num - 1;
        if(extra === 1) return 12;
        if(extra === 2) return 8 * 2;
        if(extra >= 3) return 6 * extra;
        return 0;
      }
      if(service === 'paseos') return 8 * (num - 1);
      if(service === 'alojamiento' && species === 'perro') return 25 * (num - 1);
      return 0;
    }

    function getBasePrice(service){
      let base = BASES[service] || 0;
      const isPuppy = (els.isPuppy?.value === 'si');
      if(service === 'alojamiento' && isPuppy){ base = 35; }
      return base;
    }

    function toggleFields(){
      const svc = els.service?.value;
      const needSpeciesNum = (svc === 'visitas' || svc === 'alojamiento' || svc === 'paseos');
      if(els.fieldSpecies) els.fieldSpecies.hidden = !needSpeciesNum;
      if(els.fieldNumPets) els.fieldNumPets.hidden = !needSpeciesNum;
      const needPuppy = (svc === 'alojamiento' || svc === 'guarderia');
      if(els.fieldIsPuppy) els.fieldIsPuppy.hidden = !needPuppy;
      if(svc === 'visitas' && els.species) els.species.value = 'gato';
    }

    // Nº mascotas exacto si 6+
    function handleNumPetsExact(){
      if(!els.numPets || !els.numPetsExact) return;
      if(els.numPets.value === '6+'){
        els.numPetsExact.style.display = 'block';
        if(!els.numPetsExact.value) els.numPetsExact.value = 6;
      }else{
        els.numPetsExact.style.display = 'none';
      }
    }

    function getEffectivePets(){
      if(!els.numPets) return 1;
      if(els.numPets.value === '6+') return Math.max(6, parseInt(els.numPetsExact.value || '6', 10));
      return parseInt(els.numPets.value || '1', 10);
    }

    // --- Preferencia: JSON local /festivos-es-YYYY.json (si existe) ---
    async function fetchLocalHolidays(year){
      const urls = [`/festivos-es-${year}.json`, `festivos-es-${year}.json`];
      for(const url of urls){
        try{
          const r = await fetch(url, {cache:'no-store'});
          if(!r.ok) continue;
          const data = await r.json();
          const nacional = new Set((data.national || data.nacional || []).map(x => x.date || x));
          const porCcaa = new Map();
          if(data.regions){
            Object.entries(data.regions).forEach(([k, arr])=>{
              porCcaa.set(k, new Set((arr||[]).map(x => x.date || x)));
            });
          }
          return { nacional, porCcaa, _src:'local' };
        }catch(_){}
      }
      return null;
    }

    // --- Nager.Date (sin API key) ---
    async function fetchNagerHolidays(year){
      const r = await fetch(`https://date.nager.at/api/v3/PublicHolidays/${year}/ES`, {cache:'force-cache'});
      if(!r.ok) throw new Error('Nager fail');
      const data = await r.json();
      const nacional = new Set();
      const porCcaa = new Map();
      for(const h of data){
        const date = h.date;
        if(!h.counties || !h.counties.length){
          nacional.add(date);
        }else{
          for(const c of h.counties){
            const key = COUNTY_TO_REGIONKEY[c] || c;
            if(!porCcaa.has(key)) porCcaa.set(key, new Set());
            porCcaa.get(key).add(date);
          }
        }
      }
      return { nacional, porCcaa, _src:'nager' };
    }

    async function fetchHolidaysForYear(year){
      if(_festivosCache.has(year)) return _festivosCache.get(year);
      try{
        const raw = localStorage.getItem(`tpl_festivos_${year}`);
        if(raw){
          const parsed = JSON.parse(raw);
          if(parsed?.t && Date.now() - parsed.t <= 24*3600*1000){
            const nacional = new Set(parsed.d || []);
            const porCcaa = new Map((parsed.r || []).map(([k,arr])=>[k, new Set(arr||[])]));
            const cached = {nacional, porCcaa, _src:'localStorage'};
            _festivosCache.set(year, cached);
            return cached;
          }
        }
      }catch(_){}

      const local = await fetchLocalHolidays(year);
      if(local){ _festivosCache.set(year, local); return local; }

      try{
        const nager = await fetchNagerHolidays(year);
        _festivosCache.set(year, nager);
        try{
          localStorage.setItem(`tpl_festivos_${year}`, JSON.stringify({
            t: Date.now(),
            d: [...nager.nacional],
            r: [...nager.porCcaa.entries()].map(([k,v])=>[k,[...v]])
          }));
        }catch(_){}
        return nager;
      }catch(_){}

      const basic = {
        nacional: new Set([`${year}-01-06`, `${year}-05-01`, `${year}-08-15`, `${year}-10-12`, `${year}-11-01`, `${year}-12-06`, `${year}-12-08`, `${year}-12-25`]),
        porCcaa: new Map(),
        _src:'basic'
      };
      _festivosCache.set(year, basic);
      return basic;
    }

    async function detectRecargos(ccaa, dateStr){
      if(!dateStr) return { festivo:0, senalado:0 };
      const d = new Date(dateStr);
      if(isNaN(d)) return { festivo:0, senalado:0 };
      const year = d.getFullYear();
      const iso = ymd(d);
      const pack = await fetchHolidaysForYear(year);

      const isNat = !!pack?.nacional?.has(iso);
      const county = REGION_TO_COUNTY[ccaa || 'nacional'] || null;
      const regKey = COUNTY_TO_REGIONKEY[county] || county;
      const isReg = regKey ? !!(pack?.porCcaa?.get(regKey)?.has(iso) || pack?.porCcaa?.get(county)?.has(iso)) : false;

      const isSpecial = SPECIAL_MMDD.includes(mmdd(d));
      return { festivo: (isNat || isReg) ? 10 : 0, senalado: isSpecial ? 30 : 0 };
    }

    async function autoFestivoSenalado(){
      const ccaa = els.region?.value || 'nacional';
      const dateStr = els.date?.value || '';
      try{
        const r = await detectRecargos(ccaa, dateStr);
        if(els.festivo)  els.festivo.value  = String(r.festivo);
        if(els.senalado) els.senalado.value = String(r.senalado);
      }catch(_){}
    }

    function recalc(){
      const svc = els.service?.value || '';
      const species = (els.species?.value || 'perro');
      const n = getEffectivePets();

      const base = getBasePrice(svc);
      const pets = calcPetSupplements(svc, species, n);
      const festivo = parseFloat(els.festivo?.value || 0);
      const senalado = parseFloat(els.senalado?.value || 0);

      const subtotal = base + pets + festivo + senalado;
      const depPct = parseFloat((els.depositPctSelect?.value) || 0.2);
      const deposit = subtotal * depPct;

      if(els.sumBase)     els.sumBase.textContent = base ? currency(base) : '—';
      if(els.sumPets)     els.sumPets.textContent = currency(pets);
      if(els.sumFestivo)  els.sumFestivo.textContent = currency(festivo);
      if(els.sumSenalado) els.sumSenalado.textContent = currency(senalado);
      if(els.sumSubtotal) els.sumSubtotal.textContent = base ? currency(subtotal) : '—';
      if(els.sumDeposit)  els.sumDeposit.textContent = base ? currency(deposit) : '—';
    }

    async function recalcWithAuto(){
      await autoFestivoSenalado();
      recalc();
    }

    // Eventos
    ['change','input'].forEach(ev=>{
      ['service','species','isPuppy','numPets','numPetsExact','region','date','dateEnd'].forEach(id=>{
        const el = document.getElementById(id);
        if(el) el.addEventListener(ev, ()=>{ toggleFields(); handleNumPetsExact(); recalcWithAuto(); });
      });
    });
    // Deposito selector puede estar en tu HTML original (si no, ignora)
    if(els.depositPctSelect){
      els.depositPctSelect.addEventListener('change', recalcWithAuto);
    }

    toggleFields();
    handleNumPetsExact();
    recalcWithAuto();

    // Guardar desglose para Formspree
    if(form){
      form.addEventListener('submit', ()=>{
        const speciesOther = document.getElementById('speciesOther');
        const speciesVal = (els.species && !els.fieldSpecies?.hidden)
          ? (speciesOther?.value ? `otros (${speciesOther.value.trim()})` : els.species.value)
          : '-';
        const petCount = getEffectivePets();
        const summary = [
          `Servicio: ${els.service?.options?.[els.service.selectedIndex]?.text || ''}`,
          `Fecha inicio: ${els.date?.value || '-'}`,
          `Fecha fin: ${els.dateEnd?.value || '-'}`,
          `Tipo de animal: ${speciesVal}`,
          `Cachorro: ${els.isPuppy && !els.fieldIsPuppy?.hidden ? els.isPuppy.value : (els.isPuppy?.value || '-')}`,
          `Nº mascotas: ${petCount}`,
          `CCAA: ${els.region?.options?.[els.region.selectedIndex]?.text || 'España'}`,
          `Festivo (auto sobre fecha inicio): ${els.festivo?.value || '0'} €`,
          `Día señalado (auto): ${els.senalado?.value || '0'} €`,
          `Subtotal (sin desplazamiento): ${document.getElementById('sumSubtotal')?.textContent || '0.00'} €`,
          `Depósito a retener: ${document.getElementById('sumDeposit')?.textContent || '0.00'} €`,
          `Preferencia contacto: ${document.getElementById('contactPref')?.value || '-'}`,
          `Cliente: ${els.custName?.value || '-'} | ${els.custEmail?.value || '-'} | ${els.custPhone?.value || '-'}`,
          `Kilometraje: pendiente (al asignar cuidador)`
        ].join(' | ');
        if(els.summaryField) els.summaryField.value = summary;
        // Normaliza Fecha_fin vacía => Fecha_inicio
        if(!els.dateEnd.value && els.date.value){ els.dateEnd.value = els.date.value; }
      });
    }

    // “Otros” animales: input dinámico
    (function speciesOtherToggle(){
      const sel = els.species;
      if(!sel) return;
      function ensureOtherInput(){
        let extra = document.getElementById('speciesOther');
        if(sel.value === 'otros'){
          if(!extra){
            extra = document.createElement('input');
            extra.id = 'speciesOther';
            extra.name = 'Tipo_animal_otro';
            extra.placeholder = 'Especifica el animal';
            extra.className = 'booking-extra';
            extra.style.marginTop = '6px';
            document.getElementById('fieldSpecies').appendChild(extra);
          }
          extra.required = true;
        }else if(extra){
          extra.remove();
        }
      }
      sel.addEventListener('change', ensureOtherInput);
      ensureOtherInput();
    })();

    // ===== Autorrelleno de usuario (Firebase Auth + Firestore si existe) =====
    async function fillUserFromAuth(user){
      const name = user?.displayName || '';
      const email = user?.email || '';
      const phone = user?.phoneNumber || '';

      // Intenta Firestore (si existe) para completar teléfono/nombre
      let fsName = '', fsPhone = '';
      try{
        if(window.firebase && firebase.firestore){
          const db = firebase.firestore();
          const doc = await db.collection('users').doc(user.uid).get();
          if(doc.exists){
            const u = doc.data() || {};
            fsName = u.name || u.fullName || '';
            fsPhone = u.phone || '';
            // Intenta última mascota para “cachorro” auto
            if(u.pets && Array.isArray(u.pets) && u.pets.length){
              const pet = u.pets.find(p=>p.primary) || u.pets[0];
              if(pet?.species && els.species){ els.species.value = pet.species; }
              if(pet?.dob){
                const ageMonths = Math.floor((Date.now() - new Date(pet.dob).getTime()) / (30*24*3600*1000));
                if(els.isPuppy){ els.isPuppy.value = (ageMonths <= 6) ? 'si' : 'no'; }
              }
            }
          }
        }
      }catch(_){}

      const finalName = fsName || name || '(sin nombre)';
      const finalPhone = fsPhone || phone || '';

      if(els.uiName)  els.uiName.textContent  = `Nombre: ${finalName}`;
      if(els.uiEmail) els.uiEmail.textContent = `Email: ${email || '(sin email)'}`;
      if(els.uiPhone) els.uiPhone.textContent = `Tel.: ${finalPhone || '(sin teléfono)'}`;

      if(els.custName)  els.custName.value  = finalName;
      if(els.custEmail) els.custEmail.value = email || '';
      if(els.custPhone) els.custPhone.value = finalPhone || '';
    }

    // Fallback localStorage para “cachorro” si hay perfil local
    (function fallbackLocalPet(){
      try{
        const raw = localStorage.getItem('tpl_last_pet');
        if(!raw) return;
        const p = JSON.parse(raw);
        if(p?.species && els.species){ els.species.value = p.species; }
        if(p?.dob && els.isPuppy){
          const ageMonths = Math.floor((Date.now() - new Date(p.dob).getTime()) / (30*24*3600*1000));
          els.isPuppy.value = (ageMonths <= 6) ? 'si' : 'no';
        }
      }catch(_){}
    })();

    // Observa cambios para recálculo
    if(els.isPuppy){ els.isPuppy.addEventListener('change', recalcWithAuto); }

    // Exponer función para Firebase Auth (se define más abajo)
    window.__tpl_onAuthUser = (u)=>{ if(u){ fillUserFromAuth(u); } };
  });
  </script>
  <!-- TPL: FIN BLOQUE NUEVO -->

  <!-- Footer unificado (inyectado) -->
  <div id="tpl-footer">
    <noscript>
      <footer class="site-footer">
        <div class="container footer-row">
          <div class="footer-left">
            <nav class="footer-links-row">
              <a href="sobre-nosotros.html">Sobre nosotros</a><span class="sep">|</span>
              <a href="contacto.html">Contacta con nosotros</a><span class="sep">|</span>
              <a href="donde-estamos.html">Dónde estamos</a><span class="sep">|</span>
              <a href="trabaja-con-nosotros.html">Trabaja con nosotros</a><span class="sep">|</span>
              <a href="privacidad.html">Política de Privacidad</a><span class="sep">|</span>
              <a href="condiciones.html">Condiciones de Servicio</a><span class="sep">|</span>
              <a href="digital-services-act.html">Digital Services Act</a>
            </nav>
            <div class="footer-help">¿Necesitas ayuda? <a href="ayuda.html">Centro de ayuda</a></div>
          </div>
          <div class="footer-right socials">
            <a href="#" aria-label="WhatsApp"><i class="fab fa-whatsapp"></i></a>
            <a href="#" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
            <a href="#" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
            <a href="#" aria-label="TikTok"><i class="fab fa-tiktok"></i></a>
          </div>
        </div>
        <div class="footer-bottom footer-bottom--inline">
          <div class="footer-bottom-left">© <span class="year-span"></span> The Pets Lovers — Todos los derechos reservados</div>
          <nav class="footer-bottom-right legal-links">
            <a href="aviso-legal.html">Aviso legal</a><span class="sep">|</span>
            <a href="privacidad.html">Privacidad</a><span class="sep">|</span>
            <a href="cookies.html">Cookies</a><span class="sep">|</span>
            <a href="canal-denuncias.html">Canal de denuncias</a>
          </nav>
        </div>
      </footer>
    </noscript>
  </div>

  <!-- Mini-injectors -->
  <script src="tpl-navbar.js" defer></script>
  <script src="tpl-footer.js" defer></script>

  <!-- TPL: INICIO BLOQUE NUEVO [Firebase SDK compat] -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-analytics-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDW73aFuz2AFS9VeWg_linHIRJYN4YMgTk",
      authDomain: "thepetslovers-c1111.firebaseapp.com",
      projectId: "thepetslovers-c1111",
      storageBucket: "thepetslovers-c1111.appspot.com",
      messagingSenderId: "415914577533",
      appId: "1:415914577533:web:0b7a056ebaa4f1de28ab14",
      measurementId: "G-FXPD69KXBG"
    };
    if (typeof firebase !== 'undefined') {
      if (firebase.apps.length === 0) firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      if (firebase.analytics) { try { firebase.analytics(); } catch(e){} }

      function updateAuthUI(user){
        const logged = !!user;
        const form = document.getElementById('bookingForm');
        const wall = document.getElementById('authWall');
        if (form) form.classList.toggle('disabled', !logged);
        if (wall) wall.style.display = logged ? 'none' : 'block';
        if (logged && window.__tpl_onAuthUser) window.__tpl_onAuthUser(user);
      }
      auth.onAuthStateChanged(updateAuthUI);
    }
  </script>
  <!-- TPL: FIN BLOQUE NUEVO -->

</body>
</html>
