# `reservas.html`

```html
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reservas · The Pets Lovers</title>
  <meta name="description" content="Reserva guardería de día, alojamiento nocturno, paseos, visitas a domicilio, exóticos y transporte. Solo pagas una pequeña parte ahora; el resto 12 días antes." />
  <link rel="canonical" href="https://www.thepetslovers.es/reservas.html" />

  <!-- Tipografías y estilos del sitio -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/style.css" />

  <!-- Navbar/Footer (inyectados) -->
  <script defer src="/js/tpl-navbar.js"></script>
  <script defer src="/js/tpl-footer.js"></script>

  <!-- Config pública Firebase (puedes sustituir por la tuya) -->
  <script>
    window.TPL_FIREBASE_CONFIG = {
      apiKey: "AIzaSyDW73aFuz2AFS9VeWg_linHIRJYN4YMgTk",
      authDomain: "thepetslovers-c1111.firebaseapp.com",
      projectId: "thepetslovers-c1111",
      storageBucket: "thepetslovers-c1111.appspot.com",
      messagingSenderId: "415914577533",
      appId: "1:415914577533:web:0b7a056ebaa4f1de28ab14",
      measurementId: "G-FXPD69KXBG"
    };
  </script>

  <!-- SEO JSON-LD: ReservationPage + Organization -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "ReservationPage",
    "name": "Reservas · The Pets Lovers",
    "description": "Reserva servicios de cuidado de mascotas en Madrid y alrededores.",
    "breadcrumb": {
      "@type": "BreadcrumbList",
      "itemListElement": [
        {"@type": "ListItem", "position": 1, "name": "Inicio", "item": "https://www.thepetslovers.es/"},
        {"@type": "ListItem", "position": 2, "name": "Reservas", "item": "https://www.thepetslovers.es/reservas.html"}
      ]
    },
    "about": {"@type": "Organization", "name": "The Pets Lovers", "url": "https://www.thepetslovers.es"}
  }
  </script>

  <style>
    /* Ajustes mínimos para esta página (todo lo demás en style.css) */
    :root { --tpl-green: #18a05e; --tpl-dark: #111; --tpl-muted:#6b7280; }
    body { font-family: 'Poppins', system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Montserrat', sans-serif; }
    .container { max-width: 1080px; margin: 0 auto; padding: 1.5rem; }
    .hero { text-align:center; padding: 3.5rem 1rem 2rem; }
    .hero h1 { font-family: 'Montserrat', sans-serif; font-weight: 700; font-size: clamp(1.6rem, 2.5vw, 2.2rem); margin-bottom: .5rem; }
    .hero p { color: var(--tpl-muted); margin-bottom: 1rem; }
    .btn { display:inline-flex; align-items:center; gap:.5rem; padding:.8rem 1rem; border-radius: 999px; border:1px solid #e5e7eb; background:#fff; cursor:pointer; font-weight:600; }
    .btn.primary { background: var(--tpl-green); color:#fff; border-color: var(--tpl-green); }
    .btn.link { background: transparent; border: none; color: var(--tpl-green); }
    .grid { display:grid; gap:1rem; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius: 1rem; padding:1rem; box-shadow: 0 2px 8px rgba(0,0,0,.04); }
    .fieldset { display:grid; gap:.75rem; }
    .fieldset legend { font-weight:700; font-family: 'Montserrat', sans-serif; margin-bottom:.5rem; }
    label { font-size:.95rem; color:#111; font-weight:600; }
    input, select, textarea { width:100%; border:1px solid #e5e7eb; border-radius:.75rem; padding:.7rem .9rem; font-size: .95rem; background:#fff; }
    input[readonly] { background:#f9fafb; color:#6b7280; }
    .row { display:grid; gap:.75rem; grid-template-columns: 1fr; }
    @media(min-width:720px){ .row.two{ grid-template-columns: repeat(2,1fr);} .row.three{ grid-template-columns: repeat(3,1fr);} }
    .muted { color: var(--tpl-muted); font-size:.9rem; }
    .badge { display:inline-block; font-size:.75rem; background:#ecfdf5; color:#065f46; padding:.2rem .5rem; border-radius:.5rem; border:1px solid #a7f3d0; }
    .pet-item { display:flex; align-items:center; justify-content:space-between; border:1px dashed #e5e7eb; border-radius:.75rem; padding:.6rem .8rem; }

    /* Auth wall */
    #authWall { display:none; background:#fff; border:1px solid #e5e7eb; border-radius:1rem; padding:1rem; text-align:center; }
    #authWall h3 { font-family:'Montserrat', sans-serif; font-weight:700; margin-bottom:.5rem; }
    #authWall p { color:var(--tpl-muted); margin-bottom:1rem; }

    /* Cookie mini modal */
    .cookie { position:fixed; inset:auto 1rem 1rem auto; max-width: 360px; background:#111; color:#fff; padding: .9rem 1rem; border-radius: .75rem; font-size:.9rem; box-shadow: 0 8px 20px rgba(0,0,0,.25); }
    .cookie button { margin-left:.5rem; }

    /* Disabled overlay (anti-overlays) */
    .disabled-overlay { position:relative; }
    .disabled-overlay::after { content:""; position:absolute; inset:0; background:rgba(255,255,255,.6); backdrop-filter: blur(2px); border-radius:1rem; display:none; }
    .disabled-overlay[data-disabled="true"]::after { display:block; }

    /* CTA row */
    .cta-row { display:flex; gap:.75rem; flex-wrap:wrap; justify-content:flex-end; }
  </style>
</head>
<body>
  <!-- NAVBAR -->
  <div id="tpl-navbar"></div>

  <!-- HERO -->
  <section class="hero container">
    <h1>Reserva tu servicio</h1>
    <p>Flujo rápido: elige servicio y fechas → mascotas → datos → desglose → ¡Listo! Solo pagas una pequeña parte ahora; el resto 12 días antes.</p>
    <button class="btn primary" id="ctaStart">Empezar</button>
  </section>

  <main class="container grid" style="grid-template-columns: 1fr;">

    <!-- AUTH WALL (se muestra si no hay sesión) -->
    <section id="authWall" class="card">
      <h3>Accede para reservar</h3>
      <p>Necesitas una cuenta para continuar. Puedes crearla en 1 minuto.</p>
      <div style="display:flex; gap:.5rem; justify-content:center; flex-wrap:wrap;">
        <button class="btn primary" id="btnLogin">Iniciar sesión</button>
        <button class="btn" id="btnRegister">Crear cuenta</button>
      </div>
    </section>

    <!-- FORMULARIO (bloques) -->
    <form id="reservaForm" class="grid disabled-overlay" data-disabled="true">

      <!-- 1) Datos del servicio -->
      <fieldset class="card fieldset" id="fsServicio">
        <legend>Datos del servicio</legend>
        <div class="row two">
          <div>
            <label for="service">Servicio</label>
            <select id="service" name="service" required>
              <option value="">— Selecciona —</option>
              <option value="daycare">Guardería de día</option>
              <option value="overnight">Alojamiento nocturno</option>
              <option value="walk60">Paseo (60’)</option>
              <option value="visita_gato">Visita a domicilio (gato)</option>
              <option value="exoticos">Exóticos (visitas)</option>
              <option value="transporte">Transporte</option>
            </select>
          </div>
          <div class="row two">
            <div>
              <label for="startDate">Fecha inicio</label>
              <input type="date" id="startDate" name="startDate" required />
            </div>
            <div>
              <label for="endDate">Fecha fin</label>
              <input type="date" id="endDate" name="endDate" required />
            </div>
          </div>
        </div>
        <div class="row two">
          <div>
            <label for="startTime">Hora inicio</label>
            <input type="time" id="startTime" name="startTime" />
          </div>
          <div>
            <label for="endTime">Hora fin</label>
            <input type="time" id="endTime" name="endTime" />
          </div>
        </div>
        <!-- Especie / Subtipo según servicio -->
        <div id="speciesRow" class="row two" style="display:none;">
          <div>
            <label for="species">Especie</label>
            <input id="species" name="species" placeholder="Gato (auto para Visitas)" readonly />
          </div>
          <div id="exoticosSubtypeWrap" style="display:none;">
            <label for="exoticosSubtype">Tipo (exóticos)</label>
            <select id="exoticosSubtype" name="exoticosSubtype">
              <option value="aves">Aves</option>
              <option value="reptiles">Reptiles</option>
              <option value="pequenos_mamiferos">Pequeños mamíferos</option>
              <option value="otro">Otro</option>
            </select>
          </div>
        </div>
        <p class="muted">Si has llegado desde una ficha de servicio, lo verás preseleccionado.</p>
      </fieldset>

      <!-- 2) Mascotas -->
      <fieldset class="card fieldset" id="fsMascotas">
        <legend>Mascotas</legend>
        <div id="petsList" class="grid"></div>
        <p class="muted">Selecciona una o varias. El badge “Cachorro” (≤6 meses) se calcula automáticamente.</p>
      </fieldset>

      <!-- 3) Datos del titular -->
      <fieldset class="card fieldset" id="fsTitular">
        <legend>Datos del titular</legend>
        <div class="row two">
          <div>
            <label for="fullName">Nombre y apellidos</label>
            <input id="fullName" name="fullName" autocomplete="name" required />
          </div>
          <div>
            <label for="phone">Teléfono</label>
            <input id="phone" name="phone" type="tel" autocomplete="tel" required />
          </div>
        </div>
        <div class="row two">
          <div>
            <label for="email">Email</label>
            <input id="email" name="email" type="email" autocomplete="email" required />
          </div>
          <div>
            <label for="region">Comunidad Autónoma</label>
            <select id="region" name="region" required>
              <option value="">— Selecciona —</option>
              <option>Andalucía</option>
              <option>Aragón</option>
              <option>Asturias</option>
              <option>Islas Baleares</option>
              <option>Islas Canarias</option>
              <option>Cantabria</option>
              <option>Castilla-La Mancha</option>
              <option>Castilla y León</option>
              <option>Cataluña</option>
              <option>Comunidad Valenciana</option>
              <option>Extremadura</option>
              <option>Galicia</option>
              <option>La Rioja</option>
              <option>Comunidad de Madrid</option>
              <option>Región de Murcia</option>
              <option>Navarra</option>
              <option>País Vasco</option>
              <option>Ceuta</option>
              <option>Melilla</option>
            </select>
          </div>
        </div>
        <div class="row three">
          <div>
            <label for="address">Dirección</label>
            <input id="address" name="address" autocomplete="street-address" />
          </div>
          <div>
            <label for="postalCode">Código Postal</label>
            <input id="postalCode" name="postalCode" autocomplete="postal-code" />
          </div>
          <div>
            <label for="observations">Observaciones</label>
            <input id="observations" name="observations" placeholder="Alergias, horarios, etc." />
          </div>
        </div>
        <!-- Opcionales futuros: preferencia de contacto, franja, desplazamiento -->
      </fieldset>

      <!-- 4) Desglose (siempre visible) -->
      <fieldset class="card fieldset" id="fsDesglose">
        <legend>Desglose</legend>
        <div id="breakdown" class="grid"></div>
        <p class="muted">Nota: Solo abonarás una pequeña parte ahora. El resto se pagará 12 días antes del inicio del servicio.</p>
      </fieldset>

      <!-- 5) CTA -->
      <div class="card cta-row">
        <button type="button" class="btn" id="btnBack">⟵ Atrás</button>
        <button type="submit" class="btn primary" id="btnSubmit">Reservar ahora</button>
      </div>
    </form>
  </main>

  <!-- FOOTER -->
  <div id="tpl-footer" style="margin-top:3rem"></div>

  <!-- Cookie mini modal (no intrusivo) -->
  <div id="cookieMini" class="cookie" style="display:none;">
    Usamos cookies técnicas para mejorar tu experiencia. <button class="btn primary" id="acceptCookies">Aceptar</button>
  </div>

  <!-- SDKs Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script>
    (function(){
      if (typeof firebase!=='undefined' && !firebase.apps.length && window.TPL_FIREBASE_CONFIG) {
        firebase.initializeApp(window.TPL_FIREBASE_CONFIG);
      }
    })();
  </script>

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>
    window.TPL_EMAILJS = {
      serviceId: "service_odjqrfl",
      publicKey:  "L2xAATfVuHJwj4EIV",
      templates: { cliente: "template_rao5n0c", gestion: "template_rao5n0c" },
      adminEmail: "gestion@thepetslovers.es"
    };
    try { emailjs.init(window.TPL_EMAILJS.publicKey); } catch(e) {}
  </script>

  <!-- Bridge de auth/UI y lógica de reservas -->
  <script defer src="/js/tpl-auth-bridge.js"></script>
  <script defer src="/js/tpl-reservas.js"></script>
</body>
</html>
```

---

# `js/tpl-auth-bridge.js`

```javascript
/*
  TPL · Auth bridge + Perfil → Autorrelleno y mascotas
  - Muestra/oculta el muro de login según sesión
  - Login/Registro mínimos en modal sin redirección
  - Carga perfil (propietarios/{uid}) y mascotas → window.TPL_SESSION
*/
(function(){
  const auth = firebase.auth();
  const db = firebase.firestore();

  // Estado global mínimo
  window.TPL_SESSION = { user: null, profile: null, pets: [] };

  // UI refs
  const authWall = document.getElementById('authWall');
  const formWrap = document.getElementById('reservaForm');
  const btnLogin = document.getElementById('btnLogin');
  const btnRegister = document.getElementById('btnRegister');
  const ctaStart = document.getElementById('ctaStart');

  // Simple modal
  const modal = document.createElement('dialog');
  modal.innerHTML = `
    <form method="dialog" style="min-width:320px; max-width:420px; border:none; padding:0;">
      <div style="padding:1rem;">
        <h3 style="margin:0 0 .5rem; font-weight:700; font-family:Montserrat, sans-serif;">Accede a tu cuenta</h3>
        <div style="display:grid; gap:.5rem;">
          <input id="mEmail" type="email" placeholder="Email" required />
          <input id="mPass" type="password" placeholder="Contraseña" required />
        </div>
        <div style="display:flex; gap:.5rem; justify-content:flex-end; margin-top:.75rem;">
          <button class="btn">Cancelar</button>
          <button id="mDoLogin" class="btn primary" value="login">Iniciar sesión</button>
          <button id="mDoRegister" class="btn" value="register">Crear cuenta</button>
        </div>
        <p id="mError" class="muted" style="color:#ef4444; display:none; margin-top:.5rem;"></p>
      </div>
    </form>`;
  document.body.appendChild(modal);

  const show = el => el && (el.style.display = 'block');
  const hide = el => el && (el.style.display = 'none');

  function setDisabledForm(disabled){
    formWrap?.setAttribute('data-disabled', disabled ? 'true' : 'false');
    [...formWrap.querySelectorAll('input,select,textarea,button')].forEach(el => {
      if (el.id === 'btnBack') return; // permitir atrás
      if (el.closest('#authWall')) return;
      el.disabled = !!disabled;
    });
  }

  function fillProfile(profile){
    document.getElementById('fullName').value = profile?.fullName || '';
    document.getElementById('email').value = profile?.email || '';
    document.getElementById('phone').value = profile?.phone || '';
    document.getElementById('address').value = profile?.address || '';
    document.getElementById('postalCode').value = profile?.postalCode || '';
    document.getElementById('region').value = profile?.region || '';
  }

  function renderPets(pets){
    const wrap = document.getElementById('petsList');
    wrap.innerHTML = '';
    if (!pets || !pets.length) {
      wrap.innerHTML = `<p class="muted">No tienes mascotas guardadas todavía.</p>`;
      return;
    }
    pets.forEach(p => {
      const isPuppy = (() => {
        if (!p.birth) return false;
        const sixMonthsMs = 1000*60*60*24*30.4375*6;
        const birth = new Date(p.birth).getTime();
        return (Date.now() - birth) <= sixMonthsMs;
      })();
      const id = `pet_${p.id || p.name}`;
      const div = document.createElement('div');
      div.className = 'pet-item';
      div.innerHTML = `
        <label style="display:flex; align-items:center; gap:.6rem;">
          <input type="checkbox" name="pets" value="${p.id || p.name}" data-species="${p.species || ''}" data-isPuppy="${isPuppy ? '1':'0'}" />
          <span><strong>${p.name}</strong> · <span class="muted">${p.species || '—'}</span></span>
        </label>
        ${isPuppy ? '<span class="badge">Cachorro ≤6m</span>' : ''}
      `;
      wrap.appendChild(div);
    });
  }

  // Escuchar auth
  auth.onAuthStateChanged(async(user) => {
    window.TPL_SESSION.user = user || null;
    if (!user) {
      show(authWall); setDisabledForm(true);
      return;
    }
    hide(authWall); setDisabledForm(false);

    // Cargar perfil + mascotas
    try {
      const doc = await db.collection('propietarios').doc(user.uid).get();
      const profile = doc.exists ? doc.data() : null;
      window.TPL_SESSION.profile = profile;
      window.TPL_SESSION.pets = profile?.pets || [];
      fillProfile(profile||{});
      renderPets(window.TPL_SESSION.pets);
    } catch(err){ console.error('Perfil error', err); }
  });

  // CTA empezar → scroll al formulario
  ctaStart?.addEventListener('click', () => {
    document.getElementById('fsServicio')?.scrollIntoView({behavior:'smooth'});
  });

  // Muro → abrir modal
  btnLogin?.addEventListener('click', ()=> modal.showModal());
  btnRegister?.addEventListener('click', ()=> modal.showModal());

  // Acciones modal
  modal.addEventListener('click', (e)=>{ if(e.target === modal) modal.close(); });
  modal.querySelector('#mDoLogin')?.addEventListener('click', async (e)=>{
    e.preventDefault();
    const email = modal.querySelector('#mEmail').value.trim();
    const pass = modal.querySelector('#mPass').value;
    try { await auth.signInWithEmailAndPassword(email, pass); modal.close(); }
    catch(err){ const m = modal.querySelector('#mError'); m.textContent = err.message; m.style.display='block'; }
  });
  modal.querySelector('#mDoRegister')?.addEventListener('click', async (e)=>{
    e.preventDefault();
    const email = modal.querySelector('#mEmail').value.trim();
    const pass = modal.querySelector('#mPass').value;
    try { await auth.createUserWithEmailAndPassword(email, pass); modal.close(); }
    catch(err){ const m = modal.querySelector('#mError'); m.textContent = err.message; m.style.display='block'; }
  });

  // Cookies mini
  const ckKey = 'tpl_ck_ok';
  if (!localStorage.getItem(ckKey)) {
    document.getElementById('cookieMini').style.display='block';
    document.getElementById('acceptCookies').onclick = ()=>{
      localStorage.setItem(ckKey, '1');
      document.getElementById('cookieMini').style.display='none';
    };
  }
})();
```

---

# `js/tpl-reservas.js`

```javascript
/*
  TPL · Lógica de reservas: preselección, cálculo de desglose, envío a Firestore y EmailJS
  - Preselección por ?service= / ?svc= y localStorage('lastService')
  - Cálculo de precios (cliente) + suplementos + días
  - Cálculo de "A pagar ahora":
      pagar_ahora = subtotal - (coste_auxiliar + festivo_auxiliar)
    Donde coste_auxiliar viene de reglas internas (si no hay, fallback a margen %)
  - Guardado en reservas y envío de emails (cliente + gestión)
*/
(function(){
  const db = firebase.firestore();

  // ====== CONFIG PÚBLICA DE PRECIOS (CLIENTE) ======
  // Puedes ajustar aquí sin tocar la lógica.
  window.TPL_PRICING = {
    daycare: { adult: 15, puppy: 20, bonosAdulto: {10:135,20:250,30:315}, bonosPuppy:{10:185,20:350,30:465} },
    visita_gato: {
      base60: { d1_10: 22, d11p: 18 },
      base90: { d1_10: 30, d11p: 27 },
      med15: { d1_10: 12, d11p: 10 },
      // suplementos por nº de gatos adicionales por visita
      extraCats: { oneMore: 12, twoEach: 8, threePlusEach: 6 }
    },
    overnight: { adult: { d1_10: 30, d11p: 27 }, puppy: { d1_10: 35, d11p: 32 }, secondDog: { d1_10: 25, d11p: 22 } },
    walk60: { price: 12, secondPet: 8, bonos: {10:115,15:168,20:220,25:270,30:318} },
    exoticos: { aves: 20, reptiles: 20, pequenos_mamiferos: 25, otro: 20 },
    transporte: { flat: 20 },
    supplements: { urgencia: 10, festivo: 10, senalado: 30 }
  };

  // ====== CONFIG AUXILIAR (OCULTA) ======
  // Si conoces tus costes internos, ponlos aquí para un cálculo exacto.
  // Ejemplo (por día/visita): daycare.adult = 11; daycare.puppy = 15; etc.
  // Si se deja null, usamos fallback a margen porcentual (ver MARGIN_FALLBACK).
  window.TPL_AUX_RULES = {
    daycare: { adult: null, puppy: null },
    visita_gato: { base60: null, base90: null, med15: null, extraCat: null },
    overnight: { adult: null, puppy: null, secondDog: null },
    walk60: { base: null, secondPet: null },
    exoticos: { aves: null, reptiles: null, pequenos_mamiferos: null, otro: null },
    transporte: { flat: null },
    festivo_aux: { normal: 8, senalado: 15 }
  };
  const MARGIN_FALLBACK = 0.20; // 20% del subtotal si no hay reglas internas

  // ====== UTILS ======
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const fmt = n => new Intl.NumberFormat('es-ES', { style:'currency', currency:'EUR'}).format(n||0);
  const todayStr = () => new Date().toISOString().slice(0,10);

  function daysInclusive(a, b){
    const d1 = new Date(a), d2 = new Date(b);
    if (isNaN(+d1) || isNaN(+d2)) return 0;
    const diff = Math.round((d2 - d1) / (1000*60*60*24));
    return diff + 1;
  }

  function getQueryService(){
    const url = new URL(location.href);
    return url.searchParams.get('service') || url.searchParams.get('svc');
  }

  function preselectService(){
    const sel = $('#service');
    const q = getQueryService();
    const remembered = localStorage.getItem('lastService');
    const value = q || remembered;
    if (value && sel.querySelector(`option[value="${value}"]`)) {
      sel.value = value;
      sel.dispatchEvent(new Event('change'));
    }
  }

  // ====== UI REACTIVA (especie/subtipo) ======
  function syncSpeciesUI(){
    const service = $('#service').value;
    const row = $('#speciesRow');
    const sub = $('#exoticosSubtypeWrap');
    const inp = $('#species');
    row.style.display = 'none'; sub.style.display = 'none'; inp.readOnly = true; inp.value = '';

    if (service === 'visita_gato') { row.style.display='grid'; inp.value = 'Gato'; }
    if (service === 'exoticos') { row.style.display='grid'; inp.readOnly = true; inp.value='Exótico'; sub.style.display='block'; }
  }

  // ====== DESGLOSE ======
  function compute(state){
    const P = window.TPL_PRICING;
    const A = window.TPL_AUX_RULES;

    const items = [];
    let subtotal = 0; let festivoAux = 0;

    const d = daysInclusive(state.startDate, state.endDate);
    const isLong = d >= 11; // regla "desde día 11"

    // Helpers
    const add = (label, amount) => { if(!amount) return; items.push({label, amount}); subtotal += amount; };

    // === Por servicio ===
    if (state.service === 'daycare') {
      // Si hay cachorros en selección → tarifa cachorro, si no → estándar
      const anyPuppy = state.pets.some(p => p.isPuppy);
      const rate = anyPuppy ? P.daycare.puppy : P.daycare.adult;
      // Bonos opcionales (elige 10/20/30) → si días exactos coinciden, aplica precio bono
      let base;
      if (state.bono && [10,20,30].includes(state.bono) && d === state.bono) {
        base = anyPuppy ? P.daycare.bonosPuppy[state.bono] : P.daycare.bonosAdulto[state.bono];
        add(`Bono ${state.bono} días`, base);
      } else {
        base = d * rate * Math.max(1, state.pets.length);
        add(`Base (${d} día/s × ${state.pets.length} mascota/s)`, base);
      }
      // Auxiliar
      const auxRate = (anyPuppy ? A.daycare.puppy : A.daycare.adult);
      const auxCost = (auxRate!=null ? auxRate * d * Math.max(1, state.pets.length) : null);
      state._auxCost = auxCost;
    }

    if (state.service === 'overnight') {
      const anyPuppy = state.pets.some(p => p.isPuppy);
      const table = anyPuppy ? P.overnight.puppy : P.overnight.adult;
      const rate = isLong ? table.d11p : table.d1_10;
      // 2º perro con tarifa diferente
      const dogs = state.pets.filter(p=> (p.species||'').toLowerCase()==='perro');
      const first = Math.min(1, dogs.length), second = Math.max(0, dogs.length-1);
      const firstCost = d * rate * first;
      const secondRate = isLong ? P.overnight.secondDog.d11p : P.overnight.secondDog.d1_10;
      const secondCost = d * secondRate * second;
      add(`Base 1º perro (${d}d)`, firstCost);
      if (second) add(`2º perro (${d}d)`, secondCost);
      state._auxCost = null; // pon tus reglas si las sabes
    }

    if (state.service === 'walk60') {
      if (state.bono && P.walk60.bonos[state.bono]) {
        add(`Bono paseos ×${state.bono}`, P.walk60.bonos[state.bono]);
      } else {
        const base = state.numWalks * P.walk60.price;
        add(`Paseos (${state.numWalks}×)`, base);
        if (state.secondPet) add(`2ª mascota (${state.numWalks}×)`, state.numWalks * P.walk60.secondPet);
      }
      state._auxCost = null;
    }

    if (state.service === 'visita_gato') {
      // número de visitas = días inclusivos (si quieres visitas/día ajusta state.visitsPerDay)
      const visits = d * (state.visitsPerDay || 1);
      const baseTable = (state.duration==='90' ? P.visita_gato.base90 : P.visita_gato.base60);
      const baseRate = isLong ? baseTable.d11p : baseTable.d1_10;
      add(`Visitas (${visits}×)`, visits * baseRate);

      if (state.med15) {
        const medRate = isLong ? P.visita_gato.med15.d11p : P.visita_gato.med15.d1_10;
        add(`Medicaciones 15’ (${visits}×)`, visits * medRate);
      }

      // Suplementos por nº de gatos adicionales por visita
      const extraCats = Math.max(0, state.catsCount - 1);
      if (extraCats>0) {
        let supp = 0;
        if (extraCats === 1) supp = P.visita_gato.extraCats.oneMore * visits;
        else if (extraCats === 2) supp = (2 * P.visita_gato.extraCats.twoEach) * visits;
        else if (extraCats >= 3) supp = (extraCats * P.visita_gato.extraCats.threePlusEach) * visits;
        add(`Supl. gatos adicionales (${visits}×)`, supp);
      }
      state._auxCost = null;
    }

    if (state.service === 'exoticos') {
      const subtype = state.exoSubtype || 'otro';
      add(`Exóticos · ${subtype}`, P.exoticos[subtype] || P.exoticos.otro);
      state._auxCost = null;
    }

    if (state.service === 'transporte') {
      add('Transporte', P.transporte.flat);
      state._auxCost = null;
    }

    // === SUPLEMENTOS GENERALES ===
    if (state.urgencia) add('Urgencia (mismo día <2h)', P.supplements.urgencia);
    if (state.festivo) { add('Festivo', P.supplements.festivo); festivoAux += (A.festivo_aux?.normal || 0); }
    if (state.senalado) { add('Días señalados (24/12,25/12,31/12,01/01)', P.supplements.senalado); festivoAux += (A.festivo_aux?.senalado || 0); }

    // === MARGEN / PAGO AHORA ===
    let auxCost = 0;
    if (state._auxCost != null) auxCost += state._auxCost;
    // Si no hay reglas internas suficientes, fallback a % del subtotal
    if (!auxCost) auxCost = Math.max(0, subtotal * (1 - MARGIN_FALLBACK));

    const pagar_ahora = Math.max(0, subtotal - (auxCost + festivoAux));
    const pendiente = Math.max(0, subtotal - pagar_ahora);

    return { items, subtotal, pagar_ahora, pendiente, festivoAux };
  }

  function renderBreakdown(bk){
    const wrap = document.getElementById('breakdown');
    wrap.innerHTML = '';
    bk.items.forEach(it => {
      const row = document.createElement('div');
      row.style.display='flex'; row.style.justifyContent='space-between';
      row.innerHTML = `<span>${it.label}</span><strong>${fmt(it.amount)}</strong>`;
      wrap.appendChild(row);
    });
    const hr = () => { const d = document.createElement('hr'); d.style.border='none'; d.style.borderTop='1px solid #eee'; d.style.margin='.5rem 0'; return d; };
    wrap.appendChild(hr());
    wrap.appendChild(rowKV('Subtotal', fmt(bk.subtotal)));
    wrap.appendChild(rowKV('A pagar ahora', fmt(bk.pagar_ahora)));
    wrap.appendChild(rowKV('Pendiente (12 días antes)', fmt(bk.pendiente)));

    function rowKV(k,v){ const d=document.createElement('div'); d.style.display='flex'; d.style.justifyContent='space-between'; d.innerHTML=`<span><strong>${k}</strong></span><strong>${v}</strong>`; return d; }
  }

  // ====== ESTADO ======
  const state = {
    service:'', startDate:'', endDate:'', startTime:'', endTime:'',
    pets:[], // [{id,name,species,isPuppy}]
    bono:null, // 10/20/30
    numWalks: 1, secondPet: false,
    duration:'60', med15:false, visitsPerDay:1, catsCount:1,
    exoSubtype:'aves',
    urgencia:false, festivo:false, senalado:false
  };

  // ====== BINDINGS ======
  function collectState(){
    state.service = $('#service').value;
    state.startDate = $('#startDate').value; state.endDate = $('#endDate').value;
    state.startTime = $('#startTime').value; state.endTime = $('#endTime').value;
    state.pets = $$('#petsList input[type="checkbox"]:checked').map(chk => ({
      id: chk.value, name: chk.closest('.pet-item')?.querySelector('strong')?.textContent || chk.value,
      species: chk.dataset.species || '',
      isPuppy: chk.dataset.ispuppy === '1'
    }));

    // Campos condicionales por servicio
    if (state.service === 'daycare') {
      state.bono = parseInt(localStorage.getItem('daycareBono')||'') || null;
    }
    if (state.service === 'walk60') {
      state.numWalks = parseInt(localStorage.getItem('walkNum')||'1');
      state.secondPet = localStorage.getItem('walkSecond') === '1';
    }
    if (state.service === 'visita_gato') {
      state.duration = localStorage.getItem('vgDur') || '60';
      state.med15 = localStorage.getItem('vgMed') === '1';
      state.visitsPerDay = parseInt(localStorage.getItem('vgVpd')||'1');
      state.catsCount = parseInt(localStorage.getItem('vgCats')||'1');
    }
    if (state.service === 'exoticos') {
      state.exoSubtype = $('#exoticosSubtype')?.value || 'otro';
    }

    state.urgencia = localStorage.getItem('supUrg') === '1';
    state.festivo = localStorage.getItem('supFest') === '1';
    state.senalado = localStorage.getItem('supSen') === '1';

    return state;
  }

  // Controles ligeros (debajo de cada fieldset en runtime)
  function ensureInlineControls(){
    // Daycare bonos
    const fs = document.getElementById('fsServicio');
    let bonoCtl = fs.querySelector('#ctlDaycareBono');
    if (!bonoCtl) {
      bonoCtl = document.createElement('div');
      bonoCtl.id='ctlDaycareBono';
      bonoCtl.className='row two';
      bonoCtl.innerHTML = `
        <div style="display:none" data-for="daycare">
          <label>¿Bono guardería?</label>
          <select id="daycareBono">
            <option value="">Sin bono</option>
            <option value="10">Bono 10</option>
            <option value="20">Bono 20</option>
            <option value="30">Bono 30</option>
          </select>
        </div>
        <div style="display:none" data-for="walk60">
          <label>Nº de paseos</label>
          <input id="walkNum" type="number" min="1" value="1" />
          <label style="display:flex; align-items:center; gap:.4rem; margin-top:.4rem;"><input id="walkSecond" type="checkbox" /> 2ª mascota</label>
        </div>
        <div style="display:none" data-for="visita_gato">
          <div class="row two">
            <div>
              <label>Duración</label>
              <select id="vgDur"><option value="60">60 min</option><option value="90">90 min</option></select>
            </div>
            <div>
              <label>Visitas por día</label>
              <input id="vgVpd" type="number" min="1" value="1" />
            </div>
          </div>
          <div class="row two">
            <div>
              <label>Nº total de gatos</label>
              <input id="vgCats" type="number" min="1" value="1" />
            </div>
            <div>
              <label>¿Medicaciones 15’?</label>
              <input id="vgMed" type="checkbox" />
            </div>
          </div>
        </div>
        <div data-for="supps" class="row two" style="margin-top:.5rem;">
          <label style="display:flex; align-items:center; gap:.4rem;"><input id="supUrg" type="checkbox" /> Urgencia</label>
          <label style="display:flex; align-items:center; gap:.4rem;"><input id="supFest" type="checkbox" /> Festivo</label>
          <label style="display:flex; align-items:center; gap:.4rem;"><input id="supSen" type="checkbox" /> Días señalados</label>
        </div>
      `;
      fs.appendChild(bonoCtl);

      // Bind persistencia en localStorage (para cálculo reactivo sencillo)
      const bind = (id, key, type='value') => {
        const el = document.getElementById(id); if(!el) return;
        const save = () => localStorage.setItem(key, (type==='checked') ? (el.checked?'1':'0') : el.value);
        el.addEventListener('input', () => { save(); refresh(); });
        el.addEventListener('change', () => { save(); refresh(); });
      };
      bind('daycareBono','daycareBono');
      bind('walkNum','walkNum'); bind('walkSecond','walkSecond','checked');
      bind('vgDur','vgDur'); bind('vgVpd','vgVpd'); bind('vgCats','vgCats'); bind('vgMed','vgMed','checked');
      bind('supUrg','supUrg','checked'); bind('supFest','supFest','checked'); bind('supSen','supSen','checked');
    }

    // Mostrar/ocultar grupos según servicio
    const service = $('#service').value;
    bonoCtl.querySelectorAll('[data-for]')?.forEach(g => {
      const target = g.getAttribute('data-for');
      const show = (target === service) || (target === 'supps');
      g.style.display = show ? 'block' : 'none';
    });
  }

  function refresh(){
    const s = collectState();
    syncSpeciesUI();
    ensureInlineControls();
    const bk = compute(s);
    renderBreakdown(bk);
  }

  // Eventos de formulario
  $('#service').addEventListener('change', ()=>{ localStorage.setItem('lastService',$('#service').value); refresh(); });
  ['startDate','endDate','startTime','endTime'].forEach(id=> $('#'+id).addEventListener('change', refresh));
  document.getElementById('petsList').addEventListener('change', refresh);

  // Botón atrás
  $('#btnBack').addEventListener('click', ()=>{
    if (document.referrer) history.back(); else location.href = '/servicios.html';
  });

  // Submit → Guardar + emails + redirect
  $('#reservaForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const user = firebase.auth().currentUser;
    if (!user) { alert('Inicia sesión para reservar.'); return; }

    const s = collectState();
    const bk = compute(s);

    // Componer documento
    const now = new Date();
    const doc = {
      _estado: 'paid_review', _uid: user.uid, _email: user.email || $('#email').value,
      _createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      service: s.service, startDate: s.startDate, endDate: s.endDate, Hora_inicio: s.startTime, Hora_fin: s.endTime,
      species: (s.service==='visita_gato' ? 'Gato' : (s.service==='exoticos' ? (s.exoSubtype||'Exótico') : '')),
      pets: s.pets, catsCount: s.catsCount||null,
      titular: {
        firstName: $('#fullName').value, email: $('#email').value, phone: $('#phone').value,
        region: $('#region').value, address: $('#address').value, postalCode: $('#postalCode').value,
        observations: $('#observations').value
      },
      total_cliente: bk.subtotal, pagar_ahora: bk.pagar_ahora, pendiente: bk.pendiente,
      total_txt: fmt(bk.subtotal), pay_now_txt: fmt(bk.pagar_ahora), pay_later_txt: fmt(bk.pendiente),
      summaryField: document.getElementById('breakdown').innerText
    };

    try {
      const ref = await db.collection('reservas').add(doc);

      // EmailJS → cliente
      const params = {
        reserva_id: ref.id,
        service: doc.service, startDate: doc.startDate, endDate: doc.endDate,
        Hora_inicio: doc.Hora_inicio, Hora_fin: doc.Hora_fin,
        species: doc.species, summaryField: doc.summaryField,
        firstName: doc.titular.firstName, email: doc.titular.email, phone: doc.titular.phone,
        region: doc.titular.region, address: doc.titular.address, postalCode: doc.titular.postalCode,
        observations: doc.titular.observations,
        _estado: doc._estado, _uid: doc._uid, _email: doc._email,
        total_cliente: doc.total_cliente, pagar_ahora: doc.pagar_ahora, pendiente: doc.pendiente,
        total_txt: doc.total_txt, pay_now_txt: doc.pay_now_txt, pay_later_txt: doc.pay_later_txt,
        admin_email: (window.TPL_EMAILJS?.adminEmail || 'gestion@thepetslovers.es')
      };

      await emailjs.send(window.TPL_EMAILJS.serviceId, window.TPL_EMAILJS.templates.cliente, params);
      // EmailJS → gestión
      await emailjs.send(window.TPL_EMAILJS.serviceId, window.TPL_EMAILJS.templates.gestion, params);

      alert('Tu reserva se ha registrado y está en revisión.');
      // Copia a localStorage (respaldo ligero)
      try { localStorage.setItem('lastReserva', JSON.stringify({ id: ref.id, ...doc })); } catch(e) {}
      // Redirect suave a perfil
      setTimeout(()=> location.href = '/perfil.html', 600);
    }
    catch(err){
      console.error(err);
      alert('No se pudo completar la reserva. Revísalo e inténtalo de nuevo.');
    }
  });

  // Inicialización
  (function init(){
    // Fechas mínimas (hoy)
    $('#startDate').min = todayStr();
    $('#endDate').min = todayStr();

    // Preselección servicio
    preselectService();
    syncSpeciesUI();
    ensureInlineControls();
    refresh();
  })();
})();
```

---

## Notas rápidas de integración

* **Mismo diseño del sitio**: esta página solo añade estilos mínimos (hero y pequeños ajustes). Todo lo demás lo hereda de `style.css`, `tpl-navbar.js` y `tpl-footer.js`.
* **Auth wall**: el `form` lleva `data-disabled="true"` cuando no hay sesión y muestra el muro. Al autenticarte, se desbloquean los campos.
* **Preselección del servicio**: acepta `?service=` o `?svc=` (valores: `daycare`, `overnight`, `walk60`, `visita_gato`, `exoticos`, `transporte`). También memoriza `lastService` en `localStorage`.
* **Autorrelleno de titular + mascotas**: lectura de `propietarios/{uid}` con campos `fullName, email, phone, address, postalCode, region` y `pets` (array `{id,name,species,birth,subtype}`). El badge “Cachorro ≤6m” se calcula desde `birth`.
* **Desglose dinámico**: precio base/bonos/suplementos + “A pagar ahora” y “Pendiente (12 días antes)”.
* **Margen / auxiliar**: si **rellenas** `window.TPL_AUX_RULES` con tus importes internos por día/visita, el cálculo será exacto. Si no, aplica un margen por defecto del **20%** sobre el subtotal. Los festivos añaden el coste auxiliar oculto de **8 €** (normal) y **15 €** (señalados) por la parte del auxiliar para que **no aumente tu margen**.
* **EmailJS**: usa `window.TPL_EMAILJS` (IDs de ejemplo). Sustituye por tus valores si difieren.
* **Firestore**: guarda en `reservas` con `_estado: "paid_review"` y todos los campos necesarios para mostrar en el perfil.
* **Botón Atrás**: vuelve al `history.back()` o a `/servicios.html` si no hay referrer.
* **Opcionales (iteración 2)**: duración visible 60/90/15, nº visitas/día, urgencia automática (<2h), preferencia de contacto, franja, desplazamiento, Stripe para pago de margen, bloqueo de festivos por CA.
