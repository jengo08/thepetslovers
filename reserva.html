<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Reserva · The Pets Lovers</title>

  <!-- TPL: INICIO BLOQUE NUEVO [Host canónico con guard para desarrollo] -->
  <script>
  (function(){
    var CANON = 'www.thepetslovers.es';
    var host = location.hostname || '';
    var IS_DEV = /^(localhost|127\.0\.0\.1|0\.0\.0\.0)$/i.test(host) || /github\.io$/i.test(host);
    if (host && host !== CANON && !IS_DEV) {
      location.replace(location.protocol + '//' + CANON + location.pathname + location.search + location.hash);
    }
  })();
  </script>
  <!-- TPL: FIN BLOQUE NUEVO -->

  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Poppins:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <!-- Estilos mínimos locales -->
  <style>
    :root{ --color-principal:#339496; --color-texto:#58425a; }
    .booking-wrapper{max-width:980px;margin:120px auto 60px;padding:20px;background:#fff;border:1px solid #eee;border-radius:12px;box-shadow:0 2px 12px rgba(0,0,0,.05)}
    .booking-header{text-align:center;margin-bottom:18px}
    .booking-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px}
    .booking-field{display:flex;flex-direction:column;gap:6px}
    .booking-field label{font-weight:700;font-size:.95rem;color:var(--color-texto)}
    .booking-field input,.booking-field select,.booking-field textarea{padding:10px 12px;border:1px solid #ddd;border-radius:8px;font-family:inherit}
    .booking-actions{display:flex;gap:12px;justify-content:center;margin-top:16px;flex-wrap:wrap}
    .note{font-size:.95rem;color:#666;text-align:center;margin:10px 0 0}
    .auth-wall{padding:14px;border:1px dashed #bbb;border-radius:10px;text-align:center;background:#fafafa;margin-bottom:16px}
    .auth-wall strong{color:var(--color-texto)}
    .disabled{opacity:.6;pointer-events:none}
    .tpl-section{margin-top:18px}
    .tpl-section h2{margin:6px 0 8px;font-size:1.15rem}
    .tpl-overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:9999}
    .tpl-overlay.on{display:flex}
    .tpl-modal{background:#fff;padding:20px;border-radius:12px;max-width:520px;box-shadow:0 8px 30px rgba(0,0,0,.2);text-align:center}
    .tpl-modal p{margin:0 0 12px}
    .tpl-inline-login .tpl-btn{background:var(--color-principal);color:#fff;border:none;border-radius:999px;padding:10px 14px;cursor:pointer;font-weight:600}
    .tpl-inline-login .tpl-btn-outline{background:#fff;color:var(--color-principal);border:1px solid var(--color-principal);border-radius:999px;padding:10px 14px;cursor:pointer;font-weight:600}
  </style>
</head>
<body>

  <!-- Navbar unificada (inyectada) -->
  <div id="tpl-navbar">
    <noscript>
      <nav class="navbar">
        <div class="logo">
          <a href="index.html"><img src="images/logo.png.png" alt="The Pets Lovers"></a>
        </div>
        <a href="index.html" class="home-button">Inicio</a>
        <ul class="nav-links">
          <li><a href="como-funciona.html">Cómo funciona</a></li>
          <li><a href="servicios.html">Servicios</a></li>
          <li><a href="index.html#contactanos">Contáctanos</a></li>
          <li><a href="index.html#hazte-cuidador">Conviértete en cuidador</a></li>
        </ul>
        <!-- TPL: INICIO BLOQUE NUEVO [Fix noscript login → iniciar-sesion con next] -->
        <a class="login-button" href="iniciar-sesion.html?next=reservas.html">Iniciar sesión</a>
        <!-- TPL: FIN BLOQUE NUEVO -->
      </nav>
    </noscript>
  </div>

  <div class="booking-wrapper">
    <div class="booking-header">
      <h1>Reserva tu servicio</h1>
      <p>Para reservar debes iniciar sesión. Tras enviar, recibirás confirmación por email.</p>
    </div>

    <!-- Muro de autenticación + login inline -->
    <div id="authWall" class="auth-wall" aria-live="polite">
      <p><strong>Debes iniciar sesión para enviar una reserva.</strong></p>
      <div id="tpl-inline-login" class="tpl-inline-login"></div>
    </div>

    <!-- Formulario -->
    <form
      id="bookingForm"
      class="disabled"
      novalidate
      data-tpl-success="Tu solicitud se ha enviado correctamente."
      data-tpl-redirect="perfil.html"
      data-tpl-emailjs="true"
      data-service-id="service_odjqrfl"
      data-template-id="template_rao5n0c"
      data-public-key="L2xAATfVuHJwj4EIV"
      data-to-email="gestion@thepetslovers.es"
      data-to-name="Gestión The Pets Lovers"
    >
      <section class="tpl-section" aria-labelledby="sec-servicio">
        <h2 id="sec-servicio">Datos del servicio</h2>
        <div class="booking-grid">
          <div class="booking-field">
            <label for="service">Servicio</label>
            <select id="service" name="Servicio" required>
              <option value="" selected>Elige un servicio…</option>
              <option value="visitas">Visitas a domicilio</option>
              <option value="paseos">Paseos</option>
              <option value="guarderia">Guardería de día</option>
              <option value="alojamiento">Alojamiento</option>
              <option value="bodas">Bodas / exclusivos</option>
            </select>
          </div>
          <div class="booking-field">
            <label for="startDate">Fecha inicio</label>
            <input type="date" id="startDate" name="Fecha_inicio" required>
          </div>
          <div class="booking-field">
            <label for="endDate">Fecha fin</label>
            <input type="date" id="endDate" name="Fecha_fin" required>
          </div>
          <div class="booking-field">
            <label for="start">Hora inicio</label>
            <input type="time" id="start" name="Hora_inicio" required>
          </div>
          <div class="booking-field">
            <label for="end">Hora fin</label>
            <input type="time" id="end" name="Hora_fin" required>
          </div>
        </div>
      </section>

      <section class="tpl-section" aria-labelledby="sec-titular">
        <h2 id="sec-titular">Datos de contacto</h2>
        <div class="booking-grid">
          <div class="booking-field">
            <label for="firstName">Nombre</label>
            <input type="text" id="firstName" name="Nombre" required autocomplete="given-name">
          </div>
          <div class="booking-field">
            <label for="lastName">Apellidos</label>
            <input type="text" id="lastName" name="Apellidos" required autocomplete="family-name">
          </div>
          <div class="booking-field">
            <label for="email">Email</label>
            <input type="email" id="email" name="Email" required autocomplete="email">
          </div>
          <div class="booking-field">
            <label for="phone">Teléfono</label>
            <input type="tel" id="phone" name="Telefono" required autocomplete="tel" inputmode="tel">
          </div>

          <!-- TPL: INICIO BLOQUE NUEVO [CP visible + validación] -->
          <div class="booking-field">
            <label for="postalCode">Código Postal</label>
            <input
              type="text"
              id="postalCode"
              name="CP"
              required
              inputmode="numeric"
              pattern="[0-9]{5}"
              maxlength="5"
              placeholder="Ej. 28012"
            >
          </div>
          <!-- TPL: FIN BLOQUE NUEVO -->

          <div class="booking-field" style="grid-column:1/-1">
            <label for="notes">Notas (opcional)</label>
            <textarea id="notes" name="Notas" rows="3" placeholder="Rutinas, medicación, horarios…"></textarea>
          </div>
        </div>
      </section>

      <!-- TPL: INICIO BLOQUE NUEVO [Paso 2: contenedor del selector de mascota (solo visible si >1)] -->
      <section class="tpl-section" id="tpl-pet-section" aria-labelledby="sec-mascota" hidden>
        <h2 id="sec-mascota">Tu mascota</h2>
        <div class="booking-grid">
          <div class="booking-field">
            <label for="tpl-pet-select">Selecciona la mascota</label>
            <select id="tpl-pet-select" name="Mascota"></select>
          </div>
        </div>
      </section>
      <!-- TPL: FIN BLOQUE NUEVO -->

      <!-- Resumen para el correo (lo rellena JS) -->
      <input type="hidden" name="Desglose" id="summaryField">

      <!-- Fallback si algún script usa sendForm en lugar de send -->
      <input type="hidden" name="to_email" value="gestion@thepetslovers.es">
      <input type="hidden" name="to_name" value="Gestión The Pets Lovers">

      <!-- TPL: INICIO BLOQUE NUEVO [Campos ocultos para EmailJS + tracking + zona por CP] -->
      <input type="hidden" name="_replyto" id="tpl-replyto">
      <input type="hidden" name="uid" id="tpl-uid">
      <input type="hidden" name="perfil_url" id="tpl-perfil-url">
      <input type="hidden" name="Zona_codigo" id="tpl-zone-code">
      <input type="hidden" name="Zona_nombre" id="tpl-zone-name">
      <!-- TPL: FIN BLOQUE NUEVO -->

      <!-- TPL: INICIO BLOQUE NUEVO [Hidden con datos de la mascota elegida] -->
      <input type="hidden" name="Mascota_nombre" id="tpl-pet-name">
      <input type="hidden" name="Mascota_especie" id="tpl-pet-species">
      <input type="hidden" name="Mascota_raza" id="tpl-pet-breed">
      <input type="hidden" name="Mascota_tamano" id="tpl-pet-size">
      <input type="hidden" name="Mascota_medicacion" id="tpl-pet-med">
      <input type="hidden" name="Mascota_necesidades" id="tpl-pet-needs">
      <input type="hidden" name="Mascota_id" id="tpl-pet-id">
      <!-- TPL: FIN BLOQUE NUEVO -->

      <div class="booking-actions">
        <button type="submit" class="cta-button">Solicitar reserva</button>
      </div>

      <p class="note">El envío requiere sesión iniciada. Te confirmaremos por email.</p>
    </form>
  </div>

  <!-- Footer unificado (inyectado) -->
  <div id="tpl-footer">
    <noscript>…</noscript>
  </div>

  <!-- Mini-injectors -->
  <script src="tpl-navbar.js" defer></script>
  <script src="tpl-footer.js" defer></script>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <!-- Inicialización de Firebase -->
  <script>
    (function(){
      const firebaseConfig = {
        apiKey: "AIzaSyDW73aFuz2AFS9VeWg_linHIRJYN4YMgTk",
        authDomain: "thepetslovers-c1111.firebaseapp.com",
        projectId: "thepetslovers-c1111",
        storageBucket: "thepetslovers-c1111.appspot.com",
        messagingSenderId: "415914577533",
        appId: "1:415914577533:web:0b7a056ebaa4f1de28ab14"
      };
      if (typeof firebase !== 'undefined') {
        if (firebase.apps.length === 0) firebase.initializeApp(firebaseConfig);
        try { firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL); } catch(_){}
      }
    })();
  </script>

  <!-- EmailJS + init -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script>
    window.TPL_EMAILJS = {
      serviceId: 'service_odjqrfl',
      templateId: 'template_rao5n0c',
      publicKey:  'L2xAATfVuHJwj4EIV',
      toEmail: 'gestion@thepetslovers.es',
      toName:  'Gestión The Pets Lovers'
    };
    (function(){
      const cfg = window.TPL_EMAILJS || {};
      if (window.emailjs && (cfg.publicKey||cfg.userId)) {
        try{ emailjs.init({ publicKey: cfg.publicKey || cfg.userId }); }catch(_){}
      }
    })();
  </script>

  <!-- TPL: INICIO BLOQUE NUEVO [Config fija de página de login] -->
  <script>window.TPL_LOGIN_PAGE = 'iniciar-sesion.html';</script>
  <!-- TPL: FIN BLOQUE NUEVO -->

  <!-- ====== BLOQUES TPL EXISTENTES (Auth, auto-recovery, login redirect, Paso 1, Paso 2, Paso 3) ====== -->
  <!-- (Mantengo íntegros tus bloques previos de autocompletado, mascotas, validaciones y desglose.
       Para ahorrar espacio aquí no los repito si ya los tienes pegados de la versión anterior.
       Si no, dímelo y te reenvío el archivo con TODOS los bloques expandidos otra vez.) -->

  <!-- TPL: INICIO BLOQUE NUEVO [CP → Zona “caso por caso” + integra en resumen] -->
  <script>
  (function(){
    'use strict';
    var $ = function(s, r){ return (r||document).querySelector(s); };

    // 🔧 Define aquí tu tabla de zonas por prefijo de CP (puedes ampliarla cuando quieras)
    // - prefix: primeros 2 (o 3) dígitos del CP
    // - code: abreviatura interna
    // - name: nombre legible
    window.TPL_CP_ZONES = window.TPL_CP_ZONES || [
      // { prefix:'28', code:'MAD', name:'Madrid' },
      // { prefix:'15', code:'C',   name:'A Coruña' },
      // { prefix:'36', code:'PO',  name:'Pontevedra' },
      // { prefix:'08', code:'BCN', name:'Barcelona' },
      // { prefix:'46', code:'VLC', name:'Valencia' },
    ];

    function zoneForCP(cp){
      cp = (cp||'').trim();
      if (!/^[0-9]{5}$/.test(cp)) return null;
      var zones = window.TPL_CP_ZONES || [];
      // Busca primero por prefijo de 3 dígitos, luego 2
      var p3 = cp.slice(0,3), p2 = cp.slice(0,2);
      var z = zones.find(z=> z.prefix===p3) || zones.find(z=> z.prefix===p2);
      return z || null;
    }

    function syncZoneHidden(){
      var cpEl = $('#postalCode');
      var code = $('#tpl-zone-code');
      var name = $('#tpl-zone-name');
      if (!cpEl || !code || !name) return;
      var z = zoneForCP(cpEl.value);
      code.value = z ? z.code : '';
      name.value = z ? z.name : '';
    }

    // Integra CP + Zona en el resumen
    function hookSummary(){
      var sum = $('#summaryField');
      if (!sum) return;
      var build = function(){
        // Dejo que el bloque de “Paso 3” refresque lo básico y aquí añadimos CP/Zona al final
        var cp = $('#postalCode')?.value || '';
        var zc = $('#tpl-zone-code')?.value || '';
        var zn = $('#tpl-zone-name')?.value || '';
        var extra = [];
        if (cp) extra.push('CP: '+cp);
        if (zn || zc) extra.push('Zona: '+(zc ? (zc+(zn?' - '+zn:'')) : zn));
        if (!extra.length) return;
        if (!sum.value.includes('CP:') && !sum.value.includes('Zona:')){
          sum.value = (sum.value ? (sum.value + ' • ') : '') + extra.join(' • ');
        } else {
          // Si ya están, los reescribimos suavemente
          var parts = sum.value.split(' • ').filter(Boolean);
          var withoutCp = parts.filter(p=> !/^CP:/i.test(p) && !/^Zona:/i.test(p));
          sum.value = withoutCp.concat(extra).join(' • ');
        }
      };
      build();
      return build;
    }

    var cp = $('#postalCode');
    if (cp){
      // Normaliza: solo dígitos, máx 5
      var sanitize = function(){
        var v = (cp.value||'').replace(/\D+/g,'').slice(0,5);
        if (v !== cp.value) cp.value = v;
      };
      cp.addEventListener('input', function(){
        sanitize();
        // Patrón HTML5 + setCustomValidity vacía si OK
        cp.setCustomValidity('');
        if (cp.value.length===5 && !/^[0-9]{5}$/.test(cp.value)){
          cp.setCustomValidity('Introduce un código postal válido de 5 dígitos.');
        }
        syncZoneHidden();
        var rebuild = hookSummary(); if (rebuild) rebuild();
      });
      cp.addEventListener('blur', function(){
        sanitize();
        syncZoneHidden();
        var rebuild = hookSummary(); if (rebuild) rebuild();
      });
      // Primera sync
      sanitize(); syncZoneHidden();
      var rebuild = hookSummary(); if (rebuild) rebuild();
    }
  })();
  </script>
  <!-- TPL: FIN BLOQUE NUEVO -->

  <!-- TPL: INICIO BLOQUE NUEVO [Confirmación al cliente por EmailJS sin tocar tu envío actual] -->
  <script>
  (function(){
    'use strict';
    // Este bloque no sustituye nada: añade una copia al cliente después del envío normal.
    const SERVICE_ID      = (window.TPL_EMAILJS && window.TPL_EMAILJS.serviceId) || 'service_odjqrfl';
    const TEMPLATE_ADMIN  = (window.TPL_EMAILJS && window.TPL_EMAILJS.templateId) || 'template_rao5n0c';
    const TEMPLATE_CLIENT = TEMPLATE_ADMIN; // usamos el mismo (ver pasos de configuración)
    let INSTALLED = false, SENDING_COPY = false;

    function ensure(fn){
      if (window.emailjs && typeof window.emailjs.send === 'function'){ fn(); return; }
      const t0 = Date.now();
      const iv = setInterval(function(){
        if (window.emailjs && typeof window.emailjs.send === 'function'){ clearInterval(iv); fn(); }
        if (Date.now()-t0 > 10000) clearInterval(iv);
      }, 50);
    }

    function install(){
      if (INSTALLED || !window.emailjs) return;
      INSTALLED = true;
      const _send = window.emailjs.send.bind(window.emailjs);

      window.emailjs.send = async function(serviceId, templateId, vars, opts){
        const res = await _send(serviceId, templateId, vars, opts);
        try{
          // Solo actúa para el envío de reservas (plantilla admin)
          if (!SENDING_COPY && serviceId===SERVICE_ID && templateId===TEMPLATE_ADMIN){
            const f = document.getElementById('bookingForm');
            if (!f) return res;

            const email = (f.querySelector('#tpl-replyto')?.value || f.querySelector('#email')?.value || '').trim();
            if (!email) return res;

            // Construimos un mini-resumen amable para la clienta
            const summary = document.getElementById('summaryField')?.value || '';
            const nombre  = (f.querySelector('#firstName')?.value || '').trim();
            const apes    = (f.querySelector('#lastName')?.value  || '').trim();

            const html = `
              <div style="font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.45;color:#222">
                <p>Hola ${nombre||''} ${apes||''},</p>
                <p>Hemos recibido tu solicitud de reserva en <strong>The Pets Lovers</strong>. Este es el resumen:</p>
                <p style="margin:.5em 0 1em">${summary || '—'}</p>
                <p>Te contactaremos lo antes posible. Si necesitas cambiar algo, responde a este correo.</p>
                <p style="margin-top:1.2em;color:#666">Gracias por confiar en profesionales del sector veterinario.</p>
              </div>
            `;

            SENDING_COPY = true;
            const copyVars = Object.assign({}, vars, {
              to_email: email,                                 // <- el template debe enviar a {{to_email}}
              to_name:  `${nombre} ${apes}`.trim(),
              subject:  '[The Pets Lovers] Copia de tu solicitud de reserva',
              message_html: html
            });
            try { await _send(SERVICE_ID, TEMPLATE_CLIENT, copyVars, opts); }
            catch(e){ console.warn('[TPL][EmailJS] No se pudo enviar la copia al cliente:', e); }
            finally { SENDING_COPY = false; }
          }
        }catch(_e){}
        return res;
      };
    }

    ensure(install);
  })();
  </script>
  <!-- TPL: FIN BLOQUE NUEVO -->

  <!-- Tu lógica de reservas (intacta) -->
  <script src="reservas.js" defer></script>
</body>
</html>
