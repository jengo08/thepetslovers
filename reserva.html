<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Reserva · The Pets Lovers</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Poppins:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <style>
    .booking-wrapper{ max-width: 980px; margin: 120px auto 60px; padding: 20px; background: #fff; border:1px solid #eee; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,.05);}
    .booking-header{ text-align:center; margin-bottom: 18px; }
    .booking-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:16px; }
    .booking-field{ display:flex; flex-direction:column; gap:6px; }
    .booking-field label{ font-weight:700; font-size:.95rem; color: var(--color-texto); }
    .booking-field input, .booking-field select, .booking-field textarea{
      padding:10px 12px; border:1px solid #ddd; border-radius:8px; font-family:var(--fuente-texto);
    }
    .booking-actions{ display:flex; gap:12px; justify-content:center; margin-top: 16px; flex-wrap: wrap; }
    .note{ font-size:.95rem; color:#666; text-align:center; margin: 10px 0 0; }
    .auth-wall{ padding:14px; border:1px dashed #bbb; border-radius:10px; text-align:center; background:#fafafa; margin-bottom:16px; }
    .auth-wall strong{ color: var(--color-texto); }
    .disabled{ opacity:.6; pointer-events:none; }
    .summary-panel{ margin-top: 16px; background:#fafafa; border:1px solid #eee; border-radius:10px; padding:16px; }
    .summary-grid{ display:grid; grid-template-columns: 1fr auto; gap:8px; align-items:center; }
    .summary-row{ display:contents; }
    .summary-label{ color:#555; }
    .summary-value{ font-weight:700; color: var(--color-texto); text-align:right; }
    .summary-muted{ color:#999; font-weight:400; }
    .summary-total{ border-top:1px solid #e7e7e7; margin-top:8px; padding-top:8px; font-size:1.05rem; }
    .tpl-addr-wrap{ position: relative; }
    .tpl-addr-suggest{ position:absolute; inset:auto 0 0 0; transform: translateY(calc(100% + 6px));
      background:#fff; border:1px solid #ddd; border-radius:10px; box-shadow: 0 6px 18px rgba(0,0,0,.08); z-index: 999;
      max-height: 240px; overflow:auto; display:none; }
    .tpl-addr-item{ padding:10px 12px; cursor:pointer; }
    .tpl-addr-item:hover, .tpl-addr-item:focus{ background:#f5f7f8; outline:none; }
    .tpl-actions{
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      align-items:center; gap:12px; width:100%;
    }
    .tpl-actions .tpl-spacer{ display:block; }
    .tpl-actions .tpl-help{ font-size:.9rem; padding:8px 10px; border:2px solid var(--color-principal); color:var(--color-principal); background:#fff; border-radius:8px; justify-self:end; }
    .travel-bubble{ display:none; margin-top:6px; padding:10px 12px; border:1px dashed #bbb; border-radius:10px; background:#f9f9f9; color:#666; text-align:left;}
    .tpl-section{ margin-top: 18px; }
    .tpl-section h2{ margin: 6px 0 8px; font-size:1.15rem; }
  </style>
</head>
<body>

  <!-- Navbar unificada (inyectada) -->
  <div id="tpl-navbar">...</div>

  <div class="booking-wrapper">
    <!-- ... resto del formulario igual ... -->
  </div>

  <!-- ====== Constantes de precios y bonos ====== -->
  <script>
    const PRICES = {
      base: { visitas: 22, paseos: 12, guarderia: 15, alojamiento: 30, bodas: 0 },
      puppyBase: { guarderia: 20, alojamiento: 35 },
      visita60: 22, visita90: 30,
      visita60_larga: 18, visita90_larga: 27,
      visitaMed: 12, visitaMed_larga: 10,
      depositPct: 0.20
    };
    const BUNDLE_GUARDERIA = {
      adult:  { 10: 135, 20: 250, 30: 315 },
      puppy:  { 10: 185, 20: 350, 30: 465 }
    };
  </script>

  <!-- ====== Lógica de reservas ====== -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('bookingForm');
    const wall = document.getElementById('authWall');
    const els = { service: byId('service'), /* ... resto igual ... */ };

    function byId(id){ return document.getElementById(id); }
    const qs = (k) => new URLSearchParams(location.search).get(k);

    /* TPL: INICIO BLOQUE NUEVO [Preselección por query o por página de origen] */
    function inferServiceFromReferrer(){
      try{
        const u = new URL(document.referrer || '');
        const p = (u.pathname || '').toLowerCase();
        if(p.includes('servicio-guarderia') || p.includes('guarderia')) return 'guarderia';
        if(p.includes('servicio-estancias') || p.includes('estancias')) return 'alojamiento'; /* TPL: actualizado */
        if(p.includes('servicio-paseos') || p.includes('paseos')) return 'paseos';            /* TPL: actualizado */
        if(p.includes('servicio-visitas') || p.includes('visitas')) return 'visitas';
      }catch(_){}
      return null;
    }

    (function presetService(){
      const raw = (qs('service') || qs('svc') || '').toLowerCase();
      const norm = raw.normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'-');
      const map = {
        'visitas':'visitas','visitas-gatos':'visitas',
        'paseos':'paseos',
        'guarderia':'guarderia','guarderia-dia':'guarderia',
        'alojamiento':'alojamiento',
        'bodas':'bodas'
      };
      let val = map[norm] || inferServiceFromReferrer();
      if(val && els.service){ els.service.value = val; els.service.disabled = true; }
    })();
    /* TPL: FIN BLOQUE NUEVO */

    // ... resto de la lógica igual ...
  });
  </script>

  <!-- Footer unificado -->
  <div id="tpl-footer">...</div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-analytics-compat.js"></script>
  <script>
    const firebaseConfig = { /* ... tu config igual ... */ };
    if (typeof firebase !== 'undefined') {
      if (firebase.apps.length === 0) firebase.initializeApp(firebaseConfig);
      if (firebase.analytics) { try { firebase.analytics(); } catch(e){} }
    }
  </script>
</body>
</html>
