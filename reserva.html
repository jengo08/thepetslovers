<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Reserva · The Pets Lovers</title>

  <!-- TPL: INICIO BLOQUE NUEVO [Host canónico con guard para desarrollo] -->
  <script>
  (function(){
    var CANON = 'www.thepetslovers.es';
    var host = location.hostname || '';
    // No redirigimos si estás en desarrollo o GitHub Pages
    var IS_DEV = /^(localhost|127\.0\.0\.1|0\.0\.0\.0)$/i.test(host) || /github\.io$/i.test(host);
    if (host && host !== CANON && !IS_DEV) {
      location.replace(location.protocol + '//' + CANON + location.pathname + location.search + location.hash);
    }
  })();
  </script>
  <!-- TPL: FIN BLOQUE NUEVO -->

  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Poppins:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <!-- Estilos mínimos locales -->
  <style>
    :root{ --color-principal:#339496; --color-texto:#58425a; }
    .booking-wrapper{max-width:980px;margin:120px auto 60px;padding:20px;background:#fff;border:1px solid #eee;border-radius:12px;box-shadow:0 2px 12px rgba(0,0,0,.05)}
    .booking-header{text-align:center;margin-bottom:18px}
    .booking-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px}
    .booking-field{display:flex;flex-direction:column;gap:6px}
    .booking-field label{font-weight:700;font-size:.95rem;color:var(--color-texto)}
    .booking-field input,.booking-field select,.booking-field textarea{padding:10px 12px;border:1px solid #ddd;border-radius:8px;font-family:inherit}
    .booking-actions{display:flex;gap:12px;justify-content:center;margin-top:16px;flex-wrap:wrap}
    .note{font-size:.95rem;color:#666;text-align:center;margin:10px 0 0}
    .auth-wall{padding:14px;border:1px dashed #bbb;border-radius:10px;text-align:center;background:#fafafa;margin-bottom:16px}
    .auth-wall strong{color:var(--color-texto)}
    .disabled{opacity:.6;pointer-events:none}
    .tpl-section{margin-top:18px}
    .tpl-section h2{margin:6px 0 8px;font-size:1.15rem}
    .tpl-overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:9999}
    .tpl-overlay.on{display:flex}
    .tpl-modal{background:#fff;padding:20px;border-radius:12px;max-width:520px;box-shadow:0 8px 30px rgba(0,0,0,.2);text-align:center}
    .tpl-modal p{margin:0 0 12px}
    .tpl-inline-login .tpl-btn{background:var(--color-principal);color:#fff;border:none;border-radius:999px;padding:10px 14px;cursor:pointer;font-weight:600}
    .tpl-inline-login .tpl-btn-outline{background:#fff;color:var(--color-principal);border:1px solid var(--color-principal);border-radius:999px;padding:10px 14px;cursor:pointer;font-weight:600}
  </style>
</head>
<body>

  <!-- Navbar unificada (inyectada) -->
  <div id="tpl-navbar">
    <noscript>
      <nav class="navbar">
        <div class="logo">
          <a href="index.html"><img src="images/logo.png.png" alt="The Pets Lovers"></a>
        </div>
        <a href="index.html" class="home-button">Inicio</a>
        <ul class="nav-links">
          <li><a href="como-funciona.html">Cómo funciona</a></li>
          <li><a href="servicios.html">Servicios</a></li>
          <li><a href="index.html#contactanos">Contáctanos</a></li>
          <li><a href="index.html#hazte-cuidador">Conviértete en cuidador</a></li>
        </ul>
        <a class="login-button" href="#iniciar-sesion">Iniciar sesión</a>
      </nav>
    </noscript>
  </div>

  <div class="booking-wrapper">
    <div class="booking-header">
      <h1>Reserva tu servicio</h1>
      <p>Para reservar debes iniciar sesión. Tras enviar, recibirás confirmación por email.</p>
    </div>

    <!-- Muro de autenticación + login inline -->
    <div id="authWall" class="auth-wall" aria-live="polite">
      <p><strong>Debes iniciar sesión para enviar una reserva.</strong></p>
      <div id="tpl-inline-login" class="tpl-inline-login"></div>
    </div>

    <!-- Formulario -->
    <form id="bookingForm" class="disabled" novalidate
      data-tpl-success="Tu solicitud se ha enviado correctamente."
      data-tpl-redirect="perfil.html">
      <section class="tpl-section" aria-labelledby="sec-servicio">
        <h2 id="sec-servicio">Datos del servicio</h2>
        <div class="booking-grid">
          <div class="booking-field">
            <label for="service">Servicio</label>
            <select id="service" name="Servicio" required>
              <option value="" selected>Elige un servicio…</option>
              <option value="visitas">Visitas a domicilio</option>
              <option value="paseos">Paseos</option>
              <option value="guarderia">Guardería de día</option>
              <option value="alojamiento">Alojamiento</option>
              <option value="bodas">Bodas / exclusivos</option>
            </select>
          </div>
          <div class="booking-field">
            <label for="startDate">Fecha inicio</label>
            <input type="date" id="startDate" name="Fecha_inicio" required>
          </div>
          <div class="booking-field">
            <label for="endDate">Fecha fin</label>
            <input type="date" id="endDate" name="Fecha_fin" required>
          </div>
          <div class="booking-field">
            <label for="start">Hora inicio</label>
            <input type="time" id="start" name="Hora_inicio" required>
          </div>
          <div class="booking-field">
            <label for="end">Hora fin</label>
            <input type="time" id="end" name="Hora_fin" required>
          </div>
        </div>
      </section>

      <section class="tpl-section" aria-labelledby="sec-titular">
        <h2 id="sec-titular">Datos de contacto</h2>
        <div class="booking-grid">
          <div class="booking-field">
            <label for="firstName">Nombre</label>
            <input type="text" id="firstName" name="Nombre" required autocomplete="given-name">
          </div>
          <div class="booking-field">
            <label for="lastName">Apellidos</label>
            <input type="text" id="lastName" name="Apellidos" required autocomplete="family-name">
          </div>
          <div class="booking-field">
            <label for="email">Email</label>
            <input type="email" id="email" name="Email" required autocomplete="email">
          </div>
          <div class="booking-field">
            <label for="phone">Teléfono</label>
            <input type="tel" id="phone" name="Telefono" required autocomplete="tel">
          </div>
          <div class="booking-field" style="grid-column:1/-1">
            <label for="notes">Notas (opcional)</label>
            <textarea id="notes" name="Notas" rows="3" placeholder="Rutinas, medicación, horarios…"></textarea>
          </div>
        </div>
      </section>

      <input type="hidden" name="Desglose" id="summaryField">

      <div class="booking-actions">
        <button type="submit" class="cta-button">Solicitar reserva</button>
      </div>

      <p class="note">El envío requiere sesión iniciada. Te confirmaremos por email.</p>
    </form>
  </div>

  <!-- Footer unificado (inyectado) -->
  <div id="tpl-footer">
    <noscript>…</noscript>
  </div>

  <!-- Mini-injectors -->
  <script src="tpl-navbar.js" defer></script>
  <script src="tpl-footer.js" defer></script>

  <!-- Firebase SDKs (SIN defer, antes del init y del reservas.js) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <!-- Inicialización de Firebase: crea la app y fija la persistencia -->
  <script>
    (function(){
      const firebaseConfig = {
        apiKey: "AIzaSyDW73aFuz2AFS9VeWg_linHIRJYN4YMgTk",
        authDomain: "thepetslovers-c1111.firebaseapp.com",
        projectId: "thepetslovers-c1111",
        storageBucket: "thepetslovers-c1111.appspot.com",
        messagingSenderId: "415914577533",
        appId: "1:415914577533:web:0b7a056ebaa4f1de28ab14"
      };
      if (typeof firebase !== 'undefined') {
        if (firebase.apps.length === 0) firebase.initializeApp(firebaseConfig);
        try { firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL); } catch(_){}
      }
    })();
  </script>

  <!-- EmailJS + init -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script>
    window.TPL_EMAILJS = {
      serviceId: 'service_odjqrfl',
      templateId: 'template_rao5n0c',
      publicKey:  'L2xAATfVuHJwj4EIV'
    };
    (function(){
      const cfg = window.TPL_EMAILJS || {};
      if (window.emailjs && (cfg.publicKey||cfg.userId)) {
        try{ emailjs.init({ publicKey: cfg.publicKey || cfg.userId }); }catch(_){}
      }
    })();
  </script>

  <!-- (Opcional) Forzar login en esta página -->
  <!-- <script>window.TPL_REQUIRE_LOGIN_ON_RESERVAS = true;</script> -->

  <!-- TPL: INICIO BLOQUE NUEVO [Bootstrap Auth unificado + builder de login URL + muro] -->
  <script>
  (function(){
    'use strict';
    var DEBUG = /[?&]debugAuth=1\b/.test(location.search);

    function $(sel, root){ return (root||document).querySelector(sel); }

    // ===== Builder de URL de login (configurable) =====
    /* Puedes forzar el archivo exacto así, en cualquier <script> antes de este:
       window.TPL_LOGIN_PAGE = 'iniciar-sesion.html';
    */
    var LOGIN_CANDIDATES = ['iniciar-sesión.html','iniciar-sesion.html','login.html'];
    function getLoginBase(){
      return window.TPL_LOGIN_PAGE || LOGIN_CANDIDATES[0];
    }
    function buildNext(){
      // next = ruta actual (sin dominio) + query + hash
      var p = (location.pathname || '').replace(/^\//,'');
      return p + (location.search || '') + (location.hash || '');
    }
    function buildLoginUrl(nextOverride){
      var base = getLoginBase();
      var next = nextOverride || buildNext();
      return base + '?next=' + encodeURIComponent(next);
    }

    // ===== Estado global de Auth =====
    window.__TPL_AUTH__ = window.__TPL_AUTH__ || { user:null, ready:null };

    function setupAuthBridge(){
      if (typeof firebase === 'undefined' || !firebase.auth) return;
      var auth = firebase.auth();

      if (!window.__TPL_AUTH__.ready) {
        window.__TPL_AUTH__.ready = new Promise(function(resolve){
          var first = true;
          function handle(user){
            window.__TPL_AUTH__.user = user || null;

            try {
              document.body.setAttribute('data-auth', user ? 'in' : 'out');
              if (user && !user.isAnonymous){
                localStorage.setItem('tpl_auth_email', user.email || '');
                localStorage.setItem('tpl_auth_uid',   user.uid   || '');
              } else {
                localStorage.removeItem('tpl_auth_email');
                localStorage.removeItem('tpl_auth_uid');
              }
            } catch(_e){}

            try { window.dispatchEvent(new CustomEvent('tpl-auth-change', { detail:{ email: user ? (user.email||null) : null } })); } catch(_e){}
            if (first) {
              first = false;
              try { window.dispatchEvent(new CustomEvent('tpl-auth-ready', { detail:{ user:user||null } })); } catch(_e){}
              resolve(user || null);
            }

            if (DEBUG) console.log('[TPL][Auth] Estado:', user ? user.uid : null);
            updateUI(user);
          }

          auth.onAuthStateChanged(handle);
          handle(auth.currentUser);
        });
      } else {
        window.__TPL_AUTH__.ready.then(updateUI);
      }
    }

    // ===== UI del muro + redirecciones =====
    function updateUI(user){
      var wall = $('#authWall');
      var form = $('#bookingForm');
      var slot = $('#tpl-inline-login');

      if (!wall || !form) return;

      if (user) {
        wall.style.display = 'none';
        form.classList.remove('disabled');

        var email = $('#email'); if (user.email && email && !email.value) email.value = user.email;
        var name  = $('#firstName');
        if (user.displayName && name && !name.value) {
          var dn = String(user.displayName).trim();
          name.value = dn.split(' ')[0] || dn;
        }
      } else {
        wall.style.display = 'block';
        form.classList.add('disabled');

        // CTA de login: ahora apunta a iniciar-sesión.html?next=...
        if (slot && !slot.hasChildNodes()) {
          var loginUrl = buildLoginUrl();
          slot.innerHTML =
            '<a class="tpl-btn" href="'+ loginUrl +'">Iniciar sesión</a> '+
            '<a class="tpl-btn-outline" href="index.html#iniciar-sesion">Volver al inicio</a>';
        }

        // Redirección opcional si se fuerza login
        if (window.TPL_REQUIRE_LOGIN_ON_RESERVAS === true) {
          location.href = buildLoginUrl();
        }
      }
    }

    // Arranque
    setupAuthBridge();
    var tries = 0, t = setInterval(function(){
      tries++;
      if (window.__TPL_AUTH__ && window.__TPL_AUTH__.ready) { clearInterval(t); return; }
      setupAuthBridge();
      if (tries > 30) clearInterval(t);
    }, 100);
  })();
  </script>
  <!-- TPL: FIN BLOQUE NUEVO -->

  <!-- TPL: INICIO BLOQUE NUEVO [Auto-recovery para recursos 404 comunes] -->
  <script>
  (function(){
    // Si alguna IMG falla con *.png*.png, reintenta con *.png (no cambia tu diseño)
    window.addEventListener('error', function(e){
      var el = e.target;
      if (!el || !el.tagName) return;
      if (el.tagName === 'IMG' && /(\.png\.png)(\?.*)?$/i.test(el.src||'')) {
        var fixed = el.src.replace(/\.png\.png/i, '.png');
        el.onerror = null; // evita bucles
        el.src = fixed;
      }
    }, true);
  })();
  </script>
  <!-- TPL: FIN BLOQUE NUEVO -->

  <!-- Lógica de reservas -->
  <script src="reservas.js" defer></script>
</body>
</html>
