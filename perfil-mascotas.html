<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Perfil de mascota ¬∑ The Pets Lovers</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Poppins:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <!-- TPL: INICIO BLOQUE NUEVO [Favicon embebido (evita 404)] -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64'%3E%3Crect width='64' height='64' rx='12' ry='12' fill='%23339496'/%3E%3Ctext x='50%25' y='60%25' text-anchor='middle' font-size='44' fill='white'%3Eüêæ%3C/text%3E%3C/svg%3E" />
  <!-- TPL: FIN BLOQUE NUEVO -->

  <!-- TPL: INICIO BLOQUE NUEVO [Estilos m√≠nimos de la p√°gina (no tocan tu style.css)] -->
  <style>
    .page{ padding-top:120px }
    .tpl-card{ max-width: 980px; margin: 0 auto 60px; background:#fff; border:1px solid #eee; border-radius:16px; box-shadow:0 6px 24px rgba(0,0,0,.06); overflow:hidden; }
    .tpl-card-head{ background: linear-gradient(135deg, rgba(51,148,150,.12), rgba(88,66,90,.08)); padding:18px 18px 14px; border-bottom:1px solid #ececec; }
    .tpl-card-head h1{ margin:0; font-size:26px; color:#58425a; }
    .tpl-form{ padding:18px; display:grid; gap:14px; grid-template-columns: 1fr; }
    @media(min-width:860px){ .tpl-form{ grid-template-columns: 1fr 1fr; } .col-span-2{ grid-column: span 2; } }
    .tpl-field{ display:flex; flex-direction:column; gap:8px; }
    .tpl-field input, .tpl-field textarea, .tpl-field select { padding:12px 12px; border:1px solid #ddd; border-radius:10px; font: inherit; outline:none; }
    .tpl-actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:4px; }
    .cta-button{ background:#339496;color:#fff;padding:12px 16px;border-radius:999px;border:none;cursor:pointer;font-weight:700;text-align:center }
    .link{ background:#fff;color:#339496;border:2px solid #339496 }
    .danger{ background:#fff;color:#b00020;border:2px solid #b00020 }
    .muted{ color:#666; font-size:.95rem }
    .tpl-photo-row{display:grid;grid-template-columns:120px 1fr;gap:12px;align-items:start}
    .tpl-photo{width:120px;height:120px;border-radius:12px;object-fit:cover;border:1px solid #eee;background:#fafafa}
    @media (max-width:600px){ .tpl-photo-row{grid-template-columns:1fr} .tpl-photo{width:100%;height:180px} }
    .is-hidden{ display:none !important; }
    .msg{ display:none; margin-top:6px; }
    .msg.ok{ color:#2a7e80 } .msg.err{ color:#b00020 }

    /* TPL: INICIO BLOQUE NUEVO [Anti-uploader / Anti-overlay ‚Äúenviando‚Äù] */
    .tpl-upload, .tpl-upload-card, [data-tpl-upload]{ display:none !important; visibility:hidden !important; }
    /* TPL: FIN BLOQUE NUEVO */
  </style>
  <!-- TPL: FIN BLOQUE NUEVO -->
</head>
<body>
  <div id="tpl-navbar"></div>
  <script src="tpl-navbar.js" defer></script>

  <main class="container page" aria-labelledby="t">
    <div class="tpl-card" role="region" aria-labelledby="t">
      <div class="tpl-card-head">
        <h1 id="t"><i class="fa-solid fa-paw"></i> Perfil de tu mascota</h1>
      </div>

      <form id="f" class="tpl-form" novalidate>
        <!-- Foto (solo preview local; NO se sube) -->
        <div class="tpl-field col-span-2">
          <label for="foto"><i class="fa-regular fa-image"></i> Foto (opcional)</label>
          <div class="tpl-photo-row">
            <img id="preview" class="tpl-photo" alt="Previsualizaci√≥n" src="" />
            <div>
              <!-- TPL: INICIO BLOQUE NUEVO [bandera anti-subida para scripts externos] -->
              <input id="foto" name="foto" type="file" accept="image/*" data-tpl-noupload="1">
              <!-- TPL: FIN BLOQUE NUEVO -->
            </div>
          </div>
        </div>

        <!-- Datos b√°sicos -->
        <div class="tpl-field"><label for="nombre">Nombre *</label><input id="nombre" name="nombre" required></div>

        <div class="tpl-field">
          <label for="microchip">N¬∫ de microchip</label>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <input id="microchip" name="microchip" type="text" placeholder="15 d√≠gitos" pattern="^[0-9]{15}$">
            <label style="display:inline-flex;gap:6px;align-items:center"><input type="checkbox" id="noChip"> No tiene</label>
          </div>
        </div>

        <div class="tpl-field"><label for="especie">Especie *</label>
          <select id="especie" name="especie" required>
            <option value="">Elige‚Ä¶</option><option>Perro</option><option>Gato</option><option>Ex√≥tico</option><option>Otro</option>
          </select>
        </div>

        <div class="tpl-field">
          <label id="label-raza" for="raza">Raza / especie *</label>
          <input id="raza" name="raza" required placeholder="Escribe aqu√≠‚Ä¶">
        </div>

        <div class="tpl-field"><label for="edad">Edad (a√±os) *</label><input id="edad" name="edad" type="number" min="0" step="1" required></div>
        <div class="tpl-field"><label for="peso">Peso (kg) *</label><input id="peso" name="peso" type="number" min="0" step="0.1" required></div>

        <div class="tpl-field"><label for="sexo">Sexo *</label>
          <select id="sexo" name="sexo" required><option value="">Elige‚Ä¶</option><option>Macho</option><option>Hembra</option></select>
        </div>
        <div class="tpl-field"><label for="esterilizado">¬øEsterilizado/a? *</label>
          <select id="esterilizado" name="esterilizado" required><option value="">Elige‚Ä¶</option><option>S√≠</option><option>No</option></select>
        </div>

        <div class="tpl-field col-span-2"><label for="patologias">¬øPatolog√≠a o tratamiento? *</label><textarea id="patologias" name="patologias" rows="3" required></textarea></div>
        <div class="tpl-field"><label for="via">V√≠a/dosis/horario</label><textarea id="via" name="via" rows="2"></textarea></div>
        <div class="tpl-field"><label for="comidas">Horario de comidas</label><textarea id="comidas" name="comidas" rows="2"></textarea></div>

        <div class="tpl-field"><label for="vacunas">¬øVacunas al d√≠a? *</label>
          <select id="vacunas" name="vacunas" required><option value="">Elige‚Ä¶</option><option>S√≠</option><option>No</option></select>
        </div>

        <div id="wrap-faltan" class="tpl-field col-span-2 is-hidden">
          <label for="faltan">¬øQu√© faltan? *</label>
          <textarea id="faltan" name="faltan" rows="2"></textarea>
        </div>

        <div class="tpl-field col-span-2"><label for="comportamiento">Comportamiento *</label><textarea id="comportamiento" name="comportamiento" rows="3" required></textarea></div>

        <div class="tpl-field"><label for="seguroVet">¬øSeguro veterinario?</label>
          <select id="seguroVet" name="seguroVet"><option value="">Elige‚Ä¶</option><option>S√≠</option><option>No</option></select>
        </div>

        <div id="wrap-seguro" class="col-span-2 is-hidden" style="display:grid;gap:12px;grid-template-columns:1fr 1fr">
          <div class="tpl-field"><label for="aseguradora">Aseguradora *</label><input id="aseguradora" name="aseguradora"></div>
          <div class="tpl-field"><label for="poliza">N¬∫ de p√≥liza *</label><input id="poliza" name="poliza"></div>
        </div>

        <div class="tpl-field"><label for="seguroRC">¬øSeguro de RC?</label>
          <select id="seguroRC" name="seguroRC"><option value="">Elige‚Ä¶</option><option>S√≠</option><option>No</option></select>
        </div>

        <div class="tpl-field col-span-2"><label for="comentarios">Comentarios</label><textarea id="comentarios" name="comentarios" rows="3"></textarea></div>

        <div class="tpl-actions col-span-2">
          <button id="btn-submit" type="submit" class="cta-button">Guardar</button>
          <a class="cta-button link" id="btn-cancel" href="perfil.html">Cancelar</a>
          <button type="button" id="btn-eliminar" class="cta-button danger" style="display:none">Eliminar</button>
          <span class="msg ok" id="msg-ok"><i class="fa-solid fa-circle-check"></i> Guardado correctamente.</span>
          <span class="msg err" id="msg-err"></span>
        </div>
      </form>
    </div>
  </main>

  <div id="tpl-footer"></div>
  <script src="tpl-footer.js" defer></script>

  <!-- TPL: INICIO BLOQUE NUEVO [Firebase (App/Auth/Firestore) + l√≥gica sin subidas + anti ‚Äúenviando‚Ä¶‚Äù + redirecci√≥n garantizada] -->
  <script>
  (async function(){
    /** 1) Carga segura de Firebase (sin Storage) **/
    function loadScript(src){return new Promise((res,rej)=>{const s=document.createElement('script');s.src=src;s.async=true;s.onload=res;s.onerror=()=>rej(new Error('No se pudo cargar '+src));document.head.appendChild(s);});}
    async function ensureFirebase(){
      if (typeof firebase==='undefined'){await loadScript('https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js');}
      if (!('auth' in firebase)){await loadScript('https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js');}
      if (!('firestore' in firebase)){await loadScript('https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js');}
      if (!window.firebaseConfig){
        window.firebaseConfig = {
          apiKey: "AIzaSyDW73aFuz2AFS9VeWg_linHIRJYN4YMgTk",
          authDomain: "thepetslovers-c1111.firebaseapp.com",
          projectId: "thepetslovers-c1111",
          storageBucket: "thepetslovers-c1111.appspot.com",
          messagingSenderId: "415914577533",
          appId: "1:415914577533:web:0b7a056ebaa4f1de28ab14",
          measurementId: "G-FXPD69KXBG"
        };
      }
    }
    await ensureFirebase();
    if (firebase.apps.length===0){ firebase.initializeApp(firebaseConfig); }
    const auth=firebase.auth(); const db=firebase.firestore();

    /** 2) Anti-uploader y anti-overlays de ‚Äúenviando‚Ä¶‚Äù **/
    // Bandera global opcional por si la leen otros scripts
    window.__TPL_DISABLE_UPLOAD__ = true;

    // Elimina cualquier overlay / tarjeta que aparezca con textos t√≠picos
    const KILL_TEXT = /(subiendo archivo|enviando|procesando|la subida no progresa|revisa reglas|conexi[o√≥]n|subiendo|cargando)/i;
    const KILL_SEL  = '.tpl-upload, .tpl-upload-card, [data-tpl-upload], .upload, .uploader, .overlay, .loading';
    function purgeUploads(root=document){
      root.querySelectorAll(KILL_SEL).forEach(n=> n.remove());
      const all = (root.body || root).getElementsByTagName('*');
      for (let i=0; i<all.length; i++){
        const el = all[i];
        try{
          if (el && el.textContent && KILL_TEXT.test(el.textContent)) {
            // solo si parece una capa/overlay (fixed/absolute) para no borrar textos normales
            const style = getComputedStyle(el);
            if (style.position==='fixed' || style.position==='absolute' || el.className.toLowerCase().includes('overlay')) {
              el.remove();
            }
          }
        }catch(_){}
      }
    }
    purgeUploads();
    const mo = new MutationObserver(()=> purgeUploads());
    mo.observe(document.documentElement, {childList:true, subtree:true});

    /** 3) Refs y helpers **/
    const $=id=>document.getElementById(id);
    const form=$('f'), ok=$('msg-ok'), err=$('msg-err');
    const btnDel=$('btn-eliminar'), btnCancel=$('btn-cancel'), btnSubmit=$('btn-submit');

    const foto=$('foto'), preview=$('preview');
    const noChip=$('noChip'), microchip=$('microchip');
    const especie=$('especie'), raza=$('raza'), lblRaza=$('label-raza');
    const vacunas=$('vacunas'), wrapFaltan=$('wrap-faltan'), faltan=$('faltan');
    const seguroVet=$('seguroVet'), wrapSeguro=$('wrap-seguro'), aseguradora=$('aseguradora'), poliza=$('poliza');

    const LS_PETS_KEY='tpl-pets';
    const SUBMIT_TIMEOUT_MS = 1800; // ‚è±Ô∏è watchdog contra ‚Äúquedarse enviando‚Ä¶‚Äù
    let PET_ID=null, PET_IDX=null, fotoDataUrl='', CURRENT_UID=null;

    // Previene que *cualquier* listener externo capture el submit o el change de #foto
    document.addEventListener('submit', (e)=>{
      const isOurForm = e.target && (e.target.id==='f');
      if (isOurForm){
        e.preventDefault();
        e.stopImmediatePropagation();
        e.stopPropagation();
        handleSubmit().catch(()=>{}); // no mostramos overlays de error
      }
    }, true);
    document.addEventListener('click', (e)=>{
      const btn = e.target && e.target.closest('#btn-submit');
      if (btn){
        e.preventDefault();
        e.stopImmediatePropagation();
        e.stopPropagation();
        handleSubmit().catch(()=>{});
      }
    }, true);

    // Preview local de la foto (NO se sube)
    foto && foto.addEventListener('change', (e)=>{
      const f=foto.files?.[0]; if(!f) return;
      const r=new FileReader();
      r.onload = ev => { fotoDataUrl = ev.target.result; preview.src = fotoDataUrl; };
      r.readAsDataURL(f);
      e.stopPropagation(); e.stopImmediatePropagation();
    }, true);

    function qsp(name, fb){ const u=new URL(location.href); return u.searchParams.get(name)||fb; }
    function nextUrl(){ return qsp('next','perfil.html'); }
    btnCancel.setAttribute('href', nextUrl());

    function toggleMicrochip(){ if (!noChip||!microchip) return; if(noChip.checked){microchip.value=''; microchip.disabled=true;} else {microchip.disabled=false;} }
    noChip && noChip.addEventListener('change', toggleMicrochip);

    function toggleEspecie(){
      if (!especie||!raza) return;
      if (especie.value==='Ex√≥tico'){ raza.required=true; raza.placeholder='Ej.: Ave, Reptil, Peque√±o mam√≠fero‚Ä¶'; lblRaza.innerHTML='Tipo de ex√≥tico *'; }
      else if (especie.value){ raza.required=true; raza.placeholder='Raza / especie'; lblRaza.innerHTML='Raza / especie *'; }
      else { raza.required=false; raza.placeholder='Escribe aqu√≠‚Ä¶'; lblRaza.innerHTML='Raza / especie'; }
    }
    especie && especie.addEventListener('change', toggleEspecie);

    function toggleVacunas(){
      if (!vacunas||!wrapFaltan||!faltan) return;
      if (vacunas.value==='No'){ wrapFaltan.classList.remove('is-hidden'); faltan.required=true; }
      else { wrapFaltan.classList.add('is-hidden'); faltan.required=false; faltan.value=''; }
    }
    vacunas && vacunas.addEventListener('change', toggleVacunas);

    function toggleSeguro(){
      if (!seguroVet||!wrapSeguro||!aseguradora||!poliza) return;
      if (seguroVet.value==='S√≠'){ wrapSeguro.classList.remove('is-hidden'); aseguradora.required=true; poliza.required=true; }
      else { wrapSeguro.classList.add('is-hidden'); aseguradora.required=false; poliza.required=false; aseguradora.value=''; poliza.value=''; }
    }
    seguroVet && seguroVet.addEventListener('change', toggleSeguro);

    // LocalStorage helpers
    function loadLocal(idx){
      try{ const list=JSON.parse(localStorage.getItem(LS_PETS_KEY)||'[]'); return list[Number(idx)]||null; }catch(_){ return null; }
    }
    function saveLocal(idx, data){
      const list=JSON.parse(localStorage.getItem(LS_PETS_KEY)||'[]');
      if (idx==null){ list.push(data); PET_IDX=list.length-1; } else { list[Number(idx)]={...(list[Number(idx)]||{}), ...data}; }
      localStorage.setItem(LS_PETS_KEY, JSON.stringify(list));
    }
    function delLocal(idx){
      const list=JSON.parse(localStorage.getItem(LS_PETS_KEY)||'[]'); list.splice(Number(idx),1);
      localStorage.setItem(LS_PETS_KEY, JSON.stringify(list));
    }

    async function getPet(uid){
      PET_ID = qsp('id', null);
      PET_IDX = qsp('idx', null);
      if (uid && PET_ID){
        try{ const doc=await db.collection('users').doc(uid).collection('pets').doc(PET_ID).get(); return doc.exists ? {id:doc.id, ...doc.data()} : null; }catch(_){ return null; }
      }
      if (PET_IDX!=null){ return loadLocal(PET_IDX); }
      return null;
    }

    async function savePet(uid, data){
      // Intenta Firestore; si tarda m√°s de SUBMIT_TIMEOUT_MS, seguimos en local (optimista)
      const saveToFirestore = (async ()=>{
        if (uid){
          if (!PET_ID){ const ref=await db.collection('users').doc(uid).collection('pets').add(data); PET_ID=ref.id; }
          else { await db.collection('users').doc(uid).collection('pets').doc(PET_ID).set(data,{merge:true}); }
        } else {
          throw new Error('no-uid');
        }
      })();

      const timed = new Promise((resolve)=> setTimeout(()=>resolve('timeout'), SUBMIT_TIMEOUT_MS));
      const result = await Promise.race([saveToFirestore.then(()=> 'ok').catch(()=> 'error'), timed]);

      if (result==='ok'){ return true; }
      // Guardado local como fallback silencioso
      saveLocal(PET_IDX, data);
      return false;
    }

    async function deletePet(uid){
      try{
        if (uid && PET_ID){ await db.collection('users').doc(uid).collection('pets').doc(PET_ID).delete(); return; }
      }catch(_){}
      if (PET_IDX!=null){ delLocal(PET_IDX); }
    }

    function fill(p){
      if (!p) return;
      if (p.fotoDataUrl){ fotoDataUrl=p.fotoDataUrl; preview.src=fotoDataUrl; }
      form.nombre.value         = p.nombre || '';
      microchip.value           = p.microchip || '';
      noChip.checked            = !p.microchip; toggleMicrochip();
      especie.value             = p.especie || ''; toggleEspecie();
      if (p.especie==='Ex√≥tico'){ raza.value = p.tipoExotico || '' } else { raza.value = p.raza || '' }
      form.edad.value           = p.edad ?? '';
      form.peso.value           = p.peso ?? '';
      form.sexo.value           = p.sexo || '';
      form.esterilizado.value   = p.esterilizado || '';
      form.patologias.value     = p.patologias || '';
      form.via.value            = p.via || '';
      form.comidas.value        = p.comidas || '';
      vacunas.value             = p.vacunas || ''; toggleVacunas();
      faltan.value              = p.faltan || '';
      form.comportamiento.value = p.comportamiento || '';
      seguroVet.value           = p.seguroVet || ''; toggleSeguro();
      aseguradora.value         = p.aseguradora || '';
      poliza.value              = p.poliza || '';
      form.seguroRC.value       = p.seguroRC || '';
      form.comentarios.value    = p.comentarios || '';
    }

    // Carga inicial con guardia de sesi√≥n
    auth.onAuthStateChanged(async (u)=>{
      if (!u || u.isAnonymous){
        location.href = 'iniciar-sesion.html?next=' + encodeURIComponent(location.pathname + location.search);
        return;
      }
      CURRENT_UID = u.uid;
      const pet = await getPet(CURRENT_UID);
      if (pet){ fill(pet); btnDel.style.display='inline-flex'; } else { btnDel.style.display='none'; }
      toggleMicrochip(); toggleEspecie(); toggleVacunas(); toggleSeguro();
    });

    // Handler central de env√≠o (con watchdog y redirecci√≥n garantizada)
    async function handleSubmit(){
      ok.style.display='none'; err.style.display='none';

      if (vacunas.value==='No' && !faltan.value.trim()){ faltan.reportValidity(); return; }
      if (seguroVet.value==='S√≠' && (!aseguradora.value.trim() || !poliza.value.trim())){ aseguradora.reportValidity(); poliza.reportValidity(); return; }
      if (!form.checkValidity()){ form.reportValidity(); return; }

      const isExotico=(especie.value==='Ex√≥tico');
      const data = {
        fotoDataUrl: fotoDataUrl || undefined, fotoUrl:'',
        nombre: form.nombre.value.trim(),
        microchip: noChip.checked ? '' : microchip.value.trim(),
        especie: especie.value,
        raza: isExotico ? '' : raza.value.trim(),
        tipoExotico: isExotico ? raza.value.trim() : '',
        edad: Number(form.edad.value || 0),
        peso: Number(form.peso.value || 0),
        sexo: form.sexo.value,
        esterilizado: form.esterilizado.value,
        patologias: form.patologias.value.trim(),
        via: form.via.value.trim(),
        comidas: form.comidas.value.trim(),
        vacunas: vacunas.value,
        faltan: (vacunas.value==='No') ? faltan.value.trim() : '',
        comportamiento: form.comportamiento.value.trim(),
        seguroVet: seguroVet.value,
        aseguradora: (seguroVet.value==='S√≠') ? aseguradora.value.trim() : '',
        poliza: (seguroVet.value==='S√≠') ? poliza.value.trim() : '',
        seguroRC: form.seguroRC.value,
        comentarios: form.comentarios.value.trim(),
        updatedAt: new Date().toISOString()
      };

      // Desactiva bot√≥n para evitar dobles clics (sin mostrar ‚Äúenviando‚Ä¶‚Äù)
      btnSubmit.disabled = true;

      try{
        await savePet(CURRENT_UID, data); // guarda en Firestore o en local si hay timeout
      }catch(_){ /* ignoramos para no bloquear UX */ }
      // Redirecci√≥n SIEMPRE (optimista)
      try{ sessionStorage.setItem('tplJustSavedPet','1'); }catch(_){}
      location.href = nextUrl();
    }

    // Eliminar mascota
    btnDel.addEventListener('click', async ()=>{
      if (!confirm('¬øEliminar esta mascota?')) return;
      ok.style.display='none'; err.style.display='none';
      try{
        await deletePet(CURRENT_UID);
        try{ sessionStorage.setItem('tplJustDeletedPet','1'); }catch(_){}
        location.href = nextUrl();
      }catch(e){
        err.textContent='No se pudo eliminar: ' + (e?.message || e); err.style.display='inline-flex';
      }
    });
  })();
  </script>
  <!-- TPL: FIN BLOQUE NUEVO -->
</body>
</html>
