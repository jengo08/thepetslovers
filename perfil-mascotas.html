<!-- TPL: Config REST Navar/Codinary -->
<script>
  window.TPL_API = window.TPL_API || {
    baseUrl: 'https://TU_BACKEND_NAVAR/api',  // ← CAMBIA ESTO
    authHeaders: async () => {
      const t = localStorage.getItem('tpl_api_token') || '';
      return t ? { 'Authorization': 'Bearer ' + t } : {};
    },
    currentUserId: async () => {
      const ls = localStorage.getItem('tpl_auth_uid');
      if (ls) return ls;
      try { return window.firebase?.auth?.().currentUser?.uid || null; } catch(_) { return null; }
    },
    endpoints: {
      petGet:    (uid,id) => `/users/${uid}/pets/${id}`,
      petList:   (uid)    => `/users/${uid}/pets`,
      petCreate: (uid)    => `/users/${uid}/pets`,
      petUpdate: (uid,id) => `/users/${uid}/pets/${id}`,
      petDelete: (uid,id) => `/users/${uid}/pets/${id}`
    }
  };
</script>

<!-- TPL: Lógica Mascota — REST-first, sin subidas ni overlays -->
<script>
(function(){
  const $ = id => document.getElementById(id);
  const qsp=(k,fb)=> new URL(location.href).searchParams.get(k)||fb;
  const nextUrl = ()=> qsp('next','perfil.html');

  // ===== refs del DOM (IDs tal como los tenías) =====
  const form = $('tpl-form-mascota');
  const ok   = $('tpl-msg-ok');
  const err  = $('tpl-msg-err');
  const btnDel = $('tpl-btn-eliminar');

  const foto = $('foto'), preview = $('preview');
  const noChip=$('noChip'), microchip=$('microchip');
  const especie=$('especie'), raza=$('raza'), lblRaza=$('label-raza');
  const vacunas=$('vacunas'), wrapFaltan=$('wrap-faltan'), faltan=$('faltan');
  const seguroVet=$('seguroVet'), wrapSeguro=$('wrap-seguro'), aseguradora=$('aseguradora'), poliza=$('poliza');

  // Desactiva el capturador global (EmailJS) para este form
  try { form.setAttribute('data-tpl-emailjs','false'); } catch(_){}

  // ===== toggles UI (como en tu versión buena) =====
  function toggleMicrochip(){ if(noChip.checked){ microchip.value=''; microchip.disabled=true; } else { microchip.disabled=false; } }
  function toggleEspecie(){
    if (especie.value==='Exótico'){ raza.required=true; raza.placeholder='Ej.: Ave, Reptil, Pequeño mamífero…'; lblRaza.innerHTML='Tipo de exótico *'; }
    else if (especie.value){ raza.required=true; raza.placeholder='Escribe o elige de la lista'; lblRaza.innerHTML='Raza / especie *'; }
    else { raza.required=false; raza.placeholder='Escribe aquí…'; lblRaza.innerHTML='Raza / especie'; }
  }
  function toggleVacunas(){ if (vacunas.value==='No'){ wrapFaltan.classList.remove('is-hidden'); faltan.required=true; } else { wrapFaltan.classList.add('is-hidden'); faltan.required=false; faltan.value=''; } }
  function toggleSeguro(){ if (seguroVet.value==='Sí'){ wrapSeguro.classList.remove('is-hidden'); aseguradora.required=true; poliza.required=true; } else { wrapSeguro.classList.add('is-hidden'); aseguradora.required=false; poliza.required=false; aseguradora.value=''; poliza.value=''; } }

  noChip.addEventListener('change', toggleMicrochip);
  especie.addEventListener('change', toggleEspecie);
  vacunas.addEventListener('change', toggleVacunas);
  seguroVet.addEventListener('change', toggleSeguro);

  // ===== Foto: SOLO DataURL, nada de uploads =====
  let fotoDataUrl = '';
  foto.addEventListener('change', ()=>{
    const f = foto.files?.[0]; if(!f) return;
    const r = new FileReader();
    r.onload = e => { fotoDataUrl = e.target.result; preview.src = fotoDataUrl; };
    r.readAsDataURL(f);
  });

  // ===== REST driver =====
  const REST = {
    ok: !!(window.TPL_API && window.TPL_API.baseUrl),
    base: () => String(window.TPL_API.baseUrl).replace(/\/+$/,''),
    headers: async () => ({ 'Content-Type':'application/json', ...(await window.TPL_API.authHeaders?.()||{}) }),
    uid:     async () => await (window.TPL_API.currentUserId?.() || null),
    url(name, uid, id){
      const e = window.TPL_API.endpoints||{};
      const path = typeof e[name]==='function' ? e[name](uid,id) : '';
      return this.base() + path;
    },
    async getPet(id){
      if (!this.ok || !id) return null;
      const uid = await this.uid(); if (!uid) return null;
      const res = await fetch(this.url('petGet', uid, id), { headers: await this.headers() });
      return res.ok ? await res.json() : null;
    },
    async savePet(id, data){
      if (!this.ok) throw new Error('REST no configurado');
      const uid = await this.uid(); if (!uid) throw new Error('Debes iniciar sesión');
      const m   = id ? 'PATCH' : 'POST';
      const url = id ? this.url('petUpdate', uid, id) : this.url('petCreate', uid);
      const res = await fetch(url, { method:m, headers: await this.headers(), body: JSON.stringify(data) });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const j = await res.json().catch(()=> ({}));
      return id || j.id || j._id || null;
    },
    async deletePet(id){
      if (!this.ok || !id) return;
      const uid = await this.uid(); if (!uid) return;
      await fetch(this.url('petDelete', uid, id), { method:'DELETE', headers: await this.headers() }).catch(()=>{});
    }
  };

  // ===== Cargar si se edita =====
  let PET_ID = qsp('id', null);
  async function prefill(){
    try{
      if (PET_ID){
        const p = await REST.getPet(PET_ID);
        if (p){
          if (p.fotoDataUrl){ fotoDataUrl = p.fotoDataUrl; preview.src = fotoDataUrl; }
          $('nombre').value           = p.nombre || '';
          microchip.value             = p.microchip || '';
          noChip.checked              = !p.microchip;
          especie.value               = p.especie || '';
          raza.value = (p.especie==='Exótico') ? (p.tipoExotico||'') : (p.raza||'');
          $('edad').value             = p.edad ?? '';
          $('peso').value             = p.peso ?? '';
          $('sexo').value             = p.sexo || '';
          $('esterilizado').value     = p.esterilizado || '';
          $('patologias').value       = p.patologias || '';
          $('via').value              = p.via || '';
          $('comidas').value          = p.comidas || '';
          vacunas.value               = p.vacunas || '';
          faltan.value                = p.faltan || '';
          $('comportamiento').value   = p.comportamiento || '';
          seguroVet.value             = p.seguroVet || '';
          aseguradora.value           = p.aseguradora || '';
          poliza.value                = p.poliza || '';
          $('seguroRC').value         = p.seguroRC || '';
          $('comentarios').value      = p.comentarios || '';
          btnDel.style.display='inline-flex';
        } else {
          btnDel.style.display='none';
        }
      } else {
        btnDel.style.display='none';
      }
    }catch(_){ btnDel.style.display='none'; }
    toggleMicrochip(); toggleEspecie(); toggleVacunas(); toggleSeguro();
  }
  prefill();

  // ===== Guardar (sin overlays) =====
  form.addEventListener('submit', async (e)=>{
    e.preventDefault(); ok.style.display='none'; err.style.display='none';
    if (vacunas.value==='No' && !faltan.value.trim()){ return faltan.reportValidity(); }
    if (seguroVet.value==='Sí' && (!aseguradora.value.trim() || !poliza.value.trim())){ aseguradora.reportValidity(); poliza.reportValidity(); return; }
    if (!form.checkValidity()){ form.reportValidity(); return; }

    const isExotico = (especie.value==='Exótico');
    const data = {
      fotoDataUrl: fotoDataUrl || undefined,
      fotoUrl: '', // por claridad, siempre vacío
      nombre: $('nombre').value.trim(),
      microchip: noChip.checked ? '' : microchip.value.trim(),
      especie: especie.value,
      raza: isExotico ? '' : raza.value.trim(),
      tipoExotico: isExotico ? raza.value.trim() : '',
      edad: Number($('edad').value || 0),
      peso: Number($('peso').value || 0),
      sexo: $('sexo').value,
      esterilizado: $('esterilizado').value,
      patologias: $('patologias').value.trim(),
      via: $('via').value.trim(),
      comidas: $('comidas').value.trim(),
      vacunas: vacunas.value,
      faltan: (vacunas.value==='No') ? faltan.value.trim() : '',
      comportamiento: $('comportamiento').value.trim(),
      seguroVet: seguroVet.value,
      aseguradora: (seguroVet.value==='Sí') ? aseguradora.value.trim() : '',
      poliza: (seguroVet.value==='Sí') ? poliza.value.trim() : '',
      seguroRC: $('seguroRC').value,
      comentarios: $('comentarios').value.trim(),
      updatedAt: new Date().toISOString()
    };

    try{
      PET_ID = await REST.savePet(PET_ID, data);
      ok.style.display='inline-flex';
    }catch(e){
      err.textContent = 'No se pudo guardar (REST): ' + (e.message||e);
      err.style.display='inline-flex';
    }
    setTimeout(()=> location.href = nextUrl(), 80);
  });

  // ===== Eliminar =====
  btnDel.addEventListener('click', async ()=>{
    if (!PET_ID) return;
    if (!confirm('¿Eliminar esta mascota?')) return;
    try{ await REST.deletePet(PET_ID); }catch(_){}
    location.href = nextUrl();
  });
})();
</script>
