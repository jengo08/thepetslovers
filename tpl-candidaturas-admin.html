<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Admin · The Pets Lovers</title>
<meta name="robots" content="noindex,nofollow">
<link rel="stylesheet" href="style.css">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Poppins:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<style>
  :root{ --tpl-primary:#339496; --tpl-ink:#58425a; }
  .page{ padding-top:120px }
  .tpl-card{ max-width:1200px; margin:0 auto 60px; background:#fff; border:1px solid #eee; border-radius:12px; box-shadow:0 2px 12px rgba(0,0,0,.05); padding:16px; }
  h1{ margin:0 0 8px }
  .muted{ color:#666 }
  .btn{ background:#339496; color:#fff; border-radius:999px; padding:8px 12px; text-decoration:none; border:2px solid transparent; display:inline-block; font-weight:700; cursor:pointer }
  .btn.sec{ background:#fff; color:#339496; border-color:#339496 }
  .btn:disabled{ opacity:.6; cursor:not-allowed }
  .toolbar{ display:flex; gap:10px; flex-wrap:wrap; margin:10px 0 }
  .filters{ display:grid; gap:10px; grid-template-columns:1fr 180px 180px 120px }
  @media (max-width: 900px){ .filters{ grid-template-columns:1fr 1fr } }
  .filters input,.filters select{ border:1px solid #ddd; border-radius:10px; padding:10px; font:inherit }
  table{ width:100%; border-collapse:collapse; margin-top:8px }
  th,td{ text-align:left; padding:10px; border-bottom:1px solid #f0f0f0; vertical-align:top }
  th{ color:#58425a; font-weight:700 }
  .pill{ display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #d7efef; color:#339496; background:#f5fbfb; font-size:.85rem }
  .tabbar{ display:flex; gap:8px; margin:12px 0; flex-wrap:wrap }
  .tabbar button{ background:#f5fbfb; color:#339496; border:1px solid #d7efef; border-radius:999px; padding:6px 12px; cursor:pointer }
  .tabbar button.active{ background:#339496; color:#fff; border-color:#339496 }
  .section{ display:none }
  .section.active{ display:block }
  .status{ margin:6px 0 12px; color:#666 }
  .nowrap{ white-space:nowrap }

  /* TPL: INICIO BLOQUE NUEVO [Cards del dashboard] */
  .tpl-grid{ display:grid; grid-template-columns:repeat(12,1fr); gap:12px; }
  .tpl-col-3{ grid-column:span 3; }
  .tpl-col-4{ grid-column:span 4; }
  .tpl-col-6{ grid-column:span 6; }
  .tpl-col-12{ grid-column:span 12; }
  @media (max-width: 900px){
    .tpl-col-3,.tpl-col-4,.tpl-col-6,.tpl-col-12{ grid-column:span 12; }
  }
  .tpl-kpi{ border:1px solid #eee; border-radius:12px; padding:14px; }
  .tpl-kpi h3{ margin:0 0 8px; font-size:1rem; color:#58425a }
  .tpl-kpi .big{ font-size:1.8rem; font-weight:700; color:#339496 }
  .tpl-table-wrap{ overflow:auto }
  /* TPL: FIN BLOQUE NUEVO */
</style>
</head>
<body>
<main class="page">
  <section class="tpl-card">
    <h1>🔒 Admin · The Pets Lovers</h1>
    <p id="tpl-auth-status" class="muted">Debes iniciar sesión para ver los datos.</p>
    <div class="toolbar" id="tpl-auth-actions">
      <button class="btn" id="tpl-login">Iniciar sesión con Google</button>
      <button class="btn sec" id="tpl-logout" style="display:none">Cerrar sesión</button>
    </div>

    <!-- TPL: INICIO BLOQUE NUEVO [Tabs] -->
    <div id="tpl-app" style="display:none">
      <div class="tabbar" role="tablist" aria-label="Secciones">
        <!-- NUEVA pestaña: Panel -->
        <button class="active" data-tab="panel" role="tab">Panel</button>
        <button data-tab="cands" role="tab">Candidaturas</button>
        <button data-tab="reservas" role="tab">Reservas</button>
        <!-- NUEVA pestaña: Usuarios -->
        <button data-tab="usuarios" role="tab">Usuarios</button>
      </div>

      <!-- =================== PANEL (Dashboard) =================== -->
      <!-- TPL: INICIO BLOQUE NUEVO [Sección Panel] -->
      <div id="section-panel" class="section active" aria-labelledby="tab-panel">
        <p class="status" id="tpl-status-panel">Cargando métricas…</p>
        <div class="tpl-grid">
          <div class="tpl-col-3">
            <div class="tpl-kpi">
              <h3>Registros hoy</h3>
              <div class="big" id="kpi-users-today">–</div>
              <div class="muted" id="kpi-users-month">Mes: – · Año: –</div>
            </div>
          </div>
          <div class="tpl-col-3">
            <div class="tpl-kpi">
              <h3>Candidaturas hoy</h3>
              <div class="big" id="kpi-cands-today">–</div>
              <div class="muted" id="kpi-cands-month">Mes: – · Año: –</div>
            </div>
          </div>
          <div class="tpl-col-3">
            <div class="tpl-kpi">
              <h3>Reservas hoy</h3>
              <div class="big" id="kpi-resv-today">–</div>
              <div class="muted" id="kpi-resv-month">Mes: – · Año: –</div>
            </div>
          </div>
          <div class="tpl-col-3">
            <div class="tpl-kpi">
              <h3>Visitas hoy</h3>
              <div class="big" id="kpi-visits-today">–</div>
              <div class="muted" id="kpi-visits-month">Mes: – · Año: –</div>
            </div>
          </div>

          <div class="tpl-col-6">
            <div class="tpl-kpi">
              <h3>Ingresos (estim.)</h3>
              <div class="muted">* Suma de campos en reservas si existen: <code>importeReserva</code> y <code>importeAuxiliar</code>.</div>
              <div class="big" id="kpi-eur-total">– €</div>
              <div class="muted" id="kpi-eur-split">Reserva: – € · Auxiliar: – €</div>
            </div>
          </div>

          <div class="tpl-col-6">
            <div class="tpl-kpi">
              <h3>Distribución perfiles</h3>
              <div class="big" id="kpi-roles-total">–</div>
              <div class="muted" id="kpi-roles-split">Propietarios: – · Cuidadores: –</div>
            </div>
          </div>

          <div class="tpl-col-12">
            <div class="tpl-kpi">
              <h3>Últimas 20 acciones</h3>
              <div class="tpl-table-wrap">
                <table>
                  <thead><tr><th>Fecha</th><th>Tipo</th><th>Detalle</th></tr></thead>
                  <tbody id="tpl-activity-rows"><tr><td colspan="3">Cargando…</td></tr></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- TPL: FIN BLOQUE NUEVO -->

      <!-- =================== CANDIDATURAS =================== -->
      <div id="section-cands" class="section" aria-labelledby="tab-cands">
        <p id="tpl-status-c" class="status">Cargando candidaturas…</p>
        <div class="filters">
          <input id="tpl-q" type="search" placeholder="Buscar nombre, email, ciudad, zonas…">
          <select id="tpl-f-disp">
            <option value="">Disponibilidad (todas)</option>
            <option>Mañanas</option><option>Tardes</option><option>Noches</option>
            <option>Fines de semana</option><option>Completa</option>
          </select>
          <select id="tpl-f-estado">
            <option value="">Estado (todos)</option>
            <option value="aceptada">Aceptada</option>
            <option value="pendiente">Pendiente</option>
          </select>
          <select id="tpl-f-limit">
            <option>25</option><option selected>50</option><option>100</option>
          </select>
        </div>
        <div class="toolbar">
          <button class="btn sec" id="tpl-export">Exportar CSV</button>
        </div>
        <div style="overflow:auto">
          <table aria-describedby="tpl-status-c">
            <thead>
              <tr>
                <th class="nowrap">Fecha</th>
                <th>Nombre / Contacto</th>
                <th>Ciudad / CP</th>
                <th>Zona</th>
                <th>Disponibilidad</th>
                <th>Archivos</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="tpl-rows"><tr><td colspan="7">Cargando…</td></tr></tbody>
          </table>
        </div>
      </div>

      <!-- =================== RESERVAS =================== -->
      <div id="section-reservas" class="section" aria-labelledby="tab-reservas">
        <p id="tpl-status-r" class="status">Cargando reservas…</p>
        <div class="filters">
          <input id="tpl-r-q" type="search" placeholder="Buscar por cliente, ciudad, CP">
          <select id="tpl-r-especie">
            <option value="">Especie (todas)</option>
            <option value="perro">Perro</option>
            <option value="gato">Gato</option>
            <option value="exotico">Exótico</option>
          </select>
          <select id="tpl-r-limit">
            <option>25</option><option selected>50</option><option>100</option>
          </select>
        </div>
        <div style="overflow:auto; margin-top:10px">
          <table>
            <thead>
              <tr>
                <th class="nowrap">Fecha</th>
                <th>Cliente</th>
                <th>Ciudad / CP</th>
                <th>Especie</th>
                <th>Servicio / Fechas</th>
                <th>Acción</th>
              </tr>
            </thead>
            <tbody id="tpl-r-rows"><tr><td colspan="6">Cargando…</td></tr></tbody>
          </table>
        </div>

        <!-- Modal sugerencias -->
        <div id="tpl-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); align-items:center; justify-content:center; padding:16px">
          <div style="background:#fff; max-width:900px; width:100%; border-radius:12px; padding:16px">
            <h3 style="margin-top:0">Sugerencias de cuidadores</h3>
            <p class="muted" id="tpl-sug-desc">Resultados por cercanía, especie y disponibilidad.</p>
            <div style="overflow:auto; max-height:70vh">
              <table>
                <thead>
                  <tr>
                    <th>Cuidador</th><th>Zona</th><th>Especies</th><th>Disponibilidad</th><th>Puntuación</th><th>Acción</th>
                  </tr>
                </thead>
                <tbody id="tpl-sug-rows"><tr><td colspan="6">Calculando…</td></tr></tbody>
              </table>
            </div>
            <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px">
              <button class="btn sec" id="tpl-close">Cerrar</button>
            </div>
          </div>
        </div>
      </div>

      <!-- =================== USUARIOS (Perfiles) =================== -->
      <!-- TPL: INICIO BLOQUE NUEVO [Sección Usuarios] -->
      <div id="section-usuarios" class="section" aria-labelledby="tab-usuarios">
        <p id="tpl-status-u" class="status">Cargando usuarios…</p>
        <div class="filters">
          <input id="tpl-u-q" type="search" placeholder="Buscar por nombre/email/ciudad">
          <select id="tpl-u-rol">
            <option value="">Rol (todos)</option>
            <option value="propietario">Propietario</option>
            <option value="cuidador">Cuidador</option>
          </select>
          <select id="tpl-u-limit">
            <option>25</option><option selected>50</option><option>100</option>
          </select>
        </div>
        <div class="toolbar">
          <button class="btn sec" id="tpl-u-export">Exportar CSV</button>
        </div>
        <div class="tpl-table-wrap">
          <table>
            <thead>
              <tr>
                <th class="nowrap">Fecha</th>
                <th>Nombre / Email</th>
                <th>Rol</th>
                <th>Ciudad / CP</th>
                <th>Acción</th>
              </tr>
            </thead>
            <tbody id="tpl-u-rows"><tr><td colspan="5">Cargando…</td></tr></tbody>
          </table>
        </div>
      </div>
      <!-- TPL: FIN BLOQUE NUEVO -->
    </div>
    <!-- TPL: FIN BLOQUE NUEVO -->
  </section>
</main>

<script src="tpl-navbar.js" defer></script>
<script src="tpl-footer.js" defer></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

<!-- TPL: INICIO BLOQUE NUEVO [Init + Auth + Lógica] -->
<script>
(function(){
  // 1) Init Firebase
  if (!firebase.apps.length){
    const firebaseConfig = {
      apiKey: "AIzaSyDW73aFuz2AFS9VeWg_linHIRJYN4YMgTk",
      authDomain: "thepetslovers-c1111.firebaseapp.com",
      projectId: "thepetslovers-c1111",
      storageBucket: "thepetslovers-c1111.appspot.com",
      messagingSenderId: "415914577533",
      appId: "1:415914577533:web:0b7a056ebaa4f1de28ab14",
      measurementId: "G-FXPD69KXBG"
    };
    firebase.initializeApp(firebaseConfig);
  }
  const db = firebase.firestore();
  const auth = firebase.auth();

  <!-- TPL: INICIO BLOQUE NUEVO [Admins + helper en minúsculas] -->
  // SOLO estos emails (en minúsculas)
  const ADMIN_EMAILS = new Set(["4b.jenny.gomez@gmail.com"]);
  function isAdminEmail(email){
    return !!email && ADMIN_EMAILS.has(String(email).toLowerCase());
  }
  <!-- TPL: FIN BLOQUE NUEVO -->

  // UI
  const authStatus = document.getElementById('tpl-auth-status');
  const loginBtn = document.getElementById('tpl-login');
  const logoutBtn = document.getElementById('tpl-logout');
  const app = document.getElementById('tpl-app');

  // Tabs
  const tabs = document.querySelectorAll('[data-tab]');
  const sections = {
    panel: document.getElementById('section-panel'),
    cands: document.getElementById('section-cands'),
    reservas: document.getElementById('section-reservas'),
    usuarios: document.getElementById('section-usuarios')
  };
  tabs.forEach(b=>b.addEventListener('click', ()=>{
    tabs.forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    Object.values(sections).forEach(s=>s.classList.remove('active'));
    sections[b.dataset.tab].classList.add('active');
  }));

  <!-- TPL: INICIO BLOQUE NUEVO [Login: persistencia + sin redirección] -->
  loginBtn.addEventListener('click', async ()=>{
    const provider = new firebase.auth.GoogleAuthProvider();
    await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
    await auth.signInWithPopup(provider);
  });
  <!-- TPL: FIN BLOQUE NUEVO -->
  logoutBtn.addEventListener('click', ()=> auth.signOut());

  <!-- TPL: INICIO BLOQUE NUEVO [Auth state con check en minúsculas] -->
  auth.onAuthStateChanged(user=>{
    const ok = !!user && isAdminEmail(user.email);
    authStatus.textContent = ok
      ? `Sesión iniciada como ${user.email}.`
      : (user ? 'No autorizado.' : 'Debes iniciar sesión para ver los datos.');
    loginBtn.style.display = ok ? 'none':'inline-block';
    logoutBtn.style.display = user ? 'inline-block':'none';
    app.style.display = ok ? '' : 'none';
    if (ok){ boot(); } // carga el panel directamente
  });
  <!-- TPL: FIN BLOQUE NUEVO -->

  // ======== Helpers comunes ========
  const PROV = {"01":"Álava","02":"Albacete","03":"Alicante","04":"Almería","05":"Ávila","06":"Badajoz","07":"Islas Baleares","08":"Barcelona","09":"Burgos","10":"Cáceres","11":"Cádiz","12":"Castellón","13":"Ciudad Real","14":"Córdoba","15":"A Coruña","16":"Cuenca","17":"Girona","18":"Granada","19":"Guadalajara","20":"Gipuzkoa","21":"Huelva","22":"Huesca","23":"Jaén","24":"León","25":"Lleida","26":"La Rioja","27":"Lugo","28":"Madrid","29":"Málaga","30":"Murcia","31":"Navarra","32":"Ourense","33":"Asturias","34":"Palencia","35":"Las Palmas","36":"Pontevedra","37":"Salamanca","38":"Santa Cruz de Tenerife","39":"Cantabria","40":"Segovia","41":"Sevilla","42":"Soria","43":"Tarragona","44":"Teruel","45":"Toledo","46":"Valencia","47":"Valladolid","48":"Bizkaia","49":"Zamora","50":"Zaragoza","51":"Ceuta","52":"Melilla"};
  function zonaSugerida(cp){ const s=(cp||'').toString().padStart(5,'0').slice(0,2); return PROV[s]||''; }
  function esc(s){ return String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
  function fmt(ts){ if(!ts) return '-'; const d=ts.toDate(); return d.toLocaleDateString('es-ES',{year:'numeric',month:'2-digit',day:'2-digit'})+' '+d.toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'}); }
  function textMatch(item, needle){ if(!needle) return true; const hay=[item.nombre,item.email,item.telefono,item.ciudad,item.cp,item.zonasCobertura,item.links].join(' ').toLowerCase(); return hay.includes(needle.toLowerCase()); }
  function toYmd(d){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }
  function isSameMonth(d,ref){ return d.getFullYear()===ref.getFullYear() && d.getMonth()===ref.getMonth(); }
  function isSameYear(d,ref){ return d.getFullYear()===ref.getFullYear(); }

  // ======== CANDIDATURAS ========
  const elC = {
    status: document.getElementById('tpl-status-c'),
    q: document.getElementById('tpl-q'),
    fDisp: document.getElementById('tpl-f-disp'),
    fEstado: document.getElementById('tpl-f-estado'),
    fLimit: document.getElementById('tpl-f-limit'),
    rows: document.getElementById('tpl-rows'),
    exportBtn: document.getElementById('tpl-export')
  };
  let allC = [];

  function renderC(){
    const limit = parseInt(elC.fLimit.value||'50',10);
    const needle = elC.q.value.trim();
    const disp = elC.fDisp.value.trim();
    const estado = elC.fEstado.value.trim();
    const filtered = allC.filter(it => textMatch(it, needle) && (!disp || (it.disponibilidad||'')===disp) && (!estado || (it.estado||'pendiente')===estado)).slice(0,limit);
    elC.rows.innerHTML = filtered.length ? filtered.map(it=>{
      const archivos = (it.cvUrl?`<a class="btn sec" href="${it.cvUrl}" target="_blank" rel="noopener">CV</a>`:'')+' '+(it.tituloUrl?`<a class="btn sec" href="${it.tituloUrl}" target="_blank" rel="noopener">Título</a>`:'');
      const zona = zonaSugerida(it.cp);
      const canAccept = !it.cuidId;
      const perfilHref = it.cuidId ? `tpl-perfil-cuidador.html?id=${encodeURIComponent(it.cuidId)}` : '#';
      return `<tr>
        <td class="nowrap">${fmt(it.createdAt)}</td>
        <td><div><strong>${esc(it.nombre)}</strong></div><div class="muted">${esc(it.email||'-')} · ${esc(it.telefono||'-')}</div></td>
        <td>${esc(it.ciudad||'-')}<br><span class="muted">${esc(it.cp||'')}</span></td>
        <td>${zona?`<span class="pill">${zona}</span>`:'-'}</td>
        <td>${esc(it.disponibilidad||'-')}</td>
        <td>${archivos||'-'}</td>
        <td>${canAccept ? `<button class="btn" data-accept="${it._id}">Aceptar</button>` : `<a class="btn" href="${perfilHref}">Ver perfil</a>`}</td>
      </tr>`;
    }).join('') : '<tr><td colspan="7">Sin resultados.</td></tr>';
  }

  async function loadC(){
    elC.status.textContent = 'Cargando candidaturas…';
    const snap = await db.collection('candidaturas').orderBy('createdAt','desc').limit(300).get();
    allC = snap.docs.map(d=>({ _id:d.id, ...d.data(), estado: d.data().estado || 'pendiente' }));
    elC.status.textContent = `Cargadas ${allC.length}.`;
    renderC();
  }

  [elC.q, elC.fDisp, elC.fEstado, elC.fLimit].forEach(n=> n.addEventListener('input', renderC));
  elC.exportBtn.addEventListener('click', ()=>{
    const head = ['fecha','nombre','email','telefono','ciudad','cp','disponibilidad','links','estado','cvUrl','tituloUrl','cuidId'];
    const lines = [head.join(',')];
    allC.forEach(it=>{
      const fecha = it.createdAt?.toDate ? fmt(it.createdAt) : '';
      const row = [ fecha, it.nombre||'', it.email||'', it.telefono||'', it.ciudad||'', it.cp||'', it.disponibilidad||'', it.links||'', it.estado||'', it.cvUrl||'', it.tituloUrl||'', it.cuidId||'' ].map(v=>`"${String(v).replace(/"/g,'""')}"`);
      lines.push(row.join(','));
    });
    const blob = new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='candidaturas.csv'; a.click();
  });

  // Aceptar -> crear perfil + marcar candidatura
  elC.rows.addEventListener('click', async ev=>{
    const id = ev.target && ev.target.getAttribute('data-accept');
    if(!id) return;
    ev.target.disabled = true;
    try{
      const cand = allC.find(x=>x._id===id);
      if(!cand) throw new Error('Candidatura no encontrada');
      const cuidRef = await db.collection('cuidadores').add({
        nombre: cand.nombre||'', email: cand.email||'', telefono: cand.telefono||'',
        ciudad: cand.ciudad||'', cp: cand.cp||'', zona: zonaSugerida(cand.cp)||'',
        especiePerro: true, especieGato: true, especieExotico: false,
        disponibilidad: cand.disponibilidad||'', finesFestivos: cand.finesFestivos||'',
        zonasCobertura: cand.zonasCobertura||'',
        atvTitulado: cand.atvTitulado||'', otrasFormaciones: cand.otrasFormaciones||'',
        experienciaLaboral: cand.experienciaLaboral || cand.experienciaPrev || '',
        funcionesHabituales: cand.funcionesHabituales||'',
        links: cand.links||'', descripcionPersonal: cand.descripcionPersonal||'',
        estado: 'activo', createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      await db.collection('candidaturas').doc(id).update({ estado:'aceptada', cuidId: cuidRef.id });

      const idx = allC.findIndex(x=>x._id===id);
      if (idx>=0){ allC[idx].estado='aceptada'; allC[idx].cuidId=cuidRef.id; }
      renderC();
      alert('Candidatura aceptada y perfil creado.');
    }catch(e){
      console.error(e); alert('Error al aceptar (revisa reglas Firestore)');
    }finally{
      ev.target.disabled = false;
    }
  });

  // ======== RESERVAS + SUGERENCIAS ========
  const elR = {
    status: document.getElementById('tpl-status-r'),
    q: document.getElementById('tpl-r-q'),
    especie: document.getElementById('tpl-r-especie'),
    limit: document.getElementById('tpl-r-limit'),
    rows: document.getElementById('tpl-r-rows'),
    modal: document.getElementById('tpl-modal'),
    close: document.getElementById('tpl-close'),
    sugRows: document.getElementById('tpl-sug-rows'),
    sugDesc: document.getElementById('tpl-sug-desc')
  };
  let allR = [];
  let cachedCuid = [];

  function renderR(){
    const limit = parseInt(elR.limit.value||'50',10);
    const needle = elR.q.value.trim().toLowerCase();
    const especie = elR.especie.value;
    const filtered = allR.filter(r=>{
      const hay=[r.clienteNombre,r.clienteEmail,r.ciudad,r.cp].join(' ').toLowerCase();
      const okText = !needle || hay.includes(needle);
      const okEsp  = !especie || (r.especie===especie);
      return okText && okEsp;
    }).slice(0,limit);
    elR.rows.innerHTML = filtered.length ? filtered.map(r=>`
      <tr>
        <td class="nowrap">${fmt(r.createdAt)}</td>
        <td><strong>${esc(r.clienteNombre||'-')}</strong><div class="muted">${esc(r.clienteEmail||'')}</div></td>
        <td>${esc(r.ciudad||'-')}<br><span class="muted">${esc(r.cp||'')}</span></td>
        <td>${esc(r.especie||'-')}</td>
        <td>${esc(r.servicio||'-')}<br><span class="muted">${esc(r.fechaInicio||'')} → ${esc(r.fechaFin||'')}</span></td>
        <td><button class="btn" data-sugerir="${r._id}">Sugerir cuidadores</button></td>
      </tr>
    `).join('') : '<tr><td colspan="6">Sin reservas.</td></tr>';
  }

  async function loadR(){
    elR.status.textContent = 'Cargando reservas…';
    // Esperado en /reservas:
    // { clienteNombre, clienteEmail, ciudad, cp, especie, servicio, fechaInicio:'YYYY-MM-DD', fechaFin:'YYYY-MM-DD', createdAt, (opcional) importeReserva, importeAuxiliar }
    const snap = await db.collection('reservas').orderBy('createdAt','desc').limit(200).get();
    allR = snap.docs.map(d=>({ _id:d.id, ...d.data() }));
    elR.status.textContent = `Cargadas ${allR.length}.`;
    renderR();
  }

  async function ensureCuidadoresCache(){
    if (cachedCuid.length) return;
    const snap = await db.collection('cuidadores').where('estado','==','activo').limit(500).get();
    cachedCuid = snap.docs.map(d=>({ id:d.id, ...d.data() }));
  }

  async function sugerirParaReserva(reserva){
    await ensureCuidadoresCache();
    // 1) Especie
    const esp = reserva.especie;
    const porEspecie = cachedCuid.filter(c=>{
      if (esp==='perro') return c.especiePerro !== false;
      if (esp==='gato') return c.especieGato !== false;
      if (esp==='exotico') return c.especieExotico === true;
      return true;
    });
    // 2) Zona (CP/ciudad)
    const prefCP = String(reserva.cp||'').slice(0,2);
    function scoreZona(c){
      let s=0;
      if (c.cp && String(c.cp).slice(0,2)===prefCP) s+=3;
      if ((c.ciudad||'').toLowerCase()===(reserva.ciudad||'').toLowerCase()) s+=2;
      if ((c.zonasCobertura||'').toLowerCase().includes((reserva.ciudad||'').toLowerCase())) s+=1;
      return s;
    }
    // 3) Disponibilidad (agenda)
    const start = reserva.fechaInicio, end = reserva.fechaFin;
    async function disponibilidadScore(c){
      const q = await db.collection('cuidadores').doc(c.id).collection('agenda')
        .where('date','>=', start).where('date','<=', end).get();
      const evs = q.docs.map(d=>d.data());
      const hayBusy = evs.some(e=> e.type==='busy');
      const hayFree = evs.some(e=> e.type==='free');
      return hayBusy ? -5 : (hayFree ? 2 : 0);
    }
    const base = porEspecie.map(c=>({ c, zona: scoreZona(c) }));
    const availScores = await Promise.all(base.map(x=> disponibilidadScore(x.c)));
    return base.map((x,i)=>({ c:x.c, score: x.zona + availScores[i], zonaScore:x.zona, dispScore: availScores[i] }))
               .sort((a,b)=> b.score - a.score);
  }

  // Modal sugerencias
  const openModal = ()=> document.getElementById('tpl-modal').style.display='flex';
  const closeModal = ()=> document.getElementById('tpl-modal').style.display='none';
  document.getElementById('tpl-close').addEventListener('click', closeModal);
  document.getElementById('tpl-modal').addEventListener('click', e=>{ if(e.target.id==='tpl-modal') closeModal(); });

  document.getElementById('tpl-r-rows').addEventListener('click', async ev=>{
    const id = ev.target && ev.target.getAttribute('data-sugerir');
    if(!id) return;
    const r = allR.find(x=>x._id===id);
    if(!r) return;
    const sugRows = document.getElementById('tpl-sug-rows');
    const sugDesc = document.getElementById('tpl-sug-desc');
    sugRows.innerHTML = '<tr><td colspan="6">Calculando…</td></tr>';
    sugDesc.textContent = `Reserva: ${r.ciudad||'-'} ${r.cp||''} · ${r.especie||'-'} · ${r.fechaInicio||''} → ${r.fechaFin||''}`;
    openModal();
    try{
      const lista = await sugerirParaReserva(r);
      if (!lista.length){
        sugRows.innerHTML = '<tr><td colspan="6">No hay coincidencias. La reserva queda registrada.</td></tr>';
        return;
      }
      sugRows.innerHTML = lista.slice(0,30).map(x=>{
        const esp = [
          x.c.especiePerro!==false ? '🐶' : '—',
          x.c.especieGato!==false ? '🐱' : '—',
          x.c.especieExotico===true ? '🦎' : '—'
        ].join(' ');
        const dispTxt = x.dispScore<0 ? 'Ocupado' : (x.dispScore>0 ? 'Libre' : 'Sin datos');
        return `<tr>
          <td><strong>${esc(x.c.nombre||'-')}</strong><div class="muted">${esc(x.c.email||'')} · ${esc(x.c.telefono||'')}</div></td>
          <td>${esc(x.c.ciudad||'-')} ${x.c.cp? '('+esc(x.c.cp)+')':''}</td>
          <td>${esp}</td>
          <td>${dispTxt}</td>
          <td><span class="pill">Score ${x.score}</span></td>
          <td><a class="btn sec" target="_blank" href="tpl-perfil-cuidador.html?id=${encodeURIComponent(x.c.id)}">Abrir perfil</a></td>
        </tr>`;
      }).join('');
    }catch(e){
      console.error(e);
      sugRows.innerHTML = '<tr><td colspan="6">Error calculando sugerencias.</td></tr>';
    }
  });

  ['tpl-r-q','tpl-r-especie','tpl-r-limit'].forEach(id=>{
    const n=document.getElementById(id); n && n.addEventListener('input', renderR);
  });

  // ======== USUARIOS (Propietarios y Cuidadores) ========
  // Convención recomendada:
  // - Colección "users": { displayName, email, ciudad, cp, role: 'propietario' | 'cuidador', createdAt }
  // - Colección "cuidadores": perfiles de cuidadores aprobados (ya existente)
  const elU = {
    status: document.getElementById('tpl-status-u'),
    q: document.getElementById('tpl-u-q'),
    rol: document.getElementById('tpl-u-rol'),
    limit: document.getElementById('tpl-u-limit'),
    rows: document.getElementById('tpl-u-rows'),
    exportBtn: document.getElementById('tpl-u-export')
  };
  let allU = [];

  function renderU(){
    const limit = parseInt(elU.limit.value||'50',10);
    const q = (elU.q.value||'').toLowerCase().trim();
    const rol = elU.rol.value;
    const filtered = allU.filter(u=>{
      const hay = [u.displayName,u.email,u.ciudad,u.cp].join(' ').toLowerCase();
      const okText = !q || hay.includes(q);
      const okRol = !rol || (u.role===rol);
      return okText && okRol;
    }).slice(0,limit);
    elU.rows.innerHTML = filtered.length ? filtered.map(u=>`
      <tr>
        <td class="nowrap">${fmt(u.createdAt)}</td>
        <td><strong>${esc(u.displayName||'-')}</strong><div class="muted">${esc(u.email||'')}</div></td>
        <td>${u.role ? `<span class="pill">${esc(u.role)}</span>`:'-'}</td>
        <td>${esc(u.ciudad||'-')}<br><span class="muted">${esc(u.cp||'')}</span></td>
        <td>${
          u.role==='cuidador' && u.cuidId
           ? `<a class="btn sec" href="tpl-perfil-cuidador.html?id=${encodeURIComponent(u.cuidId)}" target="_blank">Ver perfil</a>`
           : '-'
        }</td>
      </tr>
    `).join('') : '<tr><td colspan="5">Sin usuarios.</td></tr>';
  }

  async function loadU(){
    elU.status.textContent = 'Cargando usuarios…';
    const snap = await db.collection('users').orderBy('createdAt','desc').limit(500).get();
    allU = snap.docs.map(d=>({ _id:d.id, ...d.data() }));
    elU.status.textContent = `Cargados ${allU.length}.`;
    renderU();
  }

  [elU.q, elU.rol, elU.limit].forEach(n=> n.addEventListener('input', renderU));
  elU.exportBtn.addEventListener('click', ()=>{
    const head = ['fecha','displayName','email','role','ciudad','cp','cuidId'];
    const lines = [head.join(',')];
    allU.forEach(u=>{
      const fecha = u.createdAt?.toDate ? fmt(u.createdAt) : '';
      const row = [fecha,u.displayName||'',u.email||'',u.role||'',u.ciudad||'',u.cp||'',u.cuidId||''].map(v=>`"${String(v).replace(/"/g,'""')}"`);
      lines.push(row.join(','));
    });
    const blob = new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='usuarios.csv'; a.click();
  });

  // ======== PANEL (Dashboard): KPIs y actividad ========
  async function loadKPIs(){
    const status = document.getElementById('tpl-status-panel');
    const now = new Date();
    const todayYmd = toYmd(now);

    // Helpers para contar por periodo a partir de createdAt
    async function countDocs(collection, limit=1000){
      const snap = await db.collection(collection).orderBy('createdAt','desc').limit(limit).get();
      const docs = snap.docs.map(d=>d.data()).filter(d=>d.createdAt && d.createdAt.toDate);
      let d=0,m=0,y=0;
      const ref = now;
      docs.forEach(x=>{
        const dt = x.createdAt.toDate();
        if (toYmd(dt)===todayYmd) d++;
        if (isSameMonth(dt,ref)) m++;
        if (isSameYear(dt,ref)) y++;
      });
      return {d,m,y, raw:docs};
    }

    // Registros (users)
    const users = await countDocs('users', 1000);
    document.getElementById('kpi-users-today').textContent = users.d;
    document.getElementById('kpi-users-month').textContent = `Mes: ${users.m} · Año: ${users.y}`;

    // Candidaturas
    const cands = await countDocs('candidaturas', 1000);
    document.getElementById('kpi-cands-today').textContent = cands.d;
    document.getElementById('kpi-cands-month').textContent = `Mes: ${cands.m} · Año: ${cands.y}`;

    // Reservas
    const resv = await countDocs('reservas', 1000);
    document.getElementById('kpi-resv-today').textContent = resv.d;
    document.getElementById('kpi-resv-month').textContent = `Mes: ${resv.m} · Año: ${resv.y}`;

    // Visitas (convención sugerida: colección "visitas" con docs por día { date:'YYYY-MM-DD', count:number, createdAt })
    let visToday=0, visMonth=0, visYear=0;
    try{
      const vs = await db.collection('visitas').orderBy('date','desc').limit(400).get();
      const refYear = String(now.getFullYear());
      const refMonth = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
      vs.docs.forEach(doc=>{
        const v = doc.data();
        if (v?.date === todayYmd) visToday += (v.count||0);
        if (String(v?.date||'').startsWith(refMonth)) visMonth += (v.count||0);
        if (String(v?.date||'').startsWith(refYear)) visYear += (v.count||0);
      });
    }catch(e){ /* si no existe, dejamos en 0 */ }
    document.getElementById('kpi-visits-today').textContent = visToday || 0;
    document.getElementById('kpi-visits-month').textContent = `Mes: ${visMonth||0} · Año: ${visYear||0}`;

    // Ingresos (estimación): sumar campos si existen
    let eurReserva=0, eurAux=0;
    resv.raw.forEach(r=>{
      eurReserva += Number(r.importeReserva||0);
      eurAux += Number(r.importeAuxiliar||0);
    });
    const total = eurReserva + eurAux;
    document.getElementById('kpi-eur-total').textContent = `${total.toFixed(2)} €`;
    document.getElementById('kpi-eur-split').textContent = `Reserva: ${eurReserva.toFixed(2)} € · Auxiliar: ${eurAux.toFixed(2)} €`;

    // Distribución roles
    let nProp=0, nCuid=0;
    users.raw.forEach(u=>{
      if (u.role==='propietario') nProp++;
      if (u.role==='cuidador') nCuid++;
    });
    document.getElementById('kpi-roles-total').textContent = (nProp+nCuid);
    document.getElementById('kpi-roles-split').textContent = `Propietarios: ${nProp} · Cuidadores: ${nCuid}`;

    // Actividad reciente (tomamos últimos eventos de varias colecciones)
    const actRows = document.getElementById('tpl-activity-rows');
    const rows = [];
    users.raw.slice(0,10).forEach(u=> rows.push({ts:u.createdAt, type:'Usuario', msg:`Alta de ${u.displayName||u.email||'—'}`}));
    cands.raw.slice(0,10).forEach(c=> rows.push({ts:c.createdAt, type:'Candidatura', msg:`${c.nombre||c.email||'—'} · ${c.estado||'pendiente'}`}));
    resv.raw.slice(0,10).forEach(r=> rows.push({ts:r.createdAt, type:'Reserva', msg:`${r.clienteNombre||r.clienteEmail||'—'} · ${r.servicio||''}`}));
    rows.sort((a,b)=> b.ts?.toMillis?.() - a.ts?.toMillis?.());
    const show = rows.slice(0,20);
    actRows.innerHTML = show.length
      ? show.map(x=>`<tr><td class="nowrap">${fmt(x.ts)}</td><td>${esc(x.type)}</td><td>${esc(x.msg)}</td></tr>`).join('')
      : '<tr><td colspan="3">Sin actividad reciente.</td></tr>';

    status.textContent = 'Métricas actualizadas.';
  }

  // ======== Boot general ========
  async function boot(){
    await Promise.all([loadC(), loadR(), loadU(), loadKPIs()]);
  }
})();
</script>
<!-- TPL: FIN BLOQUE NUEVO -->
</body>
</html>
