<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Admin ¬∑ The Pets Lovers</title>
<meta name="robots" content="noindex,nofollow">
<link rel="stylesheet" href="style.css">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Poppins:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<style>
  :root{ --tpl-primary:#339496; --tpl-ink:#58425a; }
  .page{ padding-top:120px }
  .tpl-card{ max-width:1200px; margin:0 auto 60px; background:#fff; border:1px solid #eee; border-radius:12px; box-shadow:0 2px 12px rgba(0,0,0,.05); padding:16px; }
  h1{ margin:0 0 8px }
  .muted{ color:#666 }
  .btn{ background:#339496; color:#fff; border-radius:999px; padding:8px 12px; text-decoration:none; border:2px solid transparent; display:inline-block; font-weight:700; cursor:pointer }
  .btn.sec{ background:#fff; color:#339496; border-color:#339496 }
  .btn:disabled{ opacity:.6; cursor:not-allowed }
  .toolbar{ display:flex; gap:10px; flex-wrap:wrap; margin:10px 0 }
  .filters{ display:grid; gap:10px; grid-template-columns:1fr 180px 180px 120px }
  @media (max-width: 900px){ .filters{ grid-template-columns:1fr 1fr } }
  .filters input,.filters select{ border:1px solid #ddd; border-radius:10px; padding:10px; font:inherit }
  table{ width:100%; border-collapse:collapse; margin-top:8px }
  th,td{ text-align:left; padding:10px; border-bottom:1px solid #f0f0f0; vertical-align:top }
  th{ color:#58425a; font-weight:700 }
  .pill{ display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #d7efef; color:#339496; background:#f5fbfb; font-size:.85rem }
  .tabbar{ display:flex; gap:8px; margin:12px 0; flex-wrap:wrap }
  .tabbar button{ background:#f5fbfb; color:#339496; border:1px solid #d7efef; border-radius:999px; padding:6px 12px; cursor:pointer }
  .tabbar button.active{ background:#339496; color:#fff; border-color:#339496 }
  .section{ display:none }
  .section.active{ display:block }
  .status{ margin:6px 0 12px; color:#666 }
  .nowrap{ white-space:nowrap }
  .tpl-grid{ display:grid; grid-template-columns:repeat(12,1fr); gap:12px; }
  .tpl-col-3{ grid-column:span 3; }
  .tpl-col-4{ grid-column:span 4; }
  .tpl-col-6{ grid-column:span 6; }
  .tpl-col-12{ grid-column:span 12; }
  @media (max-width: 900px){
    .tpl-col-3,.tpl-col-4,.tpl-col-6,.tpl-col-12{ grid-column:span 12; }
  }
  .tpl-kpi{ border:1px solid #eee; border-radius:12px; padding:14px; }
  .tpl-kpi h3{ margin:0 0 8px; font-size:1rem; color:#58425a }
  .tpl-kpi .big{ font-size:1.8rem; font-weight:700; color:#339496 }
  .tpl-table-wrap{ overflow:auto }
</style>
</head>
<body>
<main class="page">
  <section class="tpl-card">
    <h1>üîí Admin ¬∑ The Pets Lovers</h1>
    <p id="tpl-auth-status" class="muted">Debes iniciar sesi√≥n para ver los datos.</p>
    <div class="toolbar" id="tpl-auth-actions">
      <button class="btn" id="tpl-login">Iniciar sesi√≥n con Google</button>
      <button class="btn sec" id="tpl-logout" style="display:none">Cerrar sesi√≥n</button>
    </div>

    <div id="tpl-app" style="display:none">
      <div class="tabbar" role="tablist" aria-label="Secciones">
        <button class="active" data-tab="panel" role="tab">Panel</button>
        <button data-tab="cands" role="tab">Candidaturas</button>
        <button data-tab="reservas" role="tab">Reservas</button>
        <button data-tab="usuarios" role="tab">Usuarios</button>
      </div>

      <div id="section-panel" class="section active" aria-labelledby="tab-panel">
        <p class="status" id="tpl-status-panel">Cargando m√©tricas‚Ä¶</p>
        <div class="tpl-grid">
          <div class="tpl-col-3"><div class="tpl-kpi"><h3>Registros hoy</h3><div class="big" id="kpi-users-today">‚Äì</div><div class="muted" id="kpi-users-month">Mes: ‚Äì ¬∑ A√±o: ‚Äì</div></div></div>
          <div class="tpl-col-3"><div class="tpl-kpi"><h3>Candidaturas hoy</h3><div class="big" id="kpi-cands-today">‚Äì</div><div class="muted" id="kpi-cands-month">Mes: ‚Äì ¬∑ A√±o: ‚Äì</div></div></div>
          <div class="tpl-col-3"><div class="tpl-kpi"><h3>Reservas hoy</h3><div class="big" id="kpi-resv-today">‚Äì</div><div class="muted" id="kpi-resv-month">Mes: ‚Äì ¬∑ A√±o: ‚Äì</div></div></div>
          <div class="tpl-col-3"><div class="tpl-kpi"><h3>Visitas hoy</h3><div class="big" id="kpi-visits-today">‚Äì</div><div class="muted" id="kpi-visits-month">Mes: ‚Äì ¬∑ A√±o: ‚Äì</div></div></div>
          <div class="tpl-col-6"><div class="tpl-kpi"><h3>Ingresos (estim.)</h3><div class="muted">* Suma de campos en reservas si existen: <code>importeReserva</code> y <code>importeAuxiliar</code>.</div><div class="big" id="kpi-eur-total">‚Äì ‚Ç¨</div><div class="muted" id="kpi-eur-split">Reserva: ‚Äì ‚Ç¨ ¬∑ Auxiliar: ‚Äì ‚Ç¨</div></div></div>
          <div class="tpl-col-6"><div class="tpl-kpi"><h3>Distribuci√≥n perfiles</h3><div class="big" id="kpi-roles-total">‚Äì</div><div class="muted" id="kpi-roles-split">Propietarios: ‚Äì ¬∑ Cuidadores: ‚Äì</div></div></div>
          <div class="tpl-col-12"><div class="tpl-kpi"><h3>√öltimas 20 acciones</h3><div class="tpl-table-wrap"><table><thead><tr><th>Fecha</th><th>Tipo</th><th>Detalle</th></tr></thead><tbody id="tpl-activity-rows"><tr><td colspan="3">Cargando‚Ä¶</td></tr></tbody></table></div></div></div>
        </div>
      </div>

      <div id="section-cands" class="section" aria-labelledby="tab-cands">
        <p id="tpl-status-c" class="status">Cargando candidaturas‚Ä¶</p>
        <div class="filters">
          <input id="tpl-q" type="search" placeholder="Buscar nombre, email, ciudad, zonas‚Ä¶">
          <select id="tpl-f-disp">
            <option value="">Disponibilidad (todas)</option>
            <option>Ma√±anas</option><option>Tardes</option><option>Noches</option>
            <option>Fines de semana</option><option>Completa</option>
          </select>
          <select id="tpl-f-estado">
            <option value="">Estado (todos)</option>
            <option value="aceptada">Aceptada</option>
            <option value="pendiente">Pendiente</option>
          </select>
          <select id="tpl-f-limit">
            <option>25</option><option selected>50</option><option>100</option>
          </select>
        </div>
        <div class="toolbar">
          <button class="btn sec" id="tpl-export">Exportar CSV</button>
        </div>
        <div style="overflow:auto">
          <table aria-describedby="tpl-status-c">
            <thead>
              <tr>
                <th class="nowrap">Fecha</th>
                <th>Nombre / Contacto</th>
                <th>Ciudad / CP</th>
                <th>Zona</th>
                <th>Disponibilidad</th>
                <th>Archivos</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="tpl-rows"><tr><td colspan="7">Cargando‚Ä¶</td></tr></tbody>
          </table>
        </div>
      </div>

      <div id="section-reservas" class="section" aria-labelledby="tab-reservas">
        <p id="tpl-status-r" class="status">Cargando reservas‚Ä¶</p>
        <!-- ‚Ä¶estructura igual, omitida por brevedad‚Ä¶ -->
      </div>

      <div id="section-usuarios" class="section" aria-labelledby="tab-usuarios">
        <p id="tpl-status-u" class="status">Cargando usuarios‚Ä¶</p>
        <!-- ‚Ä¶estructura igual, omitida por brevedad‚Ä¶ -->
      </div>
    </div>
  </section>
</main>

<script src="tpl-navbar.js" defer></script>
<script src="tpl-footer.js" defer></script>

<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-storage-compat.js"></script>

<script>
(function(){
  // ============ Captura errores globales para no ‚Äúcolgarse‚Äù silenciosamente ============
  window.addEventListener('error', e=>{
    console.error('JS Error:', e.message, e.error);
    const s = document.getElementById('tpl-auth-status');
    if (s) s.textContent = 'Error de JavaScript: ' + e.message;
    alert('Error de JavaScript: ' + e.message);
  });
  window.addEventListener('unhandledrejection', e=>{
    console.error('Promise Rejection:', e.reason);
    const s = document.getElementById('tpl-auth-status');
    if (s) s.textContent = 'Error (promesa): ' + (e.reason && e.reason.message ? e.reason.message : e.reason);
    alert('Error (promesa): ' + (e.reason && e.reason.message ? e.reason.message : e.reason));
  });

  // 1) Init Firebase
  try{
    if (!firebase.apps.length){
      const firebaseConfig = {
        apiKey: "AIzaSyDW73aFuz2AFS9VeWg_linHIRJYN4YMgTk",
        authDomain: "thepetslovers-c1111.firebaseapp.com",
        projectId: "thepetslovers-c1111",
        storageBucket: "thepetslovers-c1111.appspot.com",
        messagingSenderId: "415914577533",
        appId: "1:415914577533:web:0b7a056ebaa4f1de28ab14",
        measurementId: "G-FXPD69KXBG"
      };
      firebase.initializeApp(firebaseConfig);
    }
  }catch(e){ console.error(e); }

  const db = firebase.firestore();
  const auth = firebase.auth();

  // Admins
  const ADMIN_EMAILS = new Set(["4b.jenny.gomez@gmail.com"]);
  function isAdminEmail(email){ return !!email && ADMIN_EMAILS.has(String(email).toLowerCase()); }

  // UI
  const authStatus = document.getElementById('tpl-auth-status');
  const loginBtn = document.getElementById('tpl-login');
  const logoutBtn = document.getElementById('tpl-logout');
  const app = document.getElementById('tpl-app');

  // Tabs
  const tabs = document.querySelectorAll('[data-tab]');
  const sections = {
    panel: document.getElementById('section-panel'),
    cands: document.getElementById('section-cands'),
    reservas: document.getElementById('section-reservas'),
    usuarios: document.getElementById('section-usuarios')
  };
  tabs.forEach(b=>b.addEventListener('click', ()=>{
    tabs.forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    Object.values(sections).forEach(s=>s.classList.remove('active'));
    sections[b.dataset.tab].classList.add('active');
  }));

  loginBtn.addEventListener('click', async ()=>{
    try{
      const provider = new firebase.auth.GoogleAuthProvider();
      await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
      await auth.signInWithPopup(provider);
    }catch(e){
      console.error(e);
      alert('No se pudo iniciar sesi√≥n. Revisa dominios autorizados en Firebase Auth y prueba en ventana privada.');
    }
  });
  logoutBtn.addEventListener('click', ()=> auth.signOut());

  auth.onAuthStateChanged(user=>{
    const ok = !!user && isAdminEmail(user.email);
    authStatus.textContent = ok ? `Sesi√≥n iniciada como ${user.email}.` : (user ? 'No autorizado.' : 'Debes iniciar sesi√≥n para ver los datos.');
    loginBtn.style.display = ok ? 'none':'inline-block';
    logoutBtn.style.display = user ? 'inline-block':'none';
    app.style.display = ok ? '' : 'none';
    if (ok){ boot(); }
  });

  async function boot(){
    try{
      await loadC();
      document.getElementById('tpl-status-panel').textContent = 'Panel listo.';
    }catch(e){
      console.error(e);
      document.getElementById('tpl-status-panel').textContent = 'Error cargando datos.';
    }
  }

  // ======== Helpers comunes ========
  const PROV = {"01":"√Ålava","02":"Albacete","03":"Alicante","04":"Almer√≠a","05":"√Åvila","06":"Badajoz","07":"Islas Baleares","08":"Barcelona","09":"Burgos","10":"C√°ceres","11":"C√°diz","12":"Castell√≥n","13":"Ciudad Real","14":"C√≥rdoba","15":"A Coru√±a","16":"Cuenca","17":"Girona","18":"Granada","19":"Guadalajara","20":"Gipuzkoa","21":"Huelva","22":"Huesca","23":"Ja√©n","24":"Le√≥n","25":"Lleida","26":"La Rioja","27":"Lugo","28":"Madrid","29":"M√°laga","30":"Murcia","31":"Navarra","32":"Ourense","33":"Asturias","34":"Palencia","35":"Las Palmas","36":"Pontevedra","37":"Salamanca","38":"Santa Cruz de Tenerife","39":"Cantabria","40":"Segovia","41":"Sevilla","42":"Soria","43":"Tarragona","44":"Teruel","45":"Toledo","46":"Valencia","47":"Valladolid","48":"Bizkaia","49":"Zamora","50":"Zaragoza","51":"Ceuta","52":"Melilla"};
  function zonaSugerida(cp){ const s=(cp||'').toString().padStart(5,'0').slice(0,2); return PROV[s]||''; }
  function esc(s){ return String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
  function fmt(ts){ if(!ts) return '-'; const d=ts.toDate(); return d.toLocaleDateString('es-ES',{year:'numeric',month:'2-digit',day:'2-digit'})+' '+d.toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'}); }
  function textMatch(item, needle){ if(!needle) return true; const hay=[item.nombre,item.email,item.telefono,item.ciudad,item.cp,item.zonasCobertura,item.links].join(' ').toLowerCase(); return hay.includes(needle.toLowerCase()); }

  // ======== CANDIDATURAS ========
  const elC = {
    status: document.getElementById('tpl-status-c'),
    q: document.getElementById('tpl-q'),
    fDisp: document.getElementById('tpl-f-disp'),
    fEstado: document.getElementById('tpl-f-estado'),
    fLimit: document.getElementById('tpl-f-limit'),
    rows: document.getElementById('tpl-rows'),
    exportBtn: document.getElementById('tpl-export')
  };
  let allC = [];

  async function resolveStorageLinks(items){
    if (!items || !items.length) return;
    const storage = firebase.storage();
    async function hrefFrom(url, path){
      try{
        if (path) return await storage.ref(path).getDownloadURL();
        if (url){
          try { return await storage.refFromURL(url).getDownloadURL(); }
          catch(_){ return url; }
        }
      }catch(_){}
      return '';
    }
    await Promise.all(items.map(async it=>{
      it.cvHref     = await hrefFrom(it.cvUrl,     it.cvPath);
      it.tituloHref = await hrefFrom(it.tituloUrl, it.tituloPath);
      it.dniHref    = await hrefFrom(it.dniUrl,    it.dniPath);
      it.otrosHrefs = [];
      if (Array.isArray(it.otrosPaths)){
        for (const p of it.otrosPaths){
          try{ it.otrosHrefs.push(await storage.ref(p).getDownloadURL()); }catch(_){}
        }
      }
      if (Array.isArray(it.otrosUrls)){
        it.otrosHrefs.push(...it.otrosUrls);
      }
    }));
  }

  function renderC(){
    const limit = parseInt(elC.fLimit.value||'50',10);
    const needle = elC.q.value.trim();
    const disp = elC.fDisp.value.trim();
    const estado = elC.fEstado.value.trim();
    const filtered = allC.filter(it => textMatch(it, needle) && (!disp || (it.disponibilidad||'')===disp) && (!estado || (it.estado||'pendiente')===estado)).slice(0,limit);
    elC.rows.innerHTML = filtered.length ? filtered.map(it=>{
      const badges = [];
      if (it.cvHref || it.cvUrl)       badges.push(`<a class="btn sec" href="${it.cvHref||it.cvUrl}" target="_blank" rel="noopener">CV</a>`);
      if (it.tituloHref || it.tituloUrl) badges.push(`<a class="btn sec" href="${it.tituloHref||it.tituloUrl}" target="_blank" rel="noopener">T√≠tulo</a>`);
      if (it.dniHref || it.dniUrl)     badges.push(`<a class="btn sec" href="${it.dniHref||it.dniUrl}" target="_blank" rel="noopener">DNI</a>`);
      if (Array.isArray(it.otrosHrefs) && it.otrosHrefs.length){
        it.otrosHrefs.forEach((h,i)=>badges.push(`<a class="btn sec" href="${h}" target="_blank" rel="noopener">Otros ${i+1}</a>`));
      }
      const archivos = badges.join(' ');
      const zona = zonaSugerida(it.cp);
      const canAccept = !it.cuidId;
      const perfilHref = it.cuidId ? `tpl-perfil-cuidador.html?id=${encodeURIComponent(it.cuidId)}` : '#';
      return `<tr>
        <td class="nowrap">${fmt(it.createdAt)}</td>
        <td><div><strong>${esc(it.nombre)}</strong></div><div class="muted">${esc(it.email||'-')} ¬∑ ${esc(it.telefono||'-')}</div></td>
        <td>${esc(it.ciudad||'-')}<br><span class="muted">${esc(it.cp||'')}</span></td>
        <td>${zona?`<span class="pill">${zona}</span>`:'-'}</td>
        <td>${esc(it.disponibilidad||'-')}</td>
        <td>${archivos||'-'}</td>
        <td>${canAccept ? `<button class="btn" data-accept="${it._id}">Aceptar</button>` : `<a class="btn" href="${perfilHref}">Ver perfil</a>`}</td>
      </tr>`;
    }).join('') : '<tr><td colspan="7">Sin resultados.</td></tr>';
  }

  async function loadC(){
    elC.status.textContent = 'Cargando candidaturas‚Ä¶';
    const snap = await db.collection('candidaturas').orderBy('createdAt','desc').limit(300).get();
    allC = snap.docs.map(d=>{
      const raw = d.data(); const f = raw.files || {};
      return {
        _id: d.id, ...raw,
        estado: raw.estado || 'pendiente',
        cvPath:     raw.cvPath     || f.cvPath     || '',
        tituloPath: raw.tituloPath || f.tituloPath || '',
        dniPath:    raw.dniPath    || f.dniPath    || '',
        cvUrl:      raw.cvUrl      || f.cvUrl      || '',
        tituloUrl:  raw.tituloUrl  || f.tituloUrl  || '',
        dniUrl:     raw.dniUrl     || f.dniUrl     || '',
        otrosPaths: Array.isArray(raw.otrosPaths) ? raw.otrosPaths : (Array.isArray(f.otrosPaths) ? f.otrosPaths : []),
        otrosUrls:  Array.isArray(raw.otrosUrls)  ? raw.otrosUrls  : []
      };
    });
    await resolveStorageLinks(allC);
    elC.status.textContent = `Cargadas ${allC.length}.`;
    renderC();
  }

  elC.q.addEventListener('input', renderC);
  elC.fDisp.addEventListener('input', renderC);
  elC.fEstado.addEventListener('input', renderC);
  elC.fLimit.addEventListener('input', renderC);

  elC.exportBtn.addEventListener('click', ()=>{
    const head = ['fecha','nombre','email','telefono','ciudad','cp','disponibilidad','links','estado','cv','titulo','dni','cuidId'];
    const lines = [head.join(',')];
    allC.forEach(it=>{
      const fecha = it.createdAt?.toDate ? fmt(it.createdAt) : '';
      const row = [ fecha, it.nombre||'', it.email||'', it.telefono||'', it.ciudad||'', it.cp||'', it.disponibilidad||'', it.links||'', it.estado||'', (it.cvHref||it.cvUrl||''), (it.tituloHref||it.tituloUrl||''), (it.dniHref||it.dniUrl||''), it.cuidId||'' ].map(v=>`"${String(v).replace(/"/g,'""')}"`);
      lines.push(row.join(','));
    });
    const blob = new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8;'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='candidaturas.csv'; a.click();
  });

  // Aceptar -> crear perfil + marcar candidatura
  elC.rows.addEventListener('click', async ev=>{
    const id = ev.target && ev.target.getAttribute('data-accept');
    if(!id) return;
    ev.target.disabled = true;
    try{
      const cand = allC.find(x=>x._id===id);
      if(!cand) throw new Error('Candidatura no encontrada');
      const cuidRef = await db.collection('cuidadores').add({
        nombre: cand.nombre||'', email: cand.email||'', telefono: cand.telefono||'',
        ciudad: cand.ciudad||'', cp: cand.cp||'', zona: zonaSugerida(cand.cp)||'',
        especiePerro: true, especieGato: true, especieExotico: false
      });
      await db.collection('candidaturas').doc(id).update({ estado:'aceptada', cuidId: cuidRef.id });
      alert('Candidatura aceptada.');
      await loadC();
    }catch(e){
      console.error(e);
      alert('No se pudo aceptar la candidatura.');
      ev.target.disabled = false;
    }
  });

})();
</script>
</body>
</html>
